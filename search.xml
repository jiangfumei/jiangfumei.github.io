<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Springæºç </title>
    <url>/2020/12/04/Spring%E6%BA%90%E7%A0%81/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>çº¿ç¨‹</title>
    <url>/2020/11/26/%E7%BA%BF%E7%A8%8B/</url>
    <content><![CDATA[<h2 id="çº¿ç¨‹åŸºç¡€">çº¿ç¨‹åŸºç¡€</h2>
]]></content>
      <categories>
        <category>Java</category>
        <category>JavaåŸºç¡€</category>
      </categories>
      <tags>
        <tag>JavaåŸºç¡€</tag>
      </tags>
  </entry>
  <entry>
    <title>mysqlæ•°æ®åº“ç¼–ç </title>
    <url>/2020/07/06/mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%96%E7%A0%81/</url>
    <content><![CDATA[<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p>ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘çš„è§†é¢‘æ’­æ”¾åœ°å€é“¾æ¥å­˜åˆ°æ•°æ®åº“çš„urlåœ°å€æ±‰å­—éƒ¨åˆ†æœ‰ç©ºæ ¼ä»è€Œå¯¼è‡´å®¢æˆ·ç«¯ä¸èƒ½æ’­æ”¾è§†é¢‘åœ°å€ï¼Œå› ä¸ºä¸Šä¼ å‰æ²¡æœ‰å¯¹ä¸Šä¼ æ–‡ä»¶ç»Ÿä¸€å‘½åï¼Œä¸ºé¿å…æ­¤æƒ…å†µå†å‘ç”Ÿï¼Œäº‹åæˆ‘å¯¹ä¸Šä¼ æ–‡ä»¶ä»¥uuidå‘½åã€‚ä½†æ˜¯ï¼Œé‚£äº›å·²ç»ä¼ å®Œçš„è§†é¢‘æ•°æ®å¤§çº¦æœ‰ä¸€ç™¾å¤šæ¡ï¼Œæˆ‘å¦‚ä½•å¯¹å…¶ç¼–ç æˆå’Œä¸ƒç‰›äº‘ä¸€æ ·çš„ç¼–ç åœ°å€å‘¢ï¼Ÿè¿™å°±å¼€å§‹æ¥è§¦åˆ°äº†æ•°æ®åº“urlç¼–ç ã€‚</p>
<a id="more"></a>
<h2 id="è§£å†³è¿‡ç¨‹">è§£å†³è¿‡ç¨‹</h2>
<ol>
<li>å…ˆå¯¹æ•°æ®åº“ç»Ÿä¸€ç¼–ç ï¼Œå‚è€ƒæ–‡ç« <a href="https://blog.csdn.net/weixin_33831673/article/details/91822470" target="_blank" rel="noopener">mysql urlencode æ”¯æŒä¸­æ–‡</a>,åœ¨æ­¤ä¹Ÿè´´ä¸Š</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DELIMITER ;</span><br><span class="line"> </span><br><span class="line">DROP FUNCTION IF EXISTS urlencode;</span><br><span class="line"> </span><br><span class="line">DELIMITER |</span><br><span class="line"> </span><br><span class="line">CREATE FUNCTION URLENCODE(str VARCHAR(4096) CHARSET utf8) RETURNS VARCHAR(4096) CHARSET utf8</span><br><span class="line">DETERMINISTIC</span><br><span class="line">CONTAINS SQL</span><br><span class="line">BEGIN</span><br><span class="line">   -- the individual character we are converting in our loop</span><br><span class="line">   -- NOTE: must be VARCHAR even though it won&#39;t vary in length</span><br><span class="line">   -- CHAR(1), when used with SUBSTRING, made spaces &#39;&#39; instead of &#39; &#39;</span><br><span class="line">   DECLARE sub VARCHAR(1) CHARSET utf8;</span><br><span class="line">   -- the ordinal value of the character (i.e. Ã± becomes 50097)</span><br><span class="line">   DECLARE val BIGINT DEFAULT 0;</span><br><span class="line">   -- the substring index we use in our loop (one-based)</span><br><span class="line">   DECLARE ind INT DEFAULT 1;</span><br><span class="line">   -- the integer value of the individual octet of a character being encoded</span><br><span class="line">   -- (which is potentially multi-byte and must be encoded one byte at a time)</span><br><span class="line">   DECLARE OCT INT DEFAULT 0;</span><br><span class="line">   -- the encoded return string that we build up during execution</span><br><span class="line">   DECLARE ret VARCHAR(4096) DEFAULT &#39;&#39;;</span><br><span class="line">   -- our loop index for looping through each octet while encoding</span><br><span class="line">   DECLARE octind INT DEFAULT 0;</span><br><span class="line"> </span><br><span class="line">   IF ISNULL(str) THEN</span><br><span class="line">      RETURN NULL;</span><br><span class="line">   ELSE</span><br><span class="line">      SET ret &#x3D; &#39;&#39;;</span><br><span class="line">      -- loop through the input string one character at a time - regardless</span><br><span class="line">      -- of how many bytes a character consists of</span><br><span class="line">      WHILE ind &lt;&#x3D; CHAR_LENGTH(str) DO</span><br><span class="line">         SET sub &#x3D; MID(str, ind, 1);</span><br><span class="line">         SET val &#x3D; ORD(sub);</span><br><span class="line">         -- these values are ones that should not be converted</span><br><span class="line">         -- see http:&#x2F;&#x2F;tools.ietf.org&#x2F;html&#x2F;rfc3986</span><br><span class="line">         IF NOT (val BETWEEN 48 AND 57 OR     -- 48-57  &#x3D; 0-9</span><br><span class="line">                 val BETWEEN 65 AND 90 OR     -- 65-90  &#x3D; A-Z</span><br><span class="line">                 val BETWEEN 97 AND 122 OR    -- 97-122 &#x3D; a-z</span><br><span class="line">                 -- 45 &#x3D; hyphen, 46 &#x3D; period, 95 &#x3D; underscore, 126 &#x3D; tilde</span><br><span class="line">                 val IN (45, 46, 95, 126)) THEN</span><br><span class="line">            -- This is not an &quot;unreserved&quot; char and must be encoded:</span><br><span class="line">            -- loop through each octet of the potentially multi-octet character</span><br><span class="line">            -- and convert each into its hexadecimal value</span><br><span class="line">            -- we start with the high octect because that is the order that ORD</span><br><span class="line">            -- returns them in - they need to be encoded with the most significant</span><br><span class="line">            -- byte first</span><br><span class="line">            SET octind &#x3D; OCTET_LENGTH(sub);</span><br><span class="line">            WHILE octind &gt; 0 DO</span><br><span class="line">               -- get the actual value of this octet by shifting it to the right</span><br><span class="line">               -- so that it is at the lowest byte position - in other words, make</span><br><span class="line">               -- the octet&#x2F;byte we are working on the entire number (or in even</span><br><span class="line">               -- other words, oct will no be between zero and 255 inclusive)</span><br><span class="line">               SET OCT &#x3D; (val &gt;&gt; (8 * (octind - 1)));</span><br><span class="line">               -- we append this to our return string with a percent sign, and then</span><br><span class="line">               -- a left-zero-padded (to two characters) string of the hexadecimal</span><br><span class="line">               -- value of this octet)</span><br><span class="line">               SET ret &#x3D; CONCAT(ret, &#39;%&#39;, LPAD(HEX(OCT), 2, 0));</span><br><span class="line">               -- now we need to reset val to essentially zero out the octet that we</span><br><span class="line">               -- just encoded so that our number decreases and we are only left with</span><br><span class="line">               -- the lower octets as part of our integer</span><br><span class="line">               SET val &#x3D; (val &amp; (POWER(256, (octind - 1)) - 1));</span><br><span class="line">               SET octind &#x3D; (octind - 1);</span><br><span class="line">            END WHILE;</span><br><span class="line">         ELSE</span><br><span class="line">            -- this character was not one that needed to be encoded and can simply be</span><br><span class="line">            -- added to our return string as-is</span><br><span class="line">            SET ret &#x3D; CONCAT(ret, sub);</span><br><span class="line">         END IF;</span><br><span class="line">         SET ind &#x3D; (ind + 1);</span><br><span class="line">      END WHILE;</span><br><span class="line">   END IF;</span><br><span class="line">   RETURN ret;</span><br><span class="line">END;</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>è¿ç”¨sqlå‡½æ•°æ“ä½œåº“è¡¨<br>
ä½¿ç”¨<code>left</code>ã€<code>subString</code>ã€<code>truncate</code>ç­‰å‡½æ•°å¯¹æ•°æ®åº“ä¸­çš„å¤šæ¡æ•°æ®æ‰¹é‡ä¿®æ”¹ã€‚</li>
</ol>
]]></content>
      <categories>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>MySqlæ—¶åŒºä¸Javaé¡¹ç›®çš„æ—¶åŒºé—®é¢˜</title>
    <url>/2020/06/15/MySql%E6%97%B6%E5%8C%BA%E4%B8%8EJava%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%97%B6%E5%8C%BA%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p>ä¸€æ—¥éƒ¨ç½²å®Œé¡¹ç›®postmanæµ‹è¯•ï¼Œå‘ç°jsonè¿”å›ç»“æœçš„æ—¶é—´å­—æ®µä¸æ•°æ®åº“çš„æ—¶é—´ç›¸å·®äº†13ä¸ªå°æ—¶ã€‚é©¬ä¸Šè¿›è¡Œäº†æ’æŸ¥é—®é¢˜å·¥ä½œã€‚</p>
<h2 id="æ’æŸ¥é—®é¢˜">æ’æŸ¥é—®é¢˜</h2>
<ol>
<li>æŸ¥çœ‹mysqlæ—¶åŒº</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; show variables like &quot;%time_zone%&quot;;</span><br><span class="line">+------------------+--------+</span><br><span class="line">| Variable_name   | Value  |</span><br><span class="line">+------------------+--------+</span><br><span class="line">| system_time_zone | CST   |</span><br><span class="line">| time_zone     | SYSTEM |</span><br><span class="line">+------------------+--------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>å‘ç°æ•°æ®åº“çš„æ˜¯CSTæ—¶åŒº<br>
2. å› ä¸ºæˆ‘çš„é¡¹ç›®å’Œmysqléƒ½æ˜¯dockerå®¹å™¨è£…çš„ï¼Œæ‰€ä»¥æŸ¥çœ‹è¿™ä¸¤ä¸ªdocker å®¹å™¨çš„æ—¶é—´æ˜¾ç¤º<br>
<code>docker exec -it mysql /bin/bash</code><br>
<code>docker exec -it project /bin/bash</code><br>
è¿›å…¥å®¹å™¨åï¼Œ<code>date</code>å‘½ä»¤æŸ¥çœ‹æ˜¾ç¤ºMon Jun 15 11:19:13 CST 2020,éƒ½æ˜¯CST,é¦–å…ˆæˆ‘ä»¬è¦æ˜ç™½CSTæ—¶åŒºçš„å«ä¹‰<br>
CSTæ—¶åŒº4ç§å«ä¹‰ï¼š<br>
. ç¾å›½ä¸­éƒ¨æ—¶é—´ Central Standard Time (USA) UTC-06:00<br>
. æ¾³å¤§åˆ©äºšä¸­éƒ¨æ—¶é—´ Central Standard Time (Australia)<br>
. UTC+09:30 ä¸­å›½æ ‡å‡†æ—¶ China Standard Time<br>
. UTC+08:00 å¤å·´æ ‡å‡†æ—¶ Cuba Standard Time UTC-04:00<br>
å¦å¤–ï¼šç¾å›½ä»â€œ3æœˆ11æ—¥â€è‡³â€œ11æœˆ7æ—¥â€å®è¡Œå¤ä»¤æ—¶ï¼Œç¾å›½ä¸­éƒ¨æ—¶é—´æ”¹ä¸º UTC-05:00ï¼Œä¸ UTC+08:00 ç›¸å·® 13 å°æ—¶ã€‚<br>
è¿™å¥½åƒå°±æŸ¥åˆ°åŸå› äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è§£å†³é—®é¢˜äº†ã€‚</p>
<h2 id="è§£å†³é—®é¢˜">è§£å†³é—®é¢˜</h2>
<p>æ³•1. é…ç½®æ–‡ä»¶my.cnfä¿®æ”¹æ—¶åŒº</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">##åœ¨[mysqld]</span><br><span class="line">default-time_zone &#x3D; &#39;+8:00&#39;</span><br></pre></td></tr></table></figure>
<p>é‡å¯mysqlæœåŠ¡ã€‚æ£€æŸ¥ï¼Œè¿”å›jsonç»“æœæ—¶é—´ä¸æ•°æ®åº“ä¸€è‡´ã€‚<br>
æ³•2. ç›´æ¥åœ¨application.ymlé…ç½®æ–‡ä»¶ä¸­datasourceåæ·»åŠ <br>
<code>useTimezone=true&amp;serverTimezone=GMT%2B8</code><br>
é‡æ–°deployä¸€ä¸‹ï¼Œæ­£ç¡®<br>
å¯¹æ¯”ä¸‹æ¥å¥½åƒç¬¬äºŒç§æ–¹æ³•è¾ƒä¸ºç®€å•ï¼Œä¸ç”¨ä¿®æ”¹mysqlé…ç½®æ–‡ä»¶ã€‚ğŸ˜„ã€‚</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ•°æ®åº“è¡¨æ—¶é—´ä¸å—æœåŠ¡å™¨åŠå…¶å®ƒå½±å“ï¼Œå­˜è¿›å»æ˜¯å¤šå°‘å–å‡ºæ¥æ—¶é—´ä¹Ÿæ˜¯å¤šå°‘ã€‚å”¯ä¸€æ”¹å˜çš„å› ç´ å°±æ˜¯åœ¨è¿”å›jsonç»“æœæ—¶ä¸€èˆ¬è¿”å›çš„æ—¶é—´æ˜¯jsonå­—ç¬¦ä¸²ï¼Œè¿™å°±éœ€è¦åŠ ä¸Šæ‰€åœ¨çš„æ—¶åŒºæ˜¾ç¤ºjsonæ ¼å¼ï¼Œå¦‚ä¸œå…«åŒºå¦‚ä¸‹å›¾ï¼š<br>
<img src="/images/config.png" alt="">,åœ¨é‡åˆ°æ—¶åŒºé—®é¢˜æ—¶å…·ä½“é—®é¢˜åº”å…·ä½“åˆ†æï¼Œæ­¤ç¯‡å¯åšå‚è€ƒğŸ˜„ã€‚</p>
]]></content>
      <categories>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>JavaScript Sdkä¸Šä¼ æœ¬åœ°æ–‡ä»¶è‡³ä¸ƒç‰›äº‘</title>
    <url>/2020/06/05/js-sdk-qiniuyun/</url>
    <content><![CDATA[<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p>åå°ç®¡ç†é¡µé¢éœ€è¦å¢åŠ ä¸Šä¼ æœ¬åœ°è§†é¢‘åˆ°ä¸ƒç‰›äº‘åŠŸèƒ½ã€‚ä½¿ç”¨ä¸ƒç‰›äº‘å®˜æ–¹å®¢æˆ·ç«¯(Webç«¯)JavaScript sdk</p>
<h2 id="ä»£ç é›†æˆ">ä»£ç é›†æˆ</h2>
<p>å‰å°jsæ–‡ä»¶ uploadVideo.js</p>
<a id="more"></a>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">$.ajax(&#123;<span class="attr">url</span>: <span class="string">"/qiniu/upload/uptoken"</span>, <span class="attr">success</span>: <span class="function">(<span class="params">res</span>) =&gt;</span> initFileInput(res)&#125;)<span class="comment">//è¯·æ±‚åå°æ¥å£è·å–ä¸Šä¼ token</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> initFileInput = <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> token = res.uptoken;</span><br><span class="line">    <span class="keyword">let</span> domain = res.domain;</span><br><span class="line">    <span class="keyword">let</span> config = &#123;</span><br><span class="line">        useCdnDomain: <span class="literal">true</span>,</span><br><span class="line">        region: qiniu.region.as0</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">let</span> putExtra = &#123;</span><br><span class="line">        fname: <span class="string">""</span>,</span><br><span class="line">        params: &#123;&#125;,</span><br><span class="line">        mimeType: <span class="literal">null</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    $(<span class="string">"#file1"</span>).change(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> file = <span class="keyword">this</span>.files[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">let</span> key = file.name;</span><br><span class="line">        <span class="comment">//è·å–å½“å‰æ—¶é—´</span></span><br><span class="line">        <span class="keyword">let</span> timestamp=<span class="keyword">new</span> <span class="built_in">Date</span>().getTime();</span><br><span class="line">        <span class="keyword">let</span> keyValue = <span class="string">'rizin/video/'</span> + timestamp + <span class="string">'/'</span> + key;</span><br><span class="line">        <span class="comment">// æ·»åŠ ä¸Šä¼ domé¢æ¿</span></span><br><span class="line">        <span class="keyword">let</span> next = <span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> total = response.total;</span><br><span class="line">            <span class="comment">/*$(".speed").text("è¿›åº¦ï¼š" + total.percent + "% ");*/</span></span><br><span class="line">            $(<span class="string">"#speed1"</span>).text(<span class="string">"è¿›åº¦ï¼š"</span> + total.percent + <span class="string">"% "</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®next,error,completeå¯¹åº”çš„æ“ä½œï¼Œåˆ†åˆ«å¤„ç†ç›¸åº”çš„è¿›åº¦ä¿¡æ¯ï¼Œé”™è¯¯ä¿¡æ¯ï¼Œä»¥åŠå®Œæˆåçš„æ“ä½œ</span></span><br><span class="line">        <span class="keyword">let</span> error = <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">            alert(<span class="string">"ä¸Šä¼ å‡ºé”™"</span>)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> complete = <span class="function"><span class="keyword">function</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">            sdDeal(res.key, domain);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">let</span> subObject = &#123;</span><br><span class="line">            next: next,</span><br><span class="line">            error: error,</span><br><span class="line">            complete: complete</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// è°ƒç”¨sdkä¸Šä¼ æ¥å£è·å¾—ç›¸åº”çš„observableï¼Œæ§åˆ¶ä¸Šä¼ å’Œæš‚åœ</span></span><br><span class="line">        <span class="keyword">let</span> observable = qiniu.upload(file, keyValue, token, putExtra, config);</span><br><span class="line">        <span class="comment">//observable.subscribe(next);</span></span><br><span class="line">        observable.subscribe(subObject);</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<p>htmlæ–‡ä»¶</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"form-group"</span>&gt;</span><br><span class="line">    &lt;label <span class="class"><span class="keyword">class</span></span>=<span class="string">"col-sm-2 control-label"</span>&gt;<span class="xml"><span class="tag">&lt;<span class="name">font</span> <span class="attr">color</span>=<span class="string">"red"</span>&gt;</span>*<span class="tag">&lt;/<span class="name">font</span>&gt;</span></span>ç”»è³ªï¼ˆæ™®é€šï¼‰&lt;<span class="regexp">/label&gt;</span></span><br><span class="line"><span class="regexp">    &lt;div class="col-sm-4"&gt;</span></span><br><span class="line"><span class="regexp">        &lt;input type="file" id="file1"&gt;</span></span><br><span class="line"><span class="regexp">        &lt;input type="hidden"  name="sd" id="sdhid" value=""&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">    &lt;div <span class="class"><span class="keyword">class</span></span>=<span class="string">"col-sm-2"</span> style=<span class="string">'overflow:hidden'</span>&gt;</span><br><span class="line">        &lt;p <span class="class"><span class="keyword">class</span></span>=<span class="string">'speed'</span> id=<span class="string">"speed1"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>div&gt;</span><br></pre></td></tr></table></figure>
<p>åå°é›†æˆéœ€è¦å¼•å…¥ä¸ƒç‰›äº‘ç›¸å…³ä¾èµ–ï¼Œå®˜æ–¹sdkéƒ½æœ‰<br>
application.properties</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">###ä¸ƒç‰›äº‘è§†é¢‘ä¸Šä¼ ###</span><br><span class="line">qiniu.accessKey=**************************</span><br><span class="line">qiniu.secretKey=**************************</span><br><span class="line">qiniu.vhost=http:<span class="comment">//xxx.com/</span></span><br><span class="line">qiniu.zone=as0<span class="comment">//åŒºåŸŸ</span></span><br><span class="line">qiniu.bucket=xxx<span class="comment">//ç©ºé—´å</span></span><br></pre></td></tr></table></figure>
<p>UploadConfig.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(</span><br><span class="line">        prefix = <span class="string">"qiniu"</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QiniuUploadConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String accessKey;</span><br><span class="line">    <span class="keyword">private</span> String secretKey;</span><br><span class="line">    <span class="keyword">private</span> String bucket;</span><br><span class="line">    <span class="keyword">private</span> String vhost;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAccessKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> accessKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccessKey</span><span class="params">(String accessKey)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.accessKey = accessKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSecretKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> secretKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSecretKey</span><span class="params">(String secretKey)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.secretKey = secretKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getBucket</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bucket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBucket</span><span class="params">(String bucket)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bucket = bucket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getVhost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> vhost;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVhost</span><span class="params">(String vhost)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.vhost = vhost;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>QiniuUploadController.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/qiniu/upload"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QiniuUploadController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    QiniuUploadConfig config;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"uptoken"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JSONObject <span class="title">uptoken</span><span class="params">(@RequestParam Map&lt;String, Object&gt; params)</span> <span class="keyword">throws</span> AuthException </span>&#123;</span><br><span class="line">        JSONObject json = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        Auth auth = Auth.create(config.getAccessKey(), config.getSecretKey()); </span><br><span class="line">        String upToken = auth.uploadToken(config.getBucket());</span><br><span class="line">        String domain = config.getVhost();</span><br><span class="line">        json.put(<span class="string">"uptoken"</span>, upToken);</span><br><span class="line">        json.put(<span class="string">"domain"</span>,domain);</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¤§åŠŸå‘Šæˆï¼ğŸ˜„ã€‚</p>
]]></content>
      <categories>
        <category>ç¬¬ä¸‰æ–¹</category>
      </categories>
      <tags>
        <tag>ç¬¬ä¸‰æ–¹</tag>
        <tag>JPush</tag>
      </tags>
  </entry>
  <entry>
    <title>è§£å†³â€œDocker have no space left on deviceâ€é—®é¢˜</title>
    <url>/2020/06/03/Docker-have-no-space-left-on-device/</url>
    <content><![CDATA[<h2 id="å¼‚å¸¸">å¼‚å¸¸</h2>
<p>åƒå¾€å¸¸ä¸€æ ·éƒ¨ç½²é¡¹ç›®<code>./deploy.sh xx.jar</code>æ—¶,å¤±è´¥æŠ¥<code>Docker have no space left on device</code>é”™è¯¯ã€‚äºæ˜¯æˆ‘å°±ç”¨<code>docker system prune</code>åˆ é™¤æ— ç”¨çš„dokeræ•°æ®ï¼Œä½†æ˜¯è¿˜æ˜¯ä¾ç„¶æŠ¥æ­¤é”™è¯¯ã€‚é‚£å°±è¦æƒ³å æ®ç£ç›˜ç©ºé—´çš„ä¸»è¦å› ç´ ä¸€èˆ¬æ˜¯æ—¥å¿—å’Œdockeræ‰€å çš„ç©ºé—´äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿›è¡Œå¦‚ä¸‹æ“ä½œã€‚</p>
<h2 id="è§£å†³åŠæ³•">è§£å†³åŠæ³•</h2>
<h3 id="åˆ é™¤æ—¥å¿—">åˆ é™¤æ—¥å¿—</h3>
<ol>
<li>dfå‘½ä»¤ç”¨äºæ˜¾ç¤ºç›®å‰åœ¨Linuxç³»ç»Ÿä¸Šçš„æ–‡ä»¶ç³»ç»Ÿçš„ç£ç›˜ä½¿ç”¨æƒ…å†µç»Ÿè®¡ã€‚<br>
<code>df -h</code><br>
<img src="/images/df.png" alt=""></li>
<li>æŸ¥çœ‹æ—¥å¿—ç£ç›˜ä½¿ç”¨ç‡<br>
<code>du /var/log/ -h</code><br>
<img src="/images/du-log.png" alt=""></li>
<li>è¿›å…¥æ—¥å¿—ç›®å½•ï¼ŒæŸ¥çœ‹<br>
<code>cd /var/log</code><br>
<code>ls -alh</code><br>
è¿™é‡Œé¢çš„æ—¥å¿—ä¸€èˆ¬éƒ½èƒ½åˆ é™¤ï¼Œåˆ é™¤å ç£ç›˜ç©ºé—´å¤§çš„ï¼Œå¦‚åˆ é™¤æ–‡ä»¶å‰ç¼€ä¸ºbtmpçš„<br>
<code>rm btmp-* -f</code></li>
<li>å†æ¬¡æŸ¥çœ‹ç£ç›˜ä¿¡æ¯<br>
<code>df</code><br>
<img src="/images/df-1.png" alt=""></li>
</ol>
<h3 id="åˆ é™¤dockeræ‰€å ç£ç›˜ç©ºé—´">åˆ é™¤dockeræ‰€å ç£ç›˜ç©ºé—´</h3>
<ol>
<li>æŸ¥çœ‹é•œåƒ<br>
<code>docker images</code><br>
<img src="/images/dockerimages.png" alt=""></li>
<li>æ‰¹é‡åˆ é™¤æ— ç”¨é•œåƒ<br>
<code>docker images |cut -c41-53 |xargs docker rmi</code><br>
æ­¤æ¡å‘½ä»¤åªèƒ½åˆ é™¤ä¸é‡åä¸”æ²¡æœ‰ä¾èµ–çš„é•œåƒ</li>
<li>åˆ é™¤é‡åå¹¶ä¸”æœ‰ä¾èµ–çš„åºŸå¼ƒçš„é•œåƒï¼Œä¾‹å¦‚åˆ é™¤5ä¸ªæœˆå‰çš„é•œåƒ<br>
<code>docker images |grep '5 months ago' |cut -c41-53 |xargs docker rmi -f</code></li>
<li>dfå†æ¬¡æŸ¥çœ‹ç£ç›˜æ‰€å ç©ºé—´<br>
<code>df</code><br>
<img src="/images/df-final.png" alt=""><br>
æœ€åé™„é€æŸ¥çœ‹å®šæ—¶ä»»åŠ¡å‘½ä»¤,ğŸ˜„<br>
<code>crontab -l</code></li>
</ol>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>OAuth2</title>
    <url>/2020/04/09/OAuth2/</url>
    <content><![CDATA[<h2 id="OAuthå››ç§è§’è‰²">OAuthå››ç§è§’è‰²</h2>
<p>å®Œæ•´æˆæƒæµç¨‹ä¸­æœ‰å››ä¸ªé‡è¦çš„è§’è‰²[ RFC 6749 ]ï¼š</p>
<p>èµ„æºæ‹¥æœ‰è€…ï¼ˆresource ownerï¼‰ï¼šèƒ½æˆæƒè®¿é—®å—ä¿æŠ¤èµ„æºçš„ä¸€ä¸ªå®ä½“ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªäººï¼Œé‚£æˆ‘ä»¬ç§°ä¹‹ä¸ºæœ€ç»ˆç”¨æˆ·ï¼›<br>
èµ„æºæœåŠ¡å™¨ï¼ˆresource serverï¼‰ï¼šå­˜å‚¨å—ä¿æŠ¤èµ„æºï¼Œå®¢æˆ·ç«¯é€šè¿‡access tokenè¯·æ±‚èµ„æºï¼Œèµ„æºæœåŠ¡å™¨å“åº”å—ä¿æŠ¤èµ„æºç»™å®¢æˆ·ç«¯ï¼›<br>
æˆæƒæœåŠ¡å™¨ï¼ˆauthorization serverï¼‰ï¼šæˆåŠŸéªŒè¯èµ„æºæ‹¥æœ‰è€…å¹¶è·å–æˆæƒä¹‹åï¼ŒæˆæƒæœåŠ¡å™¨é¢å‘æˆæƒä»¤ç‰Œï¼ˆAccess Tokenï¼‰ç»™å®¢æˆ·ç«¯ã€‚<br>
å®¢æˆ·ç«¯ï¼ˆclientï¼‰ï¼šç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œä¹Ÿå¯ä»¥æ˜¯å®ƒè‡ªå·±çš„å®˜æ–¹åº”ç”¨ï¼›å…¶æœ¬èº«ä¸å­˜å‚¨èµ„æºï¼Œè€Œæ˜¯èµ„æºæ‹¥æœ‰è€…æˆæƒé€šè¿‡åï¼Œä½¿ç”¨å®ƒçš„æˆæƒï¼ˆæˆæƒä»¤ç‰Œï¼‰è®¿é—®å—ä¿æŠ¤èµ„æºï¼Œç„¶åå®¢æˆ·ç«¯æŠŠç›¸åº”çš„æ•°æ®å±•ç¤ºå‡ºæ¥/æäº¤åˆ°æœåŠ¡å™¨ã€‚</p>
<a id="more"></a>
<h2 id="å®¢æˆ·ç«¯å››ç§æˆæƒæ¨¡å¼">å®¢æˆ·ç«¯å››ç§æˆæƒæ¨¡å¼</h2>
<h3 id="Authorization-codeï¼ˆæˆæƒç æ¨¡å¼ï¼‰">Authorization codeï¼ˆæˆæƒç æ¨¡å¼ï¼‰</h3>
<p>æ ‡å‡†çš„ Server æˆæƒæ¨¡å¼ï¼Œéå¸¸é€‚åˆ Server ç«¯çš„ Web åº”ç”¨ã€‚ä¸€æ—¦èµ„æºçš„æ‹¥æœ‰è€…æˆæƒè®¿é—®ä»–ä»¬çš„æ•°æ®ä¹‹åï¼Œä»–ä»¬å°†ä¼šè¢«é‡å®šå‘åˆ° Web åº”ç”¨å¹¶åœ¨ URL çš„æŸ¥è¯¢å‚æ•°ä¸­é™„å¸¦ä¸€ä¸ªæˆæƒç ï¼ˆcodeï¼‰ã€‚åœ¨å®¢æˆ·ç«¯é‡Œï¼Œè¯¥ code ç”¨äºè¯·æ±‚è®¿é—®ä»¤ç‰Œï¼ˆaccess_tokenï¼‰ã€‚å¹¶ä¸”è¯¥ä»¤ç‰Œäº¤æ¢çš„è¿‡ç¨‹æ˜¯ä¸¤ä¸ªæœåŠ¡ç«¯ä¹‹å‰å®Œæˆçš„ï¼Œé˜²æ­¢å…¶ä»–äººç”šè‡³æ˜¯èµ„æºæ‹¥æœ‰è€…æœ¬äººå¾—åˆ°è¯¥ä»¤ç‰Œã€‚å¦å¤–ï¼Œåœ¨è¯¥æˆæƒæ¨¡å¼ä¸‹å¯ä»¥é€šè¿‡ refresh_token æ¥åˆ·æ–°ä»¤ç‰Œä»¥å»¶é•¿è®¿é—®æˆæƒæ—¶é—´ï¼Œä¹Ÿæ˜¯æœ€ä¸ºå¤æ‚çš„ä¸€ç§æ–¹å¼ã€‚</p>
<p>1ã€ç¬¬ä¸‰æ–¹åº”ç”¨å‘æˆæƒç«¯ç‚¹URI</p>
<p>GET <a href="https://b.com/oauth/authorize" target="_blank" rel="noopener">https://b.com/oauth/authorize</a>?<br>
response_type=code&amp;			// è¡¨ç¤ºæˆæƒç æ¨¡å¼<br>
client_id=CLIENT_ID&amp;		        // è¡¨ç¤ºå®¢æˆ·ç«¯id<br>
redirect_uri=CALLBACK_URL&amp;	        // æˆæƒåè·³è½¬çš„url<br>
scope=read&amp;							// è¦æ±‚çš„æˆæƒèŒƒå›´<br>
state=state							// æ¨èçš„ã€‚ä¸€ä¸ªä¸é€æ˜çš„å€¼ç”¨äºç»´æŠ¤è¯·æ±‚å’Œå›è°ƒä¹‹é—´çš„çŠ¶æ€ã€‚æˆæƒæœåŠ¡å™¨åœ¨å°†ç”¨æˆ·ä»£ç†é‡å®šå‘ä¼šå®¢æˆ·ç«¯çš„æ—¶å€™ä¼šå¸¦ä¸Šè¯¥å‚æ•°ã€‚<br>
2ã€è¿”å›æˆæƒç </p>
<p><a href="https://a.com/callback?code=AUTHORIZATION_CODE" target="_blank" rel="noopener">https://a.com/callback?code=AUTHORIZATION_CODE</a><br>
3ã€POST è¯·æ±‚ä»¤ç‰Œï¼Œå‘ä»¤ç‰Œç«¯ç‚¹å‘å‡ºè¯·æ±‚</p>
<p>POST <a href="https://b.com/oauth/token" target="_blank" rel="noopener">https://b.com/oauth/token</a>?<br>
client_id=CLIENT_ID&amp;<br>
client_secret=CLIENT_SECRET&amp;<br>
grant_type=authorization_code&amp;<br>
code=AUTHORIZATION_CODE&amp;<br>
redirect_uri=CALLBACK_URL<br>
4ã€éªŒè¯é€šè¿‡åè¿”å›ä»¤ç‰Œ</p>
<p>{<br>
â€œaccess_tokenâ€:â€œACCESS_TOKENâ€,<br>
â€œtoken_typeâ€:â€œbearerâ€,<br>
â€œexpires_inâ€:2592000,<br>
â€œrefresh_tokenâ€:â€œREFRESH_TOKENâ€,<br>
â€œscopeâ€:â€œreadâ€,<br>
â€œuidâ€:100101,<br>
â€œinfoâ€:{â€¦}<br>
}</p>
<h3 id="Implicit-Grantï¼ˆéšå¼æ¨¡å¼ï¼‰">Implicit Grantï¼ˆéšå¼æ¨¡å¼ï¼‰</h3>
<p>è¯¥æ¨¡å¼æ˜¯æ‰€æœ‰æˆæƒæ¨¡å¼ä¸­æœ€ç®€å•çš„ä¸€ç§ï¼Œå¹¶ä¸ºè¿è¡Œäºæµè§ˆå™¨ä¸­çš„è„šæœ¬åº”ç”¨åšäº†ä¼˜åŒ–ã€‚å½“ç”¨æˆ·è®¿é—®è¯¥åº”ç”¨æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šç«‹å³ç”Ÿæˆä¸€ä¸ªæ–°çš„è®¿é—®ä»¤ç‰Œï¼ˆaccess_tokenï¼‰å¹¶é€šè¿‡URLçš„#hashæ®µä¼ å›å®¢æˆ·ç«¯ã€‚è¿™æ—¶ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥åˆ©ç”¨JavaScriptç­‰å°†å…¶å–å‡ºç„¶åè¯·æ±‚APIæ¥å£ã€‚è¯¥æ¨¡å¼ä¸éœ€è¦æˆæƒç ï¼ˆcodeï¼‰ï¼Œå½“ç„¶ä¹Ÿä¸ä¼šæä¾›refresh tokenä»¥è·å¾—é•¿æœŸè®¿é—®çš„å…¥å£ã€‚</p>
<p><a href="https://b.com/oauth/authorize" target="_blank" rel="noopener">https://b.com/oauth/authorize</a>?<br>
response_type=token&amp;<br>
client_id=CLIENT_ID&amp;<br>
redirect_uri=CALLBACK_URL&amp;<br>
scope=read<br>
ç”¨æˆ·è®¤è¯åï¼Œç›´æ¥è¿”å›ä»¤ç‰Œ</p>
<p><a href="https://a.com/callback#token=ACCESS_TOKEN" target="_blank" rel="noopener">https://a.com/callback#token=ACCESS_TOKEN</a></p>
<h3 id="Resource-Owner-Password-Credentialsï¼ˆå¯†ç æ¨¡å¼ï¼‰">Resource Owner Password Credentialsï¼ˆå¯†ç æ¨¡å¼ï¼‰</h3>
<p>è‡ªå·±æœ‰ä¸€å¥—ç”¨æˆ·ä½“ç³»ï¼Œè¿™ç§æ¨¡å¼è¦æ±‚ç”¨æˆ·æä¾›ç”¨æˆ·åå’Œå¯†ç æ¥äº¤æ¢è®¿é—®ä»¤ç‰Œï¼ˆaccess_tokenï¼‰ã€‚è¯¥æ¨¡å¼ä»…ç”¨äºéå¸¸å€¼å¾—ä¿¡ä»»çš„ç”¨æˆ·ï¼Œä¾‹å¦‚APIæä¾›è€…æœ¬äººæ‰€å†™çš„ç§»åŠ¨åº”ç”¨ã€‚è™½ç„¶ç”¨æˆ·ä¹Ÿè¦æ±‚æä¾›å¯†ç ï¼Œä½†å¹¶ä¸éœ€è¦å­˜å‚¨åœ¨è®¾å¤‡ä¸Šã€‚å› ä¸ºåˆå§‹éªŒè¯ä¹‹åï¼Œåªéœ€å°† OAuth çš„ä»¤ç‰Œè®°å½•ä¸‹æ¥å³å¯ã€‚å¦‚æœç”¨æˆ·å¸Œæœ›å–æ¶ˆæˆæƒï¼Œå› ä¸ºå…¶çœŸå®å¯†ç å¹¶æ²¡æœ‰è¢«è®°å½•ï¼Œå› æ­¤æ— éœ€ä¿®æ”¹å¯†ç å°±å¯ä»¥ç«‹å³å–æ¶ˆæˆæƒã€‚tokenæœ¬èº«ä¹Ÿåªæ˜¯å¾—åˆ°æœ‰é™çš„æˆæƒï¼Œå› æ­¤ç›¸æ¯”æœ€ä¼ ç»Ÿçš„ username/password æˆæƒï¼Œè¯¥æ¨¡å¼ä¾ç„¶æ›´ä¸ºå®‰å…¨ã€‚</p>
<p>1ã€å®¢æˆ·ç«¯ç›´æ¥è·å–ç”¨æˆ·åœ¨èµ„æºæœåŠ¡å™¨çš„è´¦å·å¯†ç ï¼Œç„¶åå‘è®¤è¯æœåŠ¡å™¨è·å–ä»¤ç‰Œ</p>
<p><a href="https://oauth.b.com/token" target="_blank" rel="noopener">https://oauth.b.com/token</a>?<br>
grant_type=password&amp;<br>
username=USERNAME&amp;<br>
password=PASSWORD&amp;<br>
client_id=CLIENT_ID<br>
POST /token HTTP/1.1<br>
Host: <a href="http://server.example.com" target="_blank" rel="noopener">server.example.com</a><br>
Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW<br>
Content-Type: application/x-www-form-urlencoded</p>
<p>grant_type=password&amp;username=johndoe&amp;password=A3ddj3w</p>
<h3 id="Client-Credentialsï¼ˆå®¢æˆ·ç«¯æ¨¡å¼ï¼‰">Client Credentialsï¼ˆå®¢æˆ·ç«¯æ¨¡å¼ï¼‰</h3>
<p>æ²¡æœ‰ç”¨æˆ·çš„æ¦‚å¿µï¼Œä¸€ç§åŸºäº APP çš„å¯†é’¥ç›´æ¥è¿›è¡Œæˆæƒï¼Œå› æ­¤ APP çš„æƒé™éå¸¸å¤§ã€‚å®ƒé€‚åˆåƒæ•°æ®åº“æˆ–å­˜å‚¨æœåŠ¡å™¨è¿™ç§å¯¹ API çš„è®¿é—®éœ€æ±‚ã€‚</p>
<p><a href="https://oauth.b.com/token" target="_blank" rel="noopener">https://oauth.b.com/token</a>?<br>
grant_type=client_credentials&amp;<br>
client_id=CLIENT_ID&amp;<br>
client_secret=CLIENT_SECRET<br>
ä¸€æ¬ client_id å’Œ client_secret åŠ å¯†ä½œä¸ºè¯·æ±‚å¤´ä¼ è¾“</p>
<p>POST /token HTTP/1.1<br>
Host: <a href="http://server.example.com" target="_blank" rel="noopener">server.example.com</a><br>
Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW<br>
Content-Type: application/x-www-form-urlencoded</p>
<p>grant_type=client_credentials</p>
<h2 id="Tips">Tips</h2>
<p>ç®€å•è¯´ä¸‹spring security oauth2çš„è®¤è¯æ€è·¯ã€‚</p>
<p>clientæ¨¡å¼ï¼Œæ²¡æœ‰ç”¨æˆ·çš„æ¦‚å¿µï¼Œç›´æ¥ä¸è®¤è¯æœåŠ¡å™¨äº¤äº’ï¼Œç”¨é…ç½®ä¸­çš„å®¢æˆ·ç«¯ä¿¡æ¯å»ç”³è¯·accessTokenï¼Œå®¢æˆ·ç«¯æœ‰è‡ªå·±çš„client_id,client_secretå¯¹åº”äºç”¨æˆ·çš„username,passwordï¼Œè€Œå®¢æˆ·ç«¯ä¹Ÿæ‹¥æœ‰è‡ªå·±çš„authoritiesï¼Œå½“é‡‡å–clientæ¨¡å¼è®¤è¯æ—¶ï¼Œå¯¹åº”çš„æƒé™ä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯è‡ªå·±çš„authoritiesã€‚<br>
passwordæ¨¡å¼ï¼Œè‡ªå·±æœ¬èº«æœ‰ä¸€å¥—ç”¨æˆ·ä½“ç³»ï¼Œåœ¨è®¤è¯æ—¶éœ€è¦å¸¦ä¸Šè‡ªå·±çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œä»¥åŠå®¢æˆ·ç«¯çš„client_id,client_secretã€‚æ­¤æ—¶ï¼ŒaccessTokenæ‰€åŒ…å«çš„æƒé™æ˜¯ç”¨æˆ·æœ¬èº«çš„æƒé™ï¼Œè€Œä¸æ˜¯å®¢æˆ·ç«¯çš„æƒé™ã€‚<br>
æˆ‘å¯¹äºä¸¤ç§æ¨¡å¼çš„ç†è§£ä¾¿æ˜¯ï¼Œå¦‚æœä½ çš„ç³»ç»Ÿå·²ç»æœ‰äº†ä¸€å¥—ç”¨æˆ·ä½“ç³»ï¼Œæ¯ä¸ªç”¨æˆ·ä¹Ÿæœ‰äº†ä¸€å®šçš„æƒé™ï¼Œå¯ä»¥é‡‡ç”¨passwordæ¨¡å¼ï¼›å¦‚æœä»…ä»…æ˜¯æ¥å£çš„å¯¹æ¥ï¼Œä¸è€ƒè™‘ç”¨æˆ·ï¼Œåˆ™å¯ä»¥ä½¿ç”¨clientæ¨¡å¼ã€‚</p>
]]></content>
      <categories>
        <category>SpringCloud - OAuth2</category>
      </categories>
      <tags>
        <tag>OAuth2</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud Maven Module</title>
    <url>/2020/04/09/maven-module/</url>
    <content><![CDATA[<h2 id="é¡¹ç›®æ¨¡å—è¯´æ˜">é¡¹ç›®æ¨¡å—è¯´æ˜</h2>
<ul>
<li>microservice          --çˆ¶é¡¹ç›®ï¼Œå…¬å…±ä¾èµ–
<ul>
<li>sysadmin          --å­æ¨¡å—ï¼Œåå°adminé¡¹ç›®</li>
<li>common            --å­æ¨¡å—ï¼Œå…¬å…±æ¨¡å—</li>
<li>api               --å­æ¨¡å—ï¼Œç§»åŠ¨Api</li>
<li>auth              --å­æ¨¡å—ï¼ŒOAuth2é‰´æƒ
<ul>
<li>authorization-server              --æˆæƒæ¨¡å—</li>
<li>authorization-resource            --èµ„æºæ¨¡å—</li>
</ul>
</li>
</ul>
</li>
</ul>
<a id="more"></a>
<h2 id="pom-xml">pom.xml</h2>
<p>æœ€å¤–å±‚çˆ¶module</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;project xmlns=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">         xsi:schemaLocation=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">   &lt;!-- &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;com.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;micro-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">        &lt;relativePath /&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">--&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.2.2.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;relativePath/&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;packaging&gt;pom&lt;/packaging&gt;</span><br><span class="line">    &lt;groupId&gt;com.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;microservice&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;name&gt;microservice&lt;/name&gt;</span><br><span class="line">    &lt;description&gt;Demo project for Spring Cloud&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class="line">        &lt;spring-cloud.version&gt;Hoxton.SR1&lt;/spring-cloud.version&gt;</span><br><span class="line">        &lt;swagger.version&gt;2.9.2&lt;/swagger.version&gt;</span><br><span class="line">        &lt;spring-boot-version&gt;2.2.2.RELEASE&lt;/spring-boot-version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;!--çƒ­åŠ è½½--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">            &lt;optional&gt;true&lt;/optional&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!--alibaba fastjson --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.2.62&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!--lombok--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">            &lt;optional&gt;true&lt;/optional&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!--Swagger2 - RESTful APIæ–‡æ¡£--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;io.springfox&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;swagger.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;io.springfox&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;swagger.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!--nacosæœåŠ¡ä¸­å¿ƒ--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;0.9.0.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!--æµ‹è¯•--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">            &lt;exclusions&gt;</span><br><span class="line">                &lt;exclusion&gt;</span><br><span class="line">                    &lt;groupId&gt;org.junit.vintage&lt;/groupId&gt;</span><br><span class="line">                    &lt;artifactId&gt;junit-vintage-engine&lt;/artifactId&gt;</span><br><span class="line">                &lt;/exclusion&gt;</span><br><span class="line">            &lt;/exclusions&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;modules&gt;</span><br><span class="line">        &lt;module&gt;common&lt;/module&gt;</span><br><span class="line">        &lt;module&gt;sysadmin&lt;/module&gt;</span><br><span class="line">        &lt;module&gt;auth&lt;/module&gt;</span><br><span class="line">        &lt;module&gt;api&lt;/module&gt;</span><br><span class="line">        &lt;module&gt;authorization&lt;/module&gt;</span><br><span class="line">    &lt;/modules&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>
<p>common module pom.xml</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;project xmlns=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">         xsi:schemaLocation=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;com.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;microservice&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">        &lt;!--&lt;relativePath&gt;../&lt;/relativePath&gt;--&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;groupId&gt;com.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;common&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line">    &lt;name&gt;common&lt;/name&gt;</span><br><span class="line">    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;!--web--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!--redis--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.2.3.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!--rabbitmq--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-security-core&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>
<p>authä½œä¸ºå­module,å…¶ä¸‹åˆæœ‰ä¸¤ä¸ªå­module,auth module pom</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;project xmlns=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">         xsi:schemaLocation=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">   &lt;!-- &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;com.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;micro-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">        &lt;relativePath /&gt;</span><br><span class="line">    &lt;/parent&gt;--&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;com.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;microservice&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">       &lt;!-- &lt;relativePath&gt;../&lt;/relativePath&gt;--&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    &lt;groupId&gt;com.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;auth&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;name&gt;auth&lt;/name&gt;</span><br><span class="line">    &lt;packaging&gt;pom&lt;/packaging&gt;</span><br><span class="line">    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;!--commonå…¬å…±æœåŠ¡ä¸­å¿ƒ--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;common&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.security.oauth&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-security-oauth2&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.3.8.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--oauth2æˆæƒæœåŠ¡--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.security.oauth.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-security-oauth2-autoconfigure&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.2.3.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- https:<span class="comment">//mvnrepository.com/artifact/org.springframework.security/spring-security-jwt --&gt;</span></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-security-jwt&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.1.0.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- https:<span class="comment">//mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-starter-openfeign --&gt;</span></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.2.2.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>
<p>authorization-server module pom</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;project xmlns=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span><br><span class="line">         xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">         xsi:schemaLocation=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;com.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;auth&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">       &lt;!-- &lt;relativePath&gt;../&lt;/relativePath&gt;--&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    &lt;groupId&gt;com.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;authorization-server&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.9.10.1&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;compile&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- mysql --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;5.1.47&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!--jpa--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.2.2.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>
<p>authorization-resource module pom</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;project xmlns=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span><br><span class="line">         xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">         xsi:schemaLocation=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;com.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;auth&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">        &lt;!--&lt;relativePath&gt;../&lt;/relativePath&gt;--&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    &lt;groupId&gt;com.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;authorization-resource&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;!-- mysql --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;5.1.47&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>
<p>sysadmin module pom</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;project xmlns=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> xmlns:xsi=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="line">         xsi:schemaLocation=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;com.cloud&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;microservice&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">        &lt;!--&lt;relativePath&gt;../&lt;/relativePath&gt;--&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    &lt;groupId&gt;com.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;sysadmin&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;packaging&gt;jar&lt;/packaging&gt;</span><br><span class="line">    &lt;name&gt;sysadmin&lt;/name&gt;</span><br><span class="line">    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;common&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!--web--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- mysql --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;5.1.47&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- security --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- https:<span class="comment">//mvnrepository.com/artifact/cn.hutool/hutool-core --&gt;</span></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;cn.hutool&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;hutool-core&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;5.2.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!--jpa--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.2.2.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- test --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;!-- Gson https:<span class="comment">//mvnrepository.com/artifact/com.google.code.gson/gson --&gt;</span></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.google.code.gson&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;gson&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.8.6&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.assertj&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;assertj-core&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Maven</category>
      </categories>
      <tags>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>Mysql cannot allocate memory for the buffer pool è§£å†³æ–¹æ³•</title>
    <url>/2020/03/30/mysql%E5%86%85%E5%AD%98%E4%B8%8D%E8%B6%B3/</url>
    <content><![CDATA[<h2 id="å¼‚å¸¸">å¼‚å¸¸</h2>
<p><img src="/images/mysql.png" alt=""></p>
<h2 id="åŸå› ">åŸå› </h2>
<p>å†…å­˜ä¸è¶³</p>
<a id="more"></a>
<h2 id="è§£å†³åŠæ³•">è§£å†³åŠæ³•</h2>
<p>mysqlçš„é…ç½®éƒ½åœ¨/ect/mysql.cnfé‡Œé¢ï¼ˆUbuntuç›®å½•æœ‰ç¨å¾®çš„å·®åˆ«ï¼Œç”¨whereis my.cnfå°±èƒ½æ‰¾åˆ°äº†ï¼‰ã€‚<br>
<code>vim /etc/my.cnf</code><br>
<code>#innodb_buffer_pool_size = 128M</code><br>
è¿™é‡Œæ˜¾ç¤ºé»˜è®¤é…ç½®æ˜¯128Mï¼Œæ˜¯æ³¨é‡ŠçŠ¶æ€ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠæ³¨é‡Šå»æ‰ï¼ŒæŠŠ128æ”¹å°ä¸€ç‚¹ï¼ˆæ ¹æ®ä¸ªäººæƒ…å†µä¿®æ”¹ï¼‰ï¼Œæˆ‘æ”¹ä¸ºï¼š<br>
<code>innodb_buffer_pool_size = 50M</code></p>
<h2 id="è¿›ä¸€æ­¥ä¼˜åŒ–">è¿›ä¸€æ­¥ä¼˜åŒ–</h2>
<p>ä¸€èˆ¬å‡ºç°è¿™ç§é—®é¢˜çš„åŒå­¦ï¼Œå†…å­˜è‚¯å®šéƒ½ä¸å¤§ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¾ç½®swapåˆ†åŒºï¼Œä¹Ÿå°±æ˜¯é€šå¸¸æ‰€è¯´çš„è™šæ‹Ÿå†…å­˜ã€‚<br>
swapçš„ä½œç”¨å…·ä½“è¿™é‡Œå°±ä¸åšè¯´æ˜äº†ï¼Œç®€å•ç‚¹è¯´å°±æ˜¯å¯ä»¥è¾…åŠ©Memå†…å­˜ã€‚<br>
ç›´æ¥ä¸Šä»£ç ï¼š</p>
<p><code>dd if=/dev/zero of=/swapfile bs=1M count=1024</code><br>
<code>mkswap /swapfile</code><br>
<code>swapon /swapfile</code></p>
<p>æœ€åæ·»åŠ ä»£ç /swapfile swap swap defaults 0 0åˆ°/etc/fstabæ–‡ä»¶é‡Œé¢ã€‚<br>
ç„¶åå‘½ä»¤<code>free</code>ä¸€ä¸‹ï¼Œèƒ½çœ‹åˆ°Memå’Œswapä¿¡æ¯å°±è¯´æ˜æˆåŠŸäº†ã€‚<br>
æœ€åé‡å¯mysqlå°±å¯ä»¥äº†ã€‚</p>
]]></content>
      <categories>
        <category>Mysql</category>
      </categories>
      <tags>
        <tag>Mysql</tag>
      </tags>
  </entry>
  <entry>
    <title>dockeré•œåƒä¸‹è½½</title>
    <url>/2020/03/26/docker%E9%95%9C%E5%83%8F%E4%B8%8B%E8%BD%BD/</url>
    <content><![CDATA[<h2 id="é•œåƒä¸‹è½½é€Ÿåº¦æ…¢ï¼Ÿ">é•œåƒä¸‹è½½é€Ÿåº¦æ…¢ï¼Ÿ</h2>
<p>å…·ä½“è§£å†³åŠæ³•å°±æ˜¯ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒåŠ é€Ÿå™¨ï¼Œè¯¦æƒ…è¯·å‚è€ƒ<a href="https://blog.csdn.net/liu865033503/article/details/95936640" target="_blank" rel="noopener">Docker pullæ…¢ï¼Œæ— æ³•pullé—®é¢˜è§£å†³(æ›´æ”¹é•œåƒæºä¸ºé˜¿é‡Œäº‘å›½å†…é•œåƒ)</a>.<br>
ä½†æ˜¯æŒ‰ç…§é…ç½®å¥½é˜¿é‡Œäº‘é•œåƒåé‡å¯dockerå´æŠ¥é”™ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<a id="more"></a>
<p><img src="/images/docker.png" alt=""><br>
æŸ¥é˜…èµ„æ–™åï¼ŒåŸæ¥æ˜¯å¦‚æœæ˜¯é…ç½®äº†å›½å†…é•œåƒï¼Œå¹¶ä¸”é•œåƒæ–‡ä»¶ä¸º/etc/docker/daemon.jsonï¼Œåˆ™ä¿®æ”¹æ–‡ä»¶åç¼€ä¸º.confå³å¯æ­£å¸¸å¯åŠ¨docker æœåŠ¡ã€‚</p>
<h2 id="å¼€å‘å¸¸ç”¨é•œåƒå®¹å™¨å®‰è£…">å¼€å‘å¸¸ç”¨é•œåƒå®¹å™¨å®‰è£…</h2>
<ul>
<li>Java<br>
<code>docker pull java</code></li>
<li>Mysql<br>
æ‹‰å–é•œåƒï¼ˆæŒ‡å®š5.7ç‰ˆæœ¬ï¼‰<br>
<code>docker pull mysql:5.7</code><br>
å¯åŠ¨å®¹å™¨<br>
<code>docker run --restart=always -p 3306:3306 --name mysql -v /data/apps/db:/var/lib/mysql  -d mysql:5.7</code></li>
<li>Redis<br>
æ‹‰å–é•œåƒ<br>
<code>docker pull redis</code><br>
å¯åŠ¨å®¹å™¨<br>
<code>docker run --restart=always -v /etc/redis.conf:/etc/redis.conf --name redis redis redis-server /etc/redis.conf</code></li>
<li>JenKins<br>
æ‹‰å–é•œåƒ<br>
<code>docker pull jenkins</code><br>
æŸ¥çœ‹é•œåƒ<br>
<code>docker images</code><br>
åˆ›å»ºjenkinsæ•°æ®æ–‡ä»¶<br>
<code>mkdir /home/jenkins_home</code><br>
èµ‹äºˆæƒé™<br>
<code>chmod 777 /home/jenkins_home </code><br>
å¯åŠ¨å®¹å™¨<br>
<code>docker run -d --name jenkins -p 8002:8080 -p 50000:50000 -v /home/jenkins_home:/home/jenkins_home</code></li>
<li>Nacos<br>
æ‹‰å–é•œåƒï¼ˆæŒ‡å®šç‰ˆæœ¬1.1.4ï¼‰<br>
<code>docker pull nacos/nacos-server:1.1.4</code><br>
å¯åŠ¨å®¹å™¨<br>
<code>docker run --env MODE=standalone --name nacos -d -p 8848:8848 nacos/nacos-server:1.1.4</code></li>
</ul>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>vue</title>
    <url>/2020/03/20/vue/</url>
    <content><![CDATA[<h2 id="Vueé¡¹ç›®ç›®å½•åˆå§‹åŒ–">Vueé¡¹ç›®ç›®å½•åˆå§‹åŒ–</h2>
<p><a href="https://zhuanlan.zhihu.com/p/34898485" target="_blank" rel="noopener">å‚è€ƒé“¾æ¥</a></p>
]]></content>
      <categories>
        <category>Vue</category>
      </categories>
      <tags>
        <tag>Vue</tag>
      </tags>
  </entry>
  <entry>
    <title>å³æ—¶é€šè®¯IM</title>
    <url>/2020/03/19/tecent-im/</url>
    <content><![CDATA[<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>
<p>æœ€è¿‘åœ¨åšä¸€æ¬¾ç›´æ’­app,æ¶‰åŠåˆ°äº†IMé€šè®¯ï¼Œå®ç°ç›´æ’­ç¾¤ç»„èŠå¤©ï¼ŒIMæ³¨å†Œã€ç™»å½•ï¼Œæ”¹æ¢å¤´åƒã€æ˜µç§°ç­‰ã€‚ç”¨çš„æ˜¯è…¾è®¯IMã€‚</p>
<h2 id="Apiè°ƒç”¨">Apiè°ƒç”¨</h2>
<h3 id="å‡†å¤‡å·¥ä½œ">å‡†å¤‡å·¥ä½œ</h3>
<p>æœåŠ¡ç«¯éœ€è®°å½•è…¾è®¯IMæ§åˆ¶å°é‡Œçš„sdk app idåŠåº”ç”¨çš„å¯†é’¥</p>
<a id="more"></a>
<h3 id="ä»£ç ">ä»£ç </h3>
<p>Constant.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Constant</span> </span>&#123;</span><br><span class="line">    <span class="comment">//IMé€šè®¯sdkappid    å¯†é’¥</span></span><br><span class="line">    public static final Integer SDK_APPID = ######;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY = <span class="string">"#######################################3"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String IDENTIFIER = <span class="string">"admin"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TimService.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span>(<span class="string">"timService"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(TimService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HOST = <span class="string">"https://console.tim.qq.com"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SysLog</span>(<span class="string">"å•è´¦å·å¯¼å…¥"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProcessResult <span class="title">accountImport</span><span class="params">(String Identifier)</span> </span>&#123;</span><br><span class="line">        String userSig = getUserSig();</span><br><span class="line">        String url = formatUrl(<span class="string">"im_open_login_svc"</span>, <span class="string">"account_import"</span>, userSig);</span><br><span class="line">        Map jsonObj = Collections.singletonMap(<span class="string">"Identifier"</span>,Identifier);</span><br><span class="line">        HttpEntity&lt;String&gt; formEntity = <span class="keyword">new</span> HttpEntity&lt;String&gt;(JsonUtil.toJSON(jsonObj));</span><br><span class="line">        Map&lt;String, String&gt; result = restTemplate.postForObject(url, formEntity, Map<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"OK"</span>.equalsIgnoreCase(result.get(<span class="string">"ActionStatus"</span>))) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ProcessResult(ProcessResult.SUCCESS,<span class="string">"single account import success"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ProcessResult(ProcessResult.ERROR,<span class="string">"single account import failure"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SysLog</span>(<span class="string">"åˆ›å»ºç¾¤ç»„"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">createGroup</span><span class="params">(GoVideo goVideo)</span> </span>&#123;</span><br><span class="line">        String userSig = getUserSig();</span><br><span class="line">        String url = formatUrl(<span class="string">"group_open_http_svc"</span>, <span class="string">"create_group"</span>, userSig);</span><br><span class="line">        Map&lt;String, Object&gt; jsonObj = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">//jsonObj.put("Owner_Account",username);ç¾¤ä¸»çš„userId  å¾…åæœŸæ‰©å±•</span></span><br><span class="line">        jsonObj.put(<span class="string">"Type"</span>,<span class="string">"AVChatRoom"</span>);<span class="comment">//éŸ³è§†é¢‘èŠå¤©å®¤</span></span><br><span class="line">        jsonObj.put(<span class="string">"Name"</span>,<span class="string">"Group-"</span>+goVideo.getId());</span><br><span class="line">        jsonObj.put(<span class="string">"GroupId"</span>,<span class="string">"live-"</span>+goVideo.getId());</span><br><span class="line">        HttpEntity&lt;String&gt; formEntity = <span class="keyword">new</span> HttpEntity&lt;String&gt;(JsonUtil.toJSON(jsonObj));</span><br><span class="line">        Map&lt;String, String&gt; result = restTemplate.postForObject(url, formEntity, Map<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">return</span> result.get(<span class="string">"ActionStatus"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SysLog</span>(<span class="string">"APPè‡ªå®šä¹‰è„å­—"</span>)</span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/addDirtyWOrd"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProcessResult <span class="title">addDirtyWord</span><span class="params">(@RequestBody String jsonString)</span> </span>&#123;</span><br><span class="line">        Map jsonObj = JsonUtil.fromJSON(jsonString, Map<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        String userSig = getUserSig();</span><br><span class="line">        String url = formatUrl(<span class="string">"openim_dirty_words"</span>, <span class="string">"add"</span>, userSig);</span><br><span class="line">        HttpEntity&lt;String&gt; formEntity = <span class="keyword">new</span> HttpEntity&lt;String&gt;(JsonUtil.toJSON(jsonObj));</span><br><span class="line">        Map&lt;String, String&gt; rowData = restTemplate.postForObject(url, formEntity, Map<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        String actionStatus = rowData.get(<span class="string">"ActionStatus"</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">"OK"</span>.equalsIgnoreCase(actionStatus)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ProcessResult(ProcessResult.SUCCESS,<span class="string">"add dirty word success"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ProcessResult(ProcessResult.ERROR,<span class="string">"add dirty word failure :: "</span> + JsonUtil.toJSON(rowData));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SysLog</span>(<span class="string">"è§£æ•£ç¾¤ç»„"</span>)</span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/destroyGroup"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">destroyGroup</span><span class="params">(GoVideo goVideo)</span> </span>&#123;</span><br><span class="line">        Map&lt;String,Object&gt; jsonObj = <span class="keyword">new</span> HashMap();</span><br><span class="line">        jsonObj.put(<span class="string">"GroupId"</span>,goVideo.getGroupId());</span><br><span class="line">        String userSig = getUserSig();</span><br><span class="line">        String url = formatUrl(<span class="string">"group_open_http_svc"</span>, <span class="string">"destroy_group"</span>, userSig);</span><br><span class="line">        HttpEntity&lt;String&gt; formEntity = <span class="keyword">new</span> HttpEntity&lt;String&gt;(JsonUtil.toJSON(jsonObj));</span><br><span class="line">        Map&lt;String, String&gt; rowData = restTemplate.postForObject(url, formEntity, Map<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        log.info(<span class="string">"===========è§£æ•£ç¾¤ç»„================== &#123;&#125;"</span>, goVideo.getGroupId());</span><br><span class="line">        <span class="keyword">return</span> rowData.get(<span class="string">"ActionStatus"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * imæ³¨å†Œ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nickName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> faceUrl</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">registe</span><span class="params">(String uuid,String nickName,String faceUrl)</span></span>&#123;</span><br><span class="line">        String userSig = getUserSig();</span><br><span class="line">        String url = formatUrl(<span class="string">"im_open_login_svc"</span>,<span class="string">"account_import"</span>,userSig);</span><br><span class="line">        Map&lt;String,Object&gt; jsonObj = <span class="keyword">new</span> HashMap();</span><br><span class="line">        jsonObj.put(<span class="string">"Identifier"</span>,uuid);</span><br><span class="line">        jsonObj.put(<span class="string">"Nick"</span>,nickName);</span><br><span class="line">        jsonObj.put(<span class="string">"FaceUrl"</span>,faceUrl);</span><br><span class="line">        Map&lt;String, String&gt; result = restTemplate.postForObject(url, jsonObj, Map<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">return</span> result.get(<span class="string">"ActionStatus"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * imä¿®æ”¹å¤´åƒ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">updateImFaceUrl</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        String userSig = getUserSig();</span><br><span class="line">        String url = formatUrl(<span class="string">"profile"</span>, <span class="string">"portrait_set"</span>, userSig);</span><br><span class="line">        ArrayList&lt;Object&gt; profileItem = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        HashMap&lt;String, Object&gt; jsonObj = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        jsonObj.put(<span class="string">"Tag"</span>, <span class="string">"Tag_Profile_IM_Image"</span>);</span><br><span class="line">        jsonObj.put(<span class="string">"Value"</span>, user.getAvatar());</span><br><span class="line">        profileItem.add(jsonObj);</span><br><span class="line">        MapBuild&lt;String, String&gt; obj = <span class="keyword">new</span> MapBuild&lt;String, String&gt;().put(<span class="string">"From_Account"</span>,user.getUuid()).put(<span class="string">"ProfileItem"</span>, profileItem);</span><br><span class="line">        Map&lt;String, String&gt; result = restTemplate.postForObject(url, obj.build(), Map<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">return</span> result.get(<span class="string">"ActionStatus"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * imä¿®æ”¹æ˜µç§°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uuid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nickName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">updateImNick</span><span class="params">(String uuid,String nickName)</span> </span>&#123;</span><br><span class="line">        String userSig = getUserSig();</span><br><span class="line">        String url = formatUrl(<span class="string">"profile"</span>, <span class="string">"portrait_set"</span>, userSig);</span><br><span class="line">        ArrayList&lt;Object&gt; profileItem = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        HashMap&lt;String, Object&gt; jsonObj = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        jsonObj.put(<span class="string">"Tag"</span>, <span class="string">"Tag_Profile_IM_Nick"</span>);</span><br><span class="line">        jsonObj.put(<span class="string">"Value"</span>, nickName);</span><br><span class="line">        profileItem.add(jsonObj);</span><br><span class="line">        MapBuild&lt;String, String&gt; obj = <span class="keyword">new</span> MapBuild&lt;String, String&gt;().put(<span class="string">"From_Account"</span>, uuid).put(<span class="string">"ProfileItem"</span>, profileItem);</span><br><span class="line">        Map&lt;String, String&gt; result = restTemplate.postForObject(url, obj.build(), Map<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">return</span> result.get(<span class="string">"ActionStatus"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> uuid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getProfilePortrait</span><span class="params">(String uuid)</span></span>&#123;</span><br><span class="line">        String userSig = getUserSig();</span><br><span class="line">        String url = formatUrl(<span class="string">"profile"</span>,<span class="string">"portrait_get"</span>,userSig);</span><br><span class="line">        MapBuild&lt;String, String[]&gt; obj = <span class="keyword">new</span> MapBuild&lt;String, String[]&gt;().put(<span class="string">"To_Account"</span>,<span class="keyword">new</span> String[] &#123;uuid&#125;)</span><br><span class="line">                .put(<span class="string">"TagList"</span>,<span class="keyword">new</span> String[] &#123;<span class="string">"Tag_Profile_IM_Nick"</span>,<span class="string">"Tag_Profile_IM_Image"</span>&#125;);</span><br><span class="line">        Map&lt;String, String&gt; result = restTemplate.postForObject(url, obj.build(), Map<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">return</span> result.get(<span class="string">"ActionStatus"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">formatUrl</span><span class="params">(String serviceName, String cmdName, String usersig)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> rd = Math.random() * <span class="number">999_999_999</span>;</span><br><span class="line">        String url = String.format(<span class="string">"%s/v4/%s/%s?usersig=%s&amp;identifier=%s&amp;sdkappid=%s&amp;random=%d&amp;contenttype=json"</span>, HOST, serviceName, cmdName, usersig, Constant.IDENTIFIER, Constant.SDK_APPID,</span><br><span class="line">                (<span class="keyword">int</span>) rd);</span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SysLog</span>(<span class="string">"è·å–userSig"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserSig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TLSSigAPIv2 api = <span class="keyword">new</span> TLSSigAPIv2(Constant.SDK_APPID, Constant.KEY);</span><br><span class="line">        String userSig = api.genSig(Constant.IDENTIFIER , <span class="number">180</span> * <span class="number">86400</span>);</span><br><span class="line">        <span class="keyword">return</span> userSig;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>å·¥å…·ç±»TLSSigAPIv2.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xy.goone.modules.sys.util;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.net.util.Base64;</span><br><span class="line"><span class="keyword">import</span> sun.misc.BASE64Encoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.Mac;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.security.InvalidKeyException;</span><br><span class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.Deflater;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TLSSigAPIv2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> sdkappid;</span><br><span class="line">    <span class="keyword">private</span> String key;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TLSSigAPIv2</span><span class="params">(<span class="keyword">long</span> sdkappid, String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sdkappid = sdkappid;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">hmacsha256</span><span class="params">(String identifier, <span class="keyword">long</span> currTime, <span class="keyword">long</span> expire, String base64Userbuf)</span> </span>&#123;</span><br><span class="line">        String contentToBeSigned = <span class="string">"TLS.identifier:"</span> + identifier + <span class="string">"\n"</span></span><br><span class="line">                + <span class="string">"TLS.sdkappid:"</span> + sdkappid + <span class="string">"\n"</span></span><br><span class="line">                + <span class="string">"TLS.time:"</span> + currTime + <span class="string">"\n"</span></span><br><span class="line">                + <span class="string">"TLS.expire:"</span> + expire + <span class="string">"\n"</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != base64Userbuf) &#123;</span><br><span class="line">            contentToBeSigned += <span class="string">"TLS.userbuf:"</span> + base64Userbuf + <span class="string">"\n"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] byteKey = key.getBytes(<span class="string">"UTF-8"</span>);</span><br><span class="line">            Mac hmac = Mac.getInstance(<span class="string">"HmacSHA256"</span>);</span><br><span class="line">            SecretKeySpec keySpec = <span class="keyword">new</span> SecretKeySpec(byteKey, <span class="string">"HmacSHA256"</span>);</span><br><span class="line">            hmac.init(keySpec);</span><br><span class="line">            <span class="keyword">byte</span>[] byteSig = hmac.doFinal(contentToBeSigned.getBytes(<span class="string">"UTF-8"</span>));</span><br><span class="line">            <span class="comment">//return new String(Base64.encodeBase64(byteSig)).replaceAll("\\s*", "");</span></span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">new</span> BASE64Encoder().encode(byteSig)).replaceAll(<span class="string">"\\s*"</span>, <span class="string">""</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvalidKeyException  e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">genSig</span><span class="params">(String identifier, <span class="keyword">long</span> expire, <span class="keyword">byte</span>[] userbuf)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> currTime = System.currentTimeMillis()/<span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">        JSONObject sigDoc = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        sigDoc.put(<span class="string">"TLS.ver"</span>, <span class="string">"2.0"</span>);</span><br><span class="line">        sigDoc.put(<span class="string">"TLS.identifier"</span>, identifier);</span><br><span class="line">        sigDoc.put(<span class="string">"TLS.sdkappid"</span>, sdkappid);</span><br><span class="line">        sigDoc.put(<span class="string">"TLS.expire"</span>, expire);</span><br><span class="line">        sigDoc.put(<span class="string">"TLS.time"</span>, currTime);</span><br><span class="line"></span><br><span class="line">        String base64UserBuf = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != userbuf) &#123;</span><br><span class="line">            <span class="comment">//base64UserBuf = new String(Base64.encodeBase64(userbuf));</span></span><br><span class="line">            base64UserBuf = <span class="keyword">new</span> BASE64Encoder().encode(userbuf);</span><br><span class="line">            sigDoc.put(<span class="string">"TLS.userbuf"</span>, base64UserBuf);</span><br><span class="line">        &#125;</span><br><span class="line">        String sig = hmacsha256(identifier, currTime, expire, base64UserBuf);</span><br><span class="line">        <span class="keyword">if</span> (sig.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        sigDoc.put(<span class="string">"TLS.sig"</span>, sig);</span><br><span class="line">        Deflater compressor = <span class="keyword">new</span> Deflater();</span><br><span class="line">        compressor.setInput(sigDoc.toString().getBytes(Charset.forName(<span class="string">"UTF-8"</span>)));</span><br><span class="line">        compressor.finish();</span><br><span class="line">        <span class="keyword">byte</span> [] compressedBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2048</span>];</span><br><span class="line">        <span class="keyword">int</span> compressedBytesLength = compressor.deflate(compressedBytes);</span><br><span class="line">        compressor.end();</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> String(Base64URL.base64EncodeUrl(Arrays.copyOfRange(compressedBytes,</span><br><span class="line">                <span class="number">0</span>, compressedBytesLength)))).replaceAll(<span class="string">"\\s*"</span>, <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">genSig</span><span class="params">(String identifier, <span class="keyword">long</span> expire)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> genSig(identifier, expire, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">genSigWithUserBuf</span><span class="params">(String identifier, <span class="keyword">long</span> expire, <span class="keyword">byte</span>[] userbuf)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> genSig(identifier, expire, userbuf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xy.goone.tengxim;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xy.goone.common.Constant;</span><br><span class="line"><span class="keyword">import</span> com.xy.goone.common.util.MapBuild;</span><br><span class="line"><span class="keyword">import</span> com.xy.goone.modules.domain.User;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> fumei.jiang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019-08-15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImMessageService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HOST = <span class="string">"https://console.tim.qq.com"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * imæ³¨å†Œ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nickName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> faceUrl</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">registe</span><span class="params">(String uuid,String nickName,String faceUrl)</span></span>&#123;</span><br><span class="line">        String userSig = getUserSig();</span><br><span class="line">        String url = formatUrl(<span class="string">"im_open_login_svc"</span>,<span class="string">"account_import"</span>,userSig);</span><br><span class="line">        Map&lt;String,Object&gt; jsonObj = <span class="keyword">new</span> HashMap();</span><br><span class="line">        jsonObj.put(<span class="string">"Identifier"</span>,uuid);</span><br><span class="line">        jsonObj.put(<span class="string">"Nick"</span>,nickName);</span><br><span class="line">        jsonObj.put(<span class="string">"FaceUrl"</span>,faceUrl);</span><br><span class="line">        Map&lt;String, String&gt; result = restTemplate.postForObject(url, jsonObj, Map<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">return</span> result.get(<span class="string">"ActionStatus"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * imä¿®æ”¹å¤´åƒ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">updateImFaceUrl</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        String userSig = getUserSig();</span><br><span class="line">        String url = formatUrl(<span class="string">"profile"</span>, <span class="string">"portrait_set"</span>, userSig);</span><br><span class="line">        ArrayList&lt;Object&gt; profileItem = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        HashMap&lt;String, Object&gt; jsonObj = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        jsonObj.put(<span class="string">"Tag"</span>, <span class="string">"Tag_Profile_IM_Image"</span>);</span><br><span class="line">        jsonObj.put(<span class="string">"Value"</span>, user.getAvatar());</span><br><span class="line">        profileItem.add(jsonObj);</span><br><span class="line">        MapBuild&lt;String, String&gt; obj = <span class="keyword">new</span> MapBuild&lt;String, String&gt;().put(<span class="string">"From_Account"</span>,user.getUuid()).put(<span class="string">"ProfileItem"</span>, profileItem);</span><br><span class="line">        Map&lt;String, String&gt; result = restTemplate.postForObject(url, obj.build(), Map<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">return</span> result.get(<span class="string">"ActionStatus"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">updateImNick</span><span class="params">(String uuid,String nickName)</span> </span>&#123;</span><br><span class="line">        String userSig = getUserSig();</span><br><span class="line">        String url = formatUrl(<span class="string">"profile"</span>, <span class="string">"portrait_set"</span>, userSig);</span><br><span class="line">        ArrayList&lt;Object&gt; profileItem = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        HashMap&lt;String, Object&gt; jsonObj = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        jsonObj.put(<span class="string">"Tag"</span>, <span class="string">"Tag_Profile_IM_Nick"</span>);</span><br><span class="line">        jsonObj.put(<span class="string">"Value"</span>, nickName);</span><br><span class="line">        profileItem.add(jsonObj);</span><br><span class="line">        MapBuild&lt;String, String&gt; obj = <span class="keyword">new</span> MapBuild&lt;String, String&gt;().put(<span class="string">"From_Account"</span>, uuid).put(<span class="string">"ProfileItem"</span>, profileItem);</span><br><span class="line">        Map&lt;String, String&gt; result = restTemplate.postForObject(url, obj.build(), Map<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">return</span> result.get(<span class="string">"ActionStatus"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getProfilePortrait</span><span class="params">(String uuid)</span></span>&#123;</span><br><span class="line">        String userSig = getUserSig();</span><br><span class="line">        String url = formatUrl(<span class="string">"profile"</span>,<span class="string">"portrait_get"</span>,userSig);</span><br><span class="line">        MapBuild&lt;String, String[]&gt; obj = <span class="keyword">new</span> MapBuild&lt;String, String[]&gt;().put(<span class="string">"To_Account"</span>,<span class="keyword">new</span> String[] &#123;uuid&#125;)</span><br><span class="line">                .put(<span class="string">"TagList"</span>,<span class="keyword">new</span> String[] &#123;<span class="string">"Tag_Profile_IM_Nick"</span>,<span class="string">"Tag_Profile_IM_Image"</span>&#125;);</span><br><span class="line">        Map&lt;String, String&gt; result = restTemplate.postForObject(url, obj.build(), Map<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">return</span> result.get(<span class="string">"ActionStatus"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–ç”¨æˆ·ç­¾å</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserSig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TLSSigAPIv2 api = <span class="keyword">new</span> TLSSigAPIv2(Constant.SDK_APPID, Constant.KEY);</span><br><span class="line">        String userSig = api.genSig(Constant.IDENTIFIER, <span class="number">180</span> * <span class="number">86400</span>);</span><br><span class="line">        <span class="keyword">return</span> userSig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">formatUrl</span><span class="params">(String serviceName, String cmdName, String usersig)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> rd = Math.random() * <span class="number">999_999_999</span>;</span><br><span class="line">        String url = String.format(<span class="string">"%s/v4/%s/%s?usersig=%s&amp;identifier=%s&amp;sdkappid=%s&amp;random=%d&amp;contenttype=json"</span>, HOST, serviceName, cmdName, usersig, Constant.IDENTIFIER, Constant.SDK_APPID,</span><br><span class="line">                (<span class="keyword">int</span>) rd);</span><br><span class="line">        <span class="keyword">return</span> url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MapBuild.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Map.Entry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapBuild</span>&lt;<span class="title">K</span>, <span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;K, V&gt; map;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MapBuild</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MapBuild</span><span class="params">(Map&lt;K, V&gt; map)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.map = map;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> map.size();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> map.isEmpty();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsKey</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> map.containsKey(key);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> map.containsValue(value);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> map.get(key);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> MapBuild&lt;K, V&gt; <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">		map.put(key, value);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> MapBuild&lt;K, V&gt; <span class="title">put</span><span class="params">(K key, List&lt;Object&gt; value)</span> </span>&#123;</span><br><span class="line">		map.put(key, (V) value);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> MapBuild&lt;K, V&gt; <span class="title">put</span><span class="params">(K key, Integer integer)</span> </span>&#123;</span><br><span class="line">		map.put(key, (V) integer);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> MapBuild&lt;K, V&gt; <span class="title">putAll</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class="line">		map.putAll(m);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> MapBuild&lt;K, V&gt; <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		map.clear();</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Set&lt;K&gt; <span class="title">keySet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> map.keySet();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Collection&lt;V&gt; <span class="title">values</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> map.values();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> Set&lt;Entry&lt;K, V&gt;&gt; entrySet() &#123;</span><br><span class="line">		<span class="keyword">return</span> map.entrySet();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> map.equals(o);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> map.hashCode();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Map&lt;K, V&gt; <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> map;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>ç¬¬ä¸‰æ–¹</category>
      </categories>
      <tags>
        <tag>ç¬¬ä¸‰æ–¹</tag>
        <tag>è…¾è®¯IM</tag>
      </tags>
  </entry>
  <entry>
    <title>springcloud gatewayå¼‚å¸¸</title>
    <url>/2020/01/08/springcloud-gateway%E5%90%AF%E5%8A%A8%E5%BC%82%E5%B8%B8/</url>
    <content><![CDATA[<h2 id="å¼‚å¸¸">å¼‚å¸¸</h2>
<p>å¼‚å¸¸1ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Caused by: org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type <span class="string">'org.springframework.core.convert.ConversionService'</span> available: expected at least <span class="number">1</span> bean which qualifies as autowire candidate. Dependency annotations: &#123;<span class="meta">@org</span>.springframework.beans.factory.annotation.Qualifier(value=webFluxConversionService)&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>å¼‚å¸¸2ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">org.springframework.context.ApplicationContextException: Unable to start web server; nested exception is org.springframework.context.ApplicationContextException: Unable to start ServletWebServerApplicationContext due to missing ServletWebServerFactory bean.</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">## è§£å†³è¿‡ç¨‹</span><br><span class="line">åœ¨æSpringCloud GateWayæ—¶ï¼Œæ­»æ´»å¯åŠ¨ä¸èµ·æ¥ï¼Œgoogleäº†ä¸€ä¸‹ã€‚</span><br><span class="line">åŸå› 1ï¼š&#96;spring cloud gateway&#96; æ˜¯&#96;webflux&#96; é¡¹ç›®ï¼Œå¼•äº†å«æœ‰&#96;web-starter&#96;å¾—é¡¹ç›®å°±ä¼šå‡ºç°å†²çªã€‚å› ä¸º&#96;Hystrix-dashboard&#96;ä¸­å«æœ‰&#96;web-starter&#96;ï¼Œæ‰€ä»¥å‡ºç°å†²çªã€‚</span><br><span class="line">è§£å†³æ–¹å¼ï¼šå»æ‰ pom.xml ä¸­çš„ &#96;spring-boot-starter-web &#96;éƒ¨åˆ†ã€‚</span><br><span class="line">ç»“æœï¼šæ’é™¤webä¾èµ–ä¹‹åä¾æ—§ä¸å¥½ä½¿ã€‚</span><br><span class="line">åŸå› 2ï¼šwebfluxä¸mvcä¸å…¼å®¹ï¼Œå¦‚ç±»è·¯å¾„ä¸­å¼•ç”¨äº†webmvcä¼šå¯¼è‡´é¡¹ç›®å¯åŠ¨ä¸èµ·æ¥</span><br><span class="line">è§£å†³æ–¹å¼ï¼šæ‰¾åˆ°ä¾èµ–webmvcçš„jaråŒ…ï¼Œå°†webmvcæ’é™¤å³å¯</span><br><span class="line">eg:</span><br><span class="line">&#96;&#96;&#96;java</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">   &lt;groupId&gt;$&#123;project.groupId&#125;&lt;&#x2F;groupId&gt;</span><br><span class="line">   &lt;artifactId&gt;core&lt;&#x2F;artifactId&gt;</span><br><span class="line">   &lt;version&gt;$&#123;project.version&#125;&lt;&#x2F;version&gt;</span><br><span class="line">   &lt;exclusions&gt;</span><br><span class="line">        &lt;!--</span><br><span class="line">            1. webfluxä¸webmvcä¸å…¼å®¹ï¼Œå¦åˆ™ä¼šé¡¹ç›®å¯åŠ¨ä¸èµ·æ¥</span><br><span class="line">        --&gt;</span><br><span class="line">        &lt;exclusion&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-webmvc&lt;&#x2F;artifactId&gt;</span><br><span class="line">        &lt;&#x2F;exclusion&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<p>åæ¥åˆçœ‹è¯´æ˜¯springbootç‰ˆæœ¬ä¸å…¼å®¹é—®é¢˜ï¼Œä¸ç®¡äº†ï¼Œæ­»é©¬å½“æ´»é©¬åŒ»å§ï¼Œå°†æˆ‘çš„2.2.2æ”¹ä¸º2.0.5ï¼ŒæˆåŠŸäº†ï¼ï¼ï¼<br>
<a href="https://www.okcode.net/article/39299" target="_blank" rel="noopener">å‚è€ƒæ–‡ç« </a><br>
æœ€åä¿®æ”¹springbootç‰ˆæœ¬å°±å¥½äº†ï¼Œæˆ‘çš„ç”±2.2.2æ”¹ä¸º2.0.5ï¼Œå¥½åƒæ˜¯2.1ä»¥ä¸Šçš„ç‰ˆæœ¬ä¸å…¼å®¹ã€‚</p>
<p>å…³äºwebfluxä¸mvcä¸å…¼å®¹é¡¹ç›®å¯åŠ¨ä¸èµ·æ¥çš„å¼‚å¸¸ï¼Œå¦‚æœé¡¹ç›®ä¸­å­˜åœ¨äº†tomcatçš„ç”¨æ¥ï¼Œåˆ™æŠ›å‡ºçš„å¼‚å¸¸æ˜¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">org.springframework.context.ApplicationContextException: Unable to start web server; nested exception is org.springframework.context.ApplicationContextException: Unable to start ServletWebServerApplicationContext due to missing ServletWebServerFactory bean.</span><br></pre></td></tr></table></figure>
<p>è€Œå¦‚æœæ²¡æœ‰ä¾èµ–tomcatåˆ™æŠ›å‡ºçš„å¼‚å¸¸æ˜¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Caused by: org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type <span class="string">'org.springframework.core.convert.ConversionService'</span> available: expected at least <span class="number">1</span> bean which qualifies as autowire candidate. Dependency annotations: &#123;<span class="meta">@org</span>.springframework.beans.factory.annotation.Qualifier(value=webFluxConversionService)&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Javaå¼‚å¸¸</category>
      </categories>
      <tags>
        <tag>Javaå¼‚å¸¸</tag>
      </tags>
  </entry>
  <entry>
    <title>Dockerå¸¸ç”¨å‘½ä»¤</title>
    <url>/2019/12/30/Docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<h2 id="å¼€ç¯‡">å¼€ç¯‡</h2>
<p>Dockerè¶Šæ¥è¶Šå—å¤§å®¶æ¬¢è¿ï¼Œè¶Šæ¥è¶Šè¢«è¶Šå¤šçš„äººä½¿ç”¨ã€‚å€ŸåŠ©Dockerï¼Œæ‚¨å¯ä»¥ä»¥ä¸ç®¡ç†åº”ç”¨ç¨‹åºç›¸åŒçš„æ–¹å¼æ¥ç®¡ç†åŸºç¡€æ¶æ„ã€‚é€šè¿‡åˆ©ç”¨Dockerçš„æ–¹æ³•æ¥å¿«é€Ÿäº¤ä»˜ï¼Œæµ‹è¯•å’Œéƒ¨ç½²ä»£ç ï¼Œæ‚¨å¯ä»¥å¤§å¤§å‡å°‘ç¼–å†™ä»£ç å’Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œä»£ç ä¹‹é—´çš„å»¶è¿Ÿã€‚é‚£ä¹ˆï¼Œå…¶å®åœ¨linuxæœåŠ¡å™¨ä¸Šä½¿ç”¨dockeræ¥éƒ¨ç½²javaé¡¹ç›®ï¼Œå…¶å®æ˜¯éå¸¸ç®€å•çš„ã€‚è‡³äºå®ƒçš„å®‰è£…ç½‘ä¸Šä¹Ÿéƒ½æœ‰ï¼Œè¿™é‡Œæˆ‘å°±ä¸å–ç“œäº†ğŸ˜€ã€‚æˆ‘æƒ³è·Ÿå¤§å®¶è¯´çš„æ˜¯å¹³æ—¶æˆ‘ä½¿ç”¨dockerçš„å‡ æ¡å‘½ä»¤ã€‚è®°ä½è¿™å‡ æ¡å¸¸ç”¨å‘½ä»¤åŸºæœ¬å°±å¯ä»¥ç®€å•åœ°è¿ç”¨dockerå‘å¸ƒè¿è¡Œjava jaråŒ…äº†ã€‚</p>
<a id="more"></a>
<h2 id="å‡†å¤‡">å‡†å¤‡</h2>
<p>é¦–å…ˆï¼Œæˆ‘å‰è¾¹å†™åˆ°DockerfileåŠ.deploy.shè‡ªåŠ¨éƒ¨ç½²é…ç½®æ–‡ä»¶ï¼Œé™„ä¸Šæˆ‘çš„ä¸¤æ–‡é“¾æ¥<a href="https://jiangfumei.github.io/2019/11/14/docker-dockerfile/">DockerFileé…ç½®</a>å’Œ<a href="https://jiangfumei.github.io/2019/11/14/docker-deploysh/">.deploy.shéƒ¨ç½²è„šæœ¬</a>ã€‚ç„¶åä¸Šä¼ ä½ çš„jaråŒ…</p>
<h2 id="å‘½ä»¤">å‘½ä»¤</h2>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./deploy.sh xxx.jar conf/ yyy</span><br></pre></td></tr></table></figure>
<p>xxx.jarå°±æ˜¯ä½ çš„jaråŒ…åå­—ï¼Œconf/å°±æ˜¯ä½ çš„é¡¹ç›®çš„çº¿ä¸Šé…ç½®æ–‡ä»¶ï¼Œyyyå°±æ˜¯ä½ è¦éƒ¨ç½²çš„javaå®¹å™¨çš„åå­—ã€‚å…¶å®è¿™æ¡å‘½ä»¤å°±ä¼šè‡ªåŠ¨é‡å¯éƒ¨ç½²ï¼ŒåŒ…å«</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker build -t yyy</span><br></pre></td></tr></table></figure>
<p>å’Œ</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run --name yyy -p 8080:8080 -d yyy</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker logs yyy --tail 1000 -f</span><br></pre></td></tr></table></figure>
<p>â€“tail 1000æ˜¯æŸ¥çœ‹æœ€æ–°1000è¡Œçš„yyyçš„æ—¥å¿—ï¼Œå¦‚æœä½ æƒ³æŸ¥çœ‹å¸¦æœ‰ä¾‹å¦‚â€œå¯åŠ¨å®Œæˆâ€çš„logä¿¡æ¯çš„æ—¥å¿—å¯ä»¥è¿™æ ·å†™</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker logs yyy | grep 'å¯åŠ¨å®Œæˆ'</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure>
<p>åˆ—ä¸¾å‡ºè¿è¡Œä¸­çš„å®¹å™¨</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>
<p>åˆ—ä¸¾æ‰€æœ‰çš„å®¹å™¨ï¼ŒåŒ…æ‹¬è¿è¡Œå¤±è´¥çš„å®¹å™¨</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker exec -it yyy</span><br></pre></td></tr></table></figure>
<p>è¿›å…¥åå­—ä¸ºyyyçš„å®¹å™¨</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker rm -rf yyy</span><br></pre></td></tr></table></figure>
<p>ç§»é™¤åä¸ºyyyçš„å®¹å™¨</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker inspect yyy</span><br></pre></td></tr></table></figure>
<p>æ£€æŸ¥åä¸ºyyyçš„é…ç½®ä¿¡æ¯</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹é•œåƒ</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker rmi xxx</span><br></pre></td></tr></table></figure>
<p>åˆ é™¤åä¸ºxxxçš„é•œåƒ</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker start yyy</span><br></pre></td></tr></table></figure>
<p>å¯åŠ¨yyyå®¹å™¨</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker stop yyy</span><br></pre></td></tr></table></figure>
<p>åœæ­¢yyyå®¹å™¨</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker restart yyy</span><br></pre></td></tr></table></figure>
<p>é‡å¯yyyå®¹å™¨<br>
åŸºæœ¬ä¸Šæˆ‘å¸¸ç”¨çš„å‘½ä»¤å°±æ˜¯è¿™äº›ï¼Œæ¥ä¸‹æ¥å†ç»™å¤§å®¶è¯´ä¸€ä¸‹åˆ›å»ºæ¯”å¦‚redisã€mysqlç­‰å¼€å‘ç¯å¢ƒçš„å®¹å™¨çš„æ¨èå‘½ä»¤</p>
<h2 id="åˆ›å»ºå¼€å‘ç³»ç»Ÿç¯å¢ƒå‘½ä»¤">åˆ›å»ºå¼€å‘ç³»ç»Ÿç¯å¢ƒå‘½ä»¤</h2>
<p>åˆ›å»ºrediså®¹å™¨</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run  --restart=always -p 6379:6379 --name redis  -d redis:3.2 redis-server --appendonly yes</span><br></pre></td></tr></table></figure>
<p><code>--restart=always</code>æŒ‡ä¸€æ—¦å®¹å™¨æŒ‚äº†ç«‹é©¬é‡å¯ï¼Œ<code>-p 6379:6379</code>æŒ‡å°†å®¹å™¨å†…éƒ¨ä½¿ç”¨çš„ç½‘ç»œç«¯å£æ˜ å°„åˆ°æˆ‘ä»¬ä½¿ç”¨çš„ä¸»æœºä¸Šï¼ˆå¼€æˆ¿å®¹å™¨ç«¯å£å’Œé»˜è®¤æœåŠ¡ç«¯å£ï¼‰ã€‚<code>redis-server --appendonly yes</code>å¼€å¯æ°¸ä¹…åŒ–å­˜å‚¨</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run  --restart=always -p 6379:6379 --name redis -v /data/apps/redis:/var/redis  -d redis:3.2 redis-server --appendonly yes</span><br></pre></td></tr></table></figure>
<p>-væŒ‡çš„æ˜¯æŒ‚è½½ç›®å½•ï¼Œæ˜ å°„å®¿ä¸»æœºçš„ç›®å½•åˆ°å®¹å™¨ï¼Œä»¥ä¾¿å¤‡ä»½å®¹å™¨ï¼ˆå®¿ä¸»æœºå­˜å‚¨åœ¨/data/apps/redisç›®å½•ä¸‹ï¼Œå®¹å™¨å­˜å‚¨åœ¨/var/redisç›®å½•ä¸‹ï¼‰<br>
å¦‚æœæ˜¯æƒ³ç”¨æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶ï¼Œåˆ™ä½¿ç”¨ä¸‹é¢å‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run --restart=always -v /etc/redis.conf:/etc/redis.conf --name redis redis redis-server /etc/redis.conf</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºmysqlå®¹å™¨</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run --restart=always -p 3306:3306 --name mysql -v /data/apps/db:/var/lib/mysql  -d mysql:5.7</span><br></pre></td></tr></table></figure>
<p>å¤§åŠŸå‘Šæˆï¼ğŸ˜†ğŸ˜†ğŸ˜†</p>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Redisæ•°æ®åº“è¿ç§»</title>
    <url>/2019/12/27/redis%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%81%E7%A7%BB/</url>
    <content><![CDATA[<p>ä¸€æ¬¡æ­»æ´»è¿ä¸ä¸ŠæŸredisæ•°æ®åº“ï¼Œä½†æ˜¯æˆ‘åˆæƒ³æŠŠé‡Œé¢çš„æ•°æ®å¼„å‡ºæ¥ï¼Œso,ä¸‹é¢å°±åªè¯´ä¸€ä¸‹æˆ‘æ˜¯æ€ä¹ˆæŠŠredisæ•°æ®ä»192.168.10.ssè¿ç§»åˆ°192.168.1.xxxä¸Š.<br>
é¦–å…ˆæˆ‘è¦é™„ä¸Šæˆ‘çš„å‚è€ƒæ–‡ç« é“¾æ¥<a href="https://www.cnblogs.com/lina520/p/9606378.html" target="_blank" rel="noopener">redisæ•°æ®è¿ç§»</a><br>
å…¶æ¬¡ï¼Œé™„ä¸Šæˆ‘çš„å‘½ä»¤ï¼š</p>
<a id="more"></a>
<p>1.ç™»å½•192.168.1.xxxæœåŠ¡å™¨ï¼Œ<code>docker ps</code>æŸ¥çœ‹rediså®¹å™¨<br>
2.<code>docker exec -it redis bin/bash</code>(redisä¸ºrediså®¹å™¨çš„åå­—æˆ–id)<br>
3.<code>redis-cli -h 192.168.10.ss -n 0 -a å¯†ç  keys '*' | xargs -i redis-cli -h 192.168.10.ss -n 0 -a å¯†ç   migrate 192.168.1.xxx 6379 {} 5 10000</code><br>
â€œ|â€ä¹‹å‰è¡¨ç¤ºçš„æ˜¯åˆ—å‡º192.168.10.ssæœåŠ¡å™¨ä¸Šredisæ•°æ®åº“ä¸º0çš„æ‰€æœ‰key,-a å¯†ç é™„ä¸Šæƒé™ç”¨æˆ·å¯†ç ï¼Œâ€œ|â€ ä¹‹åæ„æ€æ˜¯æŠŠ192.168.10.ssä¸Šçš„redisæ•°æ®åº“ä¸º0çš„æ•°æ®è¿ç§»åˆ°192.168.1.xxxä¸Šçš„æ•°æ®åº“ä¸º5çš„redisæ•°æ®åº“ã€‚</p>
]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>springbootæ¥å…¥è‹¹æœå†…è´­</title>
    <url>/2019/12/24/iospay/</url>
    <content><![CDATA[<h1>è‹¹æœå†…è´­</h1>
<p>åœ¨ä¸Šä¸€ç¯‡ç»™å¤§å®¶æè¿°äº†googleæ”¯ä»˜çš„é›†æˆåï¼Œè‹¹æœå†…è´­ä¹Ÿæ˜¯å¿…ä¸å¯å°‘çš„ã€‚å°±æˆ‘è€Œè¨€ï¼Œæ„Ÿè§‰è‹¹æœå†…è´­æ¯”googleæ”¯ä»˜è¦ç®€å•å®¹æ˜“å¾—å¤šï¼Œå› ä¸ºè‹¹æœå†…è´­æ’¸ä»£ç å‰ä¸éœ€è¦é…ç½®å‡†å¤‡ï¼Œåªéœ€è¦åœ¨ä»£ç é‡Œé›†æˆå°±è¡Œäº†ã€‚åºŸè¯å°‘è¯´ï¼Œæ¥ä¸‹æ¥è¿˜æ˜¯åˆ†äº«ä¸€ä¸‹æˆ‘æ˜¯å¦‚ä½•é›†æˆè‹¹æœå†…è´­çš„ã€‚<br>
é¦–å…ˆéœ€è¦ä¸€ä¸ªè‹¹æœæ”¯ä»˜å·¥å…·ç±»ï¼Œè¿™é‡Œæ˜¯<code>IosVerifyUtil.java</code>:</p>
<a id="more"></a>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xy.goone.common.util.pay;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.*;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.CertificateException;</span><br><span class="line"><span class="keyword">import</span> java.security.cert.X509Certificate;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> fumei.jiang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019-08-15 18:31</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> è‹¹æœå†…è´­å·¥å…·ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IosVerifyUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TrustAnyTrustManager</span> <span class="keyword">implements</span> <span class="title">X509TrustManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkClientTrusted</span><span class="params">(X509Certificate[] chain, String authType)</span> <span class="keyword">throws</span> CertificateException </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkServerTrusted</span><span class="params">(X509Certificate[] chain, String authType)</span> <span class="keyword">throws</span> CertificateException </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> X509Certificate[] getAcceptedIssuers() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> X509Certificate[] &#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TrustAnyHostnameVerifier</span> <span class="keyword">implements</span> <span class="title">HostnameVerifier</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">verify</span><span class="params">(String hostname, SSLSession session)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String url_sandbox = <span class="string">"https://sandbox.itunes.apple.com/verifyReceipt"</span>;<span class="comment">//æ²™ç›’æµ‹è¯•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String url_verify = <span class="string">"https://buy.itunes.apple.com/verifyReceipt"</span>;<span class="comment">//æ­£å¼æµ‹è¯•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String IOS_SHARED_SECRET_PASSWORD = <span class="string">"#######################"</span>;<span class="comment">//è‹¹æœè¿ç»­è®¢é˜…å…±äº«å¯†é’¥</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è‹¹æœæœåŠ¡å™¨éªŒè¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> receipt</span></span><br><span class="line"><span class="comment">     * è´¦å•</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@url</span> è¦éªŒè¯çš„åœ°å€</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> null æˆ–è¿”å›ç»“æœ æ²™ç›’ https://sandbox.itunes.apple.com/verifyReceipt</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">buyAppVerify</span><span class="params">(String receipt,<span class="keyword">int</span> type,<span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line"><span class="comment">//ç¯å¢ƒåˆ¤æ–­ çº¿ä¸Š/å¼€å‘ç¯å¢ƒç”¨ä¸åŒçš„è¯·æ±‚é“¾æ¥</span></span><br><span class="line">        String url = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">if</span>(type==<span class="number">0</span>)&#123;</span><br><span class="line">            url = url_sandbox; <span class="comment">//æ²™ç›’æµ‹è¯•</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            url = url_verify; <span class="comment">//çº¿ä¸Šæµ‹è¯•</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            SSLContext sc = SSLContext.getInstance(<span class="string">"SSL"</span>);</span><br><span class="line">            sc.init(<span class="keyword">null</span>, <span class="keyword">new</span> TrustManager[] &#123; <span class="keyword">new</span> TrustAnyTrustManager() &#125;, <span class="keyword">new</span> java.security.SecureRandom());</span><br><span class="line">            URL console = <span class="keyword">new</span> URL(url);</span><br><span class="line">            HttpsURLConnection conn = (HttpsURLConnection) console.openConnection();</span><br><span class="line">            conn.setSSLSocketFactory(sc.getSocketFactory());</span><br><span class="line">            conn.setHostnameVerifier(<span class="keyword">new</span> TrustAnyHostnameVerifier());</span><br><span class="line">            conn.setRequestMethod(<span class="string">"POST"</span>);</span><br><span class="line">            conn.setRequestProperty(<span class="string">"content-type"</span>, <span class="string">"text/json"</span>);</span><br><span class="line">            conn.setRequestProperty(<span class="string">"Proxy-Connection"</span>, <span class="string">"Keep-Alive"</span>);</span><br><span class="line">            conn.setDoInput(<span class="keyword">true</span>);</span><br><span class="line">            conn.setDoOutput(<span class="keyword">true</span>);</span><br><span class="line">            BufferedOutputStream hurlBufOus = <span class="keyword">new</span> BufferedOutputStream(conn.getOutputStream());</span><br><span class="line">            String str = <span class="keyword">null</span>;</span><br><span class="line">           <span class="comment">/* if (status==0)&#123;//æ¶ˆè€—</span></span><br><span class="line"><span class="comment">                // æ‹¼æˆå›ºå®šçš„æ ¼å¼ä¼ ç»™å¹³å°</span></span><br><span class="line"><span class="comment">                str = String.format(Locale.CHINA, "&#123;\"receipt-data\":\"" + receipt + "\"&#125;");//æ¶ˆè€—å‹å†…è´­</span></span><br><span class="line"><span class="comment">            &#125;else if (status == 1)&#123;*/</span></span><br><span class="line">                <span class="comment">//è¿ç»­åŒ…æœˆè®¢é˜…éœ€è¦åŠ ä¸Šå…±äº«å¯†é’¥</span></span><br><span class="line">                str = String.format(Locale.CHINA, <span class="string">"&#123;\"receipt-data\":\""</span> + receipt + <span class="string">"\",\"password\":\""</span> + IOS_SHARED_SECRET_PASSWORD + <span class="string">"\"&#125;"</span>);</span><br><span class="line">            <span class="comment">//&#125;</span></span><br><span class="line">            hurlBufOus.write(str.getBytes());</span><br><span class="line">            hurlBufOus.flush();</span><br><span class="line"></span><br><span class="line">            InputStream is = conn.getInputStream();</span><br><span class="line">            BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is));</span><br><span class="line">            String line = <span class="keyword">null</span>;</span><br><span class="line">            StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                sb.append(line);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sb.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            System.out.println(<span class="string">"è‹¹æœæœåŠ¡å™¨å¼‚å¸¸"</span>);</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨BASE64åŠ å¯†</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getBASE64</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] b = str.getBytes();</span><br><span class="line">        String s = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (b != <span class="keyword">null</span>) &#123;</span><br><span class="line">            s = <span class="keyword">new</span> sun.misc.BASE64Encoder().encode(b);</span><br><span class="line">            <span class="comment">//s = new String(Base64.encodeBase64(b));</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>OrderController.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/iosPaymentVerify"</span>)</span><br><span class="line">    <span class="meta">@Authorization</span></span><br><span class="line">    <span class="meta">@ApiOperation</span>(<span class="string">"è‹¹æœå†…è´­æ”¯ä»˜"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result&lt;Object&gt; <span class="title">iosPayment</span><span class="params">(@RequestBody Map&lt;String, String&gt; map, @CurrentUser User user)</span> </span>&#123;</span><br><span class="line">        String no = map.get(<span class="string">"no"</span>);</span><br><span class="line">        String transactionId = map.get(<span class="string">"transactionId"</span>);</span><br><span class="line">        String types = map.get(<span class="string">"type"</span>);</span><br><span class="line">        <span class="keyword">int</span> type = Integer.valueOf(types.trim()); <span class="comment">//0æ¶ˆè€—å‹ 1è®¢é˜…å‹</span></span><br><span class="line">        String payload = map.get(<span class="string">"payload"</span>);</span><br><span class="line">        log.info(<span class="string">"äº¤æ˜“å·:&#123;&#125;,receipt:&#123;&#125;,äº¤æ˜“ç±»å‹:&#123;&#125;,æœ¬åœ°è®¢å•å·:&#123;&#125;"</span>, transactionId, payload, type, no);</span><br><span class="line">        IosPayment iosPayment = iosPaymentService.save(no, transactionId, type, payload, user);</span><br><span class="line">        <span class="comment">//å…ˆæ ¡å¯¹ä¸æœ¬åœ°è®¢å•</span></span><br><span class="line">        Order localOrder = orderRepository.findByNo(no);<span class="comment">//ç¦æ­¢é‡å¤åˆ·å•</span></span><br><span class="line">        <span class="keyword">if</span> (localOrder == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ResultUtil&lt;&gt;().setErrorMsg(<span class="keyword">this</span>.i18n(<span class="string">"this.order.does.not.exist.and.the.recharge.failed"</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (localOrder.getStatus() == Constant.PAY_SUCCESS || (localOrder.getTransactionId() != <span class="keyword">null</span> &amp;&amp; localOrder.getStatus() == Constant.PAY_SUCCESS)) &#123;<span class="comment">//æœ¬åœ°è®¢å•å·å’Œè‹¹æœäº¤æ˜“å·æ¯æ¬¡è´­ä¹°éƒ½æ˜¯å”¯ä¸€çš„</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ResultUtil&lt;&gt;().setErrorMsg(<span class="keyword">this</span>.i18n(<span class="string">"this.order.has.been.successfully.recharged.and.cannot.be.refilled"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        String verifyResult = <span class="keyword">null</span>;</span><br><span class="line">        String receipt = payload.replaceAll(<span class="string">"%2B"</span>, <span class="string">"+"</span>); <span class="comment">//notice: æ³¨æ„%2Bçš„ç¬¦å·</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            verifyResult = IosVerifyUtil.buyAppVerify(receipt, <span class="number">1</span>, type);<span class="comment">//1.å…ˆçº¿ä¸Šæµ‹è¯•,å‘é€å¹³å°éªŒè¯</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e1) &#123;</span><br><span class="line">            <span class="keyword">throw</span> HttpRequestException.newI18N(<span class="string">"server.exception"</span>);<span class="comment">//æœåŠ¡å™¨å¼‚å¸¸</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (verifyResult == <span class="keyword">null</span>) &#123;<span class="comment">// è‹¹æœæœåŠ¡å™¨æ²¡æœ‰è¿”å›éªŒè¯ç»“æœ</span></span><br><span class="line">            <span class="keyword">throw</span> HttpRequestException.newI18N(<span class="string">"order.information.is.abnormal"</span>);<span class="comment">//è®¢å•ä¿¡æ¯å¼‚å¸¸</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">// è‹¹æœéªŒè¯æœ‰è¿”å›ç»“æœ</span></span><br><span class="line">            log.info(<span class="string">"çº¿ä¸Šï¼Œè‹¹æœå¹³å°è¿”å›JSON:&#123;&#125;"</span>, verifyResult);</span><br><span class="line">            JSONObject job = JSONObject.parseObject(verifyResult);</span><br><span class="line">            String states = job.getString(<span class="string">"status"</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"21007"</span>.equals(states)) &#123;<span class="comment">//æ˜¯æ²™ç›’ç¯å¢ƒï¼Œåº”æ²™ç›’æµ‹è¯•ï¼Œå¦åˆ™æ‰§è¡Œä¸‹é¢</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    verifyResult = IosVerifyUtil.buyAppVerify(receipt, <span class="number">0</span>, type);<span class="comment">//2.å†æ²™ç›’æµ‹è¯•  å‘é€å¹³å°éªŒè¯</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> HttpRequestException.newI18N(<span class="string">"server.exception"</span>);<span class="comment">//æœåŠ¡å™¨å¼‚å¸¸</span></span><br><span class="line">                &#125;</span><br><span class="line">                job = JSONObject.parseObject(verifyResult);</span><br><span class="line">                states = job.getString(<span class="string">"status"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (states.equals(<span class="string">"0"</span>)) &#123;<span class="comment">// å‰ç«¯æ‰€æä¾›çš„æ”¶æ®æ˜¯æœ‰æ•ˆçš„ï¼ŒéªŒè¯æˆåŠŸ</span></span><br><span class="line">                String r_receipt = job.getString(<span class="string">"receipt"</span>);</span><br><span class="line">                JSONObject returnJson = JSONObject.parseObject(r_receipt);</span><br><span class="line">                String in_app = returnJson.getString(<span class="string">"in_app"</span>);</span><br><span class="line">                JSONArray arr = JSONArray.parseArray(in_app);<span class="comment">//æ•°ç»„</span></span><br><span class="line">                <span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line">                <span class="comment">//å¦‚æœå•å·ä¸€è‡´  åˆ™ä¿å­˜åˆ°æ•°æ®åº“</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arr.size(); i++) &#123;</span><br><span class="line">                        JSONObject obj = (JSONObject) arr.get(i);</span><br><span class="line">                        <span class="comment">// äº¤æ˜“ä¸­æœ‰å½“å‰äº¤æ˜“ï¼Œåˆ™è®¤ä¸ºäº¤æ˜“æˆåŠŸ</span></span><br><span class="line">                        <span class="keyword">if</span> (transactionId.equals(obj.get(<span class="string">"transaction_id"</span>))) &#123;</span><br><span class="line">                            flag = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (flag) &#123;<span class="comment">//å¤„ç†ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">                            String productId = obj.getString(<span class="string">"product_id"</span>);</span><br><span class="line">                            Product product = productService.getByProductId(productId).orElseThrow(() -&gt; &#123;</span><br><span class="line">                                <span class="keyword">return</span> HttpRequestException.newI18N(<span class="string">"not.find.product"</span>);</span><br><span class="line">                            &#125;);</span><br><span class="line">                            String original_transaction_id = obj.getString(<span class="string">"original_transaction_id"</span>);</span><br><span class="line">                            <span class="keyword">if</span> (type == <span class="number">0</span>) &#123;<span class="comment">//æ¶ˆè€—å‹</span></span><br><span class="line">                                <span class="keyword">long</span> purchase_date = obj.getLong(<span class="string">"purchase_date_ms"</span>);</span><br><span class="line">                                <span class="keyword">int</span> amount = product.getAmount();<span class="comment">//å……å€¼çš„coin</span></span><br><span class="line">                                <span class="keyword">int</span> sum = user.getCoin() + amount;</span><br><span class="line">                                user.setCoin(sum);</span><br><span class="line">                                localOrder.setType(type);<span class="comment">//æ¶ˆè€—å‹</span></span><br><span class="line">                                localOrder.setTransactionId(transactionId);</span><br><span class="line">                                localOrder.setStatus(Constant.PAY_SUCCESS);</span><br><span class="line">                                localOrder.setProduct(product);</span><br><span class="line">                                localOrder.setQuantity(amount);</span><br><span class="line">                                localOrder.setOriginTraId(original_transaction_id);</span><br><span class="line">                                orderService.updateOrder(localOrder);</span><br><span class="line">                                userService.updateUser(user);<span class="comment">//ç»™ç”¨æˆ·åŠ å¸</span></span><br><span class="line">                                billRecordService.save(amount, <span class="number">1</span>, <span class="string">"ãƒã‚¤ãƒ³ãƒˆè³¼å…¥"</span>, user);</span><br><span class="line">                                iosPayment.setPurchaseDate(<span class="keyword">new</span> Date(purchase_date));</span><br><span class="line">                                iosPayment.setLatestReceipt(obj.toString());</span><br><span class="line">                                iosPaymentService.update(iosPayment, payload, original_transaction_id, product, IosPayment.Status.Completed);<span class="comment">//è‹¹æœæ”¯ä»˜è¯¦æƒ…</span></span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">new</span> ResultUtil&lt;&gt;().setData(user.getCoin());</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;<span class="comment">//è®¢é˜…å‹</span></span><br><span class="line">                                <span class="keyword">return</span> iosSubscribe(user, payload, transactionId, type, localOrder, job, obj, productId, product, iosPayment);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    log.error(<span class="string">"exception is &#123;&#125;"</span>, e.getMessage());</span><br><span class="line">                    <span class="keyword">throw</span> HttpRequestException.newI18N(<span class="string">"recharge.failed"</span>);<span class="comment">//å……å€¼å¤±è´¥</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> HttpRequestException.newI18N(<span class="string">"invalid.receipt.information"</span>);<span class="comment">//æ”¶æ®ä¿¡æ¯å¼‚å¸¸</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultUtil&lt;&gt;().setErrorMsg(<span class="keyword">this</span>.i18n(<span class="string">"there.is.a.problem.with.the.order.verification"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Result&lt;Object&gt; <span class="title">iosSubscribe</span><span class="params">(@CurrentUser User user, String payload, String transactionId, <span class="keyword">int</span> type, Order localOrder, JSONObject job, JSONObject obj, String productId, Product product, IosPayment iosPayment)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//é¦–æ¬¡è®¢é˜…ä¸è¿ç»­æ€§è®¢é˜…çš„åŒºåˆ«åˆ¤æ–­</span></span><br><span class="line">        String originTransactionId = obj.getString(<span class="string">"original_transaction_id"</span>);<span class="comment">//ç°äº¤æ˜“ä¸­çš„åŸå§‹è®¢å•å·ï¼Œä½œä¸ºç»­è´¹åˆ¤å®šçš„ä¾æ®</span></span><br><span class="line">        <span class="keyword">long</span> purchase_date = obj.getLong(<span class="string">"purchase_date_ms"</span>);</span><br><span class="line">        <span class="keyword">long</span> expires_date = obj.getLong(<span class="string">"expires_date_ms"</span>);</span><br><span class="line">        Date expiresTime = <span class="keyword">new</span> Date(expires_date);</span><br><span class="line">        Date joinTime = <span class="keyword">new</span> Date(purchase_date);</span><br><span class="line">        log.info(<span class="string">"expiresTime is &#123;&#125;"</span>, expiresTime);</span><br><span class="line">        log.info(<span class="string">"joinTime is &#123;&#125;"</span>, joinTime);</span><br><span class="line">        <span class="keyword">boolean</span> is_trial_period = <span class="keyword">true</span>;<span class="comment">//æ˜¯å¦å¤„äºè¯•ç”¨æœŸé—´</span></span><br><span class="line">        String isTrial = obj.getString(<span class="string">"is_trial_period"</span>);</span><br><span class="line">        is_trial_period = Boolean.parseBoolean(isTrial);</span><br><span class="line">        <span class="keyword">if</span> (is_trial_period) &#123;<span class="comment">//å…è´¹è¯•ç”¨æœŸé—´</span></span><br><span class="line">            user.setType(<span class="number">1</span>);</span><br><span class="line">            user.setJoinTime(joinTime);<span class="comment">//ä¼šå‘˜åŠ å…¥æ—¶é—´</span></span><br><span class="line">            user.setExpireTime(expiresTime);<span class="comment">//ä¼šå‘˜è¿‡æœŸæ—¶é—´</span></span><br><span class="line">            iosPayment.setExpiresDate(expiresTime);</span><br><span class="line">            iosPayment.setPurchaseDate(<span class="keyword">new</span> Date(purchase_date));</span><br><span class="line">            log.info(<span class="string">"user id &#123;&#125; é¦–æ¬¡è®¢é˜…æˆåŠŸï¼Œä½“éªŒä¸€ä¸ªæœˆå…è´¹è¯•ç”¨æœŸ"</span>, user.getId());</span><br><span class="line">            <span class="keyword">return</span> sucribeSuccess(user, payload, transactionId, originTransactionId, type, localOrder, product, iosPayment);</span><br><span class="line"></span><br><span class="line">        &#125;<span class="comment">//ç”¨æˆ·å–æ¶ˆååˆé‡æ–°è®¢é˜…åˆ¤æ–­ä¾æ®</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isEmpty(job.getString(<span class="string">"pending_renewal_info"</span>))) &#123;</span><br><span class="line">            JSONArray renewals = JSONArray.parseArray(job.getString(<span class="string">"pending_renewal_info"</span>));</span><br><span class="line">            JSONArray pendings = <span class="keyword">new</span> JSONArray();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; renewals.size(); p++) &#123;</span><br><span class="line">                JSONObject renewal = (JSONObject) renewals.get(p);</span><br><span class="line">                <span class="keyword">if</span> (originTransactionId.equals(renewal.getString(<span class="string">"original_transaction_id"</span>))) &#123;</span><br><span class="line">                    pendings.add(renewal);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            JSONObject renewal = (JSONObject) pendings.get(pendings.size() - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">int</span> auto_renew_status = Integer.parseInt(renewal.getString(<span class="string">"auto_renew_status"</span>));<span class="comment">//è‡ªåŠ¨ç»­è®¢è®¢é˜…çš„å½“å‰ç»­è®¢çŠ¶æ€ã€‚ â€œ 1â€-è®¢é˜…å°†åœ¨å½“å‰è®¢é˜…æœŸç»“æŸæ—¶ç»­è®¢ã€‚â€œ 0â€-å®¢æˆ·å·²å…³é—­å…¶è®¢é˜…çš„è‡ªåŠ¨ç»­è®¢ã€‚</span></span><br><span class="line">            <span class="keyword">if</span> (auto_renew_status == <span class="number">0</span>) &#123;<span class="comment">//ç”¨æˆ·æœ‰å…³é—­è®¢é˜…ï¼Œé‡æ–°è®¢é˜…</span></span><br><span class="line">                user.setExpireTime(expiresTime);</span><br><span class="line">                user.setJoinTime(joinTime);</span><br><span class="line">                user.setType(<span class="number">1</span>);</span><br><span class="line">                iosPayment.setExpiresDate(expiresTime);</span><br><span class="line">                iosPayment.setPurchaseDate(<span class="keyword">new</span> Date(purchase_date));</span><br><span class="line">                log.info(<span class="string">"user id &#123;&#125; é‡æ–°è®¢é˜…æˆåŠŸ"</span>,user.getId());</span><br><span class="line">                <span class="keyword">return</span> sucribeSuccess(user, payload, transactionId, originTransactionId, type, localOrder, product, iosPayment);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span> (auto_renew_status == <span class="number">1</span>) &#123;<span class="comment">//å¯¹äºæ‰£è´¹å¤±è´¥çš„ç”¨æˆ·, è‹¹æœä»ä¼šå°è¯•æ‰£æ¬¾60å¤©, è§£æ pending_renewal_info , auto_renew_status ä¸º1å¹¶ä¸” is_in_billing_retry_period ä¸º1, æ­¤æ—¶ç”¨æˆ·çš„çŠ¶æ€å¹¶ä¸èƒ½æ ‡è®°ä¸ºå·²å…³é—­, è€Œåº”è¯¥æ˜¯æ‰£è´¹å¤±è´¥</span></span><br><span class="line">                String retry_period = renewal.getString(<span class="string">"is_in_billing_retry_period"</span>);</span><br><span class="line">                <span class="keyword">if</span> (!StringUtils.isEmpty(retry_period))&#123;<span class="comment">//æ²™ç›’æµ‹è¯•æ—¶å…­æ¬¡ç»­è®¢å®Œå…³é—­åå†æ¬¡é‡æ–°è®¢é˜…å¼€å§‹è¿”å›æ²¡æœ‰è¿™ä¸ªå­—æ®µï¼Œåªæœ‰auto_renew_status=1,å†ç‚¹å‡»å°±æœ‰äº†ï¼ˆæˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼‰</span></span><br><span class="line">                    <span class="keyword">if</span> (retry_period.equals(<span class="string">"1"</span>)) &#123;<span class="comment">//-App Storeä»åœ¨å°è¯•ç»­è®¢ã€‚</span></span><br><span class="line">                        <span class="keyword">return</span> ResultUtil.error(<span class="keyword">this</span>.i18n(<span class="string">"deduction.failed"</span>));<span class="comment">//æ‰£è´¹å¤±è´¥</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ResultUtil.error(<span class="keyword">this</span>.i18n(<span class="string">"subscribe.already"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Result&lt;Object&gt; <span class="title">sucribeSuccess</span><span class="params">(@CurrentUser User user, String payload, String transactionId, String originTraId, <span class="keyword">int</span> type, Order localOrder, Product product, IosPayment iosPayment)</span> </span>&#123;</span><br><span class="line">        userService.updateUser(user);</span><br><span class="line">        localOrder.setProduct(product);</span><br><span class="line">        localOrder.setTransactionId(transactionId);</span><br><span class="line">        localOrder.setType(type);</span><br><span class="line">        localOrder.setOriginTraId(originTraId);</span><br><span class="line">        localOrder.setStatus(Constant.PAY_SUCCESS);</span><br><span class="line">        orderService.updateOrder(localOrder);</span><br><span class="line">        iosPaymentService.update(iosPayment, payload, originTraId, product, IosPayment.Status.Completed);<span class="comment">//è‹¹æœæ”¯ä»˜è¯¦æƒ…</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultUtil&lt;&gt;().setSuccessMsg(<span class="keyword">this</span>.i18n(<span class="string">"successfully"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Authorization</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/createOrder"</span>)</span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"åˆ›å»ºæœ¬åœ°è®¢å•"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result&lt;Object&gt; <span class="title">createOrder</span><span class="params">(@RequestBody Order order, @CurrentUser User user)</span> </span>&#123;</span><br><span class="line">        Order sysOrder = <span class="keyword">new</span> Order();</span><br><span class="line">        sysOrder.setQuantity(order.getQuantity());</span><br><span class="line">        sysOrder.setPayType(order.getPayType());</span><br><span class="line">        sysOrder.setMoney(order.getMoney());</span><br><span class="line">        sysOrder.setType(order.getType());</span><br><span class="line">        sysOrder.setUser(user);</span><br><span class="line">        sysOrder.setStatus(Constant.PAY_FAILURE);</span><br><span class="line">        String no = String.valueOf(System.currentTimeMillis());<span class="comment">//è®¢å•å·</span></span><br><span class="line">        sysOrder.setNo(no + RandomUtil.getRandomNum());<span class="comment">//æ—¶é—´æˆ³+éšæœºå…­ä½æ•°</span></span><br><span class="line">        orderRepository.save(sysOrder);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultUtil&lt;&gt;().setData(sysOrder.getNo());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>æ˜¯ä¸æ˜¯æ„Ÿè§‰è‹¹æœå†…è´­ç®€å•å¤šå•¦<sup>_</sup>ã€‚ä¾‹å¦‚æˆ‘æ‰€åšçš„ä¸šåŠ¡æ˜¯ä¼šå‘˜æ¯æœˆç»­è´¹ï¼Œé‚£ä¹ˆä¼šå‘˜åˆ°æœŸæ—¥æœŸçš„æ›´æ–°å°±åœ¨latest_receipt_infoæ•°ç»„é‡Œæ¯”è¾ƒæœ€åä¸€æ¡è®¢å•æ•°æ®ï¼ˆæœ€æ–°çš„è®¢é˜…æ•°æ®ï¼‰çš„expiresDateå’Œç°åœ¨æ—¶é—´ï¼Œå¦‚æœå¤§äºç°åœ¨æ—¶é—´å°±æ›´æ–°ã€‚<br>
å…³äºè‡ªåŠ¨è¿ç»­è®¢é˜…çš„æœ‰å…³é—®é¢˜ï¼Œå¯ä»¥é™„ä¸Šæˆ‘çš„å‚è€ƒæ–‡ç« é“¾æ¥<a href="https://blog.csdn.net/theCrucian/article/details/89406203" target="_blank" rel="noopener">IAP è‡ªåŠ¨ç»­è´¹åç«¯æ¥å…¥æŒ‡å—</a>å’Œ<a href="https://www.jianshu.com/p/abd2ba4deb54" target="_blank" rel="noopener">è‡ªåŠ¨ç»­æœŸè®¢é˜…æ€»ç»“</a>ï¼</p>
<h2 id="Tips">Tips</h2>
<ul>
<li>iOSç«¯ä¼ è¿‡æ¥çš„è‹¹æœå›è°ƒæ”¶æ®ä¿¡æ¯éœ€base64åŠ å¯†ï¼Œå¦‚æœæœ‰ä¸¥é‡å‘¢ä¸ªé”™è¯¯é—®é¢˜ï¼Œæ³¨æ„æ”¶æ®ä¿¡æ¯çš„ç‰¹æ®Šç¬¦å·æ›¿æ¢ï¼Œeg:&quot;%2B&quot;ã€‚</li>
<li>è‹¹æœå†…è´­è®¢é˜…å‹éªŒè¯æœåŠ¡å™¨éœ€å¤šåŠ å…±äº«å¯†é’¥ï¼ˆç”±ioså¼€å‘äººå‘˜æä¾›ç»™ä½ ï¼‰éªŒè¯,å¦‚æœæ˜¯æ·»åŠ çš„å…¬å…±ç§˜é’¥ï¼Œé‚£ä¹ˆæ¶ˆè€—å‹éªŒè¯ä¹Ÿéœ€è¦åŠ ä¸Šç§˜é’¥éªŒè¯ã€‚</li>
<li>è‹¹æœåœ¨ä¸Šçº¿å®¡æ ¸çš„æ—¶å€™ä¹Ÿæ˜¯ä½¿ç”¨æ²™ç›’è´¦å·æµ‹è¯•çš„ï¼Œé‚£å¦‚ä½•è¯†åˆ«Appç«¯å‘è¿‡æ¥çš„æ”¶æ®æ˜¯æ²™ç›’æµ‹è¯•è¿˜æ˜¯æ­£å¼ç¯å¢ƒç”¨æˆ·çš„è´­ä¹°å‘¢ï¼Ÿè¿™é‡ŒæœåŠ¡ç«¯å°±è¦é‡‡ç”¨åŒé‡éªŒè¯ï¼Œå³å…ˆæŠŠæ”¶æ®æ‹¿åˆ°æ­£å¼ç¯å¢ƒçš„éªŒè¯åœ°å€å»éªŒè¯ï¼Œå¦‚æœè‹¹æœçš„æ­£å¼ç¯å¢ƒéªŒè¯æœåŠ¡å™¨è¿”å›çš„çŠ¶æ€ç  status ä¸º 21007ï¼Œåˆ™è¯´æ˜å½“å‰æ”¶æ®æ˜¯æ²™ç›’ç¯å¢ƒäº§ç”Ÿï¼Œåˆ™å†è¿æ¥ä¸€æ¬¡æ²™ç›’ç¯å¢ƒæœåŠ¡å™¨è¿›è¡ŒéªŒè¯ï¼Œè¿™æ ·ä¸ç®¡æ˜¯æˆ‘ä»¬è‡ªå·±é‡‡ç”¨æ²™ç›’è´¦å·æµ‹è¯•è¿˜æ˜¯è‹¹æœå®¡æ ¸äººå‘˜é‡‡ç”¨æ²™ç›’è´¦å·è¿›è¡Œå®¡æ ¸ã€æˆ–è€…ç”¨æˆ·è´­ä¹°éƒ½å¯ä»¥ä¿è¯æ”¶æ®æ­£å¸¸çš„éªŒè¯æˆåŠŸã€‚</li>
<li>è‹¹æœå†…è´­æ¶ˆè€—å‹è®¢å•ä¼ è¿‡æ¥çš„è®¢å•æ˜¯åœ¨in_appæ•°ç»„é‡Œï¼Œè€Œè‡ªåŠ¨è®¢é˜…å‹ç»­è®¢çš„æœ€æ–°æ•°æ®éƒ½åœ¨latest_receipt_infoæ•°ç»„é‡Œã€‚</li>
</ul>
<h2 id="è‹¹æœå†…è´­è‡ªåŠ¨è¿ç»­è®¢é˜…å‹æ³¨æ„ç‚¹">è‹¹æœå†…è´­è‡ªåŠ¨è¿ç»­è®¢é˜…å‹æ³¨æ„ç‚¹</h2>
<ul>
<li>æµ‹è¯•è‡ªåŠ¨è¿ç»­è®¢é˜…å‹å•†å“æ—¶ï¼Œå¦‚æœæœ‰å…è´¹ä½¿ç”¨æœŸï¼Œæ¯ä¸ªæ²™ç›’è´¦å·åªæœ‰ä¸€æ¬¡å…è´¹è¯•ç”¨æœŸï¼Œä¸”æœ€å¤šè¿ç»­ç»­è®¢äº”æ¬¡ï¼Œä¸€ä¸ªæœˆå¯¹åº”çš„æµ‹è¯•æ—¶é—´æ˜¯äº”åˆ†é’Ÿã€‚</li>
<li>è‡ªåŠ¨è®¢é˜…ç±»å‹æ­£å¼ç¯å¢ƒï¼Œé™¤äº†ç¬¬ä¸€æ¬¡è´­ä¹°è¡Œä¸ºæ˜¯ç”¨æˆ·ä¸»åŠ¨è§¦å‘çš„ã€‚åç»­ç»­è´¹éƒ½æ˜¯Appleè‡ªåŠ¨å®Œæˆçš„ï¼Œä¸€èˆ¬åœ¨è¦è¿‡æœŸçš„å‰24å°æ—¶å¼€å§‹ï¼Œè‹¹æœä¼šå°è¯•æ‰£è´¹ã€‚</li>
</ul>
<h2 id="æœåŠ¡å™¨å¯¹è‡ªåŠ¨è¿ç»­è®¢é˜…å‹äº§å“ç»­è®¢çš„è§£å†³æ–¹æ¡ˆ">æœåŠ¡å™¨å¯¹è‡ªåŠ¨è¿ç»­è®¢é˜…å‹äº§å“ç»­è®¢çš„è§£å†³æ–¹æ¡ˆ</h2>
<ol>
<li>æ·»åŠ server to server é€šçŸ¥</li>
</ol>
<ul>
<li>latest_expired_receipt_info	ç”¨äºè‡ªåŠ¨ç»­è®¢ã€‚è¿‡æœŸè®¢é˜…çš„æ”¶æ®çš„JSONè¡¨ç¤ºå½¢å¼.ä»…å½“é€šçŸ¥ç±»å‹ä¸ºRENEWALæˆ–CANCELæˆ–è®¢é˜…è¿‡æœŸä¸”ç»­è®¢å¤±è´¥æ—¶è¿”å›ã€‚<br>
é¡¹ç›®é›†æˆè¯·çœ‹å®˜ç½‘æœ‰ä»‹ç»ã€‚</li>
</ul>
<ol start="2">
<li>æœåŠ¡ç«¯serverè½®è¯¢è¦è¿‡æœŸå’Œè¿‡æœŸçš„è®¢å•æ•°æ®ï¼Œä¸»åŠ¨å‘è‹¹æœæœåŠ¡å™¨éªŒè¯</li>
</ol>
]]></content>
      <categories>
        <category>ç¬¬ä¸‰æ–¹</category>
      </categories>
      <tags>
        <tag>ç¬¬ä¸‰æ–¹</tag>
        <tag>iOSå†…è´­</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBootæ¥å…¥Google Play</title>
    <url>/2019/12/20/googlepay/</url>
    <content><![CDATA[<h2 id="æ’¸ä»£ç å‰çš„å‡†å¤‡å·¥ä½œ">æ’¸ä»£ç å‰çš„å‡†å¤‡å·¥ä½œ</h2>
<p>å‰é˜µå­å…¬å¸é¡¹ç›®éœ€è¦ç”¨åˆ°è°·æ­Œæ”¯ä»˜ï¼Œå¼€å§‹æ¥è§¦çš„æˆ‘æ‡µæ‡‚æ‘¸ç´¢äº†ä¸€æ˜ŸæœŸï¼Œç»ˆäºå’Œå®‰å“å¯¹æ¥å¥½äº†è°·æ­Œæ”¯ä»˜ã€‚å•¥éƒ½ä¸è¯´äº†,ç›´æ¥ä¸Šå›¾ï¼š<br>
1.è¿›å…¥Google Play Console ,<a href="https://play.google.com/apps/publish/?account=7344212024493937034#AppListPlace" target="_blank" rel="noopener">https://play.google.com/apps/publish/?account=7344212024493937034#AppListPlace</a><br>
2.è®¾ç½®-&gt;APIè®¿é—®-&gt;åˆ›å»ºoauth2å®¢æˆ·ç«¯-&gt;å…³è”åˆšåˆ›å»ºçš„é¡¹ç›®</p>
<a id="more"></a>
<p><img src="/images/googlepay01.png" alt=""><br>
3.å¯ä»¥åˆ›å»ºæœåŠ¡è´¦å·<br>
<img src="/images/googlepay02.png" alt=""><br>
4.è¿›å…¥APIå’ŒæœåŠ¡-&gt;è®¾ç½®è®¤è¯ä¿¡æ¯å’Œoauth2ç»Ÿä¸€ç”»é¢<br>
<img src="/images/googlepay03.png" alt=""><br>
è®¤è¯ä¿¡æ¯<br>
<img src="/images/googlepay04.png" alt=""><br>
oauth2åŒæ„ç”»é¢<br>
<img src="/images/googlepay05.png" alt=""><br>
<img src="/images/googlepay07.png" alt=""><br>
5.å¯ä»¥ç‚¹å‡»é¡¹ç›®é€‰æ‹©åˆ›å»ºoauth2å®¢æˆ·ç«¯ æˆ–è€…æœåŠ¡å¸å·<br>
<img src="/images/googlepay08.png" alt=""><br>
6.ä¸‹è½½oauth2å®¢æˆ·ç«¯jsonæˆ–è¿›å…¥ç®¡ç†è´¦æˆ·ä¸‹è½½è´¦æˆ·çš„secret.jsonæˆ–p12æ–‡ä»¶<br>
<img src="/images/googlepay09.png" alt=""><br>
åŸºæœ¬çš„æ§åˆ¶å°è®¾ç½®æµç¨‹å°±æ˜¯è¿™äº†ï¼Œæ¥ä¸‹æ¥å†çœ‹ä»£ç éƒ¨åˆ†ï¼š</p>
<h2 id="ä»£ç éƒ¨åˆ†">ä»£ç éƒ¨åˆ†</h2>
<p>1.å…ˆåœ¨application.ymlé…ç½®googleè´¦å·çš„ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾<br>
<img src="/images/googlepay10.png" alt=""><br>
æ³¨æ„ï¼šæœåŠ¡å™¨è°·æ­Œæ”¯ä»˜éªŒè¯æœ‰ä¸¤ç§æ–¹å¼ï¼š1è¯·æ±‚googleapiéªŒè¯ 2.ä½¿ç”¨å…¬å¯†é’¥éªŒè¯ã€‚åœ¨è¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯ç¬¬ä¸€ç§æ–¹å¼è¯·æ±‚google apiéªŒè¯ï¼Œç¬¬äºŒç§æˆ‘ä¹Ÿå†™äº† ä½†æ˜¯ä¸æ€ä¹ˆå¥½ä½¿<sup>_</sup>ï¼Œåœ¨è¿™é‡Œæˆ‘ä¹Ÿé™„ä¸Šä»£ç ã€‚ã€‚ã€‚<br>
googleé…ç½®ç±»<code>GooglePayConfig.java</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xy.goone.config.pay;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xy.goone.common.util.pay.GooglePayVerifyUtil;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> fumei.jiang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019-09-24 15:15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"app.google.config"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GooglePayConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String keyFile;</span><br><span class="line">    <span class="keyword">private</span> String pkcs;</span><br><span class="line">    <span class="keyword">private</span> String serviceAccountEmail;</span><br><span class="line">    <span class="keyword">private</span> String client_id;</span><br><span class="line">    <span class="keyword">private</span> String client_secret;</span><br><span class="line">    <span class="keyword">private</span> String refresh_token;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getKeyFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> keyFile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setKeyFile</span><span class="params">(String keyFile)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.keyFile = keyFile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPkcs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> pkcs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPkcs</span><span class="params">(String pkcs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.pkcs = pkcs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServiceAccountEmail</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serviceAccountEmail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setServiceAccountEmail</span><span class="params">(String serviceAccountEmail)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.serviceAccountEmail = serviceAccountEmail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getKeylongString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> GooglePayVerifyUtil.load(<span class="keyword">this</span>.getKeyFile());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPkcslongString</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> GooglePayVerifyUtil.load(<span class="keyword">this</span>.getPkcs());&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getClient_id</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> client_id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClient_id</span><span class="params">(String client_id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.client_id = client_id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getClient_secret</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> client_secret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setClient_secret</span><span class="params">(String client_secret)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.client_secret = client_secret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getRefresh_token</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> refresh_token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRefresh_token</span><span class="params">(String refresh_token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.refresh_token = refresh_token;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>éªŒè¯å·¥å…·ç±»<code>GooglePayVerifyUtil.java</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xy.goone.common.util.pay;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.binary.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyFactory;</span><br><span class="line"><span class="keyword">import</span> java.security.PublicKey;</span><br><span class="line"><span class="keyword">import</span> java.security.Signature;</span><br><span class="line"><span class="keyword">import</span> java.security.spec.X509EncodedKeySpec;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> fumei.jiang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019-08-07 16:14</span></span><br><span class="line"><span class="comment"> * è°·æ­Œæ”¯ä»˜</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GooglePayVerifyUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*@Value(value = "$&#123;google.p12key&#125;")</span></span><br><span class="line"><span class="comment">    private String p12;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    @Value(value = "$&#123;google.email&#125;")</span></span><br><span class="line"><span class="comment">    private String email;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    @Value("$&#123;google.packageName&#125;")</span></span><br><span class="line"><span class="comment">    private String packageName;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    public static void main(String[] args) throws Exception &#123;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        HttpTransport transport = GoogleNetHttpTransport.newTrustedTransport();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        PrivateKey privateKey = SecurityUtils.loadPrivateKeyFromKeyStore(</span></span><br><span class="line"><span class="comment">                SecurityUtils.getPkcs12KeyStore(),</span></span><br><span class="line"><span class="comment">                new FileInputStream(new File("&#123;P12 key file&#125;")), // ç”Ÿæˆçš„P12æ–‡ä»¶</span></span><br><span class="line"><span class="comment">                "notasecret", "privatekey", "notasecret");</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        GoogleCredential credential = new GoogleCredential.Builder()</span></span><br><span class="line"><span class="comment">                .setTransport(transport).setJsonFactory(JacksonFactory.getDefaultInstance())</span></span><br><span class="line"><span class="comment">                .setServiceAccountId("&#123;Email address&#125;") // e.g.: 626891557797-frclnjv31rn4ss81ch746g9t6pd3mmej@developer.gserviceaccount.com</span></span><br><span class="line"><span class="comment">                .setServiceAccountScopes(AndroidPublisherScopes.all())</span></span><br><span class="line"><span class="comment">                .setServiceAccountPrivateKey(privateKey).build();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        AndroidPublisher publisher = new AndroidPublisher.Builder(transport,</span></span><br><span class="line"><span class="comment">                JacksonFactory.getDefaultInstance(), credential).build();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        AndroidPublisher.Purchases.Products products = publisher.purchases().products();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // å‚æ•°è¯¦ç»†è¯´æ˜: https://developers.google.com/android-publisher/api-ref/purchases/products/get</span></span><br><span class="line"><span class="comment">        AndroidPublisher.Purchases.Products.Get product = products.get("&#123;packageName&#125;",</span></span><br><span class="line"><span class="comment">                "&#123;productId&#125;", "&#123;token&#125;");</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        // è·å–è®¢å•ä¿¡æ¯</span></span><br><span class="line"><span class="comment">        // è¿”å›ä¿¡æ¯è¯´æ˜: https://developers.google.com/android-publisher/api-ref/purchases/products</span></span><br><span class="line"><span class="comment">        // é€šè¿‡consumptionState, purchaseStateå¯ä»¥åˆ¤æ–­è®¢å•çš„çŠ¶æ€</span></span><br><span class="line"><span class="comment">        ProductPurchase purchase = product.execute();</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">docheck</span><span class="params">(String content, String sign, String publicKey)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        KeyFactory keyFactory = KeyFactory.getInstance(<span class="string">"RSA"</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] encodedKey = Base64.decodeBase64(publicKey);</span><br><span class="line">        PublicKey pubKey = keyFactory.generatePublic(<span class="keyword">new</span> X509EncodedKeySpec(encodedKey));</span><br><span class="line">        Signature signature = Signature.getInstance(<span class="string">"SHA1WithRSA"</span>);</span><br><span class="line">        signature.initVerify(pubKey);</span><br><span class="line">        signature.update(content.getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">        <span class="keyword">return</span> signature.verify(Base64.decodeBase64(sign));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String PRIVATE_KEYS;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> String <span class="title">load</span><span class="params">(String file)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (PRIVATE_KEYS == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!file.startsWith(<span class="string">"/"</span>)) &#123;</span><br><span class="line">                file = GooglePayVerifyUtil.class.getResource("/").getFile() + File.separator + file;</span><br><span class="line">            &#125;</span><br><span class="line">            File f = <span class="keyword">new</span> File(file);</span><br><span class="line">            <span class="keyword">try</span> (InputStreamReader reader = <span class="keyword">new</span> InputStreamReader(<span class="keyword">new</span> FileInputStream(f), <span class="string">"utf8"</span>);) &#123;</span><br><span class="line">                StringBuffer buffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">                <span class="keyword">char</span>[] bf = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> size = reader.read(bf);</span><br><span class="line">                    <span class="keyword">if</span> (size &lt; <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    buffer.append(bf, <span class="number">0</span>, size);</span><br><span class="line">                &#125;</span><br><span class="line">                PRIVATE_KEYS = buffer.toString();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"read file error ! "</span> + f.getAbsolutePath(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> PRIVATE_KEYS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>OrderController.java</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, String&gt; cacheToken = <span class="keyword">null</span>;<span class="comment">//è®¾ç½®é™æ€å˜é‡ï¼Œç”¨äºåˆ¤æ–­access_tokenæ˜¯å¦è¿‡æœŸ</span></span><br><span class="line"> <span class="meta">@Authorization</span></span><br><span class="line"> <span class="meta">@PostMapping</span>(value = <span class="string">"/createOrder"</span>)</span><br><span class="line"> <span class="meta">@ApiOperation</span>(value = <span class="string">"åˆ›å»ºæœ¬åœ°è®¢å•"</span>)</span><br><span class="line"> <span class="function"><span class="keyword">public</span> Result&lt;Object&gt; <span class="title">createOrder</span><span class="params">(@RequestBody Order order, @CurrentUser User user)</span> </span>&#123;</span><br><span class="line">     Order sysOrder = <span class="keyword">new</span> Order();</span><br><span class="line">     sysOrder.setQuantity(order.getQuantity());</span><br><span class="line">     sysOrder.setPayType(order.getPayType());</span><br><span class="line">     sysOrder.setMoney(order.getMoney());</span><br><span class="line">     sysOrder.setType(order.getType());</span><br><span class="line">     sysOrder.setUser(user);</span><br><span class="line">     sysOrder.setStatus(Constant.PAY_FAILURE);</span><br><span class="line">     String no = String.valueOf(System.currentTimeMillis());<span class="comment">//è®¢å•å·</span></span><br><span class="line">     sysOrder.setNo(no + RandomUtil.getRandomNum());<span class="comment">//æ—¶é—´æˆ³+éšæœºå…­ä½æ•°</span></span><br><span class="line">     orderRepository.save(sysOrder);</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> ResultUtil&lt;&gt;().setData(sysOrder.getNo());</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@RequestMapping</span>(value = <span class="string">"/googlePayVerify"</span>, method = RequestMethod.POST)</span><br><span class="line"> <span class="meta">@ApiOperation</span>(value = <span class="string">"è°·æ­Œæ”¯ä»˜æ–¹å¼äºŒï¼šé€šè¿‡è¯·æ±‚è°·æ­ŒapiéªŒè¯"</span>)</span><br><span class="line"> <span class="meta">@Authorization</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Result&lt;Object&gt; <span class="title">googlePlayVerify</span><span class="params">(@RequestBody Pay.Payment payment, @CurrentUser User user)</span> </span>&#123;</span><br><span class="line">     String no = payment.getNo();</span><br><span class="line">     <span class="keyword">int</span> type = payment.getType();<span class="comment">//ç±»å‹ï¼š0 æ¶ˆè€— 1è´­ä¹°</span></span><br><span class="line">     Pay.Purchase receipt = payment.getPurchase();</span><br><span class="line">     <span class="comment">//å…ˆæ ¡å¯¹ä¸æœ¬åœ°è®¢å•</span></span><br><span class="line">     Order localOrder = orderRepository.findByNo(no);<span class="comment">//ç¦æ­¢é‡å¤åˆ·å•</span></span><br><span class="line">     log.info(<span class="string">"no is &#123;&#125;"</span>, no);</span><br><span class="line">     <span class="keyword">if</span> (localOrder == <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> ResultUtil&lt;&gt;().setErrorMsg(<span class="keyword">this</span>.i18n(<span class="string">"order.does.not.exist.and.recharge.failed"</span>));</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (localOrder.getStatus() == Constant.PAY_SUCCESS) &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> ResultUtil&lt;&gt;().setErrorMsg(<span class="keyword">this</span>.i18n(<span class="string">"this.order.has.been.successfully.recharged.and.cannot.be.refilled"</span>));</span><br><span class="line">     &#125;</span><br><span class="line">     JSONObject jsonObject = <span class="keyword">null</span>;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         String json = JsonUtil.objectToJson(receipt);</span><br><span class="line">         log.info(<span class="string">"param  purchase json is &#123;&#125;"</span>, json);</span><br><span class="line">         jsonObject = JSON.parseObject(json);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">         <span class="keyword">throw</span> HttpRequestException.newI18N(<span class="string">"data.parsing.failed"</span>);<span class="comment">//æ•°æ®è§£æå¤±è´¥</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">null</span> != cacheToken) &#123;</span><br><span class="line">         Long expires_in = Long.valueOf(cacheToken.get(<span class="string">"expires_in"</span>)); <span class="comment">// æœ‰æ•ˆæ—¶é•¿</span></span><br><span class="line">         Long create_time = Long.valueOf(cacheToken.get(<span class="string">"create_time"</span>)); <span class="comment">// access_tokençš„åˆ›å»ºæ—¶é—´</span></span><br><span class="line">         Long now_time = (<span class="keyword">new</span> Date().getTime()) / <span class="number">1000</span>;</span><br><span class="line">         <span class="keyword">if</span> (now_time &gt; (create_time + expires_in - <span class="number">300</span>)) &#123; <span class="comment">// æå‰äº”åˆ†é’Ÿé‡æ–°è·å–access_token</span></span><br><span class="line">             cacheToken = getAccessToken();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         cacheToken = getAccessToken();</span><br><span class="line">     &#125;</span><br><span class="line">     String access_token = cacheToken.get(<span class="string">"access_token"</span>);</span><br><span class="line">     String productId = jsonObject.getString(<span class="string">"productId"</span>);</span><br><span class="line">     String packageName = jsonObject.getString(<span class="string">"packageName"</span>);</span><br><span class="line">     String purchaseToken = jsonObject.getString(<span class="string">"purchaseToken"</span>);</span><br><span class="line">     <span class="keyword">int</span> purchaseState = jsonObject.getIntValue(<span class="string">"purchaseState"</span>);</span><br><span class="line">     <span class="keyword">long</span> purchaseTime = jsonObject.getLongValue(<span class="string">"purchaseTime"</span>);</span><br><span class="line">     String orderId = jsonObject.getString(<span class="string">"orderId"</span>);</span><br><span class="line">     log.info(<span class="string">"access_token:&#123;&#125;,productId:&#123;&#125;,packageName:&#123;&#125;,purchaseToken:&#123;&#125;,purchaseState:&#123;&#125;,orderId:&#123;&#125;"</span>, access_token, productId, packageName, purchaseToken, purchaseState, orderId);</span><br><span class="line">     GooglePayment googlePayment = googlePaymentService.save(no, orderId, access_token, productId, packageName, purchaseToken, purchaseState, user, purchaseTime);</span><br><span class="line">     Order go = orderRepository.findByTransactionId(orderId);</span><br><span class="line">     <span class="keyword">if</span> (go != <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">throw</span> HttpRequestException.newI18N(<span class="string">"this.order.has.been.successfully.recharged.and.cannot.be.refilled"</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">final</span> String client_id = googlePayConfig.getClient_id();</span><br><span class="line">         <span class="keyword">final</span> String client_secret = googlePayConfig.getClient_secret();</span><br><span class="line">         <span class="keyword">final</span> String refresh_token = googlePayConfig.getRefresh_token();</span><br><span class="line">         HttpTransport transport = GoogleNetHttpTransport.newTrustedTransport();</span><br><span class="line">         TokenResponse tokenResponse = <span class="keyword">new</span> TokenResponse();</span><br><span class="line">         tokenResponse.setAccessToken(access_token);</span><br><span class="line">         tokenResponse.setRefreshToken(refresh_token);</span><br><span class="line">         tokenResponse.setExpiresInSeconds(<span class="number">3600L</span>);</span><br><span class="line">         tokenResponse.setTokenType(<span class="string">"Bearer"</span>);</span><br><span class="line">         GoogleCredential credential = <span class="keyword">new</span> GoogleCredential.Builder()</span><br><span class="line">                 .setTransport(transport)</span><br><span class="line">                 .setJsonFactory(JacksonFactory.getDefaultInstance())</span><br><span class="line">                 .setClientSecrets(client_id, client_secret)</span><br><span class="line">                 .build()</span><br><span class="line">                 .setFromTokenResponse(tokenResponse);</span><br><span class="line">         AndroidPublisher publisher = <span class="keyword">new</span> AndroidPublisher.Builder(transport, JacksonFactory.getDefaultInstance(), credential).setApplicationName(packageName).build();</span><br><span class="line">         <span class="keyword">if</span> (type == <span class="number">1</span>) &#123;<span class="comment">//è®¢é˜…å‹</span></span><br><span class="line">             <span class="comment">//è°·æ­Œè®¢é˜…å‘¨æœŸä¸ºä¸€ä¸ªæœˆç»­è®¢ æµ‹è¯•è´¦å·å¯¹åº”æ—¶é—´ä¸º5åˆ†é’Ÿ ä¸”æµ‹è¯•è´¦å·æœ€å¤šå¯è¿ç»­è®¢é˜…6æ¬¡</span></span><br><span class="line">             <span class="keyword">return</span> googleSubscribe(user, type, localOrder, productId, packageName, purchaseToken, orderId, publisher, googlePayment);</span><br><span class="line"></span><br><span class="line">         &#125;</span><br><span class="line">         AndroidPublisher.Purchases.Products products = publisher.purchases().products();</span><br><span class="line">         AndroidPublisher.Purchases.Products.Get product = products.get(packageName, productId, purchaseToken);<span class="comment">//æ¶ˆè€—å‹éªŒè¯</span></span><br><span class="line">         log.info(<span class="string">"product,packageName:&#123;&#125;,productId:&#123;&#125;,token:&#123;&#125;"</span>, product.getPackageName(), product.getProductId(), product.getToken());</span><br><span class="line">         ProductPurchase purchase = product.execute();</span><br><span class="line">         log.info(<span class="string">"purchase:&#123;&#125;"</span>, purchase);</span><br><span class="line">         <span class="keyword">if</span> (purchase.getPurchaseState() == <span class="number">0</span>) &#123;<span class="comment">//ç¡®è®¤çŠ¶æ€ä¸ºå·²è´­ä¹°çŠ¶æ€</span></span><br><span class="line">             <span class="comment">//POST https://www.googleapis.com/androidpublisher/v3/applications/packageName/purchases/products/productId/tokens/token:acknowledge</span></span><br><span class="line">             Product pro = productService.getByProductId(productId).orElseThrow(() -&gt; &#123;</span><br><span class="line">                 <span class="keyword">return</span> HttpRequestException.newI18N(<span class="string">"not.find.product"</span>);</span><br><span class="line">             &#125;);</span><br><span class="line">             <span class="keyword">int</span> amount = pro.getAmount();</span><br><span class="line">             <span class="keyword">int</span> coin = user.getCoin() + amount;</span><br><span class="line">             user.setCoin(coin);</span><br><span class="line">             userService.updateUser(user);<span class="comment">//æ›´æ–°ç”¨æˆ·coin</span></span><br><span class="line">             log.info(<span class="string">"äº§å“çš„ç¡®è®¤çŠ¶æ€:&#123;&#125;"</span>, purchase.getAcknowledgementState());</span><br><span class="line">             <span class="keyword">if</span> (purchase.getAcknowledgementState() == <span class="number">0</span>) &#123;<span class="comment">//å°šæœªå¾—åˆ°ç¡®è®¤</span></span><br><span class="line">                 ProductPurchasesAcknowledgeRequest productPurchasesAcknowledgeRequest = <span class="keyword">new</span> ProductPurchasesAcknowledgeRequest();</span><br><span class="line">                 productPurchasesAcknowledgeRequest.setDeveloperPayload(purchase.getDeveloperPayload());</span><br><span class="line">                 AndroidPublisher.Purchases.Products.Acknowledge acknowledge = products.acknowledge(packageName, productId, purchaseToken, productPurchasesAcknowledgeRequest);</span><br><span class="line">                 acknowledge.execute();</span><br><span class="line">             &#125;</span><br><span class="line">             localOrder.setTransactionId(orderId);</span><br><span class="line">             localOrder.setStatus(Constant.PAY_SUCCESS);</span><br><span class="line">             localOrder.setProduct(pro);</span><br><span class="line">             localOrder.setQuantity(pro.getAmount());</span><br><span class="line">             localOrder.setType(type);<span class="comment">//æ¶ˆè€—å‹</span></span><br><span class="line">             orderService.updateOrder(localOrder);</span><br><span class="line">             billRecordService.save(amount, <span class="number">1</span>, <span class="string">"ãƒã‚¤ãƒ³ãƒˆè³¼å…¥"</span>, user);</span><br><span class="line">             googlePayment.setAcknowledged(<span class="number">1</span>);</span><br><span class="line">             googlePaymentService.update(googlePayment, pro, GooglePayment.Type.Consume);</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">new</span> ResultUtil&lt;&gt;().setData(coin);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">         log.error(<span class="string">"exception is &#123;&#125;"</span>, e.getMessage());</span><br><span class="line">         <span class="keyword">throw</span> HttpRequestException.newI18N(<span class="string">"order.verification"</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> ResultUtil&lt;&gt;().setErrorMsg(<span class="keyword">this</span>.i18n(<span class="string">"order.verification"</span>));</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> Result&lt;Object&gt; <span class="title">googleSubscribe</span><span class="params">(@CurrentUser User user, <span class="keyword">int</span> type, Order localOrder, String productId, String packageName, String purchaseToken, String orderId, AndroidPublisher publisher, GooglePayment googlePayment)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">     log.info(<span class="string">"è®¢é˜…éªŒè¯å¼€å§‹......"</span>);</span><br><span class="line">     AndroidPublisher.Purchases.Subscriptions subscriptions = publisher.purchases().subscriptions();</span><br><span class="line">     AndroidPublisher.Purchases.Subscriptions.Get subscription = subscriptions.get(packageName, productId, purchaseToken);</span><br><span class="line">     SubscriptionPurchase subscriptionPurchase = subscription.execute();</span><br><span class="line">     log.info(<span class="string">"subscriptionPurchase:&#123;&#125;"</span>, subscriptionPurchase);</span><br><span class="line">     <span class="keyword">long</span> expiryTimeMillis = subscriptionPurchase.getExpiryTimeMillis();<span class="comment">//è®¢é˜…åˆ°æœŸçš„æ—¶é—´</span></span><br><span class="line">     <span class="keyword">long</span> startTimeMillis = subscriptionPurchase.getStartTimeMillis();<span class="comment">//æˆäºˆè®¢é˜…çš„æ—¶é—´</span></span><br><span class="line">     <span class="keyword">boolean</span> autoRenewing = subscriptionPurchase.getAutoRenewing();<span class="comment">//è®¢é˜…åœ¨è¾¾åˆ°å…¶å½“å‰åˆ°æœŸæ—¶é—´æ—¶æ˜¯å¦å°†è‡ªåŠ¨ç»­è®¢ã€‚</span></span><br><span class="line">     <span class="keyword">int</span> paymentState = subscriptionPurchase.getPaymentState();<span class="comment">//è®¢é˜…çš„ä»˜æ¬¾çŠ¶æ€ï¼š 0ä»˜æ¬¾ç­‰å¾…ä¸­ 1å·²æ”¶åˆ°ä»˜æ¬¾ 2å…è´¹è¯•ç”¨ 3å¾…æ¨è¿Ÿçš„å‡çº§</span></span><br><span class="line">     log.info(<span class="string">"expiryTimeMillis : &#123;&#125;,startTimeMillis : &#123;&#125;,autoRenewing : &#123;&#125;,paymentState : &#123;&#125;,productId:&#123;&#125;,acknowledgementState:&#123;&#125;"</span>, expiryTimeMillis, startTimeMillis, autoRenewing, paymentState, productId, subscriptionPurchase.getAcknowledgementState());</span><br><span class="line">     Product pro = productService.getByProductId(productId).orElseThrow(() -&gt; &#123;</span><br><span class="line">         <span class="keyword">return</span> HttpRequestException.newI18N(<span class="string">"not.find.product"</span>);</span><br><span class="line">     &#125;);</span><br><span class="line">     user.setJoinTime(<span class="keyword">new</span> Date(startTimeMillis));<span class="comment">//ä¼šå‘˜è®¢é˜…æ—¶é—´</span></span><br><span class="line">     user.setExpireTime(<span class="keyword">new</span> Date(expiryTimeMillis));<span class="comment">//ä¼šå‘˜åˆ°æœŸæ—¶é—´</span></span><br><span class="line">     <span class="keyword">if</span> (paymentState == <span class="number">1</span> || paymentState == <span class="number">2</span>) &#123;<span class="comment">//ä»˜æ¬¾çŠ¶æ€æˆ–è€…æ˜¯å¤„äºè¯•ç”¨æœŸ  1å·²æ”¶åˆ°ä»˜æ¬¾  2å…è´¹è¯•ç”¨</span></span><br><span class="line">         user.setType(<span class="number">1</span>);<span class="comment">//å¼ºè€…ä¼šå‘˜</span></span><br><span class="line">     &#125;</span><br><span class="line">     userService.updateUser(user);</span><br><span class="line">     log.info(<span class="string">"joinTime is&#123;&#125;,expireTime is &#123;&#125;"</span>, user.getJoinTime(), user.getExpireTime());</span><br><span class="line">     <span class="keyword">if</span> (subscriptionPurchase.getAcknowledgementState() == <span class="number">0</span>) &#123;<span class="comment">//å°šæœªå¾—åˆ°ç¡®è®¤</span></span><br><span class="line">         log.info(<span class="string">"ç¡®è®¤è®¢é˜…è®¢å•ã€‚ã€‚ã€‚ã€‚"</span>);</span><br><span class="line">         SubscriptionPurchasesAcknowledgeRequest subAckRe = <span class="keyword">new</span> SubscriptionPurchasesAcknowledgeRequest();</span><br><span class="line">         subAckRe.setDeveloperPayload(subscriptionPurchase.getDeveloperPayload());</span><br><span class="line">         AndroidPublisher.Purchases.Subscriptions.Acknowledge subAck = subscriptions.acknowledge(packageName, productId, purchaseToken, subAckRe);</span><br><span class="line">         subAck.execute();</span><br><span class="line">     &#125;</span><br><span class="line">     localOrder.setTransactionId(orderId);</span><br><span class="line">     localOrder.setStatus(<span class="number">1</span>);</span><br><span class="line">     localOrder.setProduct(pro);</span><br><span class="line">     localOrder.setType(type);<span class="comment">//è®¢é˜…</span></span><br><span class="line">     orderService.updateOrder(localOrder);</span><br><span class="line">     googlePayment.setAcknowledged(<span class="number">1</span>);</span><br><span class="line">     googlePayment.setPurchaseTime(<span class="keyword">new</span> Date(startTimeMillis));</span><br><span class="line">     googlePayment.setExpiresDate(<span class="keyword">new</span> Date(expiryTimeMillis));</span><br><span class="line">     googlePaymentService.update(googlePayment, pro, GooglePayment.Type.SubScribe);</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> ResultUtil&lt;&gt;().setSuccessMsg(<span class="keyword">this</span>.i18n(<span class="string">"successfully"</span>));</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@RequestMapping</span>(value = <span class="string">"/googleCancel"</span>, method = RequestMethod.POST)</span><br><span class="line"> <span class="meta">@ApiOperation</span>(value = <span class="string">"/å–æ¶ˆè®¢é˜…"</span>)</span><br><span class="line"> <span class="meta">@Authorization</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Result&lt;Object&gt; <span class="title">cancel</span><span class="params">(@RequestBody Pay.Purchase cancel, @CurrentUser User user)</span> </span>&#123;</span><br><span class="line">     String packageName = cancel.getPackageName();</span><br><span class="line">     String productId = cancel.getProductId();</span><br><span class="line">     String purchaseToken = cancel.getPurchaseToken();</span><br><span class="line">     log.info(<span class="string">"è°·æ­Œå–æ¶ˆè®¢é˜…ä¼ å‚,packageName is &#123;&#125;,productId is &#123;&#125;,purchaseToken is &#123;&#125;"</span>, packageName, productId, purchaseToken);</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">null</span> != cacheToken) &#123;</span><br><span class="line">         Long expires_in = Long.valueOf(cacheToken.get(<span class="string">"expires_in"</span>)); <span class="comment">// æœ‰æ•ˆæ—¶é•¿</span></span><br><span class="line">         Long create_time = Long.valueOf(cacheToken.get(<span class="string">"create_time"</span>)); <span class="comment">// access_tokençš„åˆ›å»ºæ—¶é—´</span></span><br><span class="line">         Long now_time = (<span class="keyword">new</span> Date().getTime()) / <span class="number">1000</span>;</span><br><span class="line">         <span class="keyword">if</span> (now_time &gt; (create_time + expires_in - <span class="number">300</span>)) &#123; <span class="comment">// æå‰äº”åˆ†é’Ÿé‡æ–°è·å–access_token</span></span><br><span class="line">             cacheToken = getAccessToken();</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         cacheToken = getAccessToken();</span><br><span class="line">     &#125;</span><br><span class="line">     String access_token = cacheToken.get(<span class="string">"access_token"</span>);</span><br><span class="line">     log.info(<span class="string">"accessToken is &#123;&#125;"</span>, access_token);</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">final</span> String client_id = googlePayConfig.getClient_id();</span><br><span class="line">         <span class="keyword">final</span> String client_secret = googlePayConfig.getClient_secret();</span><br><span class="line">         <span class="keyword">final</span> String refresh_token = googlePayConfig.getRefresh_token();</span><br><span class="line">         HttpTransport transport = GoogleNetHttpTransport.newTrustedTransport();</span><br><span class="line">         TokenResponse tokenResponse = <span class="keyword">new</span> TokenResponse();</span><br><span class="line">         tokenResponse.setAccessToken(access_token);</span><br><span class="line">         tokenResponse.setRefreshToken(refresh_token);</span><br><span class="line">         tokenResponse.setExpiresInSeconds(<span class="number">3600L</span>);</span><br><span class="line">         tokenResponse.setTokenType(<span class="string">"Bearer"</span>);</span><br><span class="line">         GoogleCredential credential = <span class="keyword">new</span> GoogleCredential.Builder()</span><br><span class="line">                 .setTransport(transport)</span><br><span class="line">                 .setJsonFactory(JacksonFactory.getDefaultInstance())</span><br><span class="line">                 .setClientSecrets(client_id, client_secret)</span><br><span class="line">                 .build()</span><br><span class="line">                 .setFromTokenResponse(tokenResponse);</span><br><span class="line">         AndroidPublisher publisher = <span class="keyword">new</span> AndroidPublisher.Builder(transport, JacksonFactory.getDefaultInstance(), credential).setApplicationName(packageName).build();</span><br><span class="line"></span><br><span class="line">         AndroidPublisher.Purchases.Subscriptions subscriptions = publisher.purchases().subscriptions();</span><br><span class="line">         AndroidPublisher.Purchases.Subscriptions.Get subscription = subscriptions.get(packageName, productId, purchaseToken);</span><br><span class="line">         SubscriptionPurchase subscriptionPurchase = subscription.execute();</span><br><span class="line">         log.info(<span class="string">"å–æ¶ˆè®¢é˜…çš„çš„è®¢é˜…ä¿¡æ¯ä¸º&#123;&#125;"</span>, subscriptionPurchase);</span><br><span class="line">         SubscriptionPurchasesAcknowledgeRequest subAckRe = <span class="keyword">new</span> SubscriptionPurchasesAcknowledgeRequest();</span><br><span class="line">         subAckRe.setDeveloperPayload(subscriptionPurchase.getDeveloperPayload());</span><br><span class="line">         AndroidPublisher.Purchases.Subscriptions.Cancel cancelSub = subscriptions.cancel(packageName, productId, purchaseToken);</span><br><span class="line">         cancelSub.execute();</span><br><span class="line">         log.info(<span class="string">"å–æ¶ˆè°·æ­Œè®¢é˜…æˆåŠŸ"</span>);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">         log.error(<span class="string">"exception is &#123;&#125;"</span>, e.getMessage());</span><br><span class="line">         <span class="keyword">throw</span> HttpRequestException.newI18N(<span class="string">"order.verification"</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> ResultUtil.success(<span class="keyword">this</span>.i18n(<span class="string">"successfully"</span>));</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">/*   @RequestMapping(value = "/googlePay", method = RequestMethod.POST)</span></span><br><span class="line"><span class="comment">    @ApiOperation(value = "è°·æ­Œæ”¯ä»˜æ–¹å¼äºŒï¼šé€šè¿‡è¯·æ±‚è°·æ­ŒapiéªŒè¯")</span></span><br><span class="line"><span class="comment">    @Authorization</span></span><br><span class="line"><span class="comment">    public Result&lt;Object&gt; googlePlay(@RequestBody Pay.Payment payment, @CurrentUser User user) &#123;</span></span><br><span class="line"><span class="comment">        String no = payment.getNo();</span></span><br><span class="line"><span class="comment">        Pay.Purchase receipt = payment.getPurchase();</span></span><br><span class="line"><span class="comment">        //å…ˆæ ¡å¯¹ä¸æœ¬åœ°è®¢å•</span></span><br><span class="line"><span class="comment">        Order localOrder = orderRepository.findByNo(no);//ç¦æ­¢é‡å¤åˆ·å•</span></span><br><span class="line"><span class="comment">        if (localOrder == null) &#123;</span></span><br><span class="line"><span class="comment">            return new ResultUtil&lt;&gt;().setErrorMsg(this.i18n("order.does.not.exist.and.recharge.failed"));</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        JSONObject jsonObject = null;</span></span><br><span class="line"><span class="comment">        try &#123;</span></span><br><span class="line"><span class="comment">            String json = JsonUtil.objectToJson(receipt);</span></span><br><span class="line"><span class="comment">            jsonObject = JSON.parseObject(json);</span></span><br><span class="line"><span class="comment">        &#125; catch (JSONException e) &#123;</span></span><br><span class="line"><span class="comment">            throw new HttpRequestException(HttpServletResponse.SC_NOT_ACCEPTABLE, this.i18n("data.parsing.failed"));//æ•°æ®è§£æå¤±è´¥</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        String productId = jsonObject.getString("productId");</span></span><br><span class="line"><span class="comment">        String packageName = jsonObject.getString("packageName");</span></span><br><span class="line"><span class="comment">        String purchaseToken = jsonObject.getString("purchaseToken");</span></span><br><span class="line"><span class="comment">        int purchaseState = jsonObject.getIntValue("purchaseState");</span></span><br><span class="line"><span class="comment">        String orderId = jsonObject.getString("orderId");</span></span><br><span class="line"><span class="comment">        log.info("productId:&#123;&#125;,packageName:&#123;&#125;,purchaseToken:&#123;&#125;,purchaseState:&#123;&#125;,orderId:&#123;&#125;",productId,packageName,purchaseToken,purchaseState,orderId);</span></span><br><span class="line"><span class="comment">        Order go = orderRepository.findByTransactionId(orderId);</span></span><br><span class="line"><span class="comment">        if (go!=null)&#123;</span></span><br><span class="line"><span class="comment">            throw new HttpRequestException(HttpServletResponse.SC_NOT_ACCEPTABLE,this.i18n("this.order.has.been.successfully.recharged.and.cannot.be.refilled"));</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        try &#123;</span></span><br><span class="line"><span class="comment">            File file = ResourceUtils.getFile("classpath:/googlePlayKey/rizin_p12.p12");</span></span><br><span class="line"><span class="comment">            HttpTransport transport = GoogleNetHttpTransport.newTrustedTransport();</span></span><br><span class="line"><span class="comment">            PrivateKey privateKey = SecurityUtils.loadPrivateKeyFromKeyStore(</span></span><br><span class="line"><span class="comment">                    SecurityUtils.getPkcs12KeyStore(),</span></span><br><span class="line"><span class="comment">                    new FileInputStream(file), // ç”Ÿæˆçš„P12æ–‡ä»¶</span></span><br><span class="line"><span class="comment">                    "notasecret", "privatekey", "notasecret");</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            GoogleCredential credential = new GoogleCredential.Builder()</span></span><br><span class="line"><span class="comment">                    .setTransport(transport).setJsonFactory(JacksonFactory.getDefaultInstance())</span></span><br><span class="line"><span class="comment">                    .setServiceAccountId(googlePayConfig.getServiceAccountEmail()) // e.g.: 626891557797-frclnjv31rn4ss81ch746g9t6pd3mmej@developer.gserviceaccount.com</span></span><br><span class="line"><span class="comment">                    .setServiceAccountScopes(AndroidPublisherScopes.all())</span></span><br><span class="line"><span class="comment">                    .setServiceAccountPrivateKey(privateKey).build();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            AndroidPublisher publisher = new AndroidPublisher.Builder(transport,</span></span><br><span class="line"><span class="comment">                    JacksonFactory.getDefaultInstance(), credential).build();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            AndroidPublisher.Purchases.Products products = publisher.purchases().products();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            // å‚æ•°è¯¦ç»†è¯´æ˜: https://developers.google.com/android-publisher/api-ref/purchases/products/get</span></span><br><span class="line"><span class="comment">            AndroidPublisher.Purchases.Products.Get product = products.get(packageName,</span></span><br><span class="line"><span class="comment">                    productId, purchaseToken);</span></span><br><span class="line"><span class="comment">            log.info("credential:&#123;&#125;,publisher:&#123;&#125;,products:&#123;&#125;,product:&#123;&#125;",credential,publisher,products,product);</span></span><br><span class="line"><span class="comment">            // è·å–è®¢å•ä¿¡æ¯</span></span><br><span class="line"><span class="comment">            // è¿”å›ä¿¡æ¯è¯´æ˜: https://developers.google.com/android-publisher/api-ref/purchases/products</span></span><br><span class="line"><span class="comment">            // é€šè¿‡consumptionState, purchaseStateå¯ä»¥åˆ¤æ–­è®¢å•çš„çŠ¶æ€</span></span><br><span class="line"><span class="comment">            ProductPurchase purchase = product.execute();</span></span><br><span class="line"><span class="comment">            log.info("purchaseis : &#123;&#125;",purchase);</span></span><br><span class="line"><span class="comment">            if (purchase.getPurchaseState()==0) &#123;</span></span><br><span class="line"><span class="comment">                Product pro = productService.getByProductId(productId);</span></span><br><span class="line"><span class="comment">                int amount = pro.getAmount();</span></span><br><span class="line"><span class="comment">                BigDecimal price = pro.getPrice();</span></span><br><span class="line"><span class="comment">                int coin = user.getCoin() + amount;</span></span><br><span class="line"><span class="comment">                user.setCoin(coin);</span></span><br><span class="line"><span class="comment">                userService.updateUser(user);//æ›´æ–°ç”¨æˆ·coin</span></span><br><span class="line"><span class="comment">                localOrder.setTransactionId(orderId);</span></span><br><span class="line"><span class="comment">                localOrder.setStatus(1);</span></span><br><span class="line"><span class="comment">                //todo::å……å€¼ç±»å‹æ˜¯æ¶ˆè€—å‹è¿˜æ˜¯è®¢é˜…å‹ typeèµ‹å€¼</span></span><br><span class="line"><span class="comment">                localOrder.setProductId(pro.getId());</span></span><br><span class="line"><span class="comment">                orderService.updateOrder(localOrder);</span></span><br><span class="line"><span class="comment">                return new ResultUtil&lt;&gt;().setData(coin);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125; catch (Exception e) &#123;</span></span><br><span class="line"><span class="comment">            throw new HttpRequestException(HttpServletResponse.SC_NOT_ACCEPTABLE, this.i18n("order.verification"));</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        return new ResultUtil&lt;&gt;().setErrorMsg(this.i18n("order.verification"));</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> Map&lt;String, String&gt; <span class="title">getAccessToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     String client_id = googlePayConfig.getClient_id();</span><br><span class="line">     String client_secret = googlePayConfig.getClient_secret();</span><br><span class="line">     String refresh_token = googlePayConfig.getRefresh_token();</span><br><span class="line">     Map&lt;String, String&gt; headers = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">     Map&lt;String, String&gt; querys = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">     Map&lt;String, String&gt; map = <span class="keyword">null</span>;</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// HTTP è·å–access_token</span></span><br><span class="line">         String url = <span class="string">"https://accounts.google.com/o/oauth2/token"</span>;</span><br><span class="line">         headers.put(<span class="string">"Content-Type"</span>, <span class="string">"application/x-www-form-urlencoded; charset=utf-8"</span>);</span><br><span class="line">         headers.put(<span class="string">"Accept"</span>, <span class="string">"text/plain;charset=utf-8"</span>);</span><br><span class="line">         querys.put(<span class="string">"grant_type"</span>, <span class="string">"refresh_token"</span>);</span><br><span class="line">         querys.put(<span class="string">"client_id"</span>, client_id);</span><br><span class="line">         querys.put(<span class="string">"client_secret"</span>, client_secret);</span><br><span class="line">         querys.put(<span class="string">"refresh_token"</span>, refresh_token);</span><br><span class="line">         String googleAccessToken = HttpUtils.send(url, headers, querys, <span class="string">"UTF-8"</span>);</span><br><span class="line">         JSONObject tokenObject = JSON.parseObject(googleAccessToken);</span><br><span class="line">         String access_token = tokenObject.getString(<span class="string">"access_token"</span>);</span><br><span class="line">         Long expires_in = tokenObject.getLong(<span class="string">"expires_in"</span>);</span><br><span class="line">         map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">         map.put(<span class="string">"access_token"</span>, access_token);</span><br><span class="line">         map.put(<span class="string">"expires_in"</span>, String.valueOf(expires_in));</span><br><span class="line">         <span class="comment">// å¸¦å…¥access_tokençš„åˆ›å»ºæ—¶é—´ï¼Œç”¨äºä¹‹ååˆ¤æ–­æ˜¯å¦å¤±æ•ˆ</span></span><br><span class="line">         map.put(<span class="string">"create_time"</span>, String.valueOf((<span class="keyword">new</span> Date().getTime()) / <span class="number">1000</span>));</span><br><span class="line">         log.info(<span class="string">"åŒ…å«access_tokençš„JSONä¿¡æ¯ä¸º: &#123;&#125;"</span>, tokenObject);</span><br><span class="line">     &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">         log.error(<span class="string">"è·å–access_tokenå¤±è´¥,åŸå› æ˜¯:&#123;&#125;"</span>, e);</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">     &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">         log.error(<span class="string">"è·å–access_tokenå¤±è´¥,åŸå› æ˜¯:&#123;&#125;"</span>, e);</span><br><span class="line">         e.printStackTrace();</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> map;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p><code>Pay.java</code>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xy.goone.modules.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> fumei.jiang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019-12-05 16:05</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Pay</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Payment</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> type;<span class="comment">//ç±»å‹ï¼š0æ¶ˆè€— 1è®¢é˜…</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String no;<span class="comment">//æœ¬åœ°è®¢å•å·</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Purchase purchase;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Payment</span><span class="params">(<span class="keyword">int</span> type, String no, Purchase purchase)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.type = type;</span><br><span class="line">            <span class="keyword">this</span>.no = no;</span><br><span class="line">            <span class="keyword">this</span>.purchase = purchase;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> type;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setType</span><span class="params">(<span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.type = type;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getNo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> no;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNo</span><span class="params">(String no)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.no = no;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Purchase <span class="title">getPurchase</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> purchase;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPurchase</span><span class="params">(Purchase purchase)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.purchase = purchase;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Purchase</span> </span>&#123;</span><br><span class="line">         <span class="keyword">private</span> String productId;</span><br><span class="line">         <span class="keyword">private</span> String purchaseToken;</span><br><span class="line">         <span class="keyword">private</span> String purchaseState;</span><br><span class="line">         <span class="keyword">private</span> String packageName;</span><br><span class="line">         <span class="keyword">private</span> String orderId;</span><br><span class="line">         <span class="keyword">private</span> <span class="keyword">boolean</span> acknowledged;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">public</span> String <span class="title">getPurchaseToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">             <span class="keyword">return</span> purchaseToken;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPurchaseToken</span><span class="params">(String purchaseToken)</span> </span>&#123;</span><br><span class="line">             <span class="keyword">this</span>.purchaseToken = purchaseToken;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">public</span> String <span class="title">getPurchaseState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">             <span class="keyword">return</span> purchaseState;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPurchaseState</span><span class="params">(String purchaseState)</span> </span>&#123;</span><br><span class="line">             <span class="keyword">this</span>.purchaseState = purchaseState;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">public</span> String <span class="title">getPackageName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">             <span class="keyword">return</span> packageName;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPackageName</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">             <span class="keyword">this</span>.packageName = packageName;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">public</span> String <span class="title">getOrderId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">             <span class="keyword">return</span> orderId;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrderId</span><span class="params">(String orderId)</span> </span>&#123;</span><br><span class="line">             <span class="keyword">this</span>.orderId = orderId;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">public</span> String <span class="title">getProductId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">             <span class="keyword">return</span> productId;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProductId</span><span class="params">(String productId)</span> </span>&#123;</span><br><span class="line">             <span class="keyword">this</span>.productId = productId;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAcknowledged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">             <span class="keyword">return</span> acknowledged;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAcknowledged</span><span class="params">(<span class="keyword">boolean</span> acknowledged)</span> </span>&#123;</span><br><span class="line">             <span class="keyword">this</span>.acknowledged = acknowledged;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<p>å¥½å•¦ï¼ŒåŸºæœ¬ä»£ç å·®ä¸å¤šå°±æ˜¯è¿™äº›äº†ã€‚åœ¨å¯¹æ¥è¿‡ç¨‹ä¸­ï¼Œæˆ‘åˆå‡ ç‚¹è¦æç¤ºçš„ã€‚</p>
<h2 id="Tips">Tips</h2>
<ul>
<li>è°·æ­Œæµ‹è¯•è´¦å·ä¸‹å•äº”åˆ†é’Ÿå†…æ²¡æœ‰ä»»ä½•æ“ä½œæ¯”å¦‚éªŒè¯ç¡®è®¤æ¶ˆè€—å°±ä¼šè‡ªåŠ¨å–æ¶ˆè¯¥è®¢å•ï¼Œæ¶ˆè€—å‹çš„äº§å“éœ€åœ¨ä¸‰å¤©å†…ç¡®è®¤è®¢å•ï¼Œå¦åˆ™æ­¤è®¢å•æ— æ•ˆã€‚</li>
<li>ç¡®è®¤è®¢å•å¯ä»¥åœ¨æœåŠ¡ç«¯æˆ–å®¢æˆ·ç«¯è¿›è¡Œï¼Œä½†æ˜¯æ¶ˆè€—å‹å•†å“éœ€è¦è¿›è¡Œæ¶ˆè€—(è®¢é˜…å‹å•†å“ä¸éœ€è¦è¿›è¡Œæ¶ˆè€—),æœåŠ¡ç«¯åªèƒ½ç¡®è®¤ä¸èƒ½æ¶ˆè€—äº§å“ï¼ŒéªŒè¯å¹¶ç¡®è®¤å®Œæ¯•çš„äº§å“éœ€è¦å®¢æˆ·ç«¯è¿›è¡Œæ¶ˆè€—ï¼Œå¦åˆ™ä¸‹æ¬¡è´­ä¹°æ—¶å°†ä¸å…è®¸å†æ¬¡è´­ä¹°ã€‚</li>
<li>è°·æ­Œæ”¯ä»˜ç”Ÿäº§è®¢é˜…å’Œæµ‹è¯•è®¢é˜…çš„å‘¨æœŸä¸åŒï¼Œå¦‚ä¸‹å›¾ï¼š<br>
<img src="/images/googlepay11.png" alt=""></li>
<li>å¦‚æœæ˜¯æµ‹è¯•è´¦å·çš„è®¢é˜…ï¼Œæœ€å¤šå¯ç»­è®¢6æ¬¡ã€‚<br>
å¦‚æœæ˜¯ç”¨æµ‹è¯•è´¦å·æ¥è¿›è¡Œè®¢é˜…çš„è¯ï¼Œå› ä¸ºå‘¨æœŸéå¸¸çŸ­ï¼Œä¸€ä¸ªæœˆå¾ªç¯5åˆ†é’Ÿå°±ä¼šåˆ°æœŸï¼Œè€Œä¸€å¹´çš„å¾ªç¯30åˆ†é’Ÿåˆ†é’Ÿå°±ä¼šåˆ°æœŸã€‚<br>
è€Œä¸”è¿™ç§æµ‹è¯•è®¢é˜…æœ€å¤šå¯ç»­è®¢6æ¬¡ï¼Œä¹Ÿå°±æ˜¯ä»åˆšå¼€å§‹è®¢é˜… {subId} åˆ° {subId}â€¦5 è¿™æ ·å­ï¼Œæœ€å¤š6å•è¿‡æ¥ä¹‹åï¼Œæ¥ä¸‹æ¥ google é‚£è¾¹å°±ä¼šå‘è¿‡æ¥å–æ¶ˆå¾ªç¯çš„ webhook äº†ï¼Œç„¶åå°±å–æ¶ˆå¾ªç¯äº†ã€‚<br>
å…·ä½“çš„æ–‡æ¡£ï¼š<a href="https://developer.android.com/google/play/billing/billing_testing#testing-renewals" target="_blank" rel="noopener">æµ‹è¯•è®¢é˜…ç»­è®¢</a><br>
æ„Ÿè°¢æ‚¨çš„æµè§ˆï¼Œå¸Œæœ›å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ï¼</li>
</ul>
<p><a href="https://kebingzao.com/2018/08/09/google-iap-gcp-webhook/" target="_blank" rel="noopener">Google iap webhook æ¥å…¥(2) - é¡¹ç›®æ¥å…¥GCP webhook</a></p>
]]></content>
      <categories>
        <category>ç¬¬ä¸‰æ–¹</category>
      </categories>
      <tags>
        <tag>ç¬¬ä¸‰æ–¹</tag>
        <tag>Google Play</tag>
      </tags>
  </entry>
  <entry>
    <title>RabbitMq</title>
    <url>/2019/12/08/RabbitMq/</url>
    <content><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—">ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—</h2>
<p>â€œæ¶ˆæ¯é˜Ÿåˆ—(Message Queue)â€æ˜¯åœ¨æ¶ˆæ¯çš„ä¼ è¾“è¿‡ç¨‹ä¸­ä¿å­˜æ¶ˆæ¯çš„å®¹å™¨ã€‚åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œé€šå¸¸æœ‰ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¸¤ä¸ªè§’è‰²ã€‚ç”Ÿäº§è€…åªè´Ÿè´£å‘é€æ•°æ®åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè°ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºæ•°æ®å¤„ç†ï¼Œä»–ä¸ç®¡ã€‚æ¶ˆè´¹è€…åªè´Ÿè´£ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºæ•°æ®å¤„ç†ï¼Œä»–ä¸ç®¡è¿™æ˜¯è°å‘é€çš„æ•°æ®ã€‚<br>
<img src="/images/rabbitmq.jpg" alt=""></p>
<a id="more"></a>
<h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—">ä¸ºä»€ä¹ˆä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—</h2>
<p>ä¸»è¦æœ‰ä¸‰ä¸ªä½œç”¨ï¼š</p>
<h3 id="è§£è€¦">* è§£è€¦</h3>
<p>å°†æ¶ˆæ¯å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œéœ€è¦æ¶ˆæ¯çš„ç³»ç»Ÿè‡ªå·±ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è®¢é˜…,ä»è€Œç³»ç»ŸAä¸éœ€è¦åšä»»ä½•ä¿®æ”¹</p>
<h3 id="å¼‚æ­¥">* å¼‚æ­¥</h3>
<p>å°†æ¶ˆæ¯å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œéå¿…è¦çš„ä¸šåŠ¡é€»è¾‘ä»¥å¼‚æ­¥çš„æ–¹å¼è¿è¡Œï¼ŒåŠ å¿«å“åº”é€Ÿåº¦</p>
<h3 id="å‰Šå³°">* å‰Šå³°</h3>
<p>ç³»ç»ŸAæ…¢æ…¢çš„æŒ‰ç…§æ•°æ®åº“èƒ½å¤„ç†çš„å¹¶å‘é‡ï¼Œä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ…¢æ…¢æ‹‰å–æ¶ˆæ¯ã€‚åœ¨ç”Ÿäº§ä¸­ï¼Œè¿™ä¸ªçŸ­æš‚çš„é«˜å³°æœŸç§¯å‹æ˜¯å…è®¸çš„ã€‚</p>
<h2 id="ä¸»æµçš„MQï¼Œå¦‚ï¼škafkaã€rabbitmqã€rocketmqã€activemq">ä¸»æµçš„MQï¼Œå¦‚ï¼škafkaã€rabbitmqã€rocketmqã€activemq</h2>
<p><img src="/images/messageque.jpg" alt=""></p>
<h2 id="æ¶ˆæ¯é˜Ÿåˆ—çš„ç¼ºç‚¹">æ¶ˆæ¯é˜Ÿåˆ—çš„ç¼ºç‚¹</h2>
<ol>
<li>ç³»ç»Ÿå¯ç”¨æ€§é™ä½:<br>
æœ¬æ¥å…¶ä»–ç³»ç»Ÿåªè¦è¿è¡Œå¥½å¥½çš„ï¼Œé‚£ä½ çš„ç³»ç»Ÿå°±æ˜¯æ­£å¸¸çš„ã€‚ç°åœ¨ä½ éè¦åŠ ä¸ªæ¶ˆæ¯é˜Ÿåˆ—è¿›å»ï¼Œé‚£æ¶ˆæ¯é˜Ÿåˆ—æŒ‚äº†ï¼Œä½ çš„ç³»ç»Ÿä¸æ˜¯å‘µå‘µäº†ã€‚å› æ­¤ï¼Œç³»ç»Ÿå¯ç”¨æ€§é™ä½</li>
<li>ç³»ç»Ÿå¤æ‚æ€§å¢åŠ :<br>
è¦å¤šè€ƒè™‘å¾ˆå¤šæ–¹é¢çš„é—®é¢˜ï¼Œæ¯”å¦‚ä¸€è‡´æ€§é—®é¢˜ã€å¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹ï¼Œå¦‚ä½•ä¿è¯ä¿è¯æ¶ˆæ¯å¯é ä¼ è¾“ã€‚å› æ­¤ï¼Œéœ€è¦è€ƒè™‘çš„ä¸œè¥¿æ›´å¤šï¼Œç³»ç»Ÿå¤æ‚æ€§å¢å¤§ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬è¯¥ç”¨è¿˜æ˜¯è¦ç”¨çš„ã€‚</li>
</ol>
<h2 id="RabbitMQé‡è¦ç»„ä»¶">RabbitMQé‡è¦ç»„ä»¶</h2>
<ul>
<li>ConnectionFactoryï¼ˆè¿æ¥ç®¡ç†å™¨ï¼‰ï¼šåº”ç”¨ç¨‹åºä¸Rabbitä¹‹é—´å»ºç«‹è¿æ¥çš„ç®¡ç†å™¨ï¼Œç¨‹åºä»£ç ä¸­ä½¿ç”¨ã€‚</li>
<li>Channelï¼ˆä¿¡é“ï¼‰ï¼šæ¶ˆæ¯æ¨é€ä½¿ç”¨çš„é€šé“ã€‚</li>
<li>Exchangeï¼ˆäº¤æ¢å™¨ï¼‰ï¼šç”¨äºæ¥å—ã€åˆ†é…æ¶ˆæ¯ã€‚</li>
<li>Queueï¼ˆé˜Ÿåˆ—ï¼‰ï¼šç”¨äºå­˜å‚¨ç”Ÿäº§è€…çš„æ¶ˆæ¯ã€‚RoutingKeyï¼ˆè·¯ç”±é”®ï¼‰ï¼šç”¨äºæŠŠç”Ÿæˆè€…çš„æ•°æ®åˆ†é…åˆ°äº¤æ¢å™¨ä¸Šã€‚BindingKeyï¼ˆç»‘å®šé”®ï¼‰ï¼šç”¨äºæŠŠäº¤æ¢å™¨çš„æ¶ˆæ¯ç»‘å®šåˆ°é˜Ÿåˆ—ä¸Šã€‚</li>
<li>RoutingKeyï¼ˆè·¯ç”±é”®ï¼‰ï¼šç”¨äºæŠŠç”Ÿæˆè€…çš„æ•°æ®åˆ†é…åˆ°äº¤æ¢å™¨ä¸Šã€‚</li>
<li>BindingKeyï¼ˆç»‘å®šé”®ï¼‰ï¼šç”¨äºæŠŠäº¤æ¢å™¨çš„æ¶ˆæ¯ç»‘å®šåˆ°é˜Ÿåˆ—ä¸Šã€‚<br>
æ¶ˆæ¯æ¨é€åˆ°æ¥æ”¶çš„è¿‡ç¨‹ï¼š<br>
<img src="/images/producer-consumer.png" alt=""><br>
é»„è‰²çš„åœˆåœˆå°±æ˜¯æˆ‘ä»¬çš„æ¶ˆæ¯æ¨é€æœåŠ¡ï¼Œå°†æ¶ˆæ¯æ¨é€åˆ° ä¸­é—´æ–¹æ¡†é‡Œé¢ä¹Ÿå°±æ˜¯ rabbitMqçš„æœåŠ¡å™¨ï¼Œç„¶åç»è¿‡æœåŠ¡å™¨é‡Œé¢çš„äº¤æ¢æœºã€é˜Ÿåˆ—ç­‰å„ç§å…³ç³»ï¼ˆåé¢ä¼šè¯¦ç»†è®²ï¼‰å°†æ•°æ®å¤„ç†å…¥åˆ—åï¼Œæœ€ç»ˆå³è¾¹çš„è“è‰²åœˆåœˆæ¶ˆè´¹è€…è·å–å¯¹åº”ç›‘å¬çš„æ¶ˆæ¯ã€‚<br>
å¸¸ç”¨çš„äº¤æ¢æœºæœ‰ä»¥ä¸‹ä¸‰ç§ï¼Œå› ä¸ºæ¶ˆè´¹è€…æ˜¯ä»é˜Ÿåˆ—è·å–ä¿¡æ¯çš„ï¼Œé˜Ÿåˆ—æ˜¯ç»‘å®šäº¤æ¢æœºçš„ï¼ˆä¸€èˆ¬ï¼‰ï¼Œæ‰€ä»¥å¯¹åº”çš„æ¶ˆæ¯æ¨é€/æ¥æ”¶æ¨¡å¼ä¹Ÿä¼šæœ‰ä»¥ä¸‹å‡ ç§ï¼š</li>
</ul>
<h4 id="Direct-Exchange">Direct Exchange</h4>
<p>ç›´è¿å‹äº¤æ¢æœºï¼Œæ ¹æ®æ¶ˆæ¯æºå¸¦çš„è·¯ç”±é”®å°†æ¶ˆæ¯æŠ•é€’ç»™å¯¹åº”é˜Ÿåˆ—ã€‚<br>
å¤§è‡´æµç¨‹ï¼Œæœ‰ä¸€ä¸ªé˜Ÿåˆ—ç»‘å®šåˆ°ä¸€ä¸ªç›´è¿äº¤æ¢æœºä¸Šï¼ŒåŒæ—¶èµ‹äºˆä¸€ä¸ªè·¯ç”±é”® routing key ã€‚<br>
ç„¶åå½“ä¸€ä¸ªæ¶ˆæ¯æºå¸¦ç€è·¯ç”±å€¼ä¸ºXï¼Œè¿™ä¸ªæ¶ˆæ¯é€šè¿‡ç”Ÿäº§è€…å‘é€ç»™äº¤æ¢æœºæ—¶ï¼Œäº¤æ¢æœºå°±ä¼šæ ¹æ®è¿™ä¸ªè·¯ç”±å€¼Xå»å¯»æ‰¾ç»‘å®šå€¼ä¹Ÿæ˜¯Xçš„é˜Ÿåˆ—ã€‚</p>
<h4 id="Fanout-Exchange">Fanout Exchange</h4>
<p>æ‰‡å‹äº¤æ¢æœºï¼Œè¿™ä¸ªäº¤æ¢æœºæ²¡æœ‰è·¯ç”±é”®æ¦‚å¿µï¼Œå°±ç®—ä½ ç»‘äº†è·¯ç”±é”®ä¹Ÿæ˜¯æ— è§†çš„ã€‚ è¿™ä¸ªäº¤æ¢æœºåœ¨æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œä¼šç›´æ¥è½¬å‘åˆ°ç»‘å®šåˆ°å®ƒä¸Šé¢çš„æ‰€æœ‰é˜Ÿåˆ—ã€‚</p>
<h4 id="Topic-Exchange">Topic Exchange</h4>
<p>ä¸»é¢˜äº¤æ¢æœºï¼Œè¿™ä¸ªäº¤æ¢æœºå…¶å®è·Ÿç›´è¿äº¤æ¢æœºæµç¨‹å·®ä¸å¤šï¼Œä½†æ˜¯å®ƒçš„ç‰¹ç‚¹å°±æ˜¯åœ¨å®ƒçš„è·¯ç”±é”®å’Œç»‘å®šé”®ä¹‹é—´æ˜¯æœ‰è§„åˆ™çš„ã€‚<br>
ç®€å•åœ°ä»‹ç»ä¸‹è§„åˆ™ï¼š<br>
â€˜*â€™(æ˜Ÿå·) ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªå•è¯ (å¿…é¡»å‡ºç°çš„)<br>
â€˜#â€™(äº•å·) ç”¨æ¥è¡¨ç¤ºä»»æ„æ•°é‡ï¼ˆé›¶ä¸ªæˆ–å¤šä¸ªï¼‰å•è¯<br>
é€šé…çš„ç»‘å®šé”®æ˜¯è·Ÿé˜Ÿåˆ—è¿›è¡Œç»‘å®šçš„ï¼Œä¸¾ä¸ªå°ä¾‹å­<br>
é˜Ÿåˆ—Q1 ç»‘å®šé”®ä¸º <em>.TT.</em>ï¼Œé˜Ÿåˆ—Q2ç»‘å®šé”®ä¸º  TT.#<br>
å¦‚æœä¸€æ¡æ¶ˆæ¯æºå¸¦çš„è·¯ç”±é”®ä¸º A.TT.Bï¼Œé‚£ä¹ˆé˜Ÿåˆ—Q1å°†ä¼šæ”¶åˆ°ï¼›<br>
<a href="http://xn--TT-uu2cyis92cyrg89d7xjqsh2qag53cpvv53d9v2ibzwa.AA.BB" target="_blank" rel="noopener">å¦‚æœä¸€æ¡æ¶ˆæ¯æºå¸¦çš„è·¯ç”±é”®ä¸ºTT.AA.BB</a>ï¼Œé‚£ä¹ˆé˜Ÿåˆ—Q2å°†ä¼šæ”¶åˆ°ï¼›</p>
<h2 id="æ¶ˆæ¯äº¤æ¢å™¨">æ¶ˆæ¯äº¤æ¢å™¨</h2>
<p>RabbitMQæ¶ˆæ¯äº¤æ¢å™¨éœ€è¦é‡ç‚¹æ³¨æ„çš„æ˜¯RabbitMQæ”¯æŒä¸´æ—¶å’ŒæŒä¹…ä¸¤ç§è®¢é˜…ç±»å‹ã€‚æ¶ˆè´¹è€…å¯ä»¥è°ƒç”¨RabbitMQçš„APIæ¥é€‰æ‹©ä»–ä»¬æƒ³è¦çš„è®¢é˜…ç±»å‹ã€‚æ ¹æ®RabbitMQçš„æ¶æ„è®¾è®¡ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ›å»ºä¸€ç§æ··åˆæ–¹æ³•â€”â€”è®¢é˜…è€…ä»¥ç»„é˜Ÿçš„æ–¹å¼ç„¶ååœ¨ç»„å†…ä»¥ç«äº‰å…³ç³»ä½œä¸ºæ¶ˆè´¹è€…å»å¤„ç†æŸä¸ªå…·ä½“é˜Ÿåˆ—ä¸Šçš„æ¶ˆæ¯ï¼Œè¿™ç§ç”±è®¢é˜…è€…æ„æˆçš„ç»„æˆ‘ä»¬ç§°ä¸ºæ¶ˆè´¹è€…ç»„ã€‚æŒ‰ç…§è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å®ç°äº†å‘å¸ƒ/è®¢é˜…æ¨¡å¼ï¼ŒåŒæ—¶ä¹Ÿèƒ½å¤Ÿå¾ˆå¥½çš„ä¼¸ç¼©ï¼ˆscale-upï¼‰è®¢é˜…è€…å»å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯ã€‚</p>
<h2 id="RabbitMqçš„é«˜å¯ç”¨æ€§">RabbitMqçš„é«˜å¯ç”¨æ€§</h2>
<p>RabbitMQ æ˜¯æ¯”è¾ƒæœ‰ä»£è¡¨æ€§çš„ï¼Œå› ä¸ºæ˜¯åŸºäºä¸»ä»ï¼ˆéåˆ†å¸ƒå¼ï¼‰åšé«˜å¯ç”¨æ€§çš„<br>
RabbitMQ æœ‰ä¸‰ç§æ¨¡å¼ï¼šå•æœºæ¨¡å¼ã€æ™®é€šé›†ç¾¤æ¨¡å¼ã€é•œåƒé›†ç¾¤æ¨¡å¼ã€‚</p>
<h3 id="å•æœºæ¨¡å¼">å•æœºæ¨¡å¼</h3>
<p>å•æœºæ¨¡å¼ï¼Œå°±æ˜¯ Demo çº§åˆ«çš„ï¼Œä¸€èˆ¬å°±æ˜¯ä½ æœ¬åœ°å¯åŠ¨äº†ç©ç©å„¿çš„ ï¼Œæ²¡äººç”Ÿäº§ç”¨å•æœºæ¨¡å¼ã€‚</p>
<h3 id="æ™®é€šé›†ç¾¤æ¨¡å¼ï¼ˆæ— é«˜å¯ç”¨æ€§ï¼‰">æ™®é€šé›†ç¾¤æ¨¡å¼ï¼ˆæ— é«˜å¯ç”¨æ€§ï¼‰</h3>
<p>æ™®é€šé›†ç¾¤æ¨¡å¼ï¼Œæ„æ€å°±æ˜¯åœ¨å¤šå°æœºå™¨ä¸Šå¯åŠ¨å¤šä¸ª RabbitMQ å®ä¾‹ï¼Œæ¯ä¸ªæœºå™¨å¯åŠ¨ä¸€ä¸ªã€‚ä½ åˆ›å»ºçš„ queueï¼Œåªä¼šæ”¾åœ¨ä¸€ä¸ª RabbitMQ å®ä¾‹ä¸Šï¼Œä½†æ˜¯æ¯ä¸ªå®ä¾‹éƒ½åŒæ­¥ queue çš„å…ƒæ•°æ®ï¼ˆå…ƒæ•°æ®å¯ä»¥è®¤ä¸ºæ˜¯ queue çš„ä¸€äº›é…ç½®ä¿¡æ¯ï¼Œé€šè¿‡å…ƒæ•°æ®ï¼Œå¯ä»¥æ‰¾åˆ° queue æ‰€åœ¨å®ä¾‹ï¼‰ã€‚ä½ æ¶ˆè´¹çš„æ—¶å€™ï¼Œå®é™…ä¸Šå¦‚æœè¿æ¥åˆ°äº†å¦å¤–ä¸€ä¸ªå®ä¾‹ï¼Œé‚£ä¹ˆé‚£ä¸ªå®ä¾‹ä¼šä» queue æ‰€åœ¨å®ä¾‹ä¸Šæ‹‰å–æ•°æ®è¿‡æ¥ã€‚<br>
<img src="/images/ptjq.jpg" alt=""><br>
è¿™ç§æ–¹å¼ç¡®å®å¾ˆéº»çƒ¦ï¼Œä¹Ÿä¸æ€ä¹ˆå¥½ï¼Œæ²¡åšåˆ°æ‰€è°“çš„åˆ†å¸ƒå¼ï¼Œå°±æ˜¯ä¸ªæ™®é€šé›†ç¾¤ã€‚å› ä¸ºè¿™å¯¼è‡´ä½ è¦ä¹ˆæ¶ˆè´¹è€…æ¯æ¬¡éšæœºè¿æ¥ä¸€ä¸ªå®ä¾‹ç„¶åæ‹‰å–æ•°æ®ï¼Œè¦ä¹ˆå›ºå®šè¿æ¥é‚£ä¸ª queue æ‰€åœ¨å®ä¾‹æ¶ˆè´¹æ•°æ®ï¼Œå‰è€…æœ‰æ•°æ®æ‹‰å–çš„å¼€é”€ï¼Œåè€…å¯¼è‡´å•å®ä¾‹æ€§èƒ½ç“¶é¢ˆã€‚<br>
è€Œä¸”å¦‚æœé‚£ä¸ªæ”¾ queue çš„å®ä¾‹å®•æœºäº†ï¼Œä¼šå¯¼è‡´æ¥ä¸‹æ¥å…¶ä»–å®ä¾‹å°±æ— æ³•ä»é‚£ä¸ªå®ä¾‹æ‹‰å–ï¼Œå¦‚æœä½ å¼€å¯äº†æ¶ˆæ¯æŒä¹…åŒ–ï¼Œè®© RabbitMQ è½åœ°å­˜å‚¨æ¶ˆæ¯çš„è¯ï¼Œæ¶ˆæ¯ä¸ä¸€å®šä¼šä¸¢ï¼Œå¾—ç­‰è¿™ä¸ªå®ä¾‹æ¢å¤äº†ï¼Œç„¶åæ‰å¯ä»¥ç»§ç»­ä»è¿™ä¸ª queue æ‹‰å–æ•°æ®ã€‚<br>
æ‰€ä»¥è¿™ä¸ªäº‹å„¿å°±æ¯”è¾ƒå°´å°¬äº†ï¼Œè¿™å°±æ²¡æœ‰ä»€ä¹ˆæ‰€è°“çš„é«˜å¯ç”¨æ€§ï¼Œè¿™æ–¹æ¡ˆä¸»è¦æ˜¯æé«˜ååé‡çš„ï¼Œå°±æ˜¯è¯´è®©é›†ç¾¤ä¸­å¤šä¸ªèŠ‚ç‚¹æ¥æœåŠ¡æŸä¸ª queue çš„è¯»å†™æ“ä½œã€‚</p>
<h3 id="é•œåƒé›†ç¾¤æ¨¡å¼ï¼ˆé«˜å¯ç”¨æ€§ï¼‰">é•œåƒé›†ç¾¤æ¨¡å¼ï¼ˆé«˜å¯ç”¨æ€§ï¼‰</h3>
<p>RabbitMQ çš„é«˜å¯ç”¨æ¨¡å¼ã€‚è·Ÿæ™®é€šé›†ç¾¤æ¨¡å¼ä¸ä¸€æ ·çš„æ˜¯ï¼Œåœ¨é•œåƒé›†ç¾¤æ¨¡å¼ä¸‹ï¼Œä½ åˆ›å»ºçš„ queueï¼Œæ— è®ºå…ƒæ•°æ®è¿˜æ˜¯ queue é‡Œçš„æ¶ˆæ¯éƒ½ä¼šå­˜åœ¨äºå¤šä¸ªå®ä¾‹ä¸Šï¼Œå°±æ˜¯è¯´ï¼Œæ¯ä¸ª RabbitMQ èŠ‚ç‚¹éƒ½æœ‰è¿™ä¸ª queue çš„ä¸€ä¸ªå®Œæ•´é•œåƒï¼ŒåŒ…å« queue çš„å…¨éƒ¨æ•°æ®çš„æ„æ€ã€‚ç„¶åæ¯æ¬¡ä½ å†™æ¶ˆæ¯åˆ° queue çš„æ—¶å€™ï¼Œéƒ½ä¼šè‡ªåŠ¨æŠŠæ¶ˆæ¯åŒæ­¥åˆ°å¤šä¸ªå®ä¾‹çš„ queue ä¸Šã€‚<br>
<img src="/images/rmgky.jpg" alt=""><br>
é‚£ä¹ˆå¦‚ä½•å¼€å¯è¿™ä¸ªé•œåƒé›†ç¾¤æ¨¡å¼å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼ŒRabbitMQ æœ‰å¾ˆå¥½çš„ç®¡ç†æ§åˆ¶å°ï¼Œå°±æ˜¯åœ¨åå°æ–°å¢ä¸€ä¸ªç­–ç•¥ï¼Œè¿™ä¸ªç­–ç•¥æ˜¯é•œåƒé›†ç¾¤æ¨¡å¼çš„ç­–ç•¥ï¼ŒæŒ‡å®šçš„æ—¶å€™æ˜¯å¯ä»¥è¦æ±‚æ•°æ®åŒæ­¥åˆ°æ‰€æœ‰èŠ‚ç‚¹çš„ï¼Œä¹Ÿå¯ä»¥è¦æ±‚åŒæ­¥åˆ°æŒ‡å®šæ•°é‡çš„èŠ‚ç‚¹ï¼Œå†æ¬¡åˆ›å»º queue çš„æ—¶å€™ï¼Œåº”ç”¨è¿™ä¸ªç­–ç•¥ï¼Œå°±ä¼šè‡ªåŠ¨å°†æ•°æ®åŒæ­¥åˆ°å…¶ä»–çš„èŠ‚ç‚¹ä¸Šå»äº†ã€‚<br>
è¿™æ ·çš„è¯ï¼Œå¥½å¤„åœ¨äºï¼Œä½ ä»»ä½•ä¸€ä¸ªæœºå™¨å®•æœºäº†ï¼Œæ²¡äº‹å„¿ï¼Œå…¶å®ƒæœºå™¨ï¼ˆèŠ‚ç‚¹ï¼‰è¿˜åŒ…å«äº†è¿™ä¸ª queue çš„å®Œæ•´æ•°æ®ï¼Œåˆ«çš„ consumer éƒ½å¯ä»¥åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Šå»æ¶ˆè´¹æ•°æ®ã€‚åå¤„åœ¨äºï¼Œç¬¬ä¸€ï¼Œè¿™ä¸ªæ€§èƒ½å¼€é”€ä¹Ÿå¤ªå¤§äº†å§ï¼Œæ¶ˆæ¯éœ€è¦åŒæ­¥åˆ°æ‰€æœ‰æœºå™¨ä¸Šï¼Œå¯¼è‡´ç½‘ç»œå¸¦å®½å‹åŠ›å’Œæ¶ˆè€—å¾ˆé‡ï¼ç¬¬äºŒï¼Œè¿™ä¹ˆç©å„¿ï¼Œä¸æ˜¯åˆ†å¸ƒå¼çš„ï¼Œå°±æ²¡æœ‰æ‰©å±•æ€§å¯è¨€äº†ï¼Œå¦‚æœæŸä¸ª queue è´Ÿè½½å¾ˆé‡ï¼Œä½ åŠ æœºå™¨ï¼Œæ–°å¢çš„æœºå™¨ä¹ŸåŒ…å«äº†è¿™ä¸ª queue çš„æ‰€æœ‰æ•°æ®ï¼Œå¹¶æ²¡æœ‰åŠæ³•çº¿æ€§æ‰©å±•ä½ çš„ queueã€‚ä½ æƒ³ï¼Œå¦‚æœè¿™ä¸ª queue çš„æ•°æ®é‡å¾ˆå¤§ï¼Œå¤§åˆ°è¿™ä¸ªæœºå™¨ä¸Šçš„å®¹é‡æ— æ³•å®¹çº³äº†ï¼Œæ­¤æ—¶è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<h2 id="Kafka-çš„é«˜å¯ç”¨æ€§">Kafka çš„é«˜å¯ç”¨æ€§</h2>
<p>Kafka ä¸€ä¸ªæœ€åŸºæœ¬çš„æ¶æ„è®¤è¯†ï¼šç”±å¤šä¸ª broker ç»„æˆï¼Œæ¯ä¸ª broker æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼›ä½ åˆ›å»ºä¸€ä¸ª topicï¼Œè¿™ä¸ª topic å¯ä»¥åˆ’åˆ†ä¸ºå¤šä¸ª partitionï¼Œæ¯ä¸ª partition å¯ä»¥å­˜åœ¨äºä¸åŒçš„ broker ä¸Šï¼Œæ¯ä¸ª partition å°±æ”¾ä¸€éƒ¨åˆ†æ•°æ®ã€‚è¿™å°±æ˜¯å¤©ç„¶çš„åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå°±æ˜¯è¯´ä¸€ä¸ª topic çš„æ•°æ®ï¼Œæ˜¯åˆ†æ•£æ”¾åœ¨å¤šä¸ªæœºå™¨ä¸Šçš„ï¼Œæ¯ä¸ªæœºå™¨å°±æ”¾ä¸€éƒ¨åˆ†æ•°æ®ã€‚<br>
å®é™…ä¸Š RabbitMQ ä¹‹ç±»çš„ï¼Œå¹¶ä¸æ˜¯åˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ƒå°±æ˜¯ä¼ ç»Ÿçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåªä¸è¿‡æä¾›äº†ä¸€äº›é›†ç¾¤ã€HA(High Availability, é«˜å¯ç”¨æ€§) çš„æœºåˆ¶è€Œå·²ï¼Œå› ä¸ºæ— è®ºæ€ä¹ˆç©å„¿ï¼ŒRabbitMQ ä¸€ä¸ª queue çš„æ•°æ®éƒ½æ˜¯æ”¾åœ¨ä¸€ä¸ªèŠ‚ç‚¹é‡Œçš„ï¼Œé•œåƒé›†ç¾¤ä¸‹ï¼Œä¹Ÿæ˜¯æ¯ä¸ªèŠ‚ç‚¹éƒ½æ”¾è¿™ä¸ª queue çš„å®Œæ•´æ•°æ®ã€‚<br>
Kafka 0.8 ä»¥å‰ï¼Œæ˜¯æ²¡æœ‰ HA æœºåˆ¶çš„ï¼Œå°±æ˜¯ä»»ä½•ä¸€ä¸ª broker å®•æœºäº†ï¼Œé‚£ä¸ª broker ä¸Šçš„ partition å°±åºŸäº†ï¼Œæ²¡æ³•å†™ä¹Ÿæ²¡æ³•è¯»ï¼Œæ²¡æœ‰ä»€ä¹ˆé«˜å¯ç”¨æ€§å¯è¨€ã€‚æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬å‡è®¾åˆ›å»ºäº†ä¸€ä¸ª topicï¼ŒæŒ‡å®šå…¶ partition æ•°é‡æ˜¯ 3 ä¸ªï¼Œåˆ†åˆ«åœ¨ä¸‰å°æœºå™¨ä¸Šã€‚ä½†æ˜¯ï¼Œå¦‚æœç¬¬äºŒå°æœºå™¨å®•æœºäº†ï¼Œä¼šå¯¼è‡´è¿™ä¸ª topic çš„ 1/3 çš„æ•°æ®å°±ä¸¢äº†ï¼Œå› æ­¤è¿™ä¸ªæ˜¯åšä¸åˆ°é«˜å¯ç”¨çš„ã€‚<br>
<img src="/images/kafka.jpg" alt=""><br>
Kafka 0.8 ä»¥åï¼Œæä¾›äº† HA æœºåˆ¶ï¼Œå°±æ˜¯ replicaï¼ˆå¤åˆ¶å“ï¼‰ å‰¯æœ¬æœºåˆ¶ã€‚æ¯ä¸ª partition çš„æ•°æ®éƒ½ä¼šåŒæ­¥åˆ°å…¶å®ƒæœºå™¨ä¸Šï¼Œå½¢æˆè‡ªå·±çš„å¤šä¸ª replica å‰¯æœ¬ã€‚æ‰€æœ‰ replica ä¼šé€‰ä¸¾ä¸€ä¸ª leader å‡ºæ¥ï¼Œé‚£ä¹ˆç”Ÿäº§å’Œæ¶ˆè´¹éƒ½è·Ÿè¿™ä¸ª leader æ‰“äº¤é“ï¼Œç„¶åå…¶ä»– replica å°±æ˜¯ followerã€‚å†™çš„æ—¶å€™ï¼Œleader ä¼šè´Ÿè´£æŠŠæ•°æ®åŒæ­¥åˆ°æ‰€æœ‰ follower ä¸Šå»ï¼Œè¯»çš„æ—¶å€™å°±ç›´æ¥è¯» leader ä¸Šçš„æ•°æ®å³å¯ã€‚åªèƒ½è¯»å†™ leaderï¼Ÿå¾ˆç®€å•ï¼Œè¦æ˜¯ä½ å¯ä»¥éšæ„è¯»å†™æ¯ä¸ª followerï¼Œé‚£ä¹ˆå°±è¦ care æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œç³»ç»Ÿå¤æ‚åº¦å¤ªé«˜ï¼Œå¾ˆå®¹æ˜“å‡ºé—®é¢˜ã€‚Kafka ä¼šå‡åŒ€åœ°å°†ä¸€ä¸ª partition çš„æ‰€æœ‰ replica åˆ†å¸ƒåœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼Œè¿™æ ·æ‰å¯ä»¥æé«˜å®¹é”™æ€§ã€‚<br>
<img src="/images/kafkagky.jpg" alt=""></p>
<p>è¿™ä¹ˆæï¼Œå°±æœ‰æ‰€è°“çš„é«˜å¯ç”¨æ€§äº†ï¼Œå› ä¸ºå¦‚æœæŸä¸ª broker å®•æœºäº†ï¼Œæ²¡äº‹å„¿ï¼Œé‚£ä¸ª broker ä¸Šé¢çš„ partition åœ¨å…¶ä»–æœºå™¨ä¸Šéƒ½æœ‰å‰¯æœ¬çš„ã€‚å¦‚æœè¿™ä¸ªå®•æœºçš„ broker ä¸Šé¢æœ‰æŸä¸ª partition çš„ leaderï¼Œé‚£ä¹ˆæ­¤æ—¶ä¼šä» follower ä¸­é‡æ–°é€‰ä¸¾ä¸€ä¸ªæ–°çš„ leader å‡ºæ¥ï¼Œå¤§å®¶ç»§ç»­è¯»å†™é‚£ä¸ªæ–°çš„ leader å³å¯ã€‚è¿™å°±æœ‰æ‰€è°“çš„é«˜å¯ç”¨æ€§äº†ã€‚å†™æ•°æ®çš„æ—¶å€™ï¼Œç”Ÿäº§è€…å°±å†™ leaderï¼Œç„¶å leader å°†æ•°æ®è½åœ°å†™æœ¬åœ°ç£ç›˜ï¼Œæ¥ç€å…¶ä»– follower è‡ªå·±ä¸»åŠ¨ä» leader æ¥ pull æ•°æ®ã€‚ä¸€æ—¦æ‰€æœ‰ follower åŒæ­¥å¥½æ•°æ®äº†ï¼Œå°±ä¼šå‘é€ ack ç»™ leaderï¼Œleader æ”¶åˆ°æ‰€æœ‰ follower çš„ ack ä¹‹åï¼Œå°±ä¼šè¿”å›å†™æˆåŠŸçš„æ¶ˆæ¯ç»™ç”Ÿäº§è€…ã€‚ï¼ˆå½“ç„¶ï¼Œè¿™åªæ˜¯å…¶ä¸­ä¸€ç§æ¨¡å¼ï¼Œè¿˜å¯ä»¥é€‚å½“è°ƒæ•´è¿™ä¸ªè¡Œä¸ºï¼‰æ¶ˆè´¹çš„æ—¶å€™ï¼Œåªä¼šä» leader å»è¯»ï¼Œä½†æ˜¯åªæœ‰å½“ä¸€ä¸ªæ¶ˆæ¯å·²ç»è¢«æ‰€æœ‰ follower éƒ½åŒæ­¥æˆåŠŸè¿”å› ack çš„æ—¶å€™ï¼Œè¿™ä¸ªæ¶ˆæ¯æ‰ä¼šè¢«æ¶ˆè´¹è€…è¯»åˆ°ã€‚çœ‹åˆ°è¿™é‡Œï¼Œç›¸ä¿¡ä½ å¤§è‡´æ˜ç™½äº† Kafka æ˜¯å¦‚ä½•ä¿è¯é«˜å¯ç”¨æœºåˆ¶çš„äº†ï¼Œå¯¹å§ï¼Ÿä¸è‡³äºä¸€æ— æ‰€çŸ¥ï¼Œç°åœºè¿˜èƒ½ç»™é¢è¯•å®˜ç”»ç”»å›¾ã€‚è¦æ˜¯é‡ä¸Šé¢è¯•å®˜ç¡®å®æ˜¯ Kafka é«˜æ‰‹ï¼Œæ·±æŒ–äº†é—®ï¼Œé‚£ä½ åªèƒ½è¯´ä¸å¥½æ„æ€ï¼Œå¤ªæ·±å…¥çš„ä½ æ²¡ç ”ç©¶è¿‡ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>Javaé«˜å¹¶å‘</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>Javaé«˜å¹¶å‘</tag>
      </tags>
  </entry>
  <entry>
    <title>JVMè¯¦è§£</title>
    <url>/2019/12/08/JVM%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[]]></content>
      <categories>
        <category>Java</category>
        <category>JavaåŸºç¡€</category>
      </categories>
      <tags>
        <tag>JavaåŸºç¡€</tag>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>ConcurrentHashMapæºç è§£æ</title>
    <url>/2019/11/23/currnthashmap/</url>
    <content><![CDATA[<h2 id="ConcurrentHashMapä¸HashMapç­‰çš„åŒºåˆ«">ConcurrentHashMapä¸HashMapç­‰çš„åŒºåˆ«</h2>
<p>1.HashMap<br>
æˆ‘ä»¬çŸ¥é“HashMapæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨Hashmapè¿›è¡Œputæ“ä½œä¼šå¼•èµ·æ­»å¾ªç¯ï¼Œå¯¼è‡´CPUåˆ©ç”¨ç‡æ¥è¿‘100%ï¼Œæ‰€ä»¥åœ¨å¹¶å‘æƒ…å†µä¸‹ä¸èƒ½ä½¿ç”¨HashMapã€‚<br>
2.HashTable<br>
HashTableå’ŒHashMapçš„å®ç°åŸç†å‡ ä¹ä¸€æ ·ï¼Œå·®åˆ«æ— éæ˜¯<br>
Â Â  HashTableä¸å…è®¸keyå’Œvalueä¸ºnull<br>
Â Â  HashTableæ˜¯çº¿ç¨‹å®‰å…¨çš„<br>
ä½†æ˜¯HashTableçº¿ç¨‹å®‰å…¨çš„ç­–ç•¥å®ç°ä»£ä»·å´å¤ªå¤§äº†ï¼Œç®€å•ç²—æš´ï¼Œget/putæ‰€æœ‰ç›¸å…³æ“ä½œéƒ½æ˜¯synchronizedçš„ï¼Œè¿™ç›¸å½“äºç»™æ•´ä¸ªå“ˆå¸Œè¡¨åŠ äº†ä¸€æŠŠå¤§é”ã€‚<br>
å¤šçº¿ç¨‹è®¿é—®æ—¶å€™ï¼Œåªè¦æœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®æˆ–æ“ä½œè¯¥å¯¹è±¡ï¼Œé‚£å…¶ä»–çº¿ç¨‹åªèƒ½é˜»å¡ï¼Œç›¸å½“äºå°†æ‰€æœ‰çš„æ“ä½œä¸²è¡ŒåŒ–ï¼Œåœ¨ç«äº‰æ¿€çƒˆçš„å¹¶å‘åœºæ™¯ä¸­æ€§èƒ½å°±ä¼šéå¸¸å·®ã€‚<br>
3.ConcurrentHashMap<br>
ä¸»è¦å°±æ˜¯ä¸ºäº†åº”å¯¹hashmapåœ¨å¹¶å‘ç¯å¢ƒä¸‹ä¸å®‰å…¨è€Œè¯ç”Ÿçš„ï¼ŒConcurrentHashMapçš„è®¾è®¡ä¸å®ç°éå¸¸ç²¾å·§ï¼Œå¤§é‡çš„åˆ©ç”¨äº†volatileï¼Œfinalï¼ŒCASç­‰lock-freeæŠ€æœ¯æ¥å‡å°‘é”ç«äº‰å¯¹äºæ€§èƒ½çš„å½±å“ã€‚<br>
æˆ‘ä»¬éƒ½çŸ¥é“Mapä¸€èˆ¬éƒ½æ˜¯æ•°ç»„+é“¾è¡¨ç»“æ„ï¼ˆJDK1.8è¯¥ä¸ºæ•°ç»„+çº¢é»‘æ ‘ï¼‰ã€‚<br>
é«˜å¹¶å‘ç¼–ç¨‹ç³»åˆ—ï¼šConcurrentHashMapçš„å®ç°åŸç†(JDK1.7å’ŒJDK1.8)<br>
ConcurrentHashMapé¿å…äº†å¯¹å…¨å±€åŠ é”æ”¹æˆäº†å±€éƒ¨åŠ é”æ“ä½œï¼Œè¿™æ ·å°±æå¤§åœ°æé«˜äº†å¹¶å‘ç¯å¢ƒä¸‹çš„æ“ä½œé€Ÿåº¦ï¼Œç”±äºConcurrentHashMapåœ¨JDK1.7å’Œ1.8ä¸­çš„å®ç°éå¸¸ä¸åŒï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è°ˆè°ˆJDKåœ¨1.7å’Œ1.8ä¸­çš„åŒºåˆ«ã€‚</p>
<a id="more"></a>
<h2 id="JDK1-7çš„å®ç°">JDK1.7çš„å®ç°</h2>
<p>åœ¨JDK1.7ç‰ˆæœ¬ä¸­ï¼ŒConcurrentHashMapçš„æ•°æ®ç»“æ„æ˜¯ç”±ä¸€ä¸ªSegmentæ•°ç»„å’Œå¤šä¸ªHashEntryç»„æˆï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br>
<img src="/images/1.7conhashmap.png" alt=""><br>
Segmentæ•°ç»„çš„æ„ä¹‰å°±æ˜¯å°†ä¸€ä¸ªå¤§çš„tableåˆ†å‰²æˆå¤šä¸ªå°çš„tableæ¥è¿›è¡ŒåŠ é”ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„æåˆ°çš„é”åˆ†ç¦»æŠ€æœ¯ï¼Œè€Œæ¯ä¸€ä¸ªSegmentå…ƒç´ å­˜å‚¨çš„æ˜¯HashEntryæ•°ç»„+é“¾è¡¨ï¼Œè¿™ä¸ªå’ŒHashMapçš„æ•°æ®å­˜å‚¨ç»“æ„ä¸€æ ·</p>
<h2 id="JDK1-8çš„å®ç°">JDK1.8çš„å®ç°</h2>
<p>JDK1.8çš„å®ç°å·²ç»æ‘’å¼ƒäº†Segmentçš„æ¦‚å¿µï¼Œè€Œæ˜¯ç›´æ¥ç”¨Nodeæ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„æ•°æ®ç»“æ„æ¥å®ç°ï¼Œå¹¶å‘æ§åˆ¶ä½¿ç”¨Synchronizedå’ŒCASæ¥æ“ä½œï¼Œæ•´ä¸ªçœ‹èµ·æ¥å°±åƒæ˜¯ä¼˜åŒ–è¿‡ä¸”çº¿ç¨‹å®‰å…¨çš„HashMapï¼Œè™½ç„¶åœ¨JDK1.8ä¸­è¿˜èƒ½çœ‹åˆ°Segmentçš„æ•°æ®ç»“æ„ï¼Œä½†æ˜¯å·²ç»ç®€åŒ–äº†å±æ€§ï¼Œåªæ˜¯ä¸ºäº†å…¼å®¹æ—§ç‰ˆæœ¬<br>
<img src="/images/1.8conhashmap.png" alt=""><br>
CASæ˜¯compare and swapçš„ç¼©å†™ï¼Œå³æˆ‘ä»¬æ‰€è¯´çš„æ¯”è¾ƒäº¤æ¢ã€‚casæ˜¯ä¸€ç§åŸºäºé”çš„æ“ä½œï¼Œè€Œä¸”æ˜¯ä¹è§‚é”ã€‚åœ¨javaä¸­é”åˆ†ä¸ºä¹è§‚é”å’Œæ‚²è§‚é”ã€‚æ‚²è§‚é”æ˜¯å°†èµ„æºé”ä½ï¼Œç­‰ä¸€ä¸ªä¹‹å‰è·å¾—é”çš„çº¿ç¨‹é‡Šæ”¾é”ä¹‹åï¼Œä¸‹ä¸€ä¸ªçº¿ç¨‹æ‰å¯ä»¥è®¿é—®ã€‚è€Œä¹è§‚é”é‡‡å–äº†ä¸€ç§å®½æ³›çš„æ€åº¦ï¼Œé€šè¿‡æŸç§æ–¹å¼ä¸åŠ é”æ¥å¤„ç†èµ„æºï¼Œæ¯”å¦‚é€šè¿‡ç»™è®°å½•åŠ versionæ¥è·å–æ•°æ®ï¼Œæ€§èƒ½è¾ƒæ‚²è§‚é”æœ‰å¾ˆå¤§çš„æé«˜ã€‚<br>
CAS æ“ä½œåŒ…å«ä¸‰ä¸ªæ“ä½œæ•° â€”â€” å†…å­˜ä½ç½®ï¼ˆVï¼‰ã€é¢„æœŸåŸå€¼ï¼ˆAï¼‰å’Œæ–°å€¼(B)ã€‚å¦‚æœå†…å­˜åœ°å€é‡Œé¢çš„å€¼å’ŒAçš„å€¼æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå°±å°†å†…å­˜é‡Œé¢çš„å€¼æ›´æ–°æˆBã€‚CASæ˜¯é€šè¿‡æ— é™å¾ªç¯æ¥è·å–æ•°æ®çš„ï¼Œè‹¥æœåœ¨ç¬¬ä¸€è½®å¾ªç¯ä¸­ï¼Œaçº¿ç¨‹è·å–åœ°å€é‡Œé¢çš„å€¼è¢«bçº¿ç¨‹ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆaçº¿ç¨‹éœ€è¦è‡ªæ—‹ï¼Œåˆ°ä¸‹æ¬¡å¾ªç¯æ‰æœ‰å¯èƒ½æœºä¼šæ‰§è¡Œã€‚</p>
<h3 id="æºç è§£æ">æºç è§£æ</h3>
<h4 id="åŸºæœ¬å±æ€§">åŸºæœ¬å±æ€§</h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// nodeæ•°ç»„æœ€å¤§å®¹é‡ï¼š2^30=1073741824  </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br><span class="line"><span class="comment">// é»˜è®¤åˆå§‹å€¼ï¼Œå¿…é¡»æ˜¯2çš„å¹•æ•°  </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CAPACITY = <span class="number">16</span>;</span><br><span class="line"><span class="comment">//æ•°ç»„å¯èƒ½æœ€å¤§å€¼ï¼Œéœ€è¦ä¸toArrayï¼ˆï¼‰ç›¸å…³æ–¹æ³•å…³è”  </span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_ARRAY_SIZE = Integer.MAX_VALUE - <span class="number">8</span>;</span><br><span class="line"><span class="comment">//å¹¶å‘çº§åˆ«ï¼Œé—ç•™ä¸‹æ¥çš„ï¼Œä¸ºå…¼å®¹ä»¥å‰çš„ç‰ˆæœ¬  </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CONCURRENCY_LEVEL = <span class="number">16</span>;</span><br><span class="line"><span class="comment">//è´Ÿè½½å› å­</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> LOAD_FACTOR = <span class="number">0.75f</span>;</span><br><span class="line"><span class="comment">// é“¾è¡¨è½¬çº¢é»‘æ ‘é˜€å€¼,&gt; 8 é“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEIFY_THRESHOLD = <span class="number">8</span>;</span><br><span class="line"><span class="comment">//æ ‘è½¬é“¾è¡¨é˜€å€¼ï¼Œå°äºç­‰äº6ï¼ˆtranferæ—¶ï¼Œlcã€hc=0ä¸¤ä¸ªè®¡æ•°å™¨åˆ†åˆ«++è®°å½•åŸbinã€æ–°binTreeNodeæ•°é‡ï¼Œ&lt;=UNTREEIFY_THRESHOLD åˆ™untreeify(lo)ï¼‰</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNTREEIFY_THRESHOLD = <span class="number">6</span>;</span><br><span class="line"><span class="comment">//é“¾è¡¨è½¬çº¢é»‘æ ‘çš„å¦ä¸€ä¸ªé˜ˆå€¼(æ¡ä»¶)ï¼šMapçš„å®¹é‡è‡³å°‘ä¸º64</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_TREEIFY_CAPACITY = <span class="number">64</span>;</span><br><span class="line"><span class="comment">//æ¯æ¬¡è¿›è¡Œè½¬ç§»çš„æœ€å°å€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_TRANSFER_STRIDE = <span class="number">16</span>;</span><br><span class="line"><span class="comment">//ç”ŸæˆsizeCtlæ‰€ä½¿ç”¨çš„bitä½æ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> RESIZE_STAMP_BITS = <span class="number">16</span>;</span><br><span class="line"><span class="comment">// 2^15-1ï¼Œhelp resizeæ‰©å®¹çš„æœ€å¤§çº¿ç¨‹æ•°  </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_RESIZERS = (<span class="number">1</span> &lt;&lt; (<span class="number">32</span> - RESIZE_STAMP_BITS)) - <span class="number">1</span>;</span><br><span class="line"><span class="comment">// 32-16=16ï¼ŒsizeCtlä¸­è®°å½•sizeå¤§å°çš„åç§»é‡  </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESIZE_STAMP_SHIFT = <span class="number">32</span> - RESIZE_STAMP_BITS;</span><br><span class="line"><span class="comment">// forwarding nodesçš„hashå€¼  </span></span><br><span class="line"><span class="comment">/** é¦–å…ˆå“ˆå¸Œå€¼ä¸å°äº0ï¼Œä¸‹é¢çš„å‡ ä¸ªå¸¸é‡ç›¸å½“äºæ ‡è¯†ä½ */</span></span><br><span class="line"><span class="comment">/** ç”¨äºè½¬æ¢èŠ‚ç‚¹çš„å“ˆå¸Œå€¼ */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MOVED     = -<span class="number">1</span>; <span class="comment">// hash for forwarding nodes</span></span><br><span class="line"><span class="comment">// ç”¨äºçº¢é»‘æ ‘æ ¹èŠ‚ç‚¹çš„å“ˆå¸Œç çš„æ ‡è¯†ä½</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEBIN   = -<span class="number">2</span>; <span class="comment">// hash for roots of trees</span></span><br><span class="line"><span class="comment">// å®¹å™¨ä¸­è¿˜æœ‰ä¸€ä¸ªä¿ç•™èŠ‚ç‚¹ï¼Œæ­¤å¤„ä¹Ÿæ˜¯æœ‰å…³çš„å“ˆå¸Œç çš„æ ‡è¯†ä½</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESERVED  = -<span class="number">3</span>; <span class="comment">// hash for transient reservations</span></span><br><span class="line"><span class="comment">// å¯ç”¨cpuæ•°é‡</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NCPU = Runtime.getRuntime().availableProcessors();</span><br><span class="line"><span class="comment">//å­˜æ”¾nodeçš„æ•°ç»„,å®¹å™¨çš„æ•°ç»„ï¼ˆå“ˆå¸Œè¡¨ã€æ•£åˆ—è¡¨ï¼‰ï¼Œåœ¨ç¬¬ä¸€æ¬¡æ’å…¥å…ƒç´ æ—¶æ‰åˆå§‹åŒ–ï¼Œå¤§å°æ€»æ˜¯2çš„æ¬¡å¹‚ </span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] table;</span><br><span class="line"><span class="comment">/** æ‰©å®¹æ—¶ä½¿ç”¨çš„ä¸´æ—¶è¿‡åº¦çš„æ•°ç»„ï¼ˆä»…ä½¿ç”¨äºæ‰©å®¹ï¼‰ */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line"><span class="comment">//è®°å½•å®¹å™¨çš„å®¹é‡å¤§å°ï¼Œé€šè¿‡CASæ›´æ–°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">long</span> baseCount;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿™ä¸ªsizeCtlæ˜¯volatileçš„ï¼Œé‚£ä¹ˆä»–æ˜¯çº¿ç¨‹å¯è§çš„ï¼Œä¸€ä¸ªæ€è€ƒ:å®ƒæ˜¯æ‰€æœ‰ä¿®æ”¹éƒ½åœ¨CASä¸­è¿›è¡Œï¼Œä½†æ˜¯sizeCtlä¸ºä»€ä¹ˆä¸è®¾è®¡æˆLongAdder(jdk8å‡ºç°çš„)ç±»å‹å‘¢ï¼Ÿ</span></span><br><span class="line"><span class="comment"> * æˆ–è€…è®¾è®¡æˆAtomicLong(åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹æ¯”LongAdderä½æ•ˆ)ï¼Œè¿™æ ·å°±èƒ½å‡å°‘è‡ªå·±æ“ä½œCASäº†ã€‚</span></span><br><span class="line"><span class="comment"> * é»˜è®¤ä¸º0ï¼Œç”¨æ¥æ§åˆ¶tableçš„åˆå§‹åŒ–å’Œæ‰©å®¹æ“ä½œï¼Œå…·ä½“åº”ç”¨åœ¨åç»­ä¼šä½“ç°å‡ºæ¥ã€‚</span></span><br><span class="line"><span class="comment"> * &lt;0 æ ‡è¯†å®¹å™¨æ­£åœ¨åˆå§‹åŒ–æˆ–æ‰©å®¹</span></span><br><span class="line"><span class="comment"> * -1 ä»£è¡¨tableæ­£åœ¨åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment"> * -N è¡¨ç¤ºæœ‰N-1ä¸ªçº¿ç¨‹æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line"><span class="comment"> * å…¶ä½™æƒ…å†µï¼š</span></span><br><span class="line"><span class="comment"> *1ã€å¦‚æœtableæœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºtableéœ€è¦åˆå§‹åŒ–çš„å¤§å°ã€‚</span></span><br><span class="line"><span class="comment"> *2ã€å¦‚æœtableåˆå§‹åŒ–å®Œæˆï¼Œè¡¨ç¤ºtableçš„å®¹é‡ï¼Œé»˜è®¤æ˜¯tableå¤§å°çš„0.75 å€ï¼Œå±…ç„¶ç”¨è¿™ä¸ªå…¬å¼ç®—0.75ï¼ˆn - (n &gt;&gt;&gt; 2)ï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> sizeCtl;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  è‡ªæ—‹é” ï¼ˆé”å®šé€šè¿‡ CASï¼‰ åœ¨è°ƒæ•´å¤§å°å’Œ/æˆ–åˆ›å»º CounterCells æ—¶ä½¿ç”¨ã€‚ åœ¨CounterCellç±»æ›´æ–°valueä¸­ä¼šä½¿ç”¨ï¼ŒåŠŸèƒ½ç±»ä¼¼æ˜¾ç¤ºé”å’Œå†…ç½®é”ï¼Œæ€§èƒ½æ›´å¥½</span></span><br><span class="line"><span class="comment"> *  åœ¨Striped64ç±»ä¹Ÿæœ‰åº”ç”¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> cellsBusy;</span><br><span class="line"><span class="comment">/** è®¡æ•°å™¨æ± ï¼Œéç©ºæ—¶ï¼Œå¤§å°ä¸º2çš„æ¬¡å¹‚ */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> CounterCell[] counterCells;</span><br></pre></td></tr></table></figure>
<h4 id="ConcurrentHashMap-çš„æ„é€ å‡½æ•°">ConcurrentHashMap?çš„æ„é€ å‡½æ•°</h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//é»˜è®¤æ— å‚æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="number">1</span>. <span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//initialCapacity åˆå§‹åŒ–å®¹é‡</span></span><br><span class="line"><span class="number">2</span>. <span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        <span class="keyword">int</span> cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ?</span><br><span class="line">                   MAXIMUM_CAPACITY :</span><br><span class="line">                   tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>));</span><br><span class="line">        <span class="keyword">this</span>.sizeCtl = cap;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// åˆ›å»ºä¸ç»™å®šmapå…·æœ‰ç›¸åŒæ˜ å°„çš„æ–°map</span></span><br><span class="line"><span class="number">3</span>. <span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sizeCtl = DEFAULT_CAPACITY;</span><br><span class="line">        putAll(m);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//initialCapacity åˆå§‹åŒ–å®¹é‡;loadFactor è´Ÿè½½å› å­,å½“å®¹é‡è¾¾åˆ°initialCapacity*loadFactoræ—¶ï¼Œæ‰§è¡Œæ‰©å®¹</span></span><br><span class="line"><span class="number">4</span>. <span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(initialCapacity, loadFactor, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">/*initialCapacity åˆå§‹åŒ–å®¹é‡;</span></span><br><span class="line"><span class="comment">* loadFactor è´Ÿè½½å› å­,å½“å®¹é‡è¾¾åˆ°initialCapacity*loadFactoræ—¶ï¼Œæ‰§è¡Œæ‰©å®¹</span></span><br><span class="line"><span class="comment">* concurrencyLevel é¢„ä¼°çš„å¹¶å‘æ›´æ–°çº¿ç¨‹æ•°</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="number">5</span>. <span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">float</span> loadFactor, <span class="keyword">int</span> concurrencyLevel)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!(loadFactor &gt; <span class="number">0.0f</span>) || initialCapacity &lt; <span class="number">0</span> || concurrencyLevel &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">        <span class="keyword">if</span> (initialCapacity &lt; concurrencyLevel)   <span class="comment">// Use at least as many bins</span></span><br><span class="line">            initialCapacity = concurrencyLevel;   <span class="comment">// as estimated threads </span></span><br><span class="line">        <span class="keyword">long</span> size = (<span class="keyword">long</span>)(<span class="number">1.0</span> + (<span class="keyword">long</span>)initialCapacity / loadFactor);</span><br><span class="line">        <span class="keyword">int</span> cap = (size &gt;= (<span class="keyword">long</span>)MAXIMUM_CAPACITY) ?</span><br><span class="line">            MAXIMUM_CAPACITY : tableSizeFor((<span class="keyword">int</span>)size);</span><br><span class="line">        <span class="keyword">this</span>.sizeCtl = cap;<span class="comment">//åˆå§‹åŒ–sizeCtl</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    *è¿”å›ç»™å®šæ‰€éœ€å®¹é‡ï¼Œtableçš„å¤§å°æ€»æ˜¯2çš„å¹‚æ¬¡æ–¹</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tableSizeFor</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = c - <span class="number">1</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">        <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>ConcurrentHashMapåœ¨æ„é€ å‡½æ•°ä¸­åªä¼šåˆå§‹åŒ–sizeCtlå€¼ï¼Œå¹¶ä¸ä¼šç›´æ¥åˆå§‹åŒ–tableï¼Œè€Œæ˜¯å»¶ç¼“åˆ°ç¬¬ä¸€æ¬¡putæ“ä½œ</p>
<h3 id="ConcurrentHashMapä¸­å„ç§æ•°æ®èŠ‚ç‚¹">ConcurrentHashMapä¸­å„ç§æ•°æ®èŠ‚ç‚¹</h3>
<p>jdk1.8 ConcurrentHashMap ä¸­æ•°æ®èŠ‚ç‚¹çš„ç§ç±»æ¯”è¾ƒå¤šï¼Œæ¯”å¦‚ Node&lt;K, V&gt;ã€TreeNode&lt;K, V&gt;ã€TreeBin&lt;K, V&gt;ã€ReservationNode&lt;K,V&gt;ã€‚æ­£å¼è¿™ç§ç‹¬å…·ç‰¹è‰²çš„è®¾è®¡ï¼Œæ‰æ‹¥æœ‰é«˜æ€§èƒ½çš„Mapå¹¶å‘å®¹å™¨ã€‚</p>
<h4 id="Node">Node</h4>
<p>Nodeæ˜¯ConcurrentHashMapå­˜å‚¨ç»“æ„çš„åŸºæœ¬å•å…ƒ,ä¿å­˜keyï¼ŒvalueåŠkeyçš„hashå€¼çš„æ•°æ®ç»“æ„ï¼Œå…¶ä¸­valueå’Œnextéƒ½ç”¨volatileä¿®é¥°ï¼Œä¿è¯å¹¶å‘çš„å¯è§æ€§,ç»§æ‰¿äºHashMapä¸­çš„Entryï¼Œæºä»£ç å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** å®ç°äº Map.Entry */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// // final ä¿®é¥°çš„ å“ˆå¸Œç ã€keyï¼Œé˜²æ­¢è¢«é‡å¤èµ‹å€¼</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    <span class="comment">// å…·æœ‰å¯è§æ€§çš„ val å’Œ next</span></span><br><span class="line">    <span class="keyword">volatile</span> V val;</span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹æŒ‡å‘çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">volatile</span> Node&lt;K,V&gt; next;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ„é€ æ–¹æ³•ç”¨äºæ³¨å…¥ nodeèŠ‚ç‚¹ çš„å±æ€§å€¼(æˆ–å¼•ç”¨)</span></span><br><span class="line"><span class="comment">     * å‚æ•°ä»å·¦è‡³å³ä¾æ¬¡æ˜¯ï¼škeyçš„å“ˆå¸Œç ï¼Œkeyï¼Œvalueï¼ŒæŒ‡å‘çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹next</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Node(<span class="keyword">int</span> hash, K key, V val, Node&lt;K,V&gt; next) &#123;</span><br><span class="line">        <span class="keyword">this</span>.hash = hash;</span><br><span class="line">        <span class="keyword">this</span>.key = key;</span><br><span class="line">        <span class="keyword">this</span>.val = val;</span><br><span class="line">        <span class="keyword">this</span>.next = next;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// getter &amp; toString æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title">getKey</span><span class="params">()</span>       </span>&#123; <span class="keyword">return</span> key; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">getValue</span><span class="params">()</span>     </span>&#123; <span class="keyword">return</span> val; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span></span>&#123; <span class="keyword">return</span> key + <span class="string">"="</span> + val; &#125;</span><br><span class="line">    <span class="comment">// è¿”å›èŠ‚ç‚¹çš„å“ˆå¸Œç </span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span>   </span>&#123; <span class="keyword">return</span> key.hashCode() ^ val.hashCode(); &#125;</span><br><span class="line">    <span class="comment">// è®¾ç½® value çš„æ–¹æ³•ï¼Œå¯èƒ½ä¼šæŠ›å‡ºä¸æ”¯æŒçš„æ“ä½œå¼‚å¸¸,ä¸å…è®¸æ›´æ–°value</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">setValue</span><span class="params">(V value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç”¨äºèŠ‚ç‚¹æ¯”è¾ƒæ˜¯å¦ç›¸ç­‰çš„æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        Object k, v, u; Map.Entry&lt;?,?&gt; e;</span><br><span class="line">        <span class="comment">// è¿”å›åˆ¤æ–­keyã€valueæ˜¯å¦ç›¸åŒçš„ç»“æœ</span></span><br><span class="line">        <span class="keyword">return</span> ((o <span class="keyword">instanceof</span> Map.Entry) &amp;&amp;</span><br><span class="line">                (k = (e = (Map.Entry&lt;?,?&gt;)o).getKey()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (v = e.getValue()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                (k == key || k.equals(key)) &amp;&amp;</span><br><span class="line">                (v == (u = val) || v.equals(u)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è™šæ‹ŸåŒ–åœ°æ”¯æŒ map.get() æ“ä½œ; å­ç±»å¯ä»¥é‡å†™æ­¤æ–¹æ³•.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Node&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">        Node&lt;K,V&gt; e = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">if</span> (k != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¾ªç¯éå†é“¾è¡¨</span></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                K ek;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                    ((ek = e.key) == k || (ek != <span class="keyword">null</span> &amp;&amp; k.equals(ek))))</span><br><span class="line">                    <span class="keyword">return</span> e;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Nodeæ•°æ®ç»“æ„å¾ˆç®€å•ï¼Œä»ä¸Šå¯çŸ¥ï¼Œå°±æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œä½†æ˜¯åªå…è®¸å¯¹æ•°æ®è¿›è¡ŒæŸ¥æ‰¾ï¼Œä¸å…è®¸è¿›è¡Œä¿®æ”¹</p>
<h4 id="ä¸“ç”¨äºçº¢é»‘æ ‘çš„-TreeNode-K-V-èŠ‚ç‚¹">ä¸“ç”¨äºçº¢é»‘æ ‘çš„ TreeNode&lt;K, V&gt; èŠ‚ç‚¹</h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">    TreeNode&lt;K,V&gt; parent;</span><br><span class="line">    <span class="comment">// å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">    TreeNode&lt;K,V&gt; left;</span><br><span class="line">    <span class="comment">// å³å­èŠ‚ç‚¹</span></span><br><span class="line">    TreeNode&lt;K,V&gt; right;</span><br><span class="line">    <span class="comment">// æŒ‡å‘ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼ˆä¸€èˆ¬æ˜¯çˆ¶èŠ‚ç‚¹ï¼‰ï¼Œåˆ é™¤èŠ‚ç‚¹æ—¶ä¼šç”¨åˆ°</span></span><br><span class="line">    TreeNode&lt;K,V&gt; prev;</span><br><span class="line">    <span class="comment">// çº¢é»‘æ ‡è¯†ï¼štrueè¡¨ç¤ºæ­¤èŠ‚ç‚¹ä¸ºçº¢è‰²ï¼Œfalseè¡¨ç¤ºæ­¤èŠ‚ç‚¹ä¸ºé»‘è‰²</span></span><br><span class="line">    <span class="keyword">boolean</span> red;</span><br><span class="line">	<span class="comment">// æœ‰å‚æ„é€ æ–¹æ³•</span></span><br><span class="line">    TreeNode(<span class="keyword">int</span> hash, K key, V val, Node&lt;K,V&gt; next,</span><br><span class="line">             TreeNode&lt;K,V&gt; parent) &#123;</span><br><span class="line">        <span class="keyword">super</span>(hash, key, val, next);</span><br><span class="line">        <span class="keyword">this</span>.parent = parent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Node&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> findTreeNode(h, k, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥æ‰¾å¹¶è¿”å›çº¢é»‘æ ‘ä¸­æ˜¯å­˜åœ¨çš„èŠ‚ç‚¹ï¼Œä¸å­˜åœ¨è¿”å›null</span></span><br><span class="line"><span class="comment">     * åœ¨ä¸Šç¯‡å…³äºjdk1.8HashMapæºç åˆ†æçš„æ–‡ç« ä¸­ï¼Œåˆ†æè¿‡ç±»ä¼¼çš„ï¼ˆå†™ï¼‰æ“ä½œ</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> TreeNode&lt;K,V&gt; <span class="title">findTreeNode</span><span class="params">(<span class="keyword">int</span> h, Object k, Class&lt;?&gt; kc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (k != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å½“å‰èŠ‚ç‚¹</span></span><br><span class="line">            TreeNode&lt;K,V&gt; p = <span class="keyword">this</span>;</span><br><span class="line">            <span class="comment">// å¾ªç¯éå†å¹³è¡¡æ ‘</span></span><br><span class="line">            <span class="keyword">do</span>  &#123;</span><br><span class="line">                <span class="comment">// phï¼šå½“å‰èŠ‚ç‚¹çš„å“ˆå¸Œç ï¼Œ</span></span><br><span class="line">                <span class="comment">// dirï¼šæœç´¢çš„æ–¹å‘ï¼Œå·¦æˆ–å³ï¼š-1è¡¨ç¤ºå·¦ï¼Œ1è¡¨ç¤ºå³ï¼Œ</span></span><br><span class="line">                <span class="comment">// pkï¼šå½“å‰èŠ‚ç‚¹çš„key</span></span><br><span class="line">                <span class="comment">// qï¼šå½“å‰èŠ‚ç‚¹</span></span><br><span class="line">                <span class="keyword">int</span> ph, dir; K pk; TreeNode&lt;K,V&gt; q;</span><br><span class="line">                <span class="comment">// plï¼šå½“å‰èŠ‚ç‚¹pçš„å·¦å­èŠ‚ç‚¹ï¼›prï¼šå½“å‰èŠ‚ç‚¹pçš„å³å­èŠ‚ç‚¹</span></span><br><span class="line">                TreeNode&lt;K,V&gt; pl = p.left, pr = p.right;</span><br><span class="line">                <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">                    <span class="comment">// å½“å‰èŠ‚ç‚¹çš„å“ˆå¸Œå€¼å¤§äºæŒ‡å®šçš„å“ˆå¸Œå€¼ï¼ŒæŒ‡å‘å·¦å­èŠ‚ç‚¹</span></span><br><span class="line">                    p = pl;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">                    <span class="comment">// å½“å‰èŠ‚ç‚¹çš„å“ˆå¸Œå€¼å°äºæŒ‡å®šçš„å“ˆå¸Œå€¼ï¼ŒæŒ‡å‘å³å­èŠ‚ç‚¹</span></span><br><span class="line">                    p = pr;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((pk = p.key) == k || (pk != <span class="keyword">null</span> &amp;&amp; k.equals(pk)))</span><br><span class="line">                    <span class="comment">// å¦‚æœå½“å‰èŠ‚ç‚¹çš„keyä¸æŒ‡å®šçš„kç›¸åŒï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›æ­¤èŠ‚ç‚¹</span></span><br><span class="line">                    <span class="keyword">return</span> p;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (pl == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="comment">// å¦‚æœå·¦å­èŠ‚ç‚¹ä¸ºç©ºï¼Œå°±å‘å³å­èŠ‚ç‚¹æŸ¥æ‰¾</span></span><br><span class="line">                    p = pr;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (pr == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="comment">// å¦‚æœå³å­èŠ‚ç‚¹ä¸ºç©ºï¼Œå°±å‘å·¦å­èŠ‚ç‚¹æŸ¥æ‰¾</span></span><br><span class="line">                    p = pl;</span><br><span class="line">                <span class="comment">// åˆ¤æ–­ k çš„ç±»æ˜¯å¦å®ç°äº†æ¯”è¾ƒå™¨</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((kc != <span class="keyword">null</span> ||</span><br><span class="line">                          <span class="comment">// åˆ¤æ–­ k çš„ç±»æ˜¯å¦å®ç°äº†æ¯”è¾ƒå™¨</span></span><br><span class="line">                          (kc = comparableClassFor(k)) != <span class="keyword">null</span>) &amp;&amp;</span><br><span class="line">                         <span class="comment">// è¿™é‡Œå®é™…æ˜¯ pk == null || pk.getClass() != kc ? 0 :</span></span><br><span class="line">                         <span class="comment">// ((Comparable)pk).compareTo(pk)</span></span><br><span class="line">                         <span class="comment">// ä¸‹é¢æ˜¯è§£è¯»è¿™ä¸ªä¸‰ç›®è¿ç®—ï¼š</span></span><br><span class="line">                         <span class="comment">// pk == null è¡¨ç¤ºåˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦ä¸ºnull</span></span><br><span class="line">                         <span class="comment">// pk.getClass() != kc è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å¯¹è±¡çš„ç±»å’Œkeyçš„å¯¹è±¡çš„ç±»æ˜¯å¦ä¸åŒ</span></span><br><span class="line">                         <span class="comment">// ((Comparable)k).compareTo(pk)è¡¨ç¤ºå°†æŒ‡å®šçš„keyä¸å½“å‰èŠ‚ç‚¹çš„keyæ¯”è¾ƒ</span></span><br><span class="line">                         (dir = compareComparables(kc, k, pk)) != <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">// dirå°äº0è¡¨ç¤ºå‘å·¦å­èŠ‚ç‚¹æœç´¢</span></span><br><span class="line">                    p = (dir &lt; <span class="number">0</span>) ? pl : pr;</span><br><span class="line">                <span class="comment">// å¾ªç¯æŸ¥æ‰¾</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> ((q = pr.findTreeNode(h, k, kc)) != <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> q;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    p = pl;</span><br><span class="line">            &#125; <span class="keyword">while</span> (p != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="computeIfAbsent-å’Œ-compute-æ–¹æ³•ä½¿ç”¨çš„ä½ç½®-ä¿ç•™èŠ‚ç‚¹">computeIfAbsent å’Œ compute æ–¹æ³•ä½¿ç”¨çš„ä½ç½® ä¿ç•™èŠ‚ç‚¹</h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ReservationNode</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    ReservationNode() &#123;</span><br><span class="line">        <span class="keyword">super</span>(RESERVED, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">Node&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æŒæœ‰çº¢é»‘æ ‘æ ¹èŠ‚ç‚¹çš„å®¹å™¨">æŒæœ‰çº¢é»‘æ ‘æ ¹èŠ‚ç‚¹çš„å®¹å™¨</h4>
<p>TreeBin æ˜¯ä¿è¯ ConcurrentHashMap çº¿ç¨‹å®‰å…¨çš„é‡è¦æ•°æ®ç»“æ„ï¼Œå®ƒè‡ªèº«ç»´æŠ¤ç€è¯»/å†™é”</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeBin</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹</span></span><br><span class="line">    TreeNode&lt;K,V&gt; root;</span><br><span class="line">    <span class="comment">// // é“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼ˆæ¡¶é¡¶çš„èŠ‚ç‚¹ï¼‰</span></span><br><span class="line">    <span class="keyword">volatile</span> TreeNode&lt;K,V&gt; first;</span><br><span class="line">    <span class="comment">// æœ€è¿‘ä¸€ä¸ªè®¾ç½® waiter æ ‡è¯†ä½çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread waiter;</span><br><span class="line">    <span class="comment">// é”çŠ¶æ€æ ‡è¯†ä½</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> lockState;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WRITER = <span class="number">1</span>; <span class="comment">// æŒæœ‰å†™é”æ—¶çš„çŠ¶æ€ä½</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> WAITER = <span class="number">2</span>; <span class="comment">// æ­£åœ¨ç­‰å¾…å†™é”çš„çŠ¶æ€ä½</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> READER = <span class="number">4</span>; <span class="comment">// è®¾ç½®è¯»é”æ—¶çš„å¢é‡å€¼</span></span><br><span class="line">    </span><br><span class="line">    ...å…¶ä»–æ–¹æ³•è·Ÿ TreeNode ä¸­çš„æ–¹æ³•å¾ˆç›¸ä¼¼</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ConcurrentHashMapæ·»åŠ å…ƒç´ æ“ä½œ">ConcurrentHashMapæ·»åŠ å…ƒç´ æ“ä½œ</h4>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(key, value, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¸å…è®¸keyã€valueä¸ºnull</span></span><br><span class="line">    <span class="comment">// å°†nullå€¼åˆ¤æ–­æå‰ï¼Œç¬¦åˆå¼‚å¸¸å¤„ç†çš„è§„åˆ™ï¼ˆè¿™é‡Œä¹Ÿæ˜¯è¾ƒä¸Šä¸€ç‰ˆåšäº†ä¼˜åŒ–ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="comment">// è®¡ç®—keyçš„å“ˆå¸Œç </span></span><br><span class="line">    <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">    <span class="comment">// binCount ç”¨æ¥è®°å½•é“¾è¡¨ä¸­èŠ‚ç‚¹æ•°é‡ï¼Œè¿›è€Œåˆ¤æ–­æ˜¯å¦è¾¾åˆ°è½¬ä¸ºçº¢é»‘æ ‘çš„é˜ˆå€¼</span></span><br><span class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// éå†tableæ•°ç»„</span></span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">         <span class="comment">// è¦æ’å…¥å…ƒç´ æ‰€åœ¨ä½ç½®çš„èŠ‚ç‚¹</span></span><br><span class="line">        Node&lt;K,V&gt; f;</span><br><span class="line">        <span class="comment">// n è¡¨ç¤ºæ•°ç»„é•¿åº¦ï¼›i è¡¨ç¤ºç´¢å¼•ï¼›fh è¡¨ç¤ºè¦æ’å…¥å…ƒç´ æ‰€åœ¨ä½ç½®çš„èŠ‚ç‚¹çš„å“ˆå¸Œç </span></span><br><span class="line">        <span class="keyword">int</span> n, i, fh;</span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// å¦‚æœæ•°ç»„ä¸ºnullæˆ–è€…æ•°ç»„çš„å¤§å°ä¸º0ï¼Œé‚£ä¹ˆè¿›è¡Œåˆå§‹åŒ–æ•°ç»„</span></span><br><span class="line">            tab = initTable();</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// é€šè¿‡æŒ‡å®škeyçš„å“ˆå¸Œç æ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹ï¼Œ</span></span><br><span class="line">            <span class="comment">// åœ¨èŠ‚ç‚¹ä¸ºnullçš„æƒ…å†µä¸‹ï¼Œé€šè¿‡CASè‡ªæ—‹æ–¹å¼å°†è¿™ä¸ªå…ƒç´ æ”¾å…¥å…¶ä¸­</span></span><br><span class="line">            <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">                <span class="comment">// å¦‚æœé€šè¿‡CASè‡ªæ—‹æˆåŠŸæ·»åŠ å…ƒç´ ï¼Œå°±ç›´æ¥è·³å‡ºå¾ªç¯</span></span><br><span class="line">                <span class="comment">// å¦åˆ™å°±è¿›å…¥ä¸‹ä¸€ä¸ªå¾ªç¯</span></span><br><span class="line">                <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">        <span class="comment">// æ ‡è¯†ç€è¦è¿ç§»æ•°æ®</span></span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">        <span class="comment">// é€šè¿‡ä¸Šé¢è¿‡æ»¤çš„æ¡ä»¶ï¼Œåœ¨åº”è¯¥èƒ½çŒœåˆ°ä¸‹é¢ä¸æ˜¯å…³äºé“¾è¡¨å°±æ˜¯å…³äºçº¢é»‘æ ‘</span></span><br><span class="line">        <span class="comment">// å› ä¸ºå“ˆå¸Œæ§½çš„ä½ç½®ä¸ä¸ºnull</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//æ—§å€¼</span></span><br><span class="line">            V oldVal = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//åªç»™å•ä¸ªèŠ‚ç‚¹åŠ é”</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="comment">//å†æ¬¡åˆ¤æ–­ç»“ç‚¹</span></span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="comment">// åˆ¤æ–­èŠ‚ç‚¹fçš„å“ˆå¸Œç æ˜¯å¦ä¸å°äº0</span></span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        binCount = <span class="number">1</span>;</span><br><span class="line">                        <span class="comment">// ä»æ¡¶é¡¶ï¼ˆå“ˆå¸Œæ§½ï¼‰å¼€å§‹éå†é“¾è¡¨</span></span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                            K ek;</span><br><span class="line">                            <span class="comment">// åˆ¤æ–­keyæ˜¯å¦ç›¸åŒ</span></span><br><span class="line">                            <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                ((ek = e.key) == key ||</span><br><span class="line">                                    (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                <span class="comment">// å¦‚æœç›¸åŒçš„è¯ï¼Œå°±å‡†å¤‡è·å–value</span></span><br><span class="line">                                oldVal = e.val;</span><br><span class="line">                                <span class="comment">// onlyIfAbsentä¸ºtrueæ ‡è¯†å¯ä»¥è¦†ç›–valueï¼Œfalseæ ‡è¯†ä¸å…è®¸è¦†ç›– </span></span><br><span class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                <span class="comment">// å¦‚æœå…è®¸è¦†ç›–valueï¼Œå°±è¦†ç›–value</span></span><br><span class="line">                                    e.val = value;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// è®°å½•ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼ˆç›®å‰ä»¥ä¸ºç€æ˜¯å½“å‰èŠ‚ç‚¹eï¼‰</span></span><br><span class="line">                            Node&lt;K,V&gt; pred = e;</span><br><span class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// å¦‚æœå½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºnullï¼Œå°±æŠŠå…ƒç´ æ·»åŠ åˆ°é“¾è¡¨çš„å°¾éƒ¨</span></span><br><span class="line">                                pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                            value, <span class="keyword">null</span>);</span><br><span class="line">                                <span class="comment">// æ·»åŠ å®Œæˆåå°±ç›´æ¥è·³å‡ºå¾ªç¯</span></span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        Node&lt;K,V&gt; p;</span><br><span class="line">                        binCount = <span class="number">2</span>;</span><br><span class="line">                        <span class="comment">// å°†å…ƒç´ æ·»åŠ åˆ°çº¢é»‘æ ‘</span></span><br><span class="line">                        <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                                        value)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            oldVal = p.val;</span><br><span class="line">                            <span class="comment">// æ˜¯å¦å¯ä»¥è¦†ç›–å·²æœ‰çš„value</span></span><br><span class="line">                            <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                p.val = value;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­åœ¨é“¾è¡¨ä¸ä¸ºç©ºçš„æƒ…å†µä¸‹ï¼Œæ˜¯å¦è¾¾åˆ°è½¬ä¸ºçº¢é»‘æ ‘çš„é˜ˆå€¼</span></span><br><span class="line">                <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                 <span class="comment">// å¦‚æœé“¾è¡¨å…ƒç´ è¾¾åˆ°è½¬ä¸ºçº¢é»‘æ ‘çš„é˜ˆå€¼ï¼Œå°±è½¬ä¸ºçº¢é»‘æ ‘</span></span><br><span class="line">                    treeifyBin(tab, i);</span><br><span class="line">                <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> oldVal;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ·»åŠ è®¡æ•°</span></span><br><span class="line">    addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹æ­£åœ¨å¯¹ConcurrentHashMapè¿›è¡Œæ‰©å®¹æ“ä½œï¼Œå½“å‰çº¿ç¨‹ä¹Ÿè¦è¿›å…¥æ‰©å®¹çš„æ“ä½œä¸­ã€‚è¿™ä¸ªæ‰©å®¹çš„æ“ä½œä¹‹æ‰€ä»¥èƒ½è¢«æ£€æµ‹åˆ°ï¼Œæ˜¯å› ä¸ºtransferæ–¹æ³•ä¸­åœ¨ç©ºç»“ç‚¹ä¸Šæ’å…¥forwardèŠ‚ç‚¹ï¼Œå¦‚æœæ£€æµ‹åˆ°éœ€è¦æ’å…¥çš„ä½ç½®è¢«forwardèŠ‚ç‚¹å æœ‰ï¼Œå°±å¸®åŠ©è¿›è¡Œæ‰©å®¹ï¼›<br>
å¦‚æœæ£€æµ‹åˆ°è¦æ’å…¥çš„èŠ‚ç‚¹æ˜¯éç©ºä¸”ä¸æ˜¯forwardèŠ‚ç‚¹ï¼Œå°±å¯¹è¿™ä¸ªèŠ‚ç‚¹åŠ é”ï¼Œè¿™æ ·å°±ä¿è¯äº†çº¿ç¨‹å®‰å…¨ã€‚å°½ç®¡è¿™ä¸ªæœ‰ä¸€äº›å½±å“æ•ˆç‡ï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šæ¯”HashTableçš„synchronizedè¦å¥½å¾—å¤šã€‚<br>
putVal(K key, V value, boolean onlyIfAbsent)æ–¹æ³•å¹²çš„å·¥ä½œå¦‚ä¸‹ï¼š</p>
<ol>
<li>æ£€æŸ¥key/valueæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™æŠ›å¼‚å¸¸ï¼Œå¦åˆ™è¿›è¡Œ2</li>
<li>è¿›å…¥foræ­»å¾ªç¯ï¼Œè¿›è¡Œ3</li>
<li>æ£€æŸ¥tableæ˜¯å¦åˆå§‹åŒ–äº†ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è°ƒç”¨initTable()è¿›è¡Œåˆå§‹åŒ–ç„¶åè¿›è¡Œ 2ï¼Œå¦åˆ™è¿›è¡Œ4</li>
<li>æ ¹æ®keyçš„hashå€¼è®¡ç®—å‡ºå…¶åº”è¯¥åœ¨tableä¸­å‚¨å­˜çš„ä½ç½®iï¼Œå–å‡ºtable[i]çš„èŠ‚ç‚¹ç”¨fè¡¨ç¤ºã€‚<br>
æ ¹æ®fçš„ä¸åŒæœ‰å¦‚ä¸‹ä¸‰ç§æƒ…å†µï¼š<br>
(1) å¦‚æœtable[i]==null(å³è¯¥ä½ç½®çš„èŠ‚ç‚¹ä¸ºç©ºï¼Œæ²¡æœ‰å‘ç”Ÿç¢°æ’)ï¼Œ<br>
åˆ™åˆ©ç”¨CASæ“ä½œç›´æ¥å­˜å‚¨åœ¨è¯¥ä½ç½®ï¼Œå¦‚æœCASæ“ä½œæˆåŠŸåˆ™é€€å‡ºæ­»å¾ªç¯ã€‚<br>
(2) å¦‚æœtable[i]!=null(å³è¯¥ä½ç½®å·²ç»æœ‰å…¶å®ƒèŠ‚ç‚¹ï¼Œå‘ç”Ÿç¢°æ’)ï¼Œç¢°æ’å¤„ç†ä¹Ÿæœ‰ä¸¤ç§æƒ…å†µ<br>
(2.1)æ£€æŸ¥table[i]çš„èŠ‚ç‚¹çš„hashæ˜¯å¦ç­‰äºMOVEDï¼Œå¦‚æœç­‰äºï¼Œåˆ™æ£€æµ‹åˆ°æ­£åœ¨æ‰©å®¹ï¼Œåˆ™å¸®åŠ©å…¶æ‰©å®¹<br>
(2.2)è¯´æ˜table[i]çš„èŠ‚ç‚¹çš„hashå€¼ä¸ç­‰äºMOVEDï¼Œå¦‚æœtable[i]ä¸ºé“¾è¡¨èŠ‚ç‚¹ï¼Œåˆ™å°†æ­¤èŠ‚ç‚¹æ’å…¥é“¾è¡¨ä¸­å³å¯<br>
(3) å¦‚æœtable[i]ä¸ºæ ‘èŠ‚ç‚¹ï¼Œåˆ™å°†æ­¤èŠ‚ç‚¹æ’å…¥æ ‘ä¸­å³å¯ã€‚æ’å…¥æˆåŠŸåï¼Œè¿›è¡Œ 5</li>
<li>å¦‚æœtable[i]çš„èŠ‚ç‚¹æ˜¯é“¾è¡¨èŠ‚ç‚¹ï¼Œåˆ™æ£€æŸ¥tableçš„ç¬¬iä¸ªä½ç½®çš„é“¾è¡¨æ˜¯å¦éœ€è¦è½¬åŒ–ä¸ºæ•°ï¼Œå¦‚æœéœ€è¦åˆ™è°ƒç”¨treeifyBinå‡½æ•°è¿›è¡Œè½¬åŒ–</li>
</ol>
<p>1ã€ç¬¬ä¸€æ­¥æ ¹æ®ç»™å®šçš„keyçš„hashå€¼æ‰¾åˆ°å…¶åœ¨tableä¸­çš„ä½ç½®indexã€‚<br>
2ã€æ‰¾åˆ°ä½ç½®indexåï¼Œå­˜å‚¨è¿›è¡Œå°±å¥½äº†ã€‚</p>
<p>åªæ˜¯è¿™é‡Œçš„å­˜å‚¨æœ‰ä¸‰ç§æƒ…å†µç½¢äº†ï¼Œç¬¬ä¸€ç§ï¼štable[index]ä¸­æ²¡æœ‰ä»»ä½•å…¶ä»–å…ƒç´ ï¼Œå³æ­¤å…ƒç´ æ²¡æœ‰å‘ç”Ÿç¢°æ’ï¼Œè¿™ç§æƒ…å†µç›´æ¥CASå­˜å‚¨å°±å¥½äº†å“ˆã€‚ç¬¬äºŒç§ï¼Œtable[i]å­˜å‚¨çš„æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œå¦‚æœé“¾è¡¨ä¸å­˜åœ¨keyåˆ™ç›´æ¥åŠ å…¥åˆ°é“¾è¡¨å°¾éƒ¨å³å¯ï¼Œå¦‚æœå­˜åœ¨keyåˆ™æ›´æ–°å…¶å¯¹åº”çš„valueã€‚ç¬¬ä¸‰ç§ï¼Œtable[i]å­˜å‚¨çš„æ˜¯ä¸€ä¸ªæ ‘ï¼Œåˆ™æŒ‰ç…§æ ‘æ·»åŠ èŠ‚ç‚¹çš„æ–¹æ³•æ·»åŠ å°±å¥½ã€‚ç¬¬äºŒç§å’Œç¬¬ä¸‰ç§éœ€è¦å¯¹èŠ‚ç‚¹è¿›è¡ŒåŠ é”ã€‚</p>
<h2 id="ç›¸å…³é—®é¢˜">ç›¸å…³é—®é¢˜</h2>
<h3 id="å¹¶å‘ç¯å¢ƒä¸‹ä¸ºä»€ä¹ˆä½¿ç”¨ConcurrentHashMap">å¹¶å‘ç¯å¢ƒä¸‹ä¸ºä»€ä¹ˆä½¿ç”¨ConcurrentHashMap?</h3>
<ol>
<li>HashMapçº¿ç¨‹ä¸å®‰å…¨</li>
<li>HashTableè™½ç„¶æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯æ•ˆç‡ä½ä¸‹ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®HashTableçš„åŒæ­¥æ–¹æ³•æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¦‚æœä¹Ÿè®¿é—®HashTableçš„åŒæ­¥æ–¹æ³•ï¼Œé‚£ä¹ˆä¼šè¿›å…¥é˜»å¡æˆ–è€…è½®è®­çŠ¶æ€ã€‚</li>
<li>åœ¨jdk1.6ä¸­ConcurrentHashMapä½¿ç”¨é”åˆ†æ®µæŠ€æœ¯æé«˜å¹¶å‘è®¿é—®æ•ˆç‡ã€‚é¦–å…ˆå°†æ•°æ®åˆ†æˆä¸€æ®µä¸€æ®µåœ°å­˜å‚¨ï¼Œç„¶åç»™æ¯ä¸€æ®µæ•°æ®é…ä¸€ä¸ªé”ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å ç”¨é”è®¿é—®å…¶ä¸­ä¸€æ®µæ•°æ®æ—¶ï¼Œå…¶ä»–æ®µçš„æ•°æ®ä¹Ÿèƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®ã€‚ç„¶è€Œåœ¨jdk1.8ä¸­çš„å®ç°å·²ç»æŠ›å¼ƒäº†Segmentåˆ†æ®µé”æœºåˆ¶ï¼Œåˆ©ç”¨CAS+Synchronizedæ¥ä¿è¯å¹¶å‘æ›´æ–°çš„å®‰å…¨ï¼Œåº•å±‚ä¾ç„¶é‡‡ç”¨æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„å­˜å‚¨ç»“æ„ã€‚</li>
</ol>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<p>å…¶å®å¯ä»¥çœ‹å‡ºJDK1.8ç‰ˆæœ¬çš„ConcurrentHashMapçš„æ•°æ®ç»“æ„å·²ç»æ¥è¿‘HashMapï¼Œç›¸å¯¹è€Œè¨€ï¼ŒConcurrentHashMapåªæ˜¯å¢åŠ äº†åŒæ­¥çš„æ“ä½œæ¥æ§åˆ¶å¹¶å‘ï¼Œä»JDK1.7ç‰ˆæœ¬çš„ReentrantLock+Segment+HashEntryï¼Œåˆ°JDK1.8ç‰ˆæœ¬ä¸­synchronized+CAS+HashEntry+çº¢é»‘æ ‘ã€‚<br>
1.æ•°æ®ç»“æ„ï¼šå–æ¶ˆäº†Segmentåˆ†æ®µé”çš„æ•°æ®ç»“æ„ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯æ•°ç»„+é“¾è¡¨+çº¢é»‘æ ‘çš„ç»“æ„ã€‚<br>
2.ä¿è¯çº¿ç¨‹å®‰å…¨æœºåˆ¶ï¼šJDK1.7é‡‡ç”¨segmentçš„åˆ†æ®µé”æœºåˆ¶å®ç°çº¿ç¨‹å®‰å…¨ï¼Œå…¶ä¸­segmentç»§æ‰¿è‡ªReentrantLockã€‚JDK1.8é‡‡ç”¨CAS+Synchronizedä¿è¯çº¿ç¨‹å®‰å…¨ã€‚<br>
3.é”çš„ç²’åº¦ï¼šåŸæ¥æ˜¯å¯¹éœ€è¦è¿›è¡Œæ•°æ®æ“ä½œçš„SegmentåŠ é”ï¼Œç°è°ƒæ•´ä¸ºå¯¹æ¯ä¸ªæ•°ç»„å…ƒç´ åŠ é”ï¼ˆNodeï¼‰ã€‚<br>
4.é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘:å®šä½ç»“ç‚¹çš„hashç®—æ³•ç®€åŒ–ä¼šå¸¦æ¥å¼Šç«¯,Hashå†²çªåŠ å‰§,å› æ­¤åœ¨é“¾è¡¨èŠ‚ç‚¹æ•°é‡å¤§äº8æ—¶ï¼Œä¼šå°†é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘è¿›è¡Œå­˜å‚¨ã€‚5.æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦ï¼šä»åŸæ¥çš„éå†é“¾è¡¨O(n)ï¼Œå˜æˆéå†çº¢é»‘æ ‘O(logN)ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>Javaæºç è§£æ</category>
      </categories>
      <tags>
        <tag>Javaæºç è§£æ</tag>
      </tags>
  </entry>
  <entry>
    <title>HashMapæºç åˆ†æ</title>
    <url>/2019/11/18/HashMap%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h2 id="ç›¸å…³æ¦‚å¿µ">ç›¸å…³æ¦‚å¿µ</h2>
<h3 id="æ•°ç»„">æ•°ç»„</h3>
<p>æ•°ç»„å…·æœ‰éå†å¿«ï¼Œå¢åˆ æ…¢çš„ç‰¹ç‚¹ã€‚æ•°ç»„åœ¨å †ä¸­æ˜¯ä¸€å—è¿ç»­çš„å­˜å‚¨ç©ºé—´ï¼Œéå†æ—¶æ•°ç»„çš„é¦–åœ°å€æ˜¯çŸ¥é“çš„ï¼ˆé¦–åœ°å€=é¦–åœ°å€+å…ƒç´ å­—èŠ‚æ•° * ä¸‹æ ‡ï¼‰ï¼Œæ‰€ä»¥éå†å¿«ï¼ˆæ•°ç»„éå†çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(1) ï¼‰ï¼›å¢åˆ æ…¢æ˜¯å› ä¸ºï¼Œå½“åœ¨ä¸­é—´æ’å…¥æˆ–åˆ é™¤å…ƒç´ æ—¶ï¼Œä¼šé€ æˆè¯¥å…ƒç´ åé¢æ‰€æœ‰å…ƒç´ åœ°å€çš„æ”¹å˜ï¼Œæ‰€ä»¥å¢åˆ æ…¢ï¼ˆå¢åˆ çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(n) ï¼‰ã€‚</p>
<h3 id="é“¾è¡¨">é“¾è¡¨</h3>
<p>é“¾è¡¨å…·æœ‰å¢åˆ å¿«ï¼Œéå†æ…¢çš„ç‰¹ç‚¹ã€‚é“¾è¡¨ä¸­å„å…ƒç´ çš„å†…å­˜ç©ºé—´æ˜¯ä¸è¿ç»­çš„ï¼Œä¸€ä¸ªèŠ‚ç‚¹è‡³å°‘åŒ…å«èŠ‚ç‚¹æ•°æ®ä¸åç»§èŠ‚ç‚¹çš„å¼•ç”¨ï¼Œæ‰€ä»¥åœ¨æ’å…¥åˆ é™¤æ—¶ï¼Œåªéœ€ä¿®æ”¹è¯¥ä½ç½®çš„å‰é©±èŠ‚ç‚¹ä¸åç»§èŠ‚ç‚¹å³å¯ï¼Œé“¾è¡¨åœ¨æ’å…¥åˆ é™¤æ—¶çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(1)ã€‚ä½†æ˜¯åœ¨éå†æ—¶ï¼Œget(n)å…ƒç´ æ—¶ï¼Œéœ€è¦ä»ç¬¬ä¸€ä¸ªå¼€å§‹ï¼Œä¾æ¬¡æ‹¿åˆ°åé¢å…ƒç´ çš„åœ°å€ï¼Œè¿›è¡Œéå†ï¼Œç›´åˆ°éå†åˆ°ç¬¬nä¸ªå…ƒç´ ï¼ˆæ—¶é—´å¤æ‚åº¦ä¸ºO(n) ï¼‰ï¼Œæ‰€ä»¥æ•ˆç‡æä½ã€‚</p>
<h3 id="HashMap">HashMap</h3>
<p>Hashè¡¨æ˜¯ä¸€ä¸ªæ•°ç»„+é“¾è¡¨çš„ç»“æ„ï¼Œè¿™ç§ç»“æ„èƒ½å¤Ÿä¿è¯åœ¨éå†ä¸å¢åˆ çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸äº§ç”Ÿhashç¢°æ’ï¼Œä»…éœ€ä¸€æ¬¡å®šä½å°±å¯å®Œæˆï¼Œæ—¶é—´å¤æ‚åº¦èƒ½ä¿è¯åœ¨O(1)ã€‚  åœ¨jdk1.7ä¸­ï¼Œåªæ˜¯å•çº¯çš„æ•°ç»„+é“¾è¡¨çš„ç»“æ„ï¼Œä½†æ˜¯å¦‚æœæ•£åˆ—è¡¨ä¸­çš„hashç¢°æ’è¿‡å¤šæ—¶ï¼Œä¼šé€ æˆæ•ˆç‡çš„é™ä½ï¼Œæ‰€ä»¥åœ¨JKD1.8ä¸­å¯¹è¿™ç§æƒ…å†µè¿›è¡Œäº†æ§åˆ¶ï¼Œå½“ä¸€ä¸ªhashå€¼ä¸Šçš„é“¾è¡¨é•¿åº¦å¤§äº8æ—¶ï¼Œè¯¥èŠ‚ç‚¹ä¸Šçš„æ•°æ®å°±ä¸å†ä»¥é“¾è¡¨è¿›è¡Œå­˜å‚¨ï¼Œè€Œæ˜¯è½¬æˆäº†ä¸€ä¸ªçº¢é»‘æ ‘ã€‚</p>
<a id="more"></a>
<h3 id="hashç¢°æ’ï¼š">hashç¢°æ’ï¼š</h3>
<p>hashæ˜¯æŒ‡ï¼Œä¸¤ä¸ªå…ƒç´ é€šè¿‡hashå‡½æ•°è®¡ç®—å‡ºçš„å€¼æ˜¯ä¸€æ ·çš„ï¼Œæ˜¯åŒä¸€ä¸ªå­˜å‚¨åœ°å€ã€‚å½“åé¢çš„å…ƒç´ è¦æ’å…¥åˆ°è¿™ä¸ªåœ°å€æ—¶ï¼Œå‘ç°å·²ç»è¢«å ç”¨äº†ï¼Œè¿™æ—¶å€™å°±äº§ç”Ÿäº†hashå†²çª</p>
<h3 id="hashå†²çªçš„è§£å†³æ–¹æ³•ï¼š">hashå†²çªçš„è§£å†³æ–¹æ³•ï¼š</h3>
<p>å¼€æ”¾å®šå€æ³•(æŸ¥è¯¢äº§ç”Ÿå†²çªçš„åœ°å€çš„ä¸‹ä¸€ä¸ªåœ°å€æ˜¯å¦è¢«å ç”¨ï¼Œç›´åˆ°å¯»æ‰¾åˆ°ç©ºçš„åœ°å€)ï¼Œå†æ•£åˆ—æ³•ï¼Œé“¾åœ°å€æ³•ç­‰ã€‚hashmapé‡‡ç”¨çš„å°±æ˜¯é“¾åœ°å€æ³•ï¼Œjdk1.7ä¸­ï¼Œå½“å†²çªæ—¶ï¼Œåœ¨å†²çªçš„åœ°å€ä¸Šç”Ÿæˆä¸€ä¸ªé“¾è¡¨ï¼Œå°†å†²çªçš„å…ƒç´ çš„keyï¼Œé€šè¿‡equalsè¿›è¡Œæ¯”è¾ƒï¼Œç›¸åŒå³è¦†ç›–ï¼Œä¸åŒåˆ™æ·»åŠ åˆ°é“¾è¡¨ä¸Šï¼Œæ­¤æ—¶å¦‚æœé“¾è¡¨è¿‡é•¿ï¼Œæ•ˆç‡å°±ä¼šå¤§å¤§é™ä½ï¼ŒæŸ¥æ‰¾å’Œæ·»åŠ æ“ä½œçš„æ—¶é—´å¤æ‚åº¦éƒ½ä¸ºO(n)ï¼›ä½†æ˜¯åœ¨jdk1.8ä¸­å¦‚æœé“¾è¡¨é•¿åº¦å¤§äº8ï¼Œé“¾è¡¨å°±ä¼šè½¬åŒ–ä¸ºçº¢é»‘æ ‘ï¼Œæ—¶é—´å¤æ‚åº¦ä¹Ÿé™ä¸ºäº†O(logn)ï¼Œæ€§èƒ½å¾—åˆ°äº†å¾ˆå¤§çš„ä¼˜åŒ–ã€‚</p>
<h3 id="HashMapçš„ç»§æ‰¿å›¾ï¼ˆç›—å›¾ï¼‰">HashMapçš„ç»§æ‰¿å›¾ï¼ˆç›—å›¾ï¼‰</h3>
<p><img src="/images/hashmapentends.jpg" alt=""><br>
HashMap æ ¹æ®é”®çš„ hashCode å€¼å­˜å‚¨æ•°æ®ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹å¯ä»¥ç›´æ¥å®šä½åˆ°å®ƒçš„å€¼ï¼Œå› è€Œå…·æœ‰å¾ˆå¿«çš„è®¿é—®é€Ÿåº¦ï¼Œä½†éå†é¡ºåºå´æ˜¯ä¸ç¡®å®šçš„ã€‚ HashMap æœ€å¤šåªå…è®¸ä¸€æ¡è®°å½•çš„é”®ä¸º null ï¼Œå…è®¸å¤šæ¡è®°å½•çš„å€¼ä¸º null ã€‚HashMap éçº¿ç¨‹å®‰å…¨ï¼Œå³ä»»ä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶å†™ HashMapï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®çš„ä¸ä¸€è‡´ã€‚å¦‚æœéœ€è¦æ»¡è¶³çº¿ç¨‹å®‰å…¨ï¼Œå¯ä»¥ç”¨ Collectionsçš„synchronizedMap æ–¹æ³•ä½¿ HashMap å…·æœ‰çº¿ç¨‹å®‰å…¨çš„èƒ½åŠ›ï¼Œæˆ–è€…ä½¿ç”¨ConcurrentHashMapã€‚</p>
<h3 id="HashMapå­˜å‚¨ç»“æ„">HashMapå­˜å‚¨ç»“æ„</h3>
<p><img src="/images/hashmap.jpg" alt=""></p>
<h2 id="æºç åˆ†æ">æºç åˆ†æ</h2>
<h3 id="å¸¸é‡å®šä¹‰">å¸¸é‡å®šä¹‰</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»º HashMap æ—¶æœªæŒ‡å®šåˆå§‹å®¹é‡æƒ…å†µä¸‹çš„é»˜è®¤å®¹é‡ä¸º16</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">4</span>; <span class="comment">// aka 16</span></span><br><span class="line"><span class="comment">//HashMapæœ€å¤§å®¹é‡</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br><span class="line"><span class="comment">//HashMap é»˜è®¤çš„è´Ÿè½½å› å­ï¼ˆä¹Ÿå«å¡«å……æ¯”ï¼‰</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">float</span> DEFAULT_LOAD_FACTOR = <span class="number">0.75f</span>;   <span class="comment">//è¡¨ç¤ºå½“mapé›†åˆä¸­å­˜å‚¨çš„æ•°æ®è¾¾åˆ°å½“å‰æ•°ç»„å¤§å°çš„75%åˆ™éœ€è¦è¿›è¡Œæ‰©å®¹</span></span><br><span class="line"><span class="comment">//ç”¨æ¥ç¡®å®šä½•æ—¶å°†è§£å†³ hash å†²çªçš„é“¾è¡¨è½¬å˜ä¸ºçº¢é»‘æ ‘,å¦‚æœä¸»å¹²æ•°ç»„ä¸Šçš„é“¾è¡¨çš„é•¿åº¦å¤§äº8ï¼Œé“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TREEIFY_THRESHOLD = <span class="number">8</span>;</span><br><span class="line"><span class="comment">//ç”¨æ¥ç¡®å®šä½•æ—¶å°†è§£å†³ hash å†²çªçš„çº¢é»‘æ ‘è½¬å˜ä¸ºé“¾è¡¨,hashè¡¨æ‰©å®¹åï¼Œå¦‚æœå‘ç°æŸä¸€ä¸ªçº¢é»‘æ ‘çš„é•¿åº¦å°äº6ï¼Œåˆ™ä¼šé‡æ–°é€€åŒ–ä¸ºé“¾è¡¨</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNTREEIFY_THRESHOLD = <span class="number">6</span>;</span><br><span class="line"><span class="comment">//å½“hashmapå®¹é‡å¤§äº64æ—¶ï¼Œé“¾è¡¨æ‰èƒ½è½¬æˆçº¢é»‘æ ‘,è‹¥æ˜¯ç”±äºæ•°ç»„å®¹é‡å¤ªå°ï¼ˆå°äº64ï¼‰å¯¼è‡´çš„ hash å†²çªå¤ªå¤šï¼Œåˆ™ä¸è¿›è¡Œé“¾è¡¨è½¬å˜ä¸ºçº¢é»‘æ ‘æ“ä½œï¼Œè½¬ä¸ºåˆ©ç”¨ã€€resize() å‡½æ•°å¯¹ã€€hashMap æ‰©å®¹</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_TREEIFY_CAPACITY = <span class="number">64</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ALTERNATIVE_HASHING_THRESHOLD_DEFAULT = Integer.MAX_VALUE;</span><br><span class="line"><span class="comment">//ä¿å­˜Node&lt;K,V&gt;èŠ‚ç‚¹çš„æ•°ç»„</span></span><br><span class="line"><span class="keyword">transient</span> Node&lt;K,V&gt;[] table;</span><br><span class="line"><span class="comment">//ç”±ã€€hashMap ä¸­ Node&lt;K,V&gt;ã€€èŠ‚ç‚¹æ„æˆçš„ set</span></span><br><span class="line"><span class="keyword">transient</span> Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet;</span><br><span class="line"><span class="comment">//Mapä¸­å½“å‰å­˜å‚¨çš„å…ƒç´ æ•°é‡</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> size;</span><br><span class="line"><span class="comment">//é˜ˆå€¼ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ï¼ˆthreshold = å®¹é‡*è´Ÿè½½å› å­ï¼‰</span></span><br><span class="line"><span class="keyword">int</span> threshold;</span><br><span class="line"><span class="comment">//HashMapåŠ è½½å› å­å®é™…çš„å¤§å°</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">float</span> loadFactor;</span><br><span class="line"><span class="comment">//HashMapå‘ç”Ÿç»“æ„æ€§å˜åŒ–çš„æ¬¡æ•°ï¼ˆæ³¨æ„ã€€value çš„è¦†ç›–ä¸å±äºç»“æ„æ€§å˜åŒ–ï¼‰</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">int</span> modCount;</span><br></pre></td></tr></table></figure>
<h3 id="æ„é€ æ–¹æ³•">æ„é€ æ–¹æ³•</h3>
<p>HashMapçš„æ„é€ æ–¹æ³•æœ‰4ç§ï¼Œä¸»è¦æ¶‰åŠåˆ°çš„å‚æ•°æœ‰ï¼ŒæŒ‡å®šåˆå§‹å®¹é‡ï¼ŒæŒ‡å®šå¡«å……æ¯”å’Œç”¨æ¥åˆå§‹åŒ–çš„Map</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ„é€ å‡½æ•°1 æŒ‡å®šåˆå§‹å®¹é‡å’Œè´Ÿè½½å› å­</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//æŒ‡å®šçš„åˆå§‹å®¹é‡éè´Ÿ</span></span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(Illegal initial capacity:  +</span><br><span class="line">                                           initialCapacity);</span><br><span class="line">    <span class="comment">//å¦‚æœæŒ‡å®šçš„åˆå§‹å®¹é‡å¤§äºæœ€å¤§å®¹é‡,ç½®ä¸ºæœ€å¤§å®¹é‡</span></span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">        initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">    <span class="comment">//å¡«å……æ¯”ä¸ºæ­£</span></span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(Illegal load factor:  +</span><br><span class="line">                                           loadFactor);</span><br><span class="line">    <span class="comment">/* tableSizeFor(initialCapacity)ã€€æ–¹æ³•è¿”å›çš„å€¼æ˜¯æœ€æ¥è¿‘ initialCapacity çš„2çš„å¹‚ï¼Œè‹¥æŒ‡å®šåˆå§‹å®¹é‡ä¸º9ï¼Œåˆ™å®é™… hashMap å®¹é‡ä¸º16*/</span></span><br><span class="line">    ã€€<span class="comment">//æ³¨æ„æ­¤ç§æ–¹æ³•åˆ›å»ºçš„ hashMap åˆå§‹å®¹é‡çš„å€¼å­˜åœ¨ã€€threshold ä¸­</span></span><br><span class="line">    <span class="keyword">this</span>.loadFactor = loadFactor;</span><br><span class="line">    <span class="keyword">this</span>.threshold = tableSizeFor(initialCapacity);<span class="comment">//æ–°çš„æ‰©å®¹ä¸´ç•Œå€¼</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//tableSizeFor(initialCapacity)ã€€æ–¹æ³•è¿”å›çš„å€¼æ˜¯æœ€æ¥è¿‘ initialCapacity çš„2çš„å¹‚</span></span><br><span class="line"> <span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tableSizeFor</span><span class="params">(<span class="keyword">int</span> cap)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = cap - <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">1</span>;<span class="comment">// &gt;&gt;&gt; ä»£è¡¨æ— ç¬¦å·å³ç§»</span></span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ„é€ å‡½æ•°2 æŒ‡å®šåˆå§‹å®¹é‡</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(initialCapacity, DEFAULT_LOAD_FACTOR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ„é€ å‡½æ•°3 æ— å‚æ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR; <span class="comment">// all other fields defaulted</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ„é€ å‡½æ•°4 ç”¨mçš„å…ƒç´ åˆå§‹åŒ–æ•£åˆ—æ˜ å°„ æŒ‡å®šé›†åˆ è½¬åŒ–ä¸ºiHashMap</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(Map&lt;!--? extends K, ? extends V--&gt; m)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR;</span><br><span class="line">    putMapEntries(m, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ•°ç»„é‡Œé¢æ¯ä¸ªåœ°æ–¹éƒ½å­˜äº†Key-Valueè¿™æ ·çš„å®ä¾‹ï¼Œåœ¨Java7å«Entryåœ¨Java8ä¸­å«Nodeã€‚æ•°ç»„å’Œé“¾è¡¨ç»„åˆæ„æˆçš„æ•°æ®ç»“æ„å¤§æ¦‚å¦‚ä¸‹-å·å›¾-ï¼š">æ•°ç»„é‡Œé¢æ¯ä¸ªåœ°æ–¹éƒ½å­˜äº†Key-Valueè¿™æ ·çš„å®ä¾‹ï¼Œåœ¨Java7å«Entryåœ¨Java8ä¸­å«Nodeã€‚æ•°ç»„å’Œé“¾è¡¨ç»„åˆæ„æˆçš„æ•°æ®ç»“æ„å¤§æ¦‚å¦‚ä¸‹(å·å›¾)ï¼š</h3>
<p><img src="/images/arraylist.jpg" alt=""><br>
å› ä¸ºä»–æœ¬èº«æ‰€æœ‰çš„ä½ç½®éƒ½ä¸ºnullï¼Œåœ¨putæ’å…¥çš„æ—¶å€™ä¼šæ ¹æ®keyçš„hashå»è®¡ç®—ä¸€ä¸ªindexå€¼ã€‚<br>
å°±æ¯”å¦‚æˆ‘putï¼ˆâ€å¸…ä¸™â€œï¼Œ520ï¼‰ï¼Œæˆ‘æ’å…¥äº†ä¸ºâ€å¸…ä¸™â€œçš„å…ƒç´ ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬ä¼šé€šè¿‡å“ˆå¸Œå‡½æ•°è®¡ç®—å‡ºæ’å…¥çš„ä½ç½®ï¼Œè®¡ç®—å‡ºæ¥indexæ˜¯2é‚£ç»“æœå¦‚ä¸‹(å·å›¾)ã€‚<br>
hashï¼ˆâ€œå¸…ä¸™â€ï¼‰= 2<br>
<img src="/images/shuaibing.jpg" alt=""><br>
æˆ‘ä»¬éƒ½çŸ¥é“æ•°ç»„é•¿åº¦æ˜¯æœ‰é™çš„ï¼Œåœ¨æœ‰é™çš„é•¿åº¦é‡Œé¢æˆ‘ä»¬ä½¿ç”¨å“ˆå¸Œï¼Œå“ˆå¸Œæœ¬èº«å°±å­˜åœ¨æ¦‚ç‡æ€§ï¼Œå°±æ˜¯â€å¸…ä¸™â€œå’Œâ€ä¸™å¸…â€œæˆ‘ä»¬éƒ½å»hashæœ‰ä¸€å®šçš„æ¦‚ç‡ä¼šä¸€æ ·ï¼Œå°±åƒä¸Šé¢çš„æƒ…å†µæˆ‘å†æ¬¡å“ˆå¸Œâ€ä¸™å¸…â€œæç«¯æƒ…å†µä¹Ÿä¼šhashåˆ°ä¸€ä¸ªå€¼ä¸Šï¼Œé‚£å°±å½¢æˆäº†é“¾è¡¨ï¼ˆå·å›¾ï¼‰ã€‚<br>
<img src="/images/bingshuai.jpg" alt=""><br>
æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½ä¼šä¿å­˜è‡ªèº«çš„hashã€keyã€valueã€ä»¥åŠä¸‹ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘çœ‹çœ‹Nodeçš„æºç ã€‚<br>
<img src="/images/node.jpg" alt=""><br>
ä¸‹å›¾æ˜¯ä¸€ä½å¤§ç¥çº§åˆ«ç”»çš„å›¾ï¼Œè‡ªå·±å°±ä¸å†é€ è½®å­äº†ã€‚å®¢å®˜è¯·çœ‹<br>
<img src="/images/putval.jpg" alt=""></p>
<h3 id="HashMapçš„put-ï¼Œå­˜å€¼è¿‡ç¨‹">HashMapçš„put()ï¼Œå­˜å€¼è¿‡ç¨‹</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;<span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line"> <span class="comment">/*key çš„ hashã€€å€¼çš„è®¡ç®—æ˜¯é€šè¿‡hashCode()çš„é«˜16ä½å¼‚æˆ–ä½16ä½å®ç°çš„ï¼š(h = k.hashCode()) ^ (h &gt;&gt;&gt; 16)ï¼Œä¸»è¦æ˜¯ä»é€Ÿåº¦ã€åŠŸæ•ˆã€è´¨é‡æ¥è€ƒè™‘çš„ï¼Œè¿™ä¹ˆåšå¯ä»¥åœ¨æ•°ç»„tableçš„lengthæ¯”è¾ƒå°çš„æ—¶å€™ï¼Œä¹Ÿèƒ½ä¿è¯è€ƒè™‘åˆ°é«˜ä½Bitéƒ½å‚ä¸åˆ°Hashçš„è®¡ç®—ä¸­ï¼ŒåŒæ—¶ä¸ä¼šæœ‰å¤ªå¤§çš„å¼€é”€*/</span></span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putAll</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class="line">        putMapEntries(m, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">/*æŠŠMap&lt;? extends K, ? extends V&gt; m ä¸­çš„å…ƒç´ æ’å…¥åˆ°ã€€hashMap ä¸­,è‹¥ evict ä¸º false,ä»£è¡¨æ˜¯åœ¨åˆ›å»º hashMap æ—¶è°ƒç”¨äº†è¿™ä¸ªå‡½æ•°ï¼Œä¾‹å¦‚åˆ©ç”¨ä¸Šè¿°æ„é€ å‡½æ•°ï¼“åˆ›å»º hashMap;è‹¥ evictã€€ä¸ºtrue,ä»£è¡¨æ˜¯åœ¨åˆ›å»ºã€€hashMap åæ‰è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œä¾‹å¦‚ä¸Šè¿°çš„ã€€putAll å‡½æ•°ã€‚*/</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">putMapEntries</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m, <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> s = m.size();</span><br><span class="line">    <span class="keyword">if</span> (s &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*å¦‚æœæ˜¯åœ¨åˆ›å»º hashMap æ—¶è°ƒç”¨çš„è¿™ä¸ªå‡½æ•°åˆ™ table ä¸€å®šä¸ºç©º*/</span></span><br><span class="line">        <span class="keyword">if</span> (table == <span class="keyword">null</span>) &#123; <span class="comment">// pre-size</span></span><br><span class="line">        <span class="comment">//æ ¹æ®å¾…æ’å…¥çš„map çš„ size è®¡ç®—è¦åˆ›å»ºçš„ã€€hashMap çš„å®¹é‡ã€‚</span></span><br><span class="line">            <span class="keyword">float</span> ft = ((<span class="keyword">float</span>)s / loadFactor) + <span class="number">1.0F</span>;</span><br><span class="line">            <span class="keyword">int</span> t = ((ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY) ?</span><br><span class="line">                        (<span class="keyword">int</span>)ft : MAXIMUM_CAPACITY);</span><br><span class="line">            <span class="comment">//æŠŠè¦åˆ›å»ºçš„ã€€hashMap çš„å®¹é‡å­˜åœ¨ã€€thresholdã€€ä¸­</span></span><br><span class="line">            <span class="keyword">if</span> (t &gt; threshold)</span><br><span class="line">                threshold = tableSizeFor(t);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//åˆ¤æ–­å¾…æ’å…¥çš„map çš„ size,è‹¥size å¤§äºthresholdï¼Œåˆ™å…ˆè¿›è¡Œresize()</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s &gt; threshold)</span><br><span class="line">            resize();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;? extends K, ? extends V&gt; e : m.entrySet()) &#123;</span><br><span class="line">            K key = e.getKey();</span><br><span class="line">            V value = e.getValue();</span><br><span class="line">            <span class="comment">//å®é™…ä¹Ÿæ˜¯è°ƒç”¨ã€€putValã€€å‡½æ•°è¿›è¡Œå…ƒç´ çš„æ’å…¥</span></span><br><span class="line">            putVal(hash(key), key, value, <span class="keyword">false</span>, evict);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ•°ç»„æ˜¯å¦ä¸ºç©ºï¼Œé•¿åº¦æ˜¯å¦ä¸º0ï¼Œæ˜¯åˆ™è¿›è¡Œæ‰©å®¹æ•°ç»„åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">        n = (tab = resize()).length;</span><br><span class="line">    <span class="comment">// é€šè¿‡hashç®—æ³•æ‰¾åˆ°æ•°ç»„ä¸‹æ ‡å¾—åˆ°æ•°ç»„å…ƒç´ ï¼Œå¦‚æœtableçš„åœ¨ï¼ˆn-1ï¼‰&amp;hashçš„å€¼ä¸ºç©ºåˆ™æ–°å»ºï¼ˆæ³¨æ„ç¡®å®šæ’å…¥ä½ç½®æ‰€ç”¨çš„è®¡ç®—æ–¹æ³•ä¸ºã€€(n - 1) &amp; hash,ç”±äºã€€n ä¸€å®šæ˜¯ï¼’çš„å¹‚æ¬¡ï¼Œè¿™ä¸ªæ“ä½œç›¸å½“äºhash % n ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">        tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">////è¯´æ˜å¾…æ’å…¥ä½ç½®å­˜åœ¨å…ƒç´ </span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        Node&lt;K,V&gt; e; K k;</span><br><span class="line">        <span class="comment">//  æ¯”è¾ƒåŸæ¥å…ƒç´ ä¸å¾…æ’å…¥å…ƒç´ çš„ã€€hash å€¼å’Œã€€key å€¼ï¼Œhashç›¸ç­‰åŒæ—¶keyç›¸ç­‰ï¼Œåˆ™ç›´æ¥è¦†ç›–ï¼ˆæ£€æŸ¥ç¬¬ä¸€ä¸ªNodeï¼Œpæ˜¯ä¸æ˜¯è¦æ‰¾çš„å€¼ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">            ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            e = p;</span><br><span class="line">        <span class="comment">// è¯¥æ•°ç»„å…ƒç´ åœ¨é“¾è¡¨é•¿åº¦&gt;8åå½¢æˆçº¢é»‘æ ‘ç»“æ„çš„å¯¹è±¡,pä¸ºæ ‘ç»“æ„å·²å­˜åœ¨çš„å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è¯¥æ•°ç»„å…ƒç´ hashç›¸ç­‰ï¼Œkeyä¸ç­‰ï¼ŒåŒæ—¶é“¾è¡¨é•¿åº¦&lt;8.è¿›è¡Œéå†å¯»æ‰¾å…ƒç´ ï¼Œæœ‰å°±è¦†ç›–æ— åˆ™æ–°å»º</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// æ–°å»ºé“¾è¡¨ä¸­æ•°æ®å…ƒç´ ï¼Œå°¾æ’æ³•</span></span><br><span class="line">                    p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                    <span class="comment">// é“¾è¡¨é•¿åº¦&gt;=8 ç»“æ„è½¬ä¸º çº¢é»‘æ ‘</span></span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                        treeifyBin(tab, hash);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//å¦‚æœéå†è¿‡ç¨‹ä¸­é“¾è¡¨ä¸­çš„å…ƒç´ ä¸æ–°æ·»åŠ çš„å…ƒç´ å®Œå…¨ç›¸åŒï¼Œkeyå­˜åœ¨ï¼Œç›´æ¥è¦†ç›–ï¼Œåˆ™è·³å‡ºå¾ªç¯</span></span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                p = e;<span class="comment">//å°†pä¸­çš„nextèµ‹å€¼ç»™p,å³å°†é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªnodeèµ‹å€¼ç»™pï¼Œ</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="comment">// æ–°å€¼è¦†ç›–æ—§å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key  //è¿™ä¸ªåˆ¤æ–­ä¸­ä»£ç ä½œç”¨ä¸ºï¼šå¦‚æœæ·»åŠ çš„å…ƒç´ äº§ç”Ÿäº†hashå†²çªï¼Œé‚£ä¹ˆè°ƒç”¨putæ–¹æ³•æ—¶ï¼Œä¼šå°†ä»–åœ¨é“¾è¡¨ä¸­ä»–çš„ä¸Šä¸€ä¸ªå…ƒç´ çš„å€¼è¿”å›</span></span><br><span class="line">            V oldValue = e.value;</span><br><span class="line">            <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                e.value = value;</span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è®°å½•ä¿®æ”¹æ¬¡æ•°</span></span><br><span class="line">    ++modCount;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">        resize();</span><br><span class="line">    afterNodeInsertion(evict);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//  putæ–¹æ³•ä¸­è°ƒç”¨çš„putTreeValå‡½æ•°</span></span><br><span class="line"><span class="comment">/*è¯»æ‡‚è¿™ä¸ªå‡½æ•°è¦æ³¨æ„ç†è§£ hash å†²çªå‘ç”Ÿçš„å‡ ç§æƒ…å†µ</span></span><br><span class="line"><span class="comment"> 1ã€ä¸¤èŠ‚ç‚¹ã€€key å€¼ç›¸åŒï¼ˆhashå€¼ä¸€å®šç›¸åŒï¼‰ï¼Œå¯¼è‡´å†²çª</span></span><br><span class="line"><span class="comment"> 2ã€ä¸¤èŠ‚ç‚¹ã€€key å€¼ä¸åŒï¼Œç”±äº hash å‡½æ•°çš„å±€é™æ€§å¯¼è‡´hash å€¼ç›¸åŒï¼Œå†²çª</span></span><br><span class="line"><span class="comment"> 3ã€ä¸¤èŠ‚ç‚¹ã€€key å€¼ä¸åŒï¼Œhash å€¼ä¸åŒï¼Œä½† hash å€¼å¯¹æ•°ç»„é•¿åº¦å–æ¨¡åç›¸åŒï¼Œå†²çª</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> TreeNode&lt;K,V&gt; <span class="title">putTreeVal</span><span class="params">(HashMap&lt;K,V&gt; map, Node&lt;K,V&gt;[] tab,<span class="keyword">int</span> h, K k, V v)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; kc = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> searched = <span class="keyword">false</span>;</span><br><span class="line">    TreeNode&lt;K,V&gt; root = (parent != <span class="keyword">null</span>) ? root() : <span class="keyword">this</span>;</span><br><span class="line">        <span class="comment">//ä»æ ¹èŠ‚ç‚¹å¼€å§‹æŸ¥æ‰¾åˆé€‚çš„æ’å…¥ä½ç½®ï¼ˆä¸äºŒå‰æœç´¢æ ‘æŸ¥æ‰¾è¿‡ç¨‹ç›¸åŒï¼‰</span></span><br><span class="line">    <span class="keyword">for</span> (TreeNode&lt;K,V&gt; p = root;;) &#123;</span><br><span class="line">        <span class="keyword">int</span> dir, ph; K pk;</span><br><span class="line">        <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">            dir = -<span class="number">1</span>; <span class="comment">//dirå°äº0ï¼Œæ¥ä¸‹æ¥æŸ¥æ‰¾å½“å‰èŠ‚ç‚¹å·¦å­©å­</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">            dir = <span class="number">1</span>; <span class="comment">//ã€€dirå¤§äº0ï¼Œæ¥ä¸‹æ¥æŸ¥æ‰¾å½“å‰èŠ‚ç‚¹å³å­©å­</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((pk = p.key) == k || (k != <span class="keyword">null</span> &amp;&amp; k.equals(pk)))</span><br><span class="line">        <span class="comment">//è¿›å…¥è¿™ä¸ªelse if ä»£è¡¨ã€€hash å€¼ç›¸åŒï¼Œkeyã€€ç›¸åŒ</span></span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">                <span class="comment">/*è¦è¿›å…¥ä¸‹é¢è¿™ä¸ªelse if,ä»£è¡¨æœ‰ä»¥ä¸‹å‡ ä¸ªå«ä¹‰:</span></span><br><span class="line"><span class="comment">            1ã€å½“å‰èŠ‚ç‚¹ä¸å¾…æ’å…¥èŠ‚ç‚¹ã€€keyã€€ä¸åŒ,ã€€hash å€¼ç›¸åŒ</span></span><br><span class="line"><span class="comment">ã€€ã€€ã€€ã€€ã€€ã€€ 2ã€kæ˜¯ä¸å¯æ¯”è¾ƒçš„ï¼Œå³kå¹¶æœªå®ç°ã€€comparable&lt;K&gt;ã€€æ¥å£</span></span><br><span class="line"><span class="comment">ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ï¼ˆè‹¥ k å®ç°äº†comparable&lt;K&gt;ã€€æ¥å£ï¼ŒcomparableClassForï¼ˆkï¼‰è¿”å›çš„æ˜¯kçš„ã€€class,è€Œä¸æ˜¯ã€€nullï¼‰</span></span><br><span class="line"><span class="comment">            ã€€ã€€æˆ–è€…ã€€compareComparables(kc, k, pk)ã€€è¿”å›å€¼ä¸º 0</span></span><br><span class="line"><span class="comment">ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€(pk ä¸ºç©ºã€€æˆ–è€…ã€€æŒ‰ç…§ k.compareTo(pk) è¿”å›å€¼ä¸º0ï¼Œ</span></span><br><span class="line"><span class="comment">ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€è¿”å›å€¼ä¸º0å¯èƒ½æ˜¯ç”±äºã€€ï½‹çš„compareTo æ–¹æ³•å®ç°ä¸å½“å¼•èµ·çš„ï¼ŒcompareTo åˆ¤å®šç›¸ç­‰ï¼Œè€Œä¸Šä¸ª else ifã€€ä¸­ã€€equals åˆ¤å®šä¸ç­‰)*/</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((kc == <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                    (kc = comparableClassFor(k)) == <span class="keyword">null</span>) ||</span><br><span class="line">                    (dir = compareComparables(kc, k, pk)) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">//åœ¨ä»¥å½“å‰èŠ‚ç‚¹ä¸ºæ ¹çš„æ•´ä¸ªæ ‘ä¸Šæœç´¢æ˜¯å¦å­˜åœ¨å¾…æ’å…¥èŠ‚ç‚¹ï¼ˆåªä¼šæœç´¢ä¸€æ¬¡ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> (!searched) &#123;</span><br><span class="line">                TreeNode&lt;K,V&gt; q, ch;</span><br><span class="line">                searched = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (((ch = p.left) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                        (q = ch.find(h, k, kc)) != <span class="keyword">null</span>) ||</span><br><span class="line">                    ((ch = p.right) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">                        (q = ch.find(h, k, kc)) != <span class="keyword">null</span>))</span><br><span class="line">                        <span class="comment">//è‹¥æ ‘ä¸­å­˜åœ¨å¾…æ’å…¥èŠ‚ç‚¹ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">                    <span class="keyword">return</span> q;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ—¢ç„¶ï½‹æ˜¯ä¸å¯æ¯”è¾ƒçš„ï¼Œé‚£æˆ‘è‡ªå·±æŒ‡å®šä¸€ä¸ªæ¯”è¾ƒæ–¹å¼</span></span><br><span class="line">            dir = tieBreakOrder(k, pk);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        TreeNode&lt;K,V&gt; xp = p;</span><br><span class="line">        <span class="keyword">if</span> ((p = (dir &lt;= <span class="number">0</span>) ? p.left : p.right) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//æ‰¾åˆ°äº†å¾…æ’å…¥çš„ä½ç½®ï¼Œxp ä¸ºå¾…æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€<span class="comment">//æ³¨æ„TreeNodeèŠ‚ç‚¹ä¸­æ—¢å­˜åœ¨æ ‘çŠ¶å…³ç³»ï¼Œä¹Ÿå­˜åœ¨é“¾å¼å…³ç³»ï¼Œå¹¶ä¸”æ˜¯åŒç«¯é“¾è¡¨</span></span><br><span class="line">            Node&lt;K,V&gt; xpn = xp.next;</span><br><span class="line">            TreeNode&lt;K,V&gt; x = map.newTreeNode(h, k, v, xpn);</span><br><span class="line">            <span class="keyword">if</span> (dir &lt;= <span class="number">0</span>)</span><br><span class="line">                xp.left = x;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                xp.right = x;</span><br><span class="line">            xp.next = x;</span><br><span class="line">            x.parent = x.prev = xp;</span><br><span class="line">            <span class="keyword">if</span> (xpn != <span class="keyword">null</span>)</span><br><span class="line">                ((TreeNode&lt;K,V&gt;)xpn).prev = x;</span><br><span class="line">                <span class="comment">//æ’å…¥èŠ‚ç‚¹åè¿›è¡ŒäºŒå‰æ ‘çš„å¹³è¡¡æ“ä½œ</span></span><br><span class="line">            moveRootToFront(tab, balanceInsertion(root, x));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tieBreakOrder</span><span class="params">(Object a, Object b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> d;</span><br><span class="line">    <span class="comment">//System.identityHashCode()å®é™…æ˜¯åˆ©ç”¨å¯¹è±¡ a,b çš„å†…å­˜åœ°å€è¿›è¡Œæ¯”è¾ƒ</span></span><br><span class="line">    <span class="keyword">if</span> (a == <span class="keyword">null</span> || b == <span class="keyword">null</span> ||</span><br><span class="line">        (d = a.getClass().getName().</span><br><span class="line">            compareTo(b.getClass().getName())) == <span class="number">0</span>)</span><br><span class="line">        d = (System.identityHashCode(a) &lt;= System.identityHashCode(b) ?</span><br><span class="line">                -<span class="number">1</span> : <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> d;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//putæ–¹æ³•çš„treeifyBin()å‡½æ•°ï¼Œé“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> hash)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n, index; Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="comment">//å¦‚æœè¡¨ä¸ºç©ºæˆ–è€…è¡¨çš„é•¿åº¦å°äºæ ‘åŒ–çš„å®¹é‡ï¼Œresize()æ‰©å®¹è€Œä¸æ˜¯æ ‘åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</span><br><span class="line">        resize();</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((e = tab[index = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//hdæ˜¯è½¬æ¢ä¸ºæ ‘èŠ‚ç‚¹åæ¡¶ä¸­çš„å¤´èŠ‚ç‚¹   tlè®°å½•ä¸Šä¸€ä¸ªéå†çš„èŠ‚ç‚¹</span></span><br><span class="line">        TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">//å°†hashä½ç½®å¤„çš„æ•°ç»„ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹åŒ…è£…æˆæ ‘èŠ‚ç‚¹ï¼Œpè®°å½•å½“å‰éå†çš„èŠ‚ç‚¹</span></span><br><span class="line">            TreeNode&lt;K,V&gt; p = replacementTreeNode(e, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (tl == <span class="keyword">null</span>)</span><br><span class="line">                hd = p;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                p.prev = tl;</span><br><span class="line">                tl.next = p;</span><br><span class="line">            &#125;</span><br><span class="line">            tl = p;</span><br><span class="line">        <span class="comment">//å¾ªç¯å°†æ¡¶ä¸­æ¯ä¸ªèŠ‚ç‚¹æ›¿æ¢ä¸ºæ ‘èŠ‚ç‚¹ï¼Œæœ€ç»ˆç»“æœå°±æ˜¯é“¾è¡¨è½¬æ¢ä¸ºåŒå‘é“¾è¡¨ï¼ŒprevæŒ‡å‘å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼ŒnextæŒ‡å‘åä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> ((tab[index] = hd) != <span class="keyword">null</span>)</span><br><span class="line">        <span class="comment">//å°†åŒå‘é“¾è¡¨è½¬åŒ–ä¸ºçº¢é»‘æ ‘</span></span><br><span class="line">            hd.treeify(tab);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŸºæœ¬è¿‡ç¨‹å¦‚ä¸‹:</p>
<ol>
<li>æ£€æŸ¥æ•°ç»„æ˜¯å¦ä¸ºç©ºï¼Œæ‰§è¡Œresize()æ‰©å……ï¼›åœ¨å®ä¾‹åŒ–HashMapæ—¶ï¼Œå¹¶ä¸ä¼šè¿›è¡Œåˆå§‹åŒ–æ•°ç»„</li>
<li>é€šè¿‡hashå€¼è®¡ç®—æ•°ç»„ç´¢å¼•ï¼Œè·å–è¯¥ç´¢å¼•ä½çš„é¦–èŠ‚ç‚¹ã€‚</li>
<li>å¦‚æœé¦–èŠ‚ç‚¹ä¸ºnullï¼ˆæ²¡å‘ç”Ÿç¢°æ’ï¼‰ï¼Œåˆ™åˆ›å»ºæ–°çš„æ•°ç»„å…ƒç´ ï¼Œç›´æ¥æ·»åŠ èŠ‚ç‚¹åˆ°è¯¥ç´¢å¼•ä½(bucket)ã€‚</li>
<li>å¦‚æœé¦–èŠ‚ç‚¹ä¸ä¸ºnullï¼ˆå‘ç”Ÿç¢°æ’ï¼‰ï¼Œé‚£ä¹ˆæœ‰3ç§æƒ…å†µ<br>
â‘  keyå’Œé¦–èŠ‚ç‚¹çš„keyç›¸åŒï¼Œè¦†ç›–old valueï¼ˆä¿è¯keyçš„å”¯ä¸€æ€§ï¼‰ï¼›å¦åˆ™æ‰§è¡Œâ‘¡æˆ–â‘¢<br>
â‘¡ å¦‚æœé¦–èŠ‚ç‚¹æ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹ï¼ˆTreeNodeï¼‰ï¼Œå°†é”®å€¼å¯¹æ·»åŠ åˆ°çº¢é»‘æ ‘ã€‚<br>
â‘¢ å¦‚æœé¦–èŠ‚ç‚¹æ˜¯é“¾è¡¨ï¼Œè¿›è¡Œéå†å¯»æ‰¾å…ƒç´ ï¼Œæœ‰å°±è¦†ç›–æ— åˆ™æ–°å»ºï¼Œå°†é”®å€¼å¯¹æ·»åŠ åˆ°é“¾è¡¨ã€‚æ·»åŠ ä¹‹åä¼šåˆ¤æ–­é“¾è¡¨é•¿åº¦æ˜¯å¦åˆ°è¾¾TREEIFY_THRESHOLD - 1è¿™ä¸ªé˜ˆå€¼ï¼Œâ€œå°è¯•â€å°†é“¾è¡¨è½¬æ¢æˆçº¢é»‘æ ‘ã€‚</li>
<li>æœ€ååˆ¤æ–­å½“å‰å…ƒç´ ä¸ªæ•°æ˜¯å¦å¤§äºthresholdï¼Œæ‰©å……æ•°ç»„ã€‚</li>
</ol>
<h3 id="HashMapçš„get-å–å€¼è¿‡ç¨‹">HashMapçš„get(),å–å€¼è¿‡ç¨‹</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="comment">//å®é™…ä¸Šæ˜¯æ ¹æ®è¾“å…¥èŠ‚ç‚¹çš„ hash å€¼å’Œ key å€¼åˆ©ç”¨getNode æ–¹æ³•è¿›è¡ŒæŸ¥æ‰¾</span></span><br><span class="line">    <span class="keyword">return</span> (e = getNode(hash(key), key)) == <span class="keyword">null</span> ? <span class="keyword">null</span> : e.value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">getNode</span><span class="params">(<span class="keyword">int</span> hash, Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; <span class="comment">//Entryå¯¹è±¡æ•°ç»„  </span></span><br><span class="line">    Node&lt;K,V&gt; first, e; <span class="comment">//åœ¨tabæ•°ç»„ä¸­ç»è¿‡æ•£åˆ—çš„ç¬¬ä¸€ä¸ªä½ç½®  </span></span><br><span class="line">    <span class="keyword">int</span> n; K k;</span><br><span class="line">    <span class="comment">/*æ‰¾åˆ°æ’å…¥çš„ç¬¬ä¸€ä¸ªNodeï¼Œæ–¹æ³•æ˜¯hashå€¼å’Œn-1ç›¸ä¸ï¼Œtab[(n - 1) &amp; hash]*/</span>  </span><br><span class="line">    <span class="comment">//ä¹Ÿå°±æ˜¯è¯´åœ¨ä¸€æ¡é“¾ä¸Šçš„hashå€¼ç›¸åŒçš„  </span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (first = tab[(n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æ°¸è¿œæ£€æŸ¥ç¬¬ä¸€ä¸ªnodeæ˜¯ä¸æ˜¯è¦æ‰¾çš„Node</span></span><br><span class="line">        <span class="keyword">if</span> (first.hash == hash &amp;&amp; <span class="comment">// always check first node</span></span><br><span class="line">            ((k = first.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k)))) <span class="comment">//åˆ¤æ–­æ¡ä»¶æ˜¯hashå€¼è¦ç›¸åŒï¼Œkeyå€¼è¦ç›¸åŒ  </span></span><br><span class="line">            <span class="keyword">return</span> first;</span><br><span class="line">            <span class="comment">/*æ£€æŸ¥firståé¢çš„node*/</span>  </span><br><span class="line">        <span class="keyword">if</span> ((e = first.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode) <span class="comment">// æ ‘æŸ¥æ‰¾</span></span><br><span class="line">                <span class="keyword">return</span> ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">                <span class="comment">/*éå†åé¢çš„é“¾è¡¨ï¼Œæ‰¾åˆ°keyå€¼å’Œhashå€¼éƒ½ç›¸åŒçš„Node*/</span>  </span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;  <span class="comment">// éå†é“¾è¡¨</span></span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">return</span> e;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="getæ–¹æ³•ä¸­è°ƒç”¨åˆ°çš„getTreeNodeå‡½æ•°">getæ–¹æ³•ä¸­è°ƒç”¨åˆ°çš„getTreeNodeå‡½æ•°</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> TreeNode&lt;K,V&gt; <span class="title">getTreeNode</span><span class="params">(<span class="keyword">int</span> h, Object k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((parent != <span class="keyword">null</span>) ? root() : <span class="keyword">this</span>).find(h, k, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">final</span> TreeNode&lt;K,V&gt; <span class="title">find</span><span class="params">(<span class="keyword">int</span> h, Object k, Class&lt;?&gt; kc)</span> </span>&#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; p = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> ph, dir; K pk;</span><br><span class="line">        TreeNode&lt;K,V&gt; pl = p.left, pr = p.right, q;</span><br><span class="line">        <span class="comment">//é¦–å…ˆè¿›è¡Œhash å€¼çš„æ¯”è¾ƒï¼Œè‹¥ä¸åŒä»¤å½“å‰èŠ‚ç‚¹å˜ä¸ºå®ƒçš„å·¦å­©å­æˆ–è€…å³å­©å­</span></span><br><span class="line">        <span class="keyword">if</span> ((ph = p.hash) &gt; h)</span><br><span class="line">            p = pl;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ph &lt; h)</span><br><span class="line">            p = pr;</span><br><span class="line">        <span class="comment">//hash å€¼ç›¸åŒï¼Œè¿›è¡Œ keyå€¼çš„æ¯”è¾ƒ</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((pk = p.key) == k || (k != <span class="keyword">null</span> &amp;&amp; k.equals(pk)))</span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pl == <span class="keyword">null</span>)</span><br><span class="line">            p = pr;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (pr == <span class="keyword">null</span>)</span><br><span class="line">            p = pl;</span><br><span class="line">        <span class="comment">//æ‰§è¡Œåˆ°è¿™å„¿ï¼Œæ„å‘³ç€hash å€¼ç›¸åŒï¼Œkey å€¼ä¸åŒ</span></span><br><span class="line">        <span class="comment">//è‹¥k æ˜¯å¯æ¯”è¾ƒçš„å¹¶ä¸”k.compareTo(pk) è¿”å›ç»“æœä¸ä¸ºï¼å¯è¿›å…¥ä¸‹é¢elseif  </span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((kc != <span class="keyword">null</span> ||</span><br><span class="line">                    (kc = comparableClassFor(k)) != <span class="keyword">null</span>) &amp;&amp;</span><br><span class="line">                    (dir = compareComparables(kc, k, pk)) != <span class="number">0</span>)</span><br><span class="line">            p = (dir &lt; <span class="number">0</span>) ? pl : pr;</span><br><span class="line">        <span class="comment">/*è‹¥ k æ˜¯ä¸å¯æ¯”è¾ƒçš„ã€€æˆ–è€…ã€€k.compareTo(pk) è¿”å›ç»“æœä¸ºï¼åˆ™åœ¨æ•´æ£µæ ‘ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œå…ˆæ‰¾å³å­æ ‘ï¼Œå³å­æ ‘æ²¡æœ‰å†æ‰¾å·¦å­æ ‘*/</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((q = pr.find(h, k, kc)) != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> q;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            p = pl;</span><br><span class="line">    &#125; <span class="keyword">while</span> (p != <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨HashMap 1.8ä¸­ï¼Œæ— è®ºæ˜¯å­˜å…ƒç´ è¿˜æ˜¯å–å…ƒç´ ï¼Œéƒ½æ˜¯ä¼˜å…ˆåˆ¤æ–­bucketä¸Šç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯å¦åŒ¹é…ï¼Œè€Œåœ¨1.7ä¸­åˆ™æ˜¯ç›´æ¥éå†æŸ¥æ‰¾ã€‚<br>
åŸºæœ¬è¿‡ç¨‹å¦‚ä¸‹:</p>
<ol>
<li>æ ¹æ®keyè®¡ç®—hash;</li>
<li>æ£€æŸ¥æ•°ç»„æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºè¿”å›null;</li>
<li>æ ¹æ®hashè®¡ç®—bucketä½ç½®ï¼Œå¦‚æœbucketç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ç›®æ ‡å…ƒç´ ï¼Œç›´æ¥è¿”å›ã€‚å¦åˆ™æ‰§è¡Œ4;</li>
<li>å¦‚æœbucketä¸Šå…ƒç´ å¤§äº1å¹¶ä¸”æ˜¯æ ‘ç»“æ„ï¼Œåˆ™æ‰§è¡Œæ ‘æŸ¥æ‰¾ã€‚å¦åˆ™æ‰§è¡Œ5;</li>
<li>å¦‚æœæ˜¯é“¾è¡¨ç»“æ„ï¼Œåˆ™éå†å¯»æ‰¾ç›®æ ‡</li>
</ol>
<h3 id="HashMapçš„remove-åˆ é™¤æ“ä½œ">HashMapçš„remove(),åˆ é™¤æ“ä½œ</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">remove</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">     Entry&lt;K,V&gt; e = removeEntryForKey(key);</span><br><span class="line">     <span class="keyword">return</span> (e == <span class="keyword">null</span> ? <span class="keyword">null</span> : e.value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">final</span> Entry&lt;K,V&gt; <span class="title">removeEntryForKey</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> hash = (key == <span class="keyword">null</span>) ? <span class="number">0</span> : hash(key);</span><br><span class="line">    <span class="keyword">int</span> i = indexFor(hash, table.length);</span><br><span class="line">    Entry&lt;K,V&gt; prev = table[i];</span><br><span class="line">    Entry&lt;K,V&gt; e = prev;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Entry&lt;K,V&gt; next = e.next;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">            ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">            modCount++;</span><br><span class="line">            size--;</span><br><span class="line">            <span class="keyword">if</span> (prev == e)</span><br><span class="line">                table[i] = next;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                prev.next = next;</span><br><span class="line">            e.recordRemoval(<span class="keyword">this</span>);</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        prev = e;</span><br><span class="line">        e = next;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ é™¤æ“ä½œï¼Œå…ˆè®¡ç®—æŒ‡å®škeyçš„hashå€¼ï¼Œç„¶åè®¡ç®—å‡ºtableä¸­çš„å­˜å‚¨ä½ç½®ï¼Œåˆ¤æ–­å½“å‰ä½ç½®æ˜¯å¦Entryå®ä½“å­˜åœ¨ï¼Œå¦‚æœæ²¡æœ‰ç›´æ¥è¿”å›ï¼Œè‹¥å½“å‰ä½ç½®æœ‰Entryå®ä½“å­˜åœ¨ï¼Œåˆ™å¼€å§‹éå†åˆ—è¡¨ã€‚å®šä¹‰äº†ä¸‰ä¸ªEntryå¼•ç”¨ï¼Œåˆ†åˆ«ä¸ºpre, e ,nextã€‚ åœ¨å¾ªç¯éå†çš„è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­pre å’Œ e æ˜¯å¦ç›¸ç­‰ï¼Œè‹¥ç›¸ç­‰è¡¨æ˜ï¼Œtableçš„å½“å‰ä½ç½®åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œç›´æ¥å°†table[i] = next = null ã€‚è‹¥å½¢æˆäº†pre -&gt; e -&gt; next çš„è¿æ¥å…³ç³»ï¼Œåˆ¤æ–­eçš„keyæ˜¯å¦å’ŒæŒ‡å®šçš„key ç›¸ç­‰ï¼Œè‹¥ç›¸ç­‰åˆ™è®©pre -&gt; next ,e å¤±å»å¼•ç”¨ã€‚</p>
<h3 id="HashMapçš„resize-æ‰©å®¹æœºåˆ¶">HashMapçš„resize(),æ‰©å®¹æœºåˆ¶</h3>
<p>æ„é€ hashè¡¨æ—¶ï¼Œå¦‚æœä¸æŒ‡æ˜åˆå§‹å¤§å°ï¼Œé»˜è®¤å¤§å°ä¸º16ï¼ˆå³Nodeæ•°ç»„å¤§å°16ï¼‰ï¼Œå¦‚æœNode[]æ•°ç»„ä¸­çš„å…ƒç´ è¾¾åˆ°ï¼ˆå¡«å……æ¯”<em>Node.lengthï¼‰é‡æ–°è°ƒæ•´HashMapå¤§å° å˜ä¸ºåŸæ¥2å€å¤§å°,æ‰©å®¹å¾ˆè€—æ—¶<br>
HashMapæ‰©å®¹å¯ä»¥åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š<br>
ç¬¬ä¸€ç§ï¼šä½¿ç”¨é»˜è®¤æ„é€ æ–¹æ³•åˆå§‹åŒ–HashMapã€‚ä»å‰æ–‡å¯ä»¥çŸ¥é“HashMapåœ¨ä¸€å¼€å§‹åˆå§‹åŒ–çš„æ—¶å€™ä¼šè¿”å›ä¸€ä¸ªç©ºçš„tableï¼Œå¹¶ä¸”thersholdä¸º0ã€‚å› æ­¤ç¬¬ä¸€æ¬¡æ‰©å®¹çš„å®¹é‡ä¸ºé»˜è®¤å€¼DEFAULT_INITIAL_CAPACITYä¹Ÿå°±æ˜¯16ã€‚åŒæ—¶threshold = DEFAULT_INITIAL_CAPACITY * DEFAULT_LOAD_FACTOR = 16</em>0.75 = 12ã€‚<br>
ç¬¬äºŒç§ï¼šæŒ‡å®šåˆå§‹å®¹é‡çš„æ„é€ æ–¹æ³•åˆå§‹åŒ–HashMapã€‚é‚£ä¹ˆä»ä¸‹é¢æºç å¯ä»¥çœ‹åˆ°åˆå§‹å®¹é‡ä¼šç­‰äºthresholdï¼Œæ¥ç€threshold = å½“å‰çš„å®¹é‡ï¼ˆthresholdï¼‰ * DEFAULT_LOAD_FACTORã€‚<br>
ç¬¬ä¸‰ç§ï¼šHashMapä¸æ˜¯ç¬¬ä¸€æ¬¡æ‰©å®¹ã€‚å¦‚æœHashMapå·²ç»æ‰©å®¹è¿‡çš„è¯ï¼Œé‚£ä¹ˆæ¯æ¬¡tableçš„å®¹é‡ä»¥åŠthresholdé‡ä¸ºåŸæœ‰çš„ä¸¤å€ã€‚<br>
è¿™è¾¹ä¹Ÿå¯ä»¥å¼•ç”³åˆ°ä¸€ä¸ªé—®é¢˜HashMapæ˜¯å…ˆæ’å…¥è¿˜æ˜¯å…ˆæ‰©å®¹ï¼šHashMapåˆå§‹åŒ–åé¦–æ¬¡æ’å…¥æ•°æ®æ—¶ï¼Œå…ˆå‘ç”Ÿresizeæ‰©å®¹å†æ’å…¥æ•°æ®ï¼Œä¹‹åæ¯å½“æ’å…¥çš„æ•°æ®ä¸ªæ•°è¾¾åˆ°thresholdæ—¶å°±ä¼šå‘ç”Ÿresizeï¼Œæ­¤æ—¶æ˜¯å…ˆæ’å…¥æ•°æ®å†resizeã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] oldTab = table; <span class="comment">//åŸè¡¨,é¦–æ¬¡åˆå§‹åŒ–åtableä¸ºNull</span></span><br><span class="line">    <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length; <span class="comment">//åŸè¡¨å¤§å°,é»˜è®¤æ„é€ å™¨çš„æƒ…å†µä¸‹ä¸º0</span></span><br><span class="line">    <span class="keyword">int</span> oldThr = threshold;<span class="comment">//ï¼ˆthresholdï¼‰é˜ˆå€¼ï¼Œ ä¸º oldCap Ã— load_factor</span></span><br><span class="line">    <span class="keyword">int</span> newCap, newThr = <span class="number">0</span>; <span class="comment">//è®°å½•æ–°è¡¨çš„å¤§å°å’Œé˜ˆå€¼</span></span><br><span class="line">    <span class="comment">//æ—§è¡¨å®¹é‡å¤§äº0ï¼Œè¡¨ç¤ºè¢«åˆå§‹åŒ–è¿‡ï¼Œéœ€è¦æ‰§è¡Œçš„æ˜¯æ‰©å®¹æ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;<span class="comment">//tableæ‰©å®¹è¿‡</span></span><br><span class="line">        <span class="comment">//å¦‚æœæ—§è¡¨å®¹é‡å¤§äºå®¹é‡æœ€å¤§å€¼ï¼Œé‚£ä¹ˆé˜ˆå€¼ä¸ºIntergerçš„æœ€å¤§å€¼ï¼Œå³æå‡é˜ˆå€¼ï¼Œä¸å†è¿›è¡Œæ‰©å®¹ï¼Œè¿”å›æ—§è¡¨</span></span><br><span class="line">        <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            threshold = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span> oldTab;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦åˆ™ï¼Œæ‰©å®¹ä¸ºåŸå…ˆå®¹é‡çš„1å€ï¼Œé˜ˆå€¼ä¹Ÿæ‰©å®¹ä¸ºåŸæ¥çš„ä¸€å€ å³ç°åœ¨æ–°è¡¨tableçš„å®¹é‡ä¹˜ä»¥2ï¼Œthresholdçš„å€¼ä¹Ÿä¹˜ä»¥2 </span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">                    oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">            newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line">    &#125;</span><br><span class="line">     <span class="comment">//æ—§è¡¨å®¹é‡ä¸º0ï¼Œé˜ˆå€¼å¤§äº0ï¼Œåˆ™ç”¨é˜ˆå€¼å¤§å°ä½œä¸ºå®¹é‡</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// initial capacity was placed in threshold</span></span><br><span class="line">    <span class="comment">//ä½¿ç”¨å¸¦æœ‰åˆå§‹å®¹é‡çš„æ„é€ å™¨æ—¶ï¼Œtableå®¹é‡ä¸ºåˆå§‹åŒ–å¾—åˆ°çš„threshold</span></span><br><span class="line">        newCap = oldThr;</span><br><span class="line">    <span class="comment">//å¦åˆ™ï¼Œè¡¨çš„å®¹é‡ä¸ºé»˜è®¤åˆå§‹å®¹é‡16ï¼Œé˜ˆå€¼ä¸ºé»˜è®¤åˆå§‹å®¹é‡16*åŠ è½½å› å­0.75</span></span><br><span class="line">    <span class="keyword">else</span> &#123;  <span class="comment">//é»˜è®¤æ„é€ å™¨ä¸‹è¿›è¡Œæ‰©å®¹             // zero initial threshold signifies using defaults</span></span><br><span class="line">        newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">        newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœæ–°è¡¨é˜ˆå€¼ä¸º0ï¼Œåˆ™åˆ©ç”¨æ–°å®¹é‡*åŠ è½½å› å­è®¡ç®—</span></span><br><span class="line">    <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//ä½¿ç”¨å¸¦æœ‰åˆå§‹å®¹é‡çš„æ„é€ å™¨åœ¨æ­¤å¤„è¿›è¡Œæ‰©å®¹</span></span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor; <span class="comment">//æ–°è¡¨é•¿åº¦ä¹˜ä»¥åŠ è½½å› å­  </span></span><br><span class="line">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">                    (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å°†æ–°çš„é˜ˆå€¼èµ‹ç»™HashMapçš„é˜ˆå€¼æˆå‘˜å˜é‡</span></span><br><span class="line">    threshold = newThr;</span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"rawtypes"</span>,<span class="string">"unchecked"</span>&#125;)</span><br><span class="line">    <span class="comment">/*ä¸‹é¢å¼€å§‹æ„é€ æ–°è¡¨ï¼Œåˆå§‹åŒ–è¡¨ä¸­çš„æ•°æ®*/</span>  </span><br><span class="line">    Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[newCap];</span><br><span class="line">    table = newTab;<span class="comment">//æŠŠæ–°è¡¨èµ‹å€¼ç»™table  </span></span><br><span class="line">    <span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;<span class="comment">//åŸè¡¨ä¸æ˜¯ç©ºè¦æŠŠåŸè¡¨ä¸­æ•°æ®ç§»åŠ¨åˆ°æ–°è¡¨ä¸­</span></span><br><span class="line">    <span class="comment">/*éå†åŸæ¥çš„æ—§è¡¨*/</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">            Node&lt;K,V&gt; e;</span><br><span class="line">            <span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                oldTab[j] = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">if</span> (e.next == <span class="keyword">null</span>) <span class="comment">//// å½“å‰indexæ²¡æœ‰å‘ç”Ÿhashå†²çªï¼Œç›´æ¥å¯¹2å–æ¨¡ï¼Œå³ç§»ä½è¿ç®—hash &amp;ï¼ˆ2^n -1ï¼‰</span></span><br><span class="line">                        <span class="comment">// æ‰©å®¹éƒ½æ˜¯æŒ‰ç…§2çš„å¹‚æ¬¡æ–¹æ‰©å®¹ï¼Œå› æ­¤newCap = 2^n</span></span><br><span class="line">                    newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode) <span class="comment">// å½“å‰indexå¯¹åº”çš„èŠ‚ç‚¹ä¸ºçº¢é»‘æ ‘</span></span><br><span class="line">                    ((TreeNode&lt;K,V&gt;)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</span><br><span class="line">                <span class="comment">//æ¡¶ä¸­å­˜æ”¾çš„æ˜¯é“¾è¡¨</span></span><br><span class="line">                <span class="keyword">else</span> &#123; <span class="comment">// preserve order ä¿è¯é¡ºåº</span></span><br><span class="line">                <span class="comment">// æŠŠå½“å‰indexå¯¹åº”çš„é“¾è¡¨åˆ†æˆä¸¤ä¸ªé“¾è¡¨ï¼Œå‡å°‘æ‰©å®¹çš„è¿ç§»é‡ï¼Œæ ¹æ®å˜åŒ–çš„æœ€é«˜ä½çš„ä¸åŒï¼Œä¹Ÿå°±æ˜¯0æˆ–è€…1ï¼Œå°†é“¾è¡¨æ‹†åˆ†å¼€</span></span><br><span class="line">                    Node&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; next;</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        next = e.next;<span class="comment">//è®°å½•ä¸‹ä¸€ä¸ªç»“ç‚¹</span></span><br><span class="line">                        <span class="comment">//æœ€é«˜ä½ä¸º0ï¼Œåˆ™å°†èŠ‚ç‚¹åŠ å…¥loTail.next</span></span><br><span class="line">                        <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">//æ‰©å®¹åä¸éœ€è¦ç§»åŠ¨çš„é“¾è¡¨</span></span><br><span class="line">                            <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</span><br><span class="line">                                loHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                loTail.next = e;</span><br><span class="line">                            loTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//æœ€é«˜ä½ä¸º1ï¼Œåˆ™å°†èŠ‚ç‚¹åŠ å…¥hiTail.next</span></span><br><span class="line">                        <span class="keyword">else</span> &#123;<span class="comment">// æ‰©å®¹åéœ€è¦ç§»åŠ¨çš„é“¾è¡¨</span></span><br><span class="line">                            <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</span><br><span class="line">                                hiHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hiTail.next = e;</span><br><span class="line">                            hiTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;<span class="comment">//åœ¨æ–°æ•°ç»„çš„ä½ç½®ä¸åŸæ•°ç»„çš„ä½ç½®ç›¸åŒ,æ–°æ•°ç»„çš„æ¡¶ç›´æ¥æŒ‡å‘LoHead</span></span><br><span class="line">                        loTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j] = loHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;<span class="comment">//åœ¨æ–°æ•°ç»„çš„ä½ç½®æ˜¯åŸæ•°ç»„çš„ä½ç½®+æ—§æ•°ç»„é•¿åº¦,æ–°æ•°ç»„çš„æ¡¶ç›´æ¥æŒ‡å‘hiHead</span></span><br><span class="line">                        hiTail.next = <span class="keyword">null</span>;</span><br><span class="line">                            <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</span><br><span class="line">                        <span class="comment">// æ‰©å®¹é•¿åº¦ä¸ºå½“å‰indexä½ç½®+æ—§çš„å®¹é‡</span></span><br><span class="line">                        newTab[j + oldCap] = hiHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç›¸å…³é—®é¢˜">ç›¸å…³é—®é¢˜</h2>
<h3 id="åŠ è½½å› å­ï¼ˆé»˜è®¤0-75ï¼‰ï¼šä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨åŠ è½½å› å­ï¼Œä¸ºä»€ä¹ˆéœ€è¦æ‰©å®¹å‘¢ï¼Ÿ">åŠ è½½å› å­ï¼ˆé»˜è®¤0.75ï¼‰ï¼šä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨åŠ è½½å› å­ï¼Œä¸ºä»€ä¹ˆéœ€è¦æ‰©å®¹å‘¢ï¼Ÿ</h3>
<p>å› ä¸ºå¦‚æœå¡«å……æ¯”å¾ˆå¤§ï¼Œè¯´æ˜åˆ©ç”¨çš„ç©ºé—´å¾ˆå¤šï¼Œå¦‚æœä¸€ç›´ä¸è¿›è¡Œæ‰©å®¹çš„è¯ï¼Œé“¾è¡¨å°±ä¼šè¶Šæ¥è¶Šé•¿ï¼Œè¿™æ ·æŸ¥æ‰¾çš„æ•ˆç‡å¾ˆä½ï¼Œå› ä¸ºé“¾è¡¨çš„é•¿åº¦å¾ˆå¤§ï¼ˆå½“ç„¶æœ€æ–°ç‰ˆæœ¬ä½¿ç”¨äº†çº¢é»‘æ ‘åä¼šæ”¹è¿›å¾ˆå¤šï¼‰ï¼Œæ‰©å®¹ä¹‹åï¼Œå°†åŸæ¥é“¾è¡¨æ•°ç»„çš„æ¯ä¸€ä¸ªé“¾è¡¨åˆ†æˆå¥‡å¶ä¸¤ä¸ªå­é“¾è¡¨åˆ†åˆ«æŒ‚åœ¨æ–°é“¾è¡¨æ•°ç»„çš„æ•£åˆ—ä½ç½®ï¼Œè¿™æ ·å°±å‡å°‘äº†æ¯ä¸ªé“¾è¡¨çš„é•¿åº¦ï¼Œå¢åŠ æŸ¥æ‰¾æ•ˆç‡</p>
<h3 id="JDK1-8ä½¿ç”¨çº¢é»‘æ ‘çš„æ”¹è¿›">JDK1.8ä½¿ç”¨çº¢é»‘æ ‘çš„æ”¹è¿›</h3>
<p>åœ¨Java jdk8ä¸­å¯¹HashMapçš„æºç è¿›è¡Œäº†ä¼˜åŒ–ï¼Œåœ¨jdk7ä¸­ï¼ŒHashMapå¤„ç†â€œç¢°æ’â€çš„æ—¶å€™ï¼Œéƒ½æ˜¯é‡‡ç”¨é“¾è¡¨æ¥å­˜å‚¨ï¼Œå½“ç¢°æ’çš„ç»“ç‚¹å¾ˆå¤šæ—¶ï¼ŒæŸ¥è¯¢æ—¶é—´æ˜¯Oï¼ˆnï¼‰ã€‚<br>
åœ¨jdk8ä¸­ï¼ŒHashMapå¤„ç†â€œç¢°æ’â€å¢åŠ äº†çº¢é»‘æ ‘è¿™ç§æ•°æ®ç»“æ„ï¼Œå½“ç¢°æ’ç»“ç‚¹è¾ƒå°‘æ—¶ï¼Œé‡‡ç”¨é“¾è¡¨å­˜å‚¨ï¼Œå½“è¾ƒå¤§æ—¶ï¼ˆ&gt;8ä¸ªï¼‰ï¼Œé‡‡ç”¨çº¢é»‘æ ‘ï¼ˆç‰¹ç‚¹æ˜¯æŸ¥è¯¢æ—¶é—´æ˜¯Oï¼ˆlognï¼‰ï¼‰å­˜å‚¨ï¼ˆæœ‰ä¸€ä¸ªé˜€å€¼æ§åˆ¶ï¼Œå¤§äºé˜€å€¼(8ä¸ª)ï¼Œå°†é“¾è¡¨å­˜å‚¨è½¬æ¢æˆçº¢é»‘æ ‘å­˜å‚¨ï¼‰<br>
<img src="/images/redblacktree.jpg" alt=""><br>
å¦‚æœæŸHashMapä¸­çš„è®°å½•è¿‡å¤§çš„è¯ï¼ˆå½“å‰æ˜¯TREEIFY_THRESHOLD = 8ï¼‰ï¼ŒHashMapä¼šåŠ¨æ€çš„ä½¿ç”¨ä¸€ä¸ªä¸“é—¨çš„treemapå®ç°æ¥æ›¿æ¢æ‰å®ƒã€‚è¿™æ ·åšçš„ç»“æœä¼šæ›´å¥½ï¼Œæ˜¯O(logn)ï¼Œè€Œä¸æ˜¯ç³Ÿç³•çš„O(n)ã€‚<br>
å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ<br>
å‰é¢äº§ç”Ÿå†²çªçš„é‚£äº›keyå¯¹åº”çš„è®°å½•åªæ˜¯ç®€å•çš„è¿½åŠ åˆ°ä¸€ä¸ªé“¾è¡¨åé¢ï¼Œè¿™äº›è®°å½•åªèƒ½é€šè¿‡éå†æ¥è¿›è¡ŒæŸ¥æ‰¾ã€‚ä½†æ˜¯è¶…è¿‡è¿™ä¸ªé˜ˆå€¼åHashMapå¼€å§‹å°†åˆ—è¡¨å‡çº§æˆä¸€ä¸ªäºŒå‰æ ‘ï¼Œä½¿ç”¨å“ˆå¸Œå€¼ä½œä¸ºæ ‘çš„åˆ†æ”¯å˜é‡ï¼Œå¦‚æœä¸¤ä¸ªå“ˆå¸Œå€¼ä¸ç­‰ï¼Œä½†æŒ‡å‘åŒä¸€ä¸ªhashmapçš„è¯ï¼Œè¾ƒå¤§çš„é‚£ä¸ªä¼šæ’å…¥åˆ°å³å­æ ‘é‡Œã€‚å¦‚æœå“ˆå¸Œå€¼ç›¸ç­‰ï¼ŒHashMapå¸Œæœ›keyå€¼æœ€å¥½æ˜¯å®ç°äº†Comparableæ¥å£çš„ï¼Œè¿™æ ·å®ƒå¯ä»¥æŒ‰ç…§é¡ºåºæ¥è¿›è¡Œæ’å…¥ã€‚è¿™å¯¹HashMapçš„keyæ¥è¯´å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œä¸è¿‡å¦‚æœå®ç°äº†å½“ç„¶æœ€å¥½ã€‚å¦‚æœæ²¡æœ‰å®ç°è¿™ä¸ªæ¥å£ï¼Œåœ¨å‡ºç°ä¸¥é‡çš„å“ˆå¸Œç¢°æ’çš„æ—¶å€™ï¼Œä½ å°±å¹¶åˆ«æŒ‡æœ›èƒ½è·å¾—æ€§èƒ½æå‡äº†ã€‚</p>
<h3 id="EntryèŠ‚ç‚¹åœ¨æ’å…¥é“¾è¡¨çš„æ—¶å€™ï¼Œæ˜¯å¦‚ä½•æ’å…¥çš„ï¼Ÿ">EntryèŠ‚ç‚¹åœ¨æ’å…¥é“¾è¡¨çš„æ—¶å€™ï¼Œæ˜¯å¦‚ä½•æ’å…¥çš„ï¼Ÿ</h3>
<p>java8ä¹‹å‰æ˜¯å¤´æ’æ³•ï¼Œå°±æ˜¯è¯´æ–°æ¥çš„å€¼ä¼šå–ä»£åŸæœ‰çš„å€¼ï¼ŒåŸæœ‰çš„å€¼å°±é¡ºæ¨åˆ°é“¾è¡¨ä¸­å»ï¼Œå°±åƒä¸Šé¢çš„ä¾‹å­ä¸€æ ·ã€‚<br>
ä½†æ˜¯ï¼Œåœ¨java8ä¹‹åï¼Œéƒ½æ˜¯æ‰€ç”¨å°¾éƒ¨æ’å…¥äº†ã€‚<br>
ä¸ºå•¥æ”¹ä¸ºå°¾éƒ¨æ’å…¥å‘¢ï¼Ÿ<br>
è§£å†³1.7ä¸­å¤šçº¿ç¨‹å¾ªç¯é“¾è¡¨çš„bug<br>
å…ˆä¸¾ä¸ªä¾‹å­å§ï¼Œæˆ‘ä»¬ç°åœ¨å¾€ä¸€ä¸ªå®¹é‡å¤§å°ä¸º2çš„putä¸¤ä¸ªå€¼ï¼Œè´Ÿè½½å› å­æ˜¯0.75æ˜¯ä¸æ˜¯æˆ‘ä»¬åœ¨putç¬¬äºŒä¸ªçš„æ—¶å€™å°±ä¼šè¿›è¡Œresizeï¼Ÿ<br>
2*0.75 = 1 æ‰€ä»¥æ’å…¥ç¬¬äºŒä¸ªå°±è¦resizeäº†<br>
ç°åœ¨æˆ‘ä»¬è¦åœ¨å®¹é‡ä¸º2çš„å®¹å™¨é‡Œé¢ç”¨ä¸åŒçº¿ç¨‹æ’å…¥Aï¼ŒBï¼ŒCï¼Œå‡å¦‚æˆ‘ä»¬åœ¨resizeä¹‹å‰æ‰“ä¸ªçŸ­ç‚¹ï¼Œé‚£æ„å‘³ç€æ•°æ®éƒ½æ’å…¥äº†ä½†æ˜¯è¿˜æ²¡resizeé‚£æ‰©å®¹å‰å¯èƒ½æ˜¯è¿™æ ·çš„ã€‚<br>
æˆ‘ä»¬å¯ä»¥çœ‹åˆ°é“¾è¡¨çš„æŒ‡å‘A-&gt;B-&gt;C<br>
Tipï¼šAçš„ä¸‹ä¸€ä¸ªæŒ‡é’ˆæ˜¯æŒ‡å‘Bçš„<br>
<img src="/images/ab.jpg" alt=""><br>
å› ä¸ºresizeçš„èµ‹å€¼æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨äº†å•é“¾è¡¨çš„å¤´æ’å…¥æ–¹å¼ï¼ŒåŒä¸€ä½ç½®ä¸Šæ–°å…ƒç´ æ€»ä¼šè¢«æ”¾åœ¨é“¾è¡¨çš„å¤´éƒ¨ä½ç½®ï¼Œåœ¨æ—§æ•°ç»„ä¸­åŒä¸€æ¡Entryé“¾ä¸Šçš„å…ƒç´ ï¼Œé€šè¿‡é‡æ–°è®¡ç®—ç´¢å¼•ä½ç½®åï¼Œæœ‰å¯èƒ½è¢«æ”¾åˆ°äº†æ–°æ•°ç»„çš„ä¸åŒä½ç½®ä¸Šã€‚<br>
å°±å¯èƒ½å‡ºç°ä¸‹é¢çš„æƒ…å†µï¼Œå¤§å®¶å‘ç°é—®é¢˜æ²¡æœ‰ï¼Ÿ<br>
Bçš„ä¸‹ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘äº†A<br>
<img src="/images/ba.jpg" alt=""><br>
ä¸€æ—¦å‡ ä¸ªçº¿ç¨‹éƒ½è°ƒæ•´å®Œæˆï¼Œå°±å¯èƒ½å‡ºç°ç¯å½¢é“¾è¡¨<br>
<img src="/images/circlelist.jpg" alt=""><br>
å¦‚æœè¿™ä¸ªæ—¶å€™å»å–å€¼ï¼Œæ‚²å‰§å°±å‡ºç°äº†â€”â€”Infinite Loop(æ— é™å¾ªç¯)ã€‚<br>
å› ä¸ºjava8ä¹‹åé“¾è¡¨æœ‰çº¢é»‘æ ‘çš„éƒ¨åˆ†ï¼Œå¤§å®¶å¯ä»¥çœ‹åˆ°ä»£ç å·²ç»å¤šäº†å¾ˆå¤šif elseçš„é€»è¾‘åˆ¤æ–­äº†ï¼Œçº¢é»‘æ ‘çš„å¼•å…¥å·§å¦™çš„å°†åŸæœ¬O(n)çš„æ—¶é—´å¤æ‚åº¦é™ä½åˆ°äº†O(logn)ã€‚<br>
ä½¿ç”¨å¤´æ’ä¼šæ”¹å˜é“¾è¡¨çš„ä¸Šçš„é¡ºåºï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨å°¾æ’ï¼Œåœ¨æ‰©å®¹æ—¶ä¼šä¿æŒé“¾è¡¨å…ƒç´ åŸæœ¬çš„é¡ºåºï¼Œå°±ä¸ä¼šå‡ºç°é“¾è¡¨æˆç¯çš„é—®é¢˜äº†ã€‚<br>
å°±æ˜¯è¯´åŸæœ¬æ˜¯A-&gt;Bï¼Œåœ¨æ‰©å®¹åé‚£ä¸ªé“¾è¡¨è¿˜æ˜¯A-&gt;B<br>
<img src="/images/abb.jpg" alt=""><br>
Java7åœ¨å¤šçº¿ç¨‹æ“ä½œHashMapæ—¶å¯èƒ½å¼•èµ·æ­»å¾ªç¯ï¼ŒåŸå› æ˜¯æ‰©å®¹è½¬ç§»åå‰åé“¾è¡¨é¡ºåºå€’ç½®ï¼Œåœ¨è½¬ç§»è¿‡ç¨‹ä¸­ä¿®æ”¹äº†åŸæ¥é“¾è¡¨ä¸­èŠ‚ç‚¹çš„å¼•ç”¨å…³ç³»ã€‚<br>
Java8åœ¨åŒæ ·çš„å‰æä¸‹å¹¶ä¸ä¼šå¼•èµ·æ­»å¾ªç¯ï¼ŒåŸå› æ˜¯æ‰©å®¹è½¬ç§»åå‰åé“¾è¡¨é¡ºåºä¸å˜ï¼Œä¿æŒä¹‹å‰èŠ‚ç‚¹çš„å¼•ç”¨å…³ç³»ã€‚</p>
<h3 id="é‚£æ˜¯ä¸æ˜¯æ„å‘³ç€Java8å°±å¯ä»¥æŠŠHashMapç”¨åœ¨å¤šçº¿ç¨‹ä¸­å‘¢ï¼Ÿ">é‚£æ˜¯ä¸æ˜¯æ„å‘³ç€Java8å°±å¯ä»¥æŠŠHashMapç”¨åœ¨å¤šçº¿ç¨‹ä¸­å‘¢ï¼Ÿ</h3>
<p>å³ä½¿ä¸ä¼šå‡ºç°æ­»å¾ªç¯ï¼Œä½†æ˜¯é€šè¿‡æºç çœ‹åˆ°put/getæ–¹æ³•éƒ½æ²¡æœ‰åŠ åŒæ­¥é”ï¼Œå¤šçº¿ç¨‹æƒ…å†µæœ€å®¹æ˜“å‡ºç°çš„å°±æ˜¯ï¼šæ— æ³•ä¿è¯ä¸Šä¸€ç§’putçš„å€¼ï¼Œä¸‹ä¸€ç§’getçš„æ—¶å€™è¿˜æ˜¯åŸå€¼ï¼Œæ‰€ä»¥çº¿ç¨‹å®‰å…¨è¿˜æ˜¯æ— æ³•ä¿è¯ã€‚</p>
<h3 id="HashMapçš„é»˜è®¤åˆå§‹åŒ–é•¿åº¦æ˜¯å¤šå°‘ï¼ŸåŸå› ï¼Ÿ">HashMapçš„é»˜è®¤åˆå§‹åŒ–é•¿åº¦æ˜¯å¤šå°‘ï¼ŸåŸå› ï¼Ÿ</h3>
<p>åˆå§‹åŒ–å¤§å°æ˜¯16<br>
æˆ‘ä»¬åœ¨åˆ›å»ºHashMapçš„æ—¶å€™ï¼Œé˜¿é‡Œå·´å·´è§„èŒƒæ’ä»¶ä¼šæé†’æˆ‘ä»¬æœ€å¥½èµ‹åˆå€¼ï¼Œè€Œä¸”æœ€å¥½æ˜¯2çš„å¹‚ã€‚<br>
è¿™æ ·æ˜¯ä¸ºäº†ä½è¿ç®—çš„æ–¹ä¾¿ï¼Œä½ä¸è¿ç®—æ¯”ç®—æ•°è®¡ç®—çš„æ•ˆç‡é«˜äº†å¾ˆå¤šï¼Œä¹‹æ‰€ä»¥é€‰æ‹©16ï¼Œæ˜¯ä¸ºäº†æœåŠ¡å°†Keyæ˜ å°„åˆ°indexçš„ç®—æ³•ã€‚</p>
<h3 id="é‚£ä¸ºå•¥ç”¨16ä¸ç”¨åˆ«çš„å‘¢ï¼Ÿ">é‚£ä¸ºå•¥ç”¨16ä¸ç”¨åˆ«çš„å‘¢ï¼Ÿ</h3>
<p>å› ä¸ºåœ¨ä½¿ç”¨ä¸æ˜¯2çš„å¹‚çš„æ•°å­—çš„æ—¶å€™ï¼ŒLength-1çš„å€¼æ˜¯æ‰€æœ‰äºŒè¿›åˆ¶ä½å…¨ä¸º1ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œindexçš„ç»“æœç­‰åŒäºHashCodeåå‡ ä½çš„å€¼ã€‚<br>
åªè¦è¾“å…¥çš„HashCodeæœ¬èº«åˆ†å¸ƒå‡åŒ€ï¼ŒHashç®—æ³•çš„ç»“æœå°±æ˜¯å‡åŒ€çš„ã€‚<br>
è¿™æ˜¯ä¸ºäº†å®ç°å‡åŒ€åˆ†å¸ƒã€‚</p>
<h3 id="ä¸ºå•¥æˆ‘ä»¬é‡å†™equalsæ–¹æ³•çš„æ—¶å€™éœ€è¦é‡å†™hashCodeæ–¹æ³•å‘¢ï¼Ÿ">ä¸ºå•¥æˆ‘ä»¬é‡å†™equalsæ–¹æ³•çš„æ—¶å€™éœ€è¦é‡å†™hashCodeæ–¹æ³•å‘¢ï¼Ÿ</h3>
<p>å› ä¸ºåœ¨javaä¸­ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½æ˜¯ç»§æ‰¿äºObjectç±»ã€‚Objectç±»ä¸­æœ‰ä¸¤ä¸ªæ–¹æ³•equalsã€hashCodeï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯ç”¨æ¥æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸ç­‰çš„ã€‚<br>
åœ¨æœªé‡å†™equalsæ–¹æ³•æˆ‘ä»¬æ˜¯ç»§æ‰¿äº†objectçš„equalsæ–¹æ³•ï¼Œé‚£é‡Œçš„ equalsæ˜¯æ¯”è¾ƒä¸¤ä¸ªå¯¹è±¡çš„å†…å­˜åœ°å€ï¼Œæ˜¾ç„¶æˆ‘ä»¬newäº†2ä¸ªå¯¹è±¡å†…å­˜åœ°å€è‚¯å®šä¸ä¸€æ ·<br>
å¯¹äºå€¼å¯¹è±¡ï¼Œ==æ¯”è¾ƒçš„æ˜¯ä¸¤ä¸ªå¯¹è±¡çš„å€¼<br>
å¯¹äºå¼•ç”¨å¯¹è±¡ï¼Œæ¯”è¾ƒçš„æ˜¯ä¸¤ä¸ªå¯¹è±¡çš„åœ°å€<br>
å¤§å®¶æ˜¯å¦è¿˜è®°å¾—æˆ‘è¯´çš„HashMapæ˜¯é€šè¿‡keyçš„hashCodeå»å¯»æ‰¾indexçš„ï¼Œé‚£indexä¸€æ ·å°±å½¢æˆé“¾è¡¨äº†ï¼Œä¹Ÿå°±æ˜¯è¯´â€å¸…ä¸™â€œå’Œâ€ä¸™å¸…â€œçš„indexéƒ½å¯èƒ½æ˜¯2ï¼Œåœ¨ä¸€ä¸ªé“¾è¡¨ä¸Šçš„ã€‚<br>
æˆ‘ä»¬å»getçš„æ—¶å€™ï¼Œä»–å°±æ˜¯æ ¹æ®keyå»hashç„¶åè®¡ç®—å‡ºindexï¼Œæ‰¾åˆ°äº†2ï¼Œé‚£æˆ‘æ€ä¹ˆæ‰¾åˆ°å…·ä½“çš„â€å¸…ä¸™â€œè¿˜æ˜¯â€ä¸™å¸…â€œå‘¢ï¼Ÿ<br>
equalsï¼æ˜¯çš„ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬å¯¹equalsæ–¹æ³•è¿›è¡Œäº†é‡å†™ï¼Œå»ºè®®ä¸€å®šè¦å¯¹hashCodeæ–¹æ³•é‡å†™ï¼Œä»¥ä¿è¯ç›¸åŒçš„å¯¹è±¡è¿”å›ç›¸åŒçš„hashå€¼ï¼Œä¸åŒçš„å¯¹è±¡è¿”å›ä¸åŒçš„hashå€¼ã€‚<br>
ä¸ç„¶ä¸€ä¸ªé“¾è¡¨çš„å¯¹è±¡ï¼Œä½ å“ªé‡ŒçŸ¥é“ä½ è¦æ‰¾çš„æ˜¯å“ªä¸ªï¼Œåˆ°æ—¶å€™å‘ç°hashCodeéƒ½ä¸€æ ·</p>
<h3 id="æ€ä¹ˆå¤„ç†HashMapåœ¨çº¿ç¨‹å®‰å…¨çš„åœºæ™¯ä¹ˆï¼Ÿ">æ€ä¹ˆå¤„ç†HashMapåœ¨çº¿ç¨‹å®‰å…¨çš„åœºæ™¯ä¹ˆï¼Ÿ</h3>
<p>æˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šä½¿ç”¨HashTableæˆ–è€…ConcurrentHashMapï¼Œä½†æ˜¯å› ä¸ºå‰è€…çš„å¹¶å‘åº¦çš„åŸå› åŸºæœ¬ä¸Šæ²¡å•¥ä½¿ç”¨åœºæ™¯äº†ï¼Œæ‰€ä»¥å­˜åœ¨çº¿ç¨‹ä¸å®‰å…¨çš„åœºæ™¯æˆ‘ä»¬éƒ½ä½¿ç”¨çš„æ˜¯ConcurrentHashMapã€‚<br>
HashTableæˆ‘çœ‹è¿‡ä»–çš„æºç ï¼Œå¾ˆç®€å•ç²—æš´ï¼Œç›´æ¥åœ¨æ–¹æ³•ä¸Šé”ï¼Œå¹¶å‘åº¦å¾ˆä½ï¼Œæœ€å¤šåŒæ—¶å…è®¸ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼ŒConcurrentHashMapå°±å¥½å¾ˆå¤šäº†ï¼Œ1.7å’Œ1.8æœ‰è¾ƒå¤§çš„ä¸åŒï¼Œä¸è¿‡å¹¶å‘åº¦éƒ½æ¯”å‰è€…å¥½å¤ªå¤šäº†ã€‚</p>
<h3 id="ä»€ä¹ˆæ—¶å€™resize">ä»€ä¹ˆæ—¶å€™resize?</h3>
<p>æœ‰ä¸¤ä¸ªå› ç´ ï¼š</p>
<ul>
<li>Capacityï¼šHashMapå½“å‰é•¿åº¦ã€‚</li>
<li>LoadFactorï¼šè´Ÿè½½å› å­ï¼Œé»˜è®¤å€¼0.75fã€‚<br>
ä¸¾ä¸ªä¾‹å­ï¼šå°±æ¯”å¦‚å½“å‰çš„å®¹é‡å¤§å°ä¸º100ï¼Œå½“ä½ å­˜è¿›ç¬¬76ä¸ªçš„æ—¶å€™ï¼Œåˆ¤æ–­å‘ç°éœ€è¦è¿›è¡Œresizeäº†ï¼Œé‚£å°±è¿›è¡Œæ‰©å®¹ï¼Œä½†æ˜¯HashMapçš„æ‰©å®¹ä¹Ÿä¸æ˜¯ç®€å•çš„æ‰©å¤§ç‚¹å®¹é‡è¿™ä¹ˆç®€å•çš„ã€‚</li>
</ul>
<h3 id="æ‰©å®¹ï¼Ÿå®ƒæ˜¯æ€ä¹ˆæ‰©å®¹çš„å‘¢ï¼Ÿ">æ‰©å®¹ï¼Ÿå®ƒæ˜¯æ€ä¹ˆæ‰©å®¹çš„å‘¢ï¼Ÿ</h3>
<p>åˆ†ä¸ºä¸¤æ­¥</p>
<ul>
<li>æ‰©å®¹ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Entryç©ºæ•°ç»„ï¼Œé•¿åº¦æ˜¯åŸæ•°ç»„çš„2å€ã€‚</li>
<li>ReHashï¼šéå†åŸEntryæ•°ç»„ï¼ŒæŠŠæ‰€æœ‰çš„Entryé‡æ–°Hashåˆ°æ–°æ•°ç»„ã€‚</li>
</ul>
<h3 id="ä¸ºä»€ä¹ˆè¦é‡æ–°Hashå‘¢ï¼Œç›´æ¥å¤åˆ¶è¿‡å»ä¸é¦™ä¹ˆï¼Ÿ">ä¸ºä»€ä¹ˆè¦é‡æ–°Hashå‘¢ï¼Œç›´æ¥å¤åˆ¶è¿‡å»ä¸é¦™ä¹ˆï¼Ÿ</h3>
<p>æ˜¯å› ä¸ºé•¿åº¦æ‰©å¤§ä»¥åï¼ŒHashçš„è§„åˆ™ä¹Ÿéšä¹‹æ”¹å˜ã€‚<br>
Hashçš„å…¬å¼â€”&gt; index = HashCodeï¼ˆKeyï¼‰ &amp; ï¼ˆLength - 1ï¼‰<br>
åŸæ¥é•¿åº¦ï¼ˆLengthï¼‰æ˜¯8ä½ ä½è¿ç®—å‡ºæ¥çš„å€¼æ˜¯2 ï¼Œæ–°çš„é•¿åº¦æ˜¯16ä½ ä½è¿ç®—å‡ºæ¥çš„å€¼æ˜æ˜¾ä¸ä¸€æ ·äº†ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>Javaæºç è§£æ</category>
      </categories>
      <tags>
        <tag>Javaæºç è§£æ</tag>
      </tags>
  </entry>
  <entry>
    <title>Dockerä¹‹éƒ¨ç½²è„šæœ¬.deploysh</title>
    <url>/2019/11/14/docker-deploysh/</url>
    <content><![CDATA[<h2 id="è¯´æ˜">è¯´æ˜</h2>
<p>å‡å¦‚æˆ‘è¦ä½¿ç”¨dockeræ„å»ºå®¹å™¨éƒ¨ç½²springbooté¡¹ç›®ï¼Œæ­¥éª¤ï¼š</p>
<ol>
<li>æŠŠjaråŒ…ä¸Šä¼ åˆ°æœåŠ¡å™¨ä¸Š</li>
<li>åˆ›å»ºDockFileæ–‡ä»¶</li>
<li>ç¼–è¯‘é•œåƒ<br>
<code>docker build -t test.</code></li>
<li>å¯åŠ¨å®¹å™¨<br>
<code>docker run --name test -p 8080:8080 -d test</code></li>
</ol>
<a id="more"></a>
<p>â€“nameä¸ºæŒ‡å®šå®¹å™¨çš„åç§°ï¼›<br>
-pæŒ‡å®šå®¹å™¨æš´éœ²çš„ç«¯å£<br>
-dä»¥åå°è¿›ç¨‹è¿è¡Œ<br>
æ¯æ¬¡æ›´æ–°jaråŒ…æ—¶ï¼Œåªéœ€æ‰§è¡Œ<code>docker stop test</code>ã€<code>docker start test</code>å°±å¯ä»¥äº†ï¼Œå°±å°†æ–°çš„åº”ç”¨è¿›è¡Œäº†å‘å¸ƒã€‚<br>
ä¸Šé¢æ­¥éª¤è™½ç„¶è§£å†³äº†æ›´æ–°jaråŒ…çš„é—®é¢˜ï¼Œä½†æ˜¯åˆå‡ºç°äº†ä¸€ä¸ªé—®é¢˜å°±æ˜¯åœ¨Dockerfileä¸­å°†ä½¿ç”¨çš„jaråŒ…åç§°å†™æ­»äº†ï¼Œè¿™æ ·æ¯æ¬¡æ›´æ–°jaråŒ…å¿…é¡»æ˜¯åŒæ ·çš„jaråŒ…ï¼Œè¿™æ ·å½“åº”ç”¨ä»1.1ç‰ˆæœ¬æ›´æ–°1.2ç‰ˆæœ¬æ—¶å°±å¾ˆç—›è‹¦ï¼Œéœ€è¦å°†æœ¬æ˜¯1.2ç‰ˆæœ¬çš„jaråŒ…æ”¹åä¸º1.1ï¼Œè¿™æ ·ä¼šå¯¼è‡´åç»­jaråŒ…çš„é”™ä¹±ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨.deployshè„šæœ¬å•¦ï¼Œæ¨¡ç‰ˆå¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">CURRENT=`pwd`</span><br><span class="line">cd $(dirname $0)</span><br><span class="line"></span><br><span class="line">if [ $# != 3 ] ; then</span><br><span class="line">   echo Error ! $0 app.jar config_dir name</span><br><span class="line">   echo PORT in yml/properties file to config AND SPRING_PROFILES_ACTIVE=online</span><br><span class="line">   exit 1;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">DOCKER_NAME=$3</span><br><span class="line">TAG_NAME=`date +%s`</span><br><span class="line"></span><br><span class="line">set -e -x</span><br><span class="line"></span><br><span class="line">TMP="/tmp/docker-template/"</span><br><span class="line">rm -rf $TMP</span><br><span class="line">mkdir $TMP</span><br><span class="line"></span><br><span class="line">cp $CURRENT/$1 "$TMP/app.jar"</span><br><span class="line">cp -r $CURRENT/$2 "$TMP/config/"</span><br><span class="line">cp Dockerfile "$TMP/Dockerfile"</span><br><span class="line"></span><br><span class="line">cd $TMP</span><br><span class="line"></span><br><span class="line">sudo /usr/bin/docker build . -t $DOCKER_NAME:$TAG_NAME --build-arg JAR=app.jar</span><br><span class="line">sudo /usr/bin/docker tag $DOCKER_NAME:$TAG_NAME $DOCKER_NAME:latest</span><br><span class="line"></span><br><span class="line">sudo /usr/bin/docker ps|grep $DOCKER_NAME &amp;&amp; sudo /usr/bin/docker stop $DOCKER_NAME</span><br><span class="line">sudo /usr/bin/docker ps -a|grep $DOCKER_NAME &amp;&amp; sudo /usr/bin/docker rm $DOCKER_NAME</span><br><span class="line">sudo /usr/bin/docker run -d --net host --restart always --name $DOCKER_NAME -v /var/log/:/var/log/ $DOCKER_NAME:$TAG_NAME</span><br><span class="line"></span><br><span class="line">rm -rf $TMP</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡æ­¤è„šæœ¬ï¼Œæ¯æ¬¡æ›´æ–°åº”ç”¨æ—¶æˆ‘ä»¬å°±å¯ä»¥<code>.deploysh test.jar conf/ test</code>å°±å¯ä»¥å•¦ï¼Œæ˜¯ä¸æ˜¯æ–¹ä¾¿å¤šå•¦<sup>_</sup>ï¼<br>
confæ˜¯å’ŒjaråŒ…åŸºäºåŒçº§ç›®å½•çš„é…ç½®ç›®å½•ï¼Œconfç›®å½•ä¸‹æ”¾springbooté¡¹ç›®çš„é…ç½®æ–‡ä»¶ï¼Œeg:applicaion.yml,è¿è¡Œå®¹å™¨æ—¶å°±ä¼šåŠ è½½æ­¤é…ç½®æ–‡ä»¶ã€‚</p>
<h2 id="usage">usage</h2>
<p>demo:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./deploy.sh ready-to-deploy.jar ./config-directory/ docker-cotainer-name</span><br></pre></td></tr></table></figure>
<p>SPRING_PROFILES_ACTIVE is â€œonlineâ€, Server port is config IN application-online.yml / application-online.properties with default.</p>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Dockerä¹‹Dockfile</title>
    <url>/2019/11/14/docker-dockerfile/</url>
    <content><![CDATA[<h2 id="Dockerfileæ˜¯ä»€ä¹ˆï¼Ÿ">Dockerfileæ˜¯ä»€ä¹ˆï¼Ÿ</h2>
<p>Dockerå¯ä»¥é€šè¿‡é˜…è¯»Dockerfileä¸­çš„æŒ‡ä»¤æ¥è‡ªåŠ¨æ„å»ºæ˜ åƒã€‚ Dockerfileæ˜¯ä¸€ä¸ªæ–‡æœ¬æ–‡æ¡£ï¼Œå…¶ä¸­åŒ…å«ç”¨æˆ·å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸Šè°ƒç”¨ä»¥ç»„è£…æ˜ åƒçš„æ‰€æœ‰å‘½ä»¤ã€‚ä½¿ç”¨docker buildçš„ç”¨æˆ·å¯ä»¥åˆ›å»ºè‡ªåŠ¨æ‰§è¡Œçš„æ„å»ºï¼Œè¯¥æ„å»ºå¯ä»¥è¿ç»­æ‰§è¡Œå‡ ä¸ªå‘½ä»¤è¡ŒæŒ‡ä»¤ã€‚</p>
<h2 id="æ„å»ºspringbooté¡¹ç›®æ¨¡ç‰ˆ">æ„å»ºspringbooté¡¹ç›®æ¨¡ç‰ˆ</h2>
<a id="more"></a>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">FROM openjdk:<span class="number">8</span></span><br><span class="line">VOLUME /tmp</span><br><span class="line"></span><br><span class="line">ARG JAR=app.jar</span><br><span class="line"></span><br><span class="line">ENV SPRING_PROFILES_ACTIVE=online</span><br><span class="line">ENV TZ=Asia/Shanghai</span><br><span class="line"></span><br><span class="line">RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone</span><br><span class="line"></span><br><span class="line">ADD config/ /opt/app/</span><br><span class="line">ADD $JAR /opt/app/app.jar</span><br><span class="line"></span><br><span class="line">EXPOSE <span class="number">8080</span></span><br><span class="line">WORKDIR /opt/app/</span><br><span class="line"></span><br><span class="line">CMD [ <span class="string">"/usr/local/openjdk-8/bin/java"</span>, <span class="string">"-Djava.security.egd=file:/dev/urandom"</span>, <span class="string">"-jar"</span>, <span class="string">"/opt/app/app.jar"</span> ]</span><br></pre></td></tr></table></figure>
<h2 id="usage">usage</h2>
<p>demo:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.&#x2F;deploy.sh ready-to-deploy.jar .&#x2F;config-directory&#x2F; docker-cotainer-name</span><br></pre></td></tr></table></figure>
<p>SPRING_PROFILES_ACTIVE is â€œonlineâ€, Server port is config IN application-online.yml / application-online.properties with default.</p>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>hexoå’Œthemes Nextç‰ˆæœ¬å‡çº§</title>
    <url>/2019/10/26/hexo%E5%92%8Cthemes-Next%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7/</url>
    <content><![CDATA[<h2 id="hexoç‰ˆæœ¬å‡çº§">hexoç‰ˆæœ¬å‡çº§</h2>
<p>å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">1.npm i hexo-cli -g</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">2.npm update</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">3.hexo version</span><br></pre></td></tr></table></figure>
<p>å‘ç°ç‰ˆæœ¬è¿˜æ˜¯åŸæ¥çš„3.9.0ï¼Œå…¶å®ä¸Šé¢çš„æ›´æ–°å‘½ä»¤å¹¶ä¸æ˜¯å¾ˆå‡†ç¡®ã€‚</p>
<a id="more"></a>
<ol>
<li><code>npm-check</code>æ£€æŸ¥æ›´æ–°<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install -g npm-check</span><br><span class="line">npm-check</span><br></pre></td></tr></table></figure>
</li>
<li><code>npm-upgrade</code>æ›´æ–°<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm install -g npm-upgrade</span><br><span class="line">npm-upgrade</span><br></pre></td></tr></table></figure>
</li>
<li>æ›´æ–°å…¨å±€åŒ…<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm update -g</span><br></pre></td></tr></table></figure>
</li>
<li>æ›´æ–°ç”Ÿäº§ç¯å¢ƒä¾èµ–åŒ…<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm update --save</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>å†æ¬¡<code>hexo version</code>æŸ¥çœ‹ç‰ˆæœ¬ï¼Œå‘ç°å·²ç»æ›´æ–°ä¸º4.2.2äº†ã€‚</p>
<h2 id="nextç‰ˆæœ¬æ›´æ–°">nextç‰ˆæœ¬æ›´æ–°</h2>
<p>åœ¨å‡çº§ä¹‹å‰ï¼Œå»ºè®®å¤§å®¶å…ˆå¤‡ä»½è‡ªå·±çš„åšå®¢ä»“åº“ï¼Œä¸‡ä¸€æåäº†æ˜µï¼Œå²‚ä¸å°´äº†ä¸ªå¤§å°¬ï¼Œäº‹å®è¯æ˜çš„ç¡®å°ç¼–ä¹Ÿå…¥å‘ä¸€æ¬¡ï¼Œåœ¨è¿™é‡Œæˆ‘åªé™„ä¸Šæ­£ç¡®æ›´æ–°æµç¨‹ï¼Œè‡³äºè¸©å‘è®°å½•æˆ‘å°±ä¸å¤šè¯´äº†ï¼Œè¯´å¤šäº†éƒ½æ˜¯æ³ªå•ŠğŸ˜¢<br>
æ“ä½œæ­¥éª¤ï¼š</p>
<ol>
<li>ä¸‹è½½æ–°çš„Nextä¸»é¢˜ï¼Œä»“åº“åœ°å€ä¸ºï¼š<a href="https://github.com/theme-next/hexo-theme-next.git;" target="_blank" rel="noopener">https://github.com/theme-next/hexo-theme-next.git;</a></li>
<li>è¿›å…¥ä¸‹è½½çš„æ–‡ä»¶å¤¹ï¼Œgit bash here,<code>rm -rf .git</code>,å› ä¸ºå®ƒæœ¬èº«å°±æ˜¯gitä»“åº“ï¼Œä¸åˆ é™¤å’Œä½ çš„åšå®¢ä»“åº“å°±ä¼šæ˜¯ä¸¤ä¸ªåˆ†æ”¯ï¼Œè§£å†³æ–¹å¼å½“ç„¶æ˜¯åˆ é™¤.gitæ–‡ä»¶å¤¹äº†ã€‚</li>
<li>å»ºè®®ç”¨Beyound Compareå‰ªè´´å¯¹æ¯”å·¥å…·å¯¹æ¯”åŸnextæ–‡ä»¶å¤¹å’Œæ–°nextæ–‡ä»¶å¤¹ä¸‹çš„ä¸åŒï¼Œç‰¹åˆ«æ˜¯nextä¸‹çš„_config.yml,è¯¥åˆ é™¤çš„åˆ é™¤ï¼Œè¯¥ä¿®æ”¹çš„ä¿®æ”¹;</li>
<li>æ•´åˆå®Œæ¯•åå°†æ–°ä¸‹è½½çš„nextç›®å½•æ›¿æ¢åŸæ¥çš„nextç›®å½•,ç„¶åæœ¬åœ°å¯åŠ¨æµ‹è¯•OKåæ¨é€ä¸Šåº“ã€‚<br>
æ˜¯ä¸æ˜¯çœ‹äº†æˆ‘çš„æ–‡ç« ä¹‹åè§‰å¾—ä¹ŸæŒºç®€å•çš„ï¼Œå…¶å®å°±æ˜¯å¦‚æ­¤ç®€å•ï¼Œåªè¦ä¸è¿›å‘ğŸ˜„ã€‚</li>
</ol>
]]></content>
      <categories>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Rabbitmq å­¦ä¹ </title>
    <url>/2019/09/28/rabbitmq-topicexchange/</url>
    <content><![CDATA[<h2 id="æ¦‚å¿µ">æ¦‚å¿µ</h2>
<p>RabbitMQä½œä¸ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æä¾›ä¸€ä¸ªé€šç”¨çš„æ¶ˆæ¯å‘é€å’Œæ¥æ”¶å¹³å°ï¼Œå¹¶ä¸”ä¿è¯æ¶ˆæ¯åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­çš„å®‰å…¨å¯é ã€‚æ¶ˆæ¯(Message)ç”±Clientå‘é€ï¼ŒRabbitMQæ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹åé€šè¿‡äº¤æ¢æœºè½¬å‘åˆ°å¯¹åº”çš„é˜Ÿåˆ—ä¸Šé¢ã€‚Workerä¼šä»é˜Ÿåˆ—ä¸­è·å–æœªè¢«è¯»å–çš„æ•°æ®å¤„ç†ã€‚è°ˆåˆ°é˜Ÿåˆ—æœåŠ¡, ä¼šæœ‰ä¸‰ä¸ªæ¦‚å¿µï¼š å‘æ¶ˆæ¯è€…ã€é˜Ÿåˆ—ã€æ”¶æ¶ˆæ¯è€…ï¼ŒRabbitMQ åœ¨è¿™ä¸ªåŸºæœ¬æ¦‚å¿µä¹‹ä¸Š, å¤šåšäº†ä¸€å±‚æŠ½è±¡, åœ¨å‘æ¶ˆæ¯è€…å’Œ é˜Ÿåˆ—ä¹‹é—´, åŠ å…¥äº†äº¤æ¢å™¨ (Exchange). è¿™æ ·å‘æ¶ˆæ¯è€…å’Œé˜Ÿåˆ—å°±æ²¡æœ‰ç›´æ¥è”ç³», è½¬è€Œå˜æˆå‘æ¶ˆæ¯è€…æŠŠæ¶ˆæ¯ç»™äº¤æ¢å™¨, äº¤æ¢å™¨æ ¹æ®è°ƒåº¦ç­–ç•¥å†æŠŠæ¶ˆæ¯å†ç»™é˜Ÿåˆ—ã€‚</p>
<a id="more"></a>
<h2 id="äº¤æ¢æœº">äº¤æ¢æœº</h2>
<p>äº¤æ¢æœºçš„åŠŸèƒ½ä¸»è¦æ˜¯æ¥æ”¶æ¶ˆæ¯å¹¶ä¸”è½¬å‘åˆ°ç»‘å®šçš„é˜Ÿåˆ—ï¼Œäº¤æ¢æœºä¸å­˜å‚¨æ¶ˆæ¯ï¼Œåœ¨å¯ç”¨ackæ¨¡å¼åï¼Œäº¤æ¢æœºæ‰¾ä¸åˆ°é˜Ÿåˆ—ä¼šè¿”å›é”™è¯¯ã€‚äº¤æ¢æœºæœ‰å››ç§ç±»å‹ï¼šDirect, topic, Headers and Fanout<br>
è¿™é‡Œæœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ¦‚å¿µï¼šè·¯ç”±é”® ã€‚æ¶ˆæ¯åˆ°äº¤æ¢æœºçš„æ—¶å€™ï¼Œäº¤äº’æœºä¼šè½¬å‘åˆ°å¯¹åº”çš„é˜Ÿåˆ—ä¸­ï¼Œé‚£ä¹ˆç©¶ç«Ÿè½¬å‘åˆ°å“ªä¸ªé˜Ÿåˆ—ï¼Œå°±è¦æ ¹æ®è¯¥è·¯ç”±é”®ã€‚</p>
<ul>
<li>Directï¼šdirect ç±»å‹çš„è¡Œä¸ºæ˜¯â€œå…ˆåŒ¹é…, å†æŠ•é€â€. å³åœ¨ç»‘å®šæ—¶è®¾å®šä¸€ä¸ª routing_key, æ¶ˆæ¯çš„routing_key åŒ¹é…æ—¶, æ‰ä¼šè¢«äº¤æ¢å™¨æŠ•é€åˆ°ç»‘å®šçš„é˜Ÿåˆ—ä¸­å».</li>
<li>Topicï¼šæŒ‰è§„åˆ™è½¬å‘æ¶ˆæ¯ï¼ˆæœ€çµæ´»ï¼‰</li>
<li>Headersï¼šè®¾ç½® header attribute å‚æ•°ç±»å‹çš„äº¤æ¢æœº</li>
<li>Fanoutï¼šè½¬å‘æ¶ˆæ¯åˆ°æ‰€æœ‰ç»‘å®šé˜Ÿåˆ—</li>
</ul>
<h3 id="Direct-Exchange">Direct Exchange</h3>
<p>Direct Exchange æ˜¯ RabbitMQ é»˜è®¤çš„äº¤æ¢æœºæ¨¡å¼ï¼Œä¹Ÿæ˜¯æœ€ç®€å•çš„æ¨¡å¼ï¼Œæ ¹æ®keyå…¨æ–‡åŒ¹é…å»å¯»æ‰¾é˜Ÿåˆ—ã€‚</p>
<h3 id="Topic-Exchange">Topic Exchange</h3>
<p>Topic Exchange è½¬å‘æ¶ˆæ¯ä¸»è¦æ˜¯æ ¹æ®é€šé…ç¬¦ã€‚ åœ¨è¿™ç§äº¤æ¢æœºä¸‹ï¼Œé˜Ÿåˆ—å’Œäº¤æ¢æœºçš„ç»‘å®šä¼šå®šä¹‰ä¸€ç§è·¯ç”±æ¨¡å¼ï¼Œé‚£ä¹ˆï¼Œé€šé…ç¬¦å°±è¦åœ¨è¿™ç§è·¯ç”±æ¨¡å¼å’Œè·¯ç”±é”®ä¹‹é—´åŒ¹é…åäº¤æ¢æœºæ‰èƒ½è½¬å‘æ¶ˆæ¯ã€‚<br>
åœ¨è¿™ç§äº¤æ¢æœºæ¨¡å¼ä¸‹ï¼š</p>
<ul>
<li>è·¯ç”±é”®å¿…é¡»æ˜¯ä¸€ä¸²å­—ç¬¦ï¼Œç”¨å¥å·ï¼ˆ.ï¼‰ éš”å¼€ï¼Œæ¯”å¦‚è¯´ <a href="http://agreements.us" target="_blank" rel="noopener">agreements.us</a>ï¼Œæˆ–è€… agreements.eu.stockholm ç­‰ã€‚</li>
<li>è·¯ç”±æ¨¡å¼å¿…é¡»åŒ…å«ä¸€ä¸ª æ˜Ÿå·ï¼ˆ<em>ï¼‰ï¼Œä¸»è¦ç”¨äºåŒ¹é…è·¯ç”±é”®æŒ‡å®šä½ç½®çš„ä¸€ä¸ªå•è¯ï¼Œæ¯”å¦‚è¯´ï¼Œä¸€ä¸ªè·¯ç”±æ¨¡å¼æ˜¯è¿™æ ·å­ï¼šagreementsâ€¦b.</em>ï¼Œé‚£ä¹ˆå°±åªèƒ½åŒ¹é…è·¯ç”±é”®æ˜¯è¿™æ ·å­çš„ï¼šç¬¬ä¸€ä¸ªå•è¯æ˜¯ agreementsï¼Œç¬¬å››ä¸ªå•è¯æ˜¯ bã€‚ äº•å·ï¼ˆ#ï¼‰å°±è¡¨ç¤ºç›¸å½“äºä¸€ä¸ªæˆ–è€…å¤šä¸ªå•è¯ï¼Œä¾‹å¦‚ä¸€ä¸ªåŒ¹é…æ¨¡å¼æ˜¯ agreements.eu.berlin.#ï¼Œé‚£ä¹ˆï¼Œä»¥agreements.eu.berlin å¼€å¤´çš„è·¯ç”±é”®éƒ½æ˜¯å¯ä»¥çš„ã€‚</li>
</ul>
<ul>
<li>*è¡¨ç¤ºä¸€ä¸ªè¯.</li>
<li>#è¡¨ç¤ºé›¶ä¸ªæˆ–å¤šä¸ªè¯.</li>
</ul>
<h3 id="Headers-Exchange">Headers Exchange</h3>
<p>headers ä¹Ÿæ˜¯æ ¹æ®è§„åˆ™åŒ¹é…, ç›¸è¾ƒäº direct å’Œ topic å›ºå®šåœ°ä½¿ç”¨ routing_key , headers åˆ™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰åŒ¹é…è§„åˆ™çš„ç±»å‹. åœ¨é˜Ÿåˆ—ä¸äº¤æ¢å™¨ç»‘å®šæ—¶, ä¼šè®¾å®šä¸€ç»„é”®å€¼å¯¹è§„åˆ™, æ¶ˆæ¯ä¸­ä¹ŸåŒ…æ‹¬ä¸€ç»„é”®å€¼å¯¹( headers å±æ€§), å½“è¿™äº›é”®å€¼å¯¹æœ‰ä¸€å¯¹, æˆ–å…¨éƒ¨åŒ¹é…æ—¶, æ¶ˆæ¯è¢«æŠ•é€åˆ°å¯¹åº”é˜Ÿåˆ—.</p>
<h3 id="Fanout-Exchange">Fanout Exchange</h3>
<p>Fanout Exchange æ¶ˆæ¯å¹¿æ’­çš„æ¨¡å¼ï¼Œä¸ç®¡è·¯ç”±é”®æˆ–è€…æ˜¯è·¯ç”±æ¨¡å¼ï¼Œä¼šæŠŠæ¶ˆæ¯å‘ç»™ç»‘å®šç»™å®ƒçš„å…¨éƒ¨é˜Ÿåˆ—ï¼Œå¦‚æœé…ç½®äº† routing_key ä¼šè¢«å¿½ç•¥ã€‚</p>
<h2 id="ä»£ç ç¤ºä¾‹-TopicExchange">ä»£ç ç¤ºä¾‹(TopicExchange)</h2>
<p>pom.xmåŠ å…¥ä¾èµ–</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">      &lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>application.ymlæ·»åŠ é…ç½®</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  rabbitmq:</span><br><span class="line">    host: localhost</span><br><span class="line">    port: 5672</span><br><span class="line">    username: guest</span><br><span class="line">    password: guest</span><br></pre></td></tr></table></figure>
<p><code>TopicRabbitMqConfig.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.java.study.rabbitmq.topic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.TopicExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicRabbitMqConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> String TOPIC_ONE = <span class="string">"topic.one"</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> String TOPIC_TWO = <span class="string">"topic.two"</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> String TOPIC_EXCHANGE = <span class="string">"topicExchange"</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Topic äº¤æ¢æœºæ¨¡å¼  å¯ä»¥ç”¨é€šé…ç¬¦</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸¤ä¸ª Queue</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">queue_one</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(TOPIC_ONE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">queue_two</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(TOPIC_TWO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é…ç½® TopicExchange,æŒ‡å®šåç§°ä¸º topicExchange</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TopicExchange <span class="title">exchange</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TopicExchange(TOPIC_EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç»™é˜Ÿåˆ—ç»‘å®š exchange å’Œ routing_key</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">bindingExchangeMessage</span><span class="params">(Queue queue_one, TopicExchange exchange)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue_one).to(exchange).with(<span class="string">"topic.one"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">bingingExchangeMessages</span><span class="params">(Queue queue_two,TopicExchange exchange)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue_two).to(exchange).with(<span class="string">"topic.#"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>TopicSender.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.java.study.rabbitmq.topic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.AmqpTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicSender</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    AmqpTemplate amqpTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send_one</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String context = <span class="string">"Hi,I am message one"</span>;</span><br><span class="line">        <span class="keyword">this</span>.amqpTemplate.convertAndSend(TopicRabbitMqConfig.TOPIC_EXCHANGE,<span class="string">"topic.one"</span>,context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send_two</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String context = <span class="string">"Hi,I am message two"</span>;</span><br><span class="line">        <span class="keyword">this</span>.amqpTemplate.convertAndSend(TopicRabbitMqConfig.TOPIC_EXCHANGE,<span class="string">"topic.two"</span>,context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>TopicReceiver1.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.java.study.rabbitmq.topic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RabbitListener</span>(queues = <span class="string">"topic.one"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicReceiver1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Receiver1 topic.one :"</span>+ message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>TopicReceiver2.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.java.study.rabbitmq.topic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RabbitListener</span>(queues = <span class="string">"topic.two"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopicReceiver2</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Receiver2 topic.two :"</span>+ message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>RabbitmqdemoApplicationTest.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">RabbitmqdemoApplicationTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    TopicSender topicSender;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">topic</span><span class="params">()</span></span>&#123;</span><br><span class="line">        topicSender.send_one();</span><br><span class="line">        topicSender.send_two();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>topicSender.send_one()</code>æ‰“å°æ—¥å¿—å¦‚ä¸‹:<br>
<img src="/images/topic1.png" alt=""><br>
<code>topicSender.send_two()</code>æ‰“å°å¦‚ä¸‹ï¼š<br>
<img src="/images/topic2.png" alt=""><br>
ç”±æ­¤å¯è¯´æ˜å‘é€send_oneä¼šåŒ¹é…åˆ°topic.#å’Œtopic.one,æ‰€ä»¥ä¸¤ä¸ªReceiveréƒ½å¯ä»¥æ”¶åˆ°æ¶ˆæ¯ï¼Œå‘é€send_twoåªæœ‰topic.#å¯ä»¥åŒ¹é…æ‰€æœ‰,åªæœ‰Receiver2ç›‘å¬åˆ°æ¶ˆæ¯ã€‚</p>
]]></content>
      <categories>
        <category>RabbitMq</category>
      </categories>
      <tags>
        <tag>RabbitMq</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆè¯†SpringCloud</title>
    <url>/2019/09/07/springcloud-learn/</url>
    <content><![CDATA[<h2 id="å¼€ç¯‡">å¼€ç¯‡</h2>
<p>SpringCloudè¶Šæ¥è¶Šç«ï¼Œå’±ä¹Ÿå¾—è·Ÿä¸Šæ½®æµå•Šï¼Œé—²æš‡ä¹‹ä½™ï¼Œè‡ªå·±å­¦ä¹ å¹¶ä»£ç å®æˆ˜äº†ä¸‹ï¼Œå…¶å®å‘ç°å¹¶ä¸éš¾ï¼ŒçŸ¥é“å…¶å„ä¸ªæ¨¡å—æ˜¯å¹²ä»€ä¹ˆçš„å¹¶ä¸”èƒ½å¤Ÿè¿ç”¨å°±å¤Ÿäº†ï¼Œä¸‹é¢æˆ‘å°±ç®€å•è¯´ä¸‹è‡ªå·±å­¦ä¹ è¿‡ç¨‹çš„å¿ƒå¾—ï¼Œä¹Ÿç®—æ˜¯æ€»ç»“ä¸€ä¸‹ã€‚</p>
<h2 id="å¾®æœåŠ¡">å¾®æœåŠ¡</h2>
<p>ç®€è€Œè¨€ä¹‹ï¼Œå¾®æœåŠ¡æ¶æ„é£æ ¼æ˜¯ä¸€ç§å°†å•ä¸ªåº”ç”¨ç¨‹åºä½œä¸ºä¸€å¥—å°å‹æœåŠ¡å¼€å‘çš„æ–¹æ³•ï¼Œæ¯ç§åº”ç”¨ç¨‹åºéƒ½åœ¨è‡ªå·±çš„è¿›ç¨‹ä¸­è¿è¡Œï¼Œå¹¶ä¸è½»é‡çº§æœºåˆ¶ï¼ˆé€šå¸¸æ˜¯HTTPèµ„æºAPIï¼‰è¿›è¡Œé€šä¿¡ã€‚ è¿™äº›æœåŠ¡æ˜¯å›´ç»•ä¸šåŠ¡åŠŸèƒ½æ„å»ºçš„ï¼Œå¯ä»¥é€šè¿‡å…¨è‡ªåŠ¨éƒ¨ç½²æœºåˆ¶ç‹¬ç«‹éƒ¨ç½²ã€‚ è¿™äº›æœåŠ¡çš„é›†ä¸­ç®¡ç†æœ€å°‘ï¼Œå¯ä»¥ç”¨ä¸åŒçš„ç¼–ç¨‹è¯­è¨€ç¼–å†™ï¼Œå¹¶ä½¿ç”¨ä¸åŒçš„æ•°æ®å­˜å‚¨æŠ€æœ¯ã€‚</p>
<a id="more"></a>
<h2 id="ä¸ºä»€ä¹ˆè¦ç”¨å¾®æœåŠ¡">ä¸ºä»€ä¹ˆè¦ç”¨å¾®æœåŠ¡</h2>
<p>ç‰¹ç‚¹ï¼š<br>
1ã€ç‹¬ç«‹éƒ¨ç½²ï¼Œçµæ´»æ‰©å±•<br>
2ã€èµ„æºçš„æœ‰æ•ˆéš”ç¦»<br>
3ã€å›¢é˜Ÿç»„ç»‡æ¶æ„çš„è°ƒæ•´<br>
å’Œsoaçš„åŒºåˆ«ï¼š<br>
soaæ¶æ„æ˜¯ä¸€ç§ç²—ç²’åº¦æ¾è€¦åˆçš„æœåŠ¡æ¶æ„ï¼ŒSOAæ¶æ„å¼ºè°ƒçš„æ˜¯å¼‚æ„ç³»ç»Ÿä¹‹é—´çš„é€šä¿¡å’Œè§£è€¦åˆï¼Œè€Œå¾®æœåŠ¡æ¶æ„å¼ºè°ƒçš„æ˜¯ç³»ç»ŸæŒ‰ä¸šåŠ¡è¾¹ç•Œåšç»†ç²’åº¦çš„æ‹†åˆ†å’Œéƒ¨ç½²ã€‚</p>
<h2 id="å¾®æœåŠ¡ç»„ä»¶">å¾®æœåŠ¡ç»„ä»¶</h2>
<h3 id="åŒ…å«çš„ä¸»è¦ç»„ä»¶ä»¥åŠå„ç»„ä»¶ä¸»è¦æ˜¯å¹²ä»€ä¹ˆçš„">åŒ…å«çš„ä¸»è¦ç»„ä»¶ä»¥åŠå„ç»„ä»¶ä¸»è¦æ˜¯å¹²ä»€ä¹ˆçš„</h3>
<p><code>Eureka</code>ã€<code>Ribbon</code>ã€<code>Feign</code>ã€<code>Hystrix</code>ã€<code>Zuul</code>è¿™å‡ ä¸ªç»„ä»¶</p>
<h4 id="ä¸€ã€Eureka-æœåŠ¡æ³¨å†Œä¸å‘ç°ã€‚åŒ…å«Eureka-Serverå’ŒEureka-Client">ä¸€ã€Eureka:æœåŠ¡æ³¨å†Œä¸å‘ç°ã€‚åŒ…å«Eureka Serverå’ŒEureka Client</h4>
<p>Eureka Server:æ³¨å†Œä¸­å¿ƒï¼Œé‡Œé¢æœ‰ä¸€ä¸ªæ³¨å†Œè¡¨ï¼Œä¿å­˜äº†å„ä¸ªæœåŠ¡æ‰€åœ¨çš„æœºå™¨å’Œç«¯å£å·.<br>
Eureka Client:è´Ÿè´£å°†è¿™ä¸ªæœåŠ¡çš„ä¿¡æ¯æ³¨å†Œåˆ°Eureka Serverä¸­</p>
<h4 id="äºŒã€Feign-å…³é”®æœºåˆ¶å°±æ˜¯ä½¿ç”¨äº†åŠ¨æ€ä»£ç†">äºŒã€Feign:å…³é”®æœºåˆ¶å°±æ˜¯ä½¿ç”¨äº†åŠ¨æ€ä»£ç†</h4>
<p>è¿‡ç¨‹ï¼š<br>
é¦–å…ˆï¼Œå¦‚æœä½ å¯¹æŸä¸ªæ¥å£å®šä¹‰äº†<code>@FeignClient</code>æ³¨è§£ï¼ŒFeignå°±ä¼šé’ˆå¯¹è¿™ä¸ªæ¥å£åˆ›å»ºä¸€ä¸ªåŠ¨æ€ä»£ç†<br>
æ¥ç€ä½ è¦æ˜¯è°ƒç”¨é‚£ä¸ªæ¥å£ï¼Œæœ¬è´¨å°±æ˜¯ä¼šè°ƒç”¨ Feignåˆ›å»ºçš„åŠ¨æ€ä»£ç†ï¼Œè¿™æ˜¯æ ¸å¿ƒä¸­çš„æ ¸å¿ƒ<br>
<code>Feign</code>çš„åŠ¨æ€ä»£ç†ä¼šæ ¹æ®ä½ åœ¨æ¥å£ä¸Šçš„<code>@RequestMapping</code>ç­‰æ³¨è§£ï¼Œæ¥åŠ¨æ€æ„é€ å‡ºä½ è¦è¯·æ±‚çš„æœåŠ¡çš„åœ°å€<br>
æœ€åé’ˆå¯¹è¿™ä¸ªåœ°å€ï¼Œå‘èµ·è¯·æ±‚ã€è§£æå“åº”</p>
<h4 id="ä¸‰ã€Ribbon-è´Ÿè½½å‡è¡¡ã€‚å‡å¦‚ä¸€ä¸ªæœåŠ¡éƒ¨ç½²åˆ°å‡ å°æœåŠ¡å™¨ä¸Šï¼Œå®ƒçš„ä½œç”¨æ˜¯è´Ÿè½½å‡è¡¡ï¼Œä¼šå¸®ä½ åœ¨æ¯æ¬¡è¯·æ±‚æ—¶é€‰æ‹©ä¸€å°æœºå™¨ï¼Œå‡åŒ€çš„æŠŠè¯·æ±‚åˆ†å‘åˆ°å„ä¸ªæœºå™¨ä¸Šã€‚">ä¸‰ã€Ribbon:è´Ÿè½½å‡è¡¡ã€‚å‡å¦‚ä¸€ä¸ªæœåŠ¡éƒ¨ç½²åˆ°å‡ å°æœåŠ¡å™¨ä¸Šï¼Œå®ƒçš„ä½œç”¨æ˜¯è´Ÿè½½å‡è¡¡ï¼Œä¼šå¸®ä½ åœ¨æ¯æ¬¡è¯·æ±‚æ—¶é€‰æ‹©ä¸€å°æœºå™¨ï¼Œå‡åŒ€çš„æŠŠè¯·æ±‚åˆ†å‘åˆ°å„ä¸ªæœºå™¨ä¸Šã€‚</h4>
<h4 id="å››ã€æ–­è·¯å™¨ï¼ˆHystrixï¼‰">å››ã€æ–­è·¯å™¨ï¼ˆHystrixï¼‰</h4>
<p>è¿™ä¹ˆå¤šæœåŠ¡äº’ç›¸è°ƒç”¨ï¼Œè¦æ˜¯ä¸åšä»»ä½•ä¿æŠ¤çš„è¯ï¼ŒæŸä¸€ä¸ªæœåŠ¡æŒ‚äº†ï¼Œå°±ä¼šå¼•èµ·è¿é”ååº”ï¼Œå¯¼è‡´åˆ«çš„æœåŠ¡ä¹ŸæŒ‚ã€‚å¦‚æœç³»ç»Ÿå¤„äºé«˜å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œå¤§é‡è¯·æ±‚æ¶Œè¿‡æ¥çš„æ—¶å€™ï¼Œè®¢å•æœåŠ¡çš„100ä¸ªçº¿ç¨‹éƒ½ä¼šå¡åœ¨è¯·æ±‚ç§¯åˆ†æœåŠ¡è¿™å—ã€‚å¯¼è‡´è®¢å•æœåŠ¡æ²¡æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤„ç†è¯·æ±‚ï¼Œé€ æˆæœåŠ¡é›ªå´©é—®é¢˜ã€‚<br>
<code>Hystrix</code>æ˜¯éš”ç¦»ã€ç†”æ–­ä»¥åŠé™çº§çš„ä¸€ä¸ªæ¡†æ¶ã€‚è¯´ç™½äº†ï¼ŒHystrixä¼šæå¾ˆå¤šä¸ªå°å°çš„çº¿ç¨‹æ± ï¼Œæ¯”å¦‚è®¢å•æœåŠ¡è¯·æ±‚åº“å­˜æœåŠ¡æ˜¯ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè¯·æ±‚ä»“å‚¨æœåŠ¡æ˜¯ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè¯·æ±‚ç§¯åˆ†æœåŠ¡æ˜¯ä¸€ä¸ªçº¿ç¨‹æ± ã€‚æ¯ä¸ªçº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹å°±ä»…ä»…ç”¨äºè¯·æ±‚é‚£ä¸ªæœåŠ¡ã€‚<br>
å°±æ˜¯å¯¹è¯·æ±‚çš„å·²ç»æŒ‚äº†çš„æœåŠ¡ç›´æ¥è¿”å›é”™è¯¯ï¼Œä¸è¦å»èµ°ç½‘ç»œè¯·æ±‚å¡ä½å‡ ç§’é’Ÿï¼Œè¿™ä¸ªè¿‡ç¨‹ï¼Œå°±æ˜¯æ‰€è°“çš„ç†”æ–­ã€‚å’±ä¸å•å•åªæ˜¯ç›´æ¥è¿”å›é”™è¯¯ï¼Œè¿™æ ·ä¹Ÿæ²¡æœ‰å¤ªå¤§çš„æ„ä¹‰ï¼Œè¿˜è¦å¤„ç†ç‚¹ä»€ä¹ˆï¼Œæ¯”å¦‚ï¼Œåœ¨æ•°æ®åº“é‡Œå¢åŠ ä¸€æ¡è®°å½•ï¼Œè¯´ç»™æŸæŸç”¨æˆ·å¢åŠ äº†å¤šå°‘ç§¯åˆ†ï¼Œå› ä¸ºç§¯åˆ†æœåŠ¡æŒ‚äº†ï¼Œå¯¼è‡´æ²¡å¢åŠ æˆåŠŸï¼è¿™æ ·ç­‰ç§¯åˆ†æœåŠ¡æ¢å¤äº†ï¼Œä½ å¯ä»¥æ ¹æ®è¿™äº›è®°å½•æ‰‹å·¥åŠ ä¸€ä¸‹ç§¯åˆ†ã€‚è¿™ä¸ªè¿‡ç¨‹ï¼Œå°±æ˜¯æ‰€è°“çš„é™çº§ã€‚</p>
<h4 id="äº”ã€æœåŠ¡ç½‘å…³ï¼ˆZuulï¼‰">äº”ã€æœåŠ¡ç½‘å…³ï¼ˆZuulï¼‰</h4>
<p>ä¸€èˆ¬å¾®æœåŠ¡æ¶æ„ä¸­éƒ½å¿…ç„¶ä¼šè®¾è®¡ä¸€ä¸ªç½‘å…³åœ¨é‡Œé¢ï¼Œåƒandroidã€iosã€pcå‰ç«¯ã€å¾®ä¿¡å°ç¨‹åºã€H5ç­‰ç­‰ï¼Œä¸ç”¨å»å…³å¿ƒåç«¯æœ‰å‡ ç™¾ä¸ªæœåŠ¡ï¼Œå°±çŸ¥é“æœ‰ä¸€ä¸ªç½‘å…³ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½å¾€ç½‘å…³èµ°ï¼Œç½‘å…³ä¼šæ ¹æ®è¯·æ±‚ä¸­çš„ä¸€äº›ç‰¹å¾ï¼Œå°†è¯·æ±‚è½¬å‘ç»™åç«¯çš„å„ä¸ªæœåŠ¡ã€‚<br>
è€Œä¸”æœ‰ä¸€ä¸ªç½‘å…³ä¹‹åï¼Œè¿˜æœ‰å¾ˆå¤šå¥½å¤„ï¼Œæ¯”å¦‚å¯ä»¥åšç»Ÿä¸€çš„é™çº§ã€é™æµã€è®¤è¯æˆæƒã€å®‰å…¨ï¼Œç­‰ç­‰ã€‚</p>
<h4 id="å…­ã€æœåŠ¡é…ç½®ä¸­å¿ƒ-ï¼ˆSpring-Cloud-Configï¼‰">å…­ã€æœåŠ¡é…ç½®ä¸­å¿ƒ ï¼ˆSpring Cloud Configï¼‰</h4>
<p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”±äºæœåŠ¡æ•°é‡å·¨å¤šï¼Œä¸ºäº†æ–¹ä¾¿æœåŠ¡é…ç½®æ–‡ä»¶ç»Ÿä¸€ç®¡ç†ï¼Œå®æ—¶æ›´æ–°ï¼Œæ‰€ä»¥éœ€è¦åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒç»„ä»¶ã€‚åœ¨Spring Cloudä¸­ï¼Œæœ‰åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒç»„ä»¶spring cloud config ï¼Œå®ƒæ”¯æŒé…ç½®æœåŠ¡æ”¾åœ¨é…ç½®æœåŠ¡çš„å†…å­˜ä¸­ï¼ˆå³æœ¬åœ°ï¼‰ï¼Œä¹Ÿæ”¯æŒæ”¾åœ¨è¿œç¨‹Gitä»“åº“ä¸­ã€‚åœ¨spring cloud config ç»„ä»¶ä¸­ï¼Œåˆ†ä¸¤ä¸ªè§’è‰²ï¼Œä¸€æ˜¯config serverï¼ŒäºŒæ˜¯config clientã€‚</p>
<h4 id="ä¸ƒã€æœåŠ¡é“¾è·¯è¿½è¸ªï¼ˆSpring-Cloud-Sleuthï¼‰">ä¸ƒã€æœåŠ¡é“¾è·¯è¿½è¸ªï¼ˆSpring Cloud Sleuthï¼‰</h4>
<p><code>Spring Cloud Sleuth </code>ä¸»è¦åŠŸèƒ½å°±æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æä¾›è¿½è¸ªè§£å†³æ–¹æ¡ˆï¼Œå¹¶ä¸”å…¼å®¹æ”¯æŒäº† <code>Zipkin</code>ï¼Œä½ åªéœ€è¦åœ¨pomæ–‡ä»¶ä¸­å¼•å…¥ç›¸åº”çš„ä¾èµ–å³å¯ã€‚æœåŠ¡é—´ç›¸äº’è°ƒç”¨ï¼Œ<code>Zipkin</code>æ”¶é›†æ•°æ®.</p>
<h4 id="å…«ã€-æ¶ˆæ¯æ€»çº¿ï¼ˆSpring-Cloud-Busï¼‰">å…«ã€ æ¶ˆæ¯æ€»çº¿ï¼ˆSpring Cloud Busï¼‰</h4>
<p>Spring Cloud Bus å°†åˆ†å¸ƒå¼çš„èŠ‚ç‚¹ç”¨è½»é‡çš„æ¶ˆæ¯ä»£ç†è¿æ¥èµ·æ¥ã€‚å®ƒå¯ä»¥ç”¨äºå¹¿æ’­é…ç½®æ–‡ä»¶çš„æ›´æ”¹æˆ–è€…æœåŠ¡ä¹‹é—´çš„é€šè®¯ï¼Œä¹Ÿå¯ä»¥ç”¨äºç›‘æ§ã€‚ä¾‹å¦‚githubä¸Šçš„é…ç½®æ–‡ä»¶æœ‰æ›´æ–°æ—¶ï¼Œåªéœ€å‘é€è¯·æ±‚/bus/refresh/,å†è¯·æ±‚é…ç½®æ–‡ä»¶å‘ç°å†…å®¹å·²æ›´æ–°ã€‚</p>
<h4 id="ä¹ã€é«˜å¯ç”¨çš„æœåŠ¡ä¸­å¿ƒï¼šEurekaé€šè¿‡è¿è¡Œå¤šä¸ªå®ä¾‹ï¼Œä½¿å…¶æ›´å…·æœ‰é«˜å¯ç”¨æ€§ã€‚äº‹å®ä¸Šï¼Œè¿™æ˜¯å®ƒé»˜è®¤çš„ç†Ÿæ€§ï¼Œä½ éœ€è¦åšçš„å°±æ˜¯ç»™å¯¹ç­‰çš„å®ä¾‹ä¸€ä¸ªåˆæ³•çš„å…³è”serviceurlã€‚ç®€å•æ¥è¯´å°±æ˜¯å»ºå¤šä¸ªæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œå…·ä½“åšæ³•å°±æ˜¯å†™å¤šä¸ªapplication-xx-yml-æ”¹å˜etc-hostsï¼Œlinuxç³»ç»Ÿé€šè¿‡vim-etc-hosts-åŠ ä¸Šï¼š127-0-0-1-xx-127-0-0-1-yy-xx-yyå°±æ˜¯ä½ applicationçš„åç¼€å-windowsç”µè„‘ï¼Œåœ¨c-windows-systems-drivers-etc-hosts-ä¿®æ”¹ã€‚å¯åŠ¨å·¥ç¨‹ï¼š">ä¹ã€é«˜å¯ç”¨çš„æœåŠ¡ä¸­å¿ƒï¼šEurekaé€šè¿‡è¿è¡Œå¤šä¸ªå®ä¾‹ï¼Œä½¿å…¶æ›´å…·æœ‰é«˜å¯ç”¨æ€§ã€‚äº‹å®ä¸Šï¼Œè¿™æ˜¯å®ƒé»˜è®¤çš„ç†Ÿæ€§ï¼Œä½ éœ€è¦åšçš„å°±æ˜¯ç»™å¯¹ç­‰çš„å®ä¾‹ä¸€ä¸ªåˆæ³•çš„å…³è”serviceurlã€‚ç®€å•æ¥è¯´å°±æ˜¯å»ºå¤šä¸ªæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œå…·ä½“åšæ³•å°±æ˜¯å†™å¤šä¸ªapplication_xx.yml,æ”¹å˜etc/hostsï¼Œlinuxç³»ç»Ÿé€šè¿‡vim /etc/hosts ,åŠ ä¸Šï¼š127.0.0.1 xx , 127.0.0.1 yy(xx,yyå°±æ˜¯ä½ applicationçš„åç¼€å),windowsç”µè„‘ï¼Œåœ¨c:/windows/systems/drivers/etc/hosts ä¿®æ”¹ã€‚å¯åŠ¨å·¥ç¨‹ï¼š</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">java -jar eureka-server-0.0.1-SNAPSHOT.jar - -spring.profiles.active=xx</span><br><span class="line">java -jar eureka-server-0.0.1-SNAPSHOT.jar - -spring.profiles.active=yy</span><br></pre></td></tr></table></figure>
<p>Eureka-eserver xx ,Eureka-eserver yy ç›¸äº’æ„Ÿåº”ï¼Œå½“æœ‰æœåŠ¡æ³¨å†Œæ—¶ï¼Œä¸¤ä¸ªEureka-eserveræ˜¯å¯¹ç­‰çš„ï¼Œå®ƒä»¬éƒ½å­˜æœ‰ç›¸åŒçš„ä¿¡æ¯ã€‚è¿™å°±æ˜¯é€šè¿‡æœåŠ¡å™¨çš„å†—ä½™æ¥å¢åŠ å¯é æ€§ï¼Œå½“æœ‰ä¸€å°æœåŠ¡å™¨å®•æœºäº†ï¼ŒæœåŠ¡å¹¶ä¸ä¼šç»ˆæ­¢ï¼Œå› ä¸ºå¦ä¸€å°æœåŠ¡å­˜æœ‰ç›¸åŒçš„æ•°æ®ã€‚</p>
<h4 id="æ–­è·¯å™¨èšåˆç›‘æ§ï¼ˆHystrix-Turbineï¼‰">æ–­è·¯å™¨èšåˆç›‘æ§ï¼ˆHystrix Turbineï¼‰</h4>
<p>çœ‹å•ä¸ªçš„<code>Hystrix Dashboard</code>çš„æ•°æ®å¹¶æ²¡æœ‰ä»€ä¹ˆå¤šå¤§çš„ä»·å€¼ï¼Œè¦æƒ³çœ‹è¿™ä¸ªç³»ç»Ÿçš„Hystrix Dashboardæ•°æ®å°±éœ€è¦ç”¨åˆ°<code>Hystrix Turbine</code>ã€‚<code>Hystrix Turbine</code>å°†æ¯ä¸ªæœåŠ¡<code>Hystrix Dashboard</code>æ•°æ®è¿›è¡Œäº†æ•´åˆã€‚<code>Hystrix Turbine</code>çš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œåªéœ€è¦å¼•å…¥ç›¸åº”çš„ä¾èµ–å’ŒåŠ ä¸Šæ³¨è§£å’Œé…ç½®å°±å¯ä»¥äº†ã€‚</p>
<h4 id="ç½‘å…³ï¼ˆSpring-Cloud-Gatewayï¼‰">ç½‘å…³ï¼ˆSpring Cloud Gatewayï¼‰</h4>
<p><code>Spring Cloud Gateway</code>æ˜¯Spring Cloudå®˜æ–¹æ¨å‡ºçš„ç¬¬äºŒä»£ç½‘å…³æ¡†æ¶ï¼Œå–ä»£Zuulç½‘å…³ã€‚ç½‘å…³ä½œä¸ºæµé‡çš„ï¼Œåœ¨å¾®æœåŠ¡ç³»ç»Ÿä¸­æœ‰ç€éå¸¸ä½œç”¨ï¼Œç½‘å…³å¸¸è§çš„åŠŸèƒ½æœ‰è·¯ç”±è½¬å‘ã€æƒé™æ ¡éªŒã€é™æµæ§åˆ¶ç­‰ä½œç”¨ã€‚</p>
<h2 id="Tips">Tips</h2>
<ul>
<li>æ­å»ºspringcloudçš„modulesæ—¶ï¼Œçˆ¶æ¨¡å—æ‰“åŒ…æ–¹å¼æ˜¯pom,å­æ¨¡å—ä¸ºjar</li>
<li>çˆ¶æ¨¡å—ä¸éœ€è¦å¢åŠ æ„å»ºæ’ä»¶maven-pluginï¼Œå…¬å…±æ¨¡å—æå–å‡ºå•ç‹¬ä½œä¸ºä¸€ä¸ªmoduleæ—¶ï¼Œä¹Ÿä¸éœ€è¦maven-pluginï¼›å­æ¨¡å—ä½œä¸ºçˆ¶æ¨¡å—å…¶ä¸‹åˆæœ‰å­æ¨¡å—ï¼Œåˆ™è¿™ä¸ªå­æ¨¡å—ä¸éœ€è¦æ·»åŠ maven-plugin,æ‰“åŒ…æ–¹å¼ä¸ºpom,é™¤æ­¤ä¹‹å¤–,å…¶å®ƒå‡éœ€maven-plugin<br>
mavenç¤ºä¾‹è¯·æŸ¥é˜…<a href="">ä¸‹ç¯‡æ–‡ç« </a>ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>SpringCloud</category>
      </categories>
      <tags>
        <tag>SpringCloud</tag>
      </tags>
  </entry>
  <entry>
    <title>æå…‰æ¨é€æœåŠ¡ç«¯é›†æˆ</title>
    <url>/2019/08/30/jpush/</url>
    <content><![CDATA[<h2 id="å¼€ç¯‡">å¼€ç¯‡</h2>
<p>æœ‰ä¸å°‘å…¬å¸åœ¨é€‰æ‹©æ¨é€å¹³å°çš„æ—¶å€™éƒ½é€‰æ‹©äº†æå…‰æ¨é€ï¼ˆå¥½åƒç”¨å‹çš„ä¹Ÿä¸é”™ã€‚åªæ˜¯æ²¡ç”¨è¿‡ï¼‰ï¼Œä¹‹å‰æˆ‘ä¹Ÿåšè¿‡ä¸€ä¸ªphpæœåŠ¡ç«¯æå…‰æ¨é€çš„é›†æˆï¼Œä½†æ˜¯è¿™é‡Œæ˜µæˆ‘è¦è¯´çš„æ˜¯javaæœåŠ¡ç«¯çš„é›†æˆï¼Œåšè¿‡ä¸¤æ¬¡ï¼Œè¿™æ‰æƒ³èµ·æ¥æ•´ç†ä¸€ä¸‹ï¼Œä¾›ç»™æœ‰éœ€æ±‚çš„æœ‹å‹satisfied:ï¼Œè™½ç„¶æ²¡å‡ ä¸ªäººçœ‹ã€‚</p>
<h2 id="ä»£ç é›†æˆ">ä»£ç é›†æˆ</h2>
<p>åœ¨application.ymlé‡Œé…ç½®ä¸€ä¸‹jpushå¹³å°ä½ æ‰€åˆ›å»ºçš„åº”ç”¨çš„é…ç½®ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<a id="more"></a>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">jpush:</span><br><span class="line">  appKey: ########</span><br><span class="line">  masterSecret: ##################</span><br><span class="line">  apnsProduction: false   # æ˜¯å¦ç”Ÿäº§ç¯å¢ƒï¼Œtrueè¡¨ç¤ºç”Ÿäº§ç¯å¢ƒ</span><br></pre></td></tr></table></figure>
<p>JpushUtil.java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xy.goone.common.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.jiguang.common.resp.APIConnectionException;</span><br><span class="line"><span class="keyword">import</span> cn.jiguang.common.resp.APIRequestException;</span><br><span class="line"><span class="keyword">import</span> cn.jpush.api.JPushClient;</span><br><span class="line"><span class="keyword">import</span> cn.jpush.api.push.PushResult;</span><br><span class="line"><span class="keyword">import</span> cn.jpush.api.push.model.Message;</span><br><span class="line"><span class="keyword">import</span> cn.jpush.api.push.model.Options;</span><br><span class="line"><span class="keyword">import</span> cn.jpush.api.push.model.Platform;</span><br><span class="line"><span class="keyword">import</span> cn.jpush.api.push.model.PushPayload;</span><br><span class="line"><span class="keyword">import</span> cn.jpush.api.push.model.audience.Audience;</span><br><span class="line"><span class="keyword">import</span> cn.jpush.api.push.model.notification.AndroidNotification;</span><br><span class="line"><span class="keyword">import</span> cn.jpush.api.push.model.notification.IosAlert;</span><br><span class="line"><span class="keyword">import</span> cn.jpush.api.push.model.notification.IosNotification;</span><br><span class="line"><span class="keyword">import</span> cn.jpush.api.push.model.notification.Notification;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> fumei.jiang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019-08-13 13:45</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span> æå…‰æ¨é€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JPushUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;jpush.appKey&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String appKey;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;jpush.masterSecret&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String masterSecret;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;jpush.apnsProduction&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> apnsProduction;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JPushClient jPushClient = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RESPONSE_OK = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JPushClient <span class="title">getJPushClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (jPushClient == <span class="keyword">null</span>) &#123;</span><br><span class="line">            jPushClient = <span class="keyword">new</span> JPushClient(masterSecret, appKey);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> jPushClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¨é€åˆ°aliasåˆ—è¡¨</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> alias             åˆ«åæˆ–åˆ«åç»„</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> title é€šçŸ¥æ ‡é¢˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content   é€šçŸ¥å†…å®¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> extras        æ‰©å±•å­—æ®µ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PushPayload <span class="title">sendToAliasList</span><span class="params">(List&lt;String&gt; alias,String unique, String title, String content, Map&lt;String,String&gt; extras)</span> </span>&#123;</span><br><span class="line">        PushPayload pushPayload = buildPushObject_android_and_ios(Audience.alias(alias),unique,title, content, extras);</span><br><span class="line">        <span class="keyword">this</span>.sendPush(pushPayload);</span><br><span class="line">        <span class="keyword">return</span> pushPayload;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¨é€åˆ°tagåˆ—è¡¨</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tagsList          Tagæˆ–Tagç»„</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> title é€šçŸ¥æ ‡é¢˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content   é€šçŸ¥å†…å®¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> extras        æ‰©å±•å­—æ®µ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendToTagsList</span><span class="params">(List&lt;String&gt; tagsList, String unique, String title, String content, Map&lt;String,String&gt; extras)</span> </span>&#123;</span><br><span class="line">        PushPayload pushPayload = buildPushObject_android_and_ios(Audience.tag(tagsList),<span class="keyword">null</span>, title, content, extras);</span><br><span class="line">        <span class="keyword">this</span>.sendPush(pushPayload);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‘é€ç»™æ‰€æœ‰å®‰å“ç”¨æˆ·</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> notificationTitle é€šçŸ¥å†…å®¹æ ‡é¢˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msgTitle          æ¶ˆæ¯å†…å®¹æ ‡é¢˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msgContent        æ¶ˆæ¯å†…å®¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> extras            æ‰©å±•å­—æ®µ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendToAllAndroid</span><span class="params">(String notificationTitle, String msgTitle, String msgContent, String extras)</span> </span>&#123;</span><br><span class="line">        PushPayload pushPayload = buildPushObject_android_all_alertWithTitle(notificationTitle, msgTitle, msgContent, extras);</span><br><span class="line">        <span class="keyword">this</span>.sendPush(pushPayload);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‘é€ç»™æ‰€æœ‰IOSç”¨æˆ·</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> notificationTitle é€šçŸ¥å†…å®¹æ ‡é¢˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msgTitle          æ¶ˆæ¯å†…å®¹æ ‡é¢˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msgContent        æ¶ˆæ¯å†…å®¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> extras            æ‰©å±•å­—æ®µ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendToAllIOS</span><span class="params">(String notificationTitle, String msgTitle, String msgContent, String extras)</span> </span>&#123;</span><br><span class="line">        PushPayload pushPayload = buildPushObject_ios_all_alertWithTitle(notificationTitle, msgTitle, msgContent, extras);</span><br><span class="line">        <span class="keyword">this</span>.sendPush(pushPayload);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‘é€ç»™æ‰€æœ‰ç”¨æˆ·</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> title é€šçŸ¥æ ‡é¢˜</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content   é€šçŸ¥å†…å®¹</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> extras        æ‰©å±•å­—æ®µ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendToAll</span><span class="params">(String unique, String title, String content, Map&lt;String,String&gt; extras)</span> </span>&#123;</span><br><span class="line">        PushPayload pushPayload = buildPushObject_android_and_ios(Audience.all(),unique, title, content, extras);</span><br><span class="line">        <span class="keyword">this</span>.sendPush(pushPayload);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> PushResult <span class="title">sendPush</span><span class="params">(PushPayload pushPayload)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"pushPayload=&#123;&#125;"</span>, pushPayload);</span><br><span class="line">        PushResult pushResult = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            pushResult = <span class="keyword">this</span>.getJPushClient().sendPush(pushPayload);</span><br><span class="line">            log.info(<span class="string">""</span> + pushResult);</span><br><span class="line">            <span class="keyword">if</span> (pushResult.getResponseCode() == RESPONSE_OK) &#123;</span><br><span class="line">                log.info(<span class="string">"push successful, pushPayload=&#123;&#125;"</span>, pushPayload);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (APIConnectionException e) &#123;</span><br><span class="line">            log.error(<span class="string">"push failed: pushPayload=&#123;&#125;, exception=&#123;&#125;"</span>, pushPayload, e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (APIRequestException e) &#123;</span><br><span class="line">            log.error(<span class="string">"push failed: pushPayload=&#123;&#125;, exception=&#123;&#125;"</span>, pushPayload, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pushResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> filter</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> unique</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> title</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> extras</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PushPayload <span class="title">buildPushObject_android_and_ios</span><span class="params">(Audience filter,String unique, String title, String content, Map&lt;String,String&gt; extras)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> PushPayload.newBuilder()</span><br><span class="line">                .setCid(unique)</span><br><span class="line">                .setPlatform(Platform.android_ios())</span><br><span class="line">                .setAudience(filter)</span><br><span class="line">                .setNotification(Notification.newBuilder()</span><br><span class="line">                        .addPlatformNotification(AndroidNotification.newBuilder()</span><br><span class="line">                                .setTitle(title)</span><br><span class="line">                                .setAlert(content)</span><br><span class="line">                                <span class="comment">// æ­¤å­—æ®µä¸ºé€ä¼ å­—æ®µï¼Œä¸ä¼šæ˜¾ç¤ºåœ¨é€šçŸ¥æ ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡æ­¤å­—æ®µæ¥åšä¸€äº›å®šåˆ¶éœ€æ±‚ï¼Œå¦‚ç‰¹å®šçš„keyä¼ è¦æŒ‡å®šè·³è½¬çš„é¡µé¢ï¼ˆvalueï¼‰</span></span><br><span class="line">                                .addExtras(extras)</span><br><span class="line">                                .build()</span><br><span class="line">                        )</span><br><span class="line">                        .addPlatformNotification(IosNotification.newBuilder()</span><br><span class="line">                                <span class="comment">// ä¼ ä¸€ä¸ªIosAlertå¯¹è±¡ï¼ŒæŒ‡å®šapns titleã€titleã€subtitleç­‰</span></span><br><span class="line">                                .setAlert(IosAlert.newBuilder()</span><br><span class="line">                                        .setTitleAndBody(title, <span class="keyword">null</span>, content)</span><br><span class="line">                                        .build())</span><br><span class="line">                                <span class="comment">// ç›´æ¥ä¼ alert</span></span><br><span class="line">                                <span class="comment">// æ­¤é¡¹æ˜¯æŒ‡å®šæ­¤æ¨é€çš„badgeè‡ªåŠ¨åŠ 1</span></span><br><span class="line">                                .incrBadge(<span class="number">1</span>)</span><br><span class="line">                                <span class="comment">// æ­¤å­—æ®µçš„å€¼defaultè¡¨ç¤ºç³»ç»Ÿé»˜è®¤å£°éŸ³ï¼›ä¼ sound.cafè¡¨ç¤ºæ­¤æ¨é€ä»¥é¡¹ç›®é‡Œé¢æ‰“åŒ…çš„sound.cafå£°éŸ³æ¥æé†’ï¼Œ</span></span><br><span class="line">                                <span class="comment">// å¦‚æœç³»ç»Ÿæ²¡æœ‰æ­¤éŸ³é¢‘åˆ™ä»¥ç³»ç»Ÿé»˜è®¤å£°éŸ³æé†’ï¼›æ­¤å­—æ®µå¦‚æœä¼ ç©ºå­—ç¬¦ä¸²ï¼ŒiOS9åŠä»¥ä¸Šçš„ç³»ç»Ÿæ˜¯æ— å£°éŸ³æé†’ï¼Œä»¥ä¸‹çš„ç³»ç»Ÿæ˜¯é»˜è®¤å£°éŸ³</span></span><br><span class="line">                                .setSound(<span class="string">"default"</span>)</span><br><span class="line">                                <span class="comment">// æ­¤å­—æ®µä¸ºé€ä¼ å­—æ®µï¼Œä¸ä¼šæ˜¾ç¤ºåœ¨é€šçŸ¥æ ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡æ­¤å­—æ®µæ¥åšä¸€äº›å®šåˆ¶éœ€æ±‚ï¼Œå¦‚ç‰¹å®šçš„keyä¼ è¦æŒ‡å®šè·³è½¬çš„é¡µé¢ï¼ˆvalueï¼‰</span></span><br><span class="line">                                .addExtras(extras)</span><br><span class="line">                                <span class="comment">// æ­¤é¡¹è¯´æ˜æ­¤æ¨é€æ˜¯ä¸€ä¸ªbackgroundæ¨é€ï¼Œæƒ³äº†è§£backgroundçœ‹ï¼šhttp://docs.jpush.io/client/ios_tutorials/#ios-7-background-remote-notification</span></span><br><span class="line">                                <span class="comment">// .setContentAvailable(true)</span></span><br><span class="line">                                .build()</span><br><span class="line">                        )</span><br><span class="line">                        .build()</span><br><span class="line">                )</span><br><span class="line">                <span class="comment">// PlatformæŒ‡å®šäº†å“ªäº›å¹³å°å°±ä¼šåƒæŒ‡å®šå¹³å°ä¸­ç¬¦åˆæ¨é€æ¡ä»¶çš„è®¾å¤‡è¿›è¡Œæ¨é€ã€‚ jpushçš„è‡ªå®šä¹‰æ¶ˆæ¯ï¼Œ</span></span><br><span class="line">                <span class="comment">// sdké»˜è®¤ä¸åšä»»ä½•å¤„ç†ï¼Œä¸ä¼šæœ‰é€šçŸ¥æç¤ºã€‚å»ºè®®çœ‹æ–‡æ¡£http://docs.jpush.io/guideline/faq/çš„</span></span><br><span class="line">                <span class="comment">// [é€šçŸ¥ä¸è‡ªå®šä¹‰æ¶ˆæ¯æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ]äº†è§£é€šçŸ¥å’Œè‡ªå®šä¹‰æ¶ˆæ¯çš„åŒºåˆ«</span></span><br><span class="line">                .setOptions(Options.newBuilder()</span><br><span class="line">                        <span class="comment">// æ­¤å­—æ®µçš„å€¼æ˜¯ç”¨æ¥æŒ‡å®šæœ¬æ¨é€è¦æ¨é€çš„apnsç¯å¢ƒï¼Œfalseè¡¨ç¤ºå¼€å‘ï¼Œtrueè¡¨ç¤ºç”Ÿäº§ï¼›å¯¹androidå’Œè‡ªå®šä¹‰æ¶ˆæ¯æ— æ„ä¹‰</span></span><br><span class="line">                        .setApnsProduction(apnsProduction)</span><br><span class="line">                        <span class="comment">// æ­¤å­—æ®µæ˜¯ç»™å¼€å‘è€…è‡ªå·±ç»™æ¨é€ç¼–å·ï¼Œæ–¹ä¾¿æ¨é€è€…åˆ†è¾¨æ¨é€è®°å½•</span></span><br><span class="line">                        .setSendno(<span class="number">1</span>)</span><br><span class="line">                        <span class="comment">// æ­¤å­—æ®µçš„å€¼æ˜¯ç”¨æ¥æŒ‡å®šæœ¬æ¨é€çš„ç¦»çº¿ä¿å­˜æ—¶é•¿ï¼Œå¦‚æœä¸ä¼ æ­¤å­—æ®µåˆ™é»˜è®¤ä¿å­˜ä¸€å¤©ï¼Œæœ€å¤šæŒ‡å®šä¿ç•™åå¤©ï¼Œå•ä½ä¸ºç§’</span></span><br><span class="line">                        .setTimeToLive(<span class="number">86400</span>)</span><br><span class="line">                        .build())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‘androidå¹³å°æ‰€æœ‰ç”¨æˆ·æ¨é€æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> notificationTitle</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msgTitle</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msgContent</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> extras</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> PushPayload <span class="title">buildPushObject_android_all_alertWithTitle</span><span class="params">(String notificationTitle, String msgTitle, String msgContent, String extras)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> PushPayload.newBuilder()</span><br><span class="line">                <span class="comment">// æŒ‡å®šè¦æ¨é€çš„å¹³å°ï¼Œallä»£è¡¨å½“å‰åº”ç”¨é…ç½®äº†çš„æ‰€æœ‰å¹³å°ï¼Œä¹Ÿå¯ä»¥ä¼ androidç­‰å…·ä½“å¹³å°</span></span><br><span class="line">                .setPlatform(Platform.android())</span><br><span class="line">                <span class="comment">// æŒ‡å®šæ¨é€çš„æ¥æ”¶å¯¹è±¡ï¼Œallä»£è¡¨æ‰€æœ‰äººï¼Œä¹Ÿå¯ä»¥æŒ‡å®šå·²ç»è®¾ç½®æˆåŠŸçš„tagæˆ–aliasæˆ–è¯¥åº”åº”ç”¨å®¢æˆ·ç«¯è°ƒç”¨æ¥å£è·å–åˆ°çš„registration id</span></span><br><span class="line">                .setAudience(Audience.all())</span><br><span class="line">                <span class="comment">// jpushçš„é€šçŸ¥ï¼Œandroidçš„ç”±jpushç›´æ¥ä¸‹å‘ï¼ŒiOSçš„ç”±apnsæœåŠ¡å™¨ä¸‹å‘ï¼ŒWinphoneçš„ç”±mpnsä¸‹å‘</span></span><br><span class="line">                .setNotification(Notification.newBuilder()</span><br><span class="line">                        <span class="comment">// æŒ‡å®šå½“å‰æ¨é€çš„androidé€šçŸ¥</span></span><br><span class="line">                        .addPlatformNotification(AndroidNotification.newBuilder()</span><br><span class="line">                                .setAlert(notificationTitle)</span><br><span class="line">                                .setTitle(notificationTitle)</span><br><span class="line">                                <span class="comment">// æ­¤å­—æ®µä¸ºé€ä¼ å­—æ®µï¼Œä¸ä¼šæ˜¾ç¤ºåœ¨é€šçŸ¥æ ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡æ­¤å­—æ®µæ¥åšä¸€äº›å®šåˆ¶éœ€æ±‚ï¼Œå¦‚ç‰¹å®šçš„keyä¼ è¦æŒ‡å®šè·³è½¬çš„é¡µé¢ï¼ˆvalueï¼‰</span></span><br><span class="line">                                .addExtra(<span class="string">"androidNotification extras key"</span>, extras)</span><br><span class="line">                                .build())</span><br><span class="line">                        .build()</span><br><span class="line">                )</span><br><span class="line">                <span class="comment">// PlatformæŒ‡å®šäº†å“ªäº›å¹³å°å°±ä¼šåƒæŒ‡å®šå¹³å°ä¸­ç¬¦åˆæ¨é€æ¡ä»¶çš„è®¾å¤‡è¿›è¡Œæ¨é€ã€‚ jpushçš„è‡ªå®šä¹‰æ¶ˆæ¯ï¼Œ</span></span><br><span class="line">                <span class="comment">// sdké»˜è®¤ä¸åšä»»ä½•å¤„ç†ï¼Œä¸ä¼šæœ‰é€šçŸ¥æç¤ºã€‚å»ºè®®çœ‹æ–‡æ¡£http://docs.jpush.io/guideline/faq/çš„</span></span><br><span class="line">                <span class="comment">// [é€šçŸ¥ä¸è‡ªå®šä¹‰æ¶ˆæ¯æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ]äº†è§£é€šçŸ¥å’Œè‡ªå®šä¹‰æ¶ˆæ¯çš„åŒºåˆ«</span></span><br><span class="line">                .setMessage(Message.newBuilder()</span><br><span class="line">                        .setMsgContent(msgContent)</span><br><span class="line">                        .setTitle(msgTitle)</span><br><span class="line">                        .addExtra(<span class="string">"message extras key"</span>, extras)</span><br><span class="line">                        .build())</span><br><span class="line"></span><br><span class="line">                .setOptions(Options.newBuilder()</span><br><span class="line">                        <span class="comment">// æ­¤å­—æ®µçš„å€¼æ˜¯ç”¨æ¥æŒ‡å®šæœ¬æ¨é€è¦æ¨é€çš„apnsç¯å¢ƒï¼Œfalseè¡¨ç¤ºå¼€å‘ï¼Œtrueè¡¨ç¤ºç”Ÿäº§ï¼›å¯¹androidå’Œè‡ªå®šä¹‰æ¶ˆæ¯æ— æ„ä¹‰</span></span><br><span class="line">                        .setApnsProduction(apnsProduction)</span><br><span class="line">                        <span class="comment">// æ­¤å­—æ®µæ˜¯ç»™å¼€å‘è€…è‡ªå·±ç»™æ¨é€ç¼–å·ï¼Œæ–¹ä¾¿æ¨é€è€…åˆ†è¾¨æ¨é€è®°å½•</span></span><br><span class="line">                        .setSendno(<span class="number">1</span>)</span><br><span class="line">                        <span class="comment">// æ­¤å­—æ®µçš„å€¼æ˜¯ç”¨æ¥æŒ‡å®šæœ¬æ¨é€çš„ç¦»çº¿ä¿å­˜æ—¶é•¿ï¼Œå¦‚æœä¸ä¼ æ­¤å­—æ®µåˆ™é»˜è®¤ä¿å­˜ä¸€å¤©ï¼Œæœ€å¤šæŒ‡å®šä¿ç•™åå¤©ï¼Œå•ä½ä¸ºç§’</span></span><br><span class="line">                        .setTimeToLive(<span class="number">86400</span>)</span><br><span class="line">                        .build())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å‘ioså¹³å°æ‰€æœ‰ç”¨æˆ·æ¨é€æ¶ˆæ¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> notificationTitle</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msgTitle</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> msgContent</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> extras</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> PushPayload <span class="title">buildPushObject_ios_all_alertWithTitle</span><span class="params">(String notificationTitle, String msgTitle, String msgContent, String extras)</span> </span>&#123;</span><br><span class="line">        PushPayload.Builder load = PushPayload.newBuilder()</span><br><span class="line">                <span class="comment">// æŒ‡å®šè¦æ¨é€çš„å¹³å°ï¼Œallä»£è¡¨å½“å‰åº”ç”¨é…ç½®äº†çš„æ‰€æœ‰å¹³å°ï¼Œä¹Ÿå¯ä»¥ä¼ androidç­‰å…·ä½“å¹³å°</span></span><br><span class="line">                .setPlatform(Platform.ios())</span><br><span class="line">                <span class="comment">// æŒ‡å®šæ¨é€çš„æ¥æ”¶å¯¹è±¡ï¼Œallä»£è¡¨æ‰€æœ‰äººï¼Œä¹Ÿå¯ä»¥æŒ‡å®šå·²ç»è®¾ç½®æˆåŠŸçš„tagæˆ–aliasæˆ–è¯¥åº”åº”ç”¨å®¢æˆ·ç«¯è°ƒç”¨æ¥å£è·å–åˆ°çš„registration id</span></span><br><span class="line">                .setAudience(Audience.all())</span><br><span class="line">                <span class="comment">// jpushçš„é€šçŸ¥ï¼Œandroidçš„ç”±jpushç›´æ¥ä¸‹å‘ï¼ŒiOSçš„ç”±apnsæœåŠ¡å™¨ä¸‹å‘ï¼ŒWinphoneçš„ç”±mpnsä¸‹å‘</span></span><br><span class="line">                .setNotification(Notification.newBuilder()</span><br><span class="line">                        <span class="comment">// æŒ‡å®šå½“å‰æ¨é€çš„androidé€šçŸ¥</span></span><br><span class="line">                        .addPlatformNotification(IosNotification.newBuilder()</span><br><span class="line">                                <span class="comment">// ä¼ ä¸€ä¸ªIosAlertå¯¹è±¡ï¼ŒæŒ‡å®šapns titleã€titleã€subtitleç­‰</span></span><br><span class="line">                                .setAlert(notificationTitle)</span><br><span class="line">                                <span class="comment">// ç›´æ¥ä¼ alert</span></span><br><span class="line">                                <span class="comment">// æ­¤é¡¹æ˜¯æŒ‡å®šæ­¤æ¨é€çš„badgeè‡ªåŠ¨åŠ 1</span></span><br><span class="line">                                .incrBadge(<span class="number">1</span>)</span><br><span class="line">                                <span class="comment">// æ­¤å­—æ®µçš„å€¼defaultè¡¨ç¤ºç³»ç»Ÿé»˜è®¤å£°éŸ³ï¼›ä¼ sound.cafè¡¨ç¤ºæ­¤æ¨é€ä»¥é¡¹ç›®é‡Œé¢æ‰“åŒ…çš„sound.cafå£°éŸ³æ¥æé†’ï¼Œ</span></span><br><span class="line">                                <span class="comment">// å¦‚æœç³»ç»Ÿæ²¡æœ‰æ­¤éŸ³é¢‘åˆ™ä»¥ç³»ç»Ÿé»˜è®¤å£°éŸ³æé†’ï¼›æ­¤å­—æ®µå¦‚æœä¼ ç©ºå­—ç¬¦ä¸²ï¼ŒiOS9åŠä»¥ä¸Šçš„ç³»ç»Ÿæ˜¯æ— å£°éŸ³æé†’ï¼Œä»¥ä¸‹çš„ç³»ç»Ÿæ˜¯é»˜è®¤å£°éŸ³</span></span><br><span class="line">                                .setSound(<span class="string">"default"</span>)</span><br><span class="line">                                <span class="comment">// æ­¤å­—æ®µä¸ºé€ä¼ å­—æ®µï¼Œä¸ä¼šæ˜¾ç¤ºåœ¨é€šçŸ¥æ ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡æ­¤å­—æ®µæ¥åšä¸€äº›å®šåˆ¶éœ€æ±‚ï¼Œå¦‚ç‰¹å®šçš„keyä¼ è¦æŒ‡å®šè·³è½¬çš„é¡µé¢ï¼ˆvalueï¼‰</span></span><br><span class="line">                                .addExtra(<span class="string">"extras"</span>, extras)</span><br><span class="line">                                <span class="comment">// æ­¤é¡¹è¯´æ˜æ­¤æ¨é€æ˜¯ä¸€ä¸ªbackgroundæ¨é€ï¼Œæƒ³äº†è§£backgroundçœ‹ï¼šhttp://docs.jpush.io/client/ios_tutorials/#ios-7-background-remote-notification</span></span><br><span class="line">                                <span class="comment">// .setContentAvailable(true)</span></span><br><span class="line">                                .build())</span><br><span class="line">                        .build()</span><br><span class="line">                );</span><br><span class="line">        <span class="comment">// PlatformæŒ‡å®šäº†å“ªäº›å¹³å°å°±ä¼šåƒæŒ‡å®šå¹³å°ä¸­ç¬¦åˆæ¨é€æ¡ä»¶çš„è®¾å¤‡è¿›è¡Œæ¨é€ã€‚ jpushçš„è‡ªå®šä¹‰æ¶ˆæ¯ï¼Œ</span></span><br><span class="line">        <span class="comment">// sdké»˜è®¤ä¸åšä»»ä½•å¤„ç†ï¼Œä¸ä¼šæœ‰é€šçŸ¥æç¤ºã€‚å»ºè®®çœ‹æ–‡æ¡£http://docs.jpush.io/guideline/faq/çš„</span></span><br><span class="line">        <span class="comment">// [é€šçŸ¥ä¸è‡ªå®šä¹‰æ¶ˆæ¯æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ]äº†è§£é€šçŸ¥å’Œè‡ªå®šä¹‰æ¶ˆæ¯çš„åŒºåˆ«</span></span><br><span class="line">        load.setMessage(Message.newBuilder()</span><br><span class="line">                .setTitle(msgTitle)</span><br><span class="line">                .setMsgContent(msgContent)</span><br><span class="line">                .addExtra(<span class="string">"extras"</span>, extras)</span><br><span class="line">                .build())</span><br><span class="line">                .setOptions(Options.newBuilder()</span><br><span class="line">                        <span class="comment">// æ­¤å­—æ®µçš„å€¼æ˜¯ç”¨æ¥æŒ‡å®šæœ¬æ¨é€è¦æ¨é€çš„apnsç¯å¢ƒï¼Œfalseè¡¨ç¤ºå¼€å‘ï¼Œtrueè¡¨ç¤ºç”Ÿäº§;å¦‚æœä¸æ˜¾å¼è®¾ç½®çš„è¯ï¼ŒLibrary ä¼šé»˜è®¤æŒ‡å®šä¸ºå¼€å‘;å¯¹androidå’Œè‡ªå®šä¹‰æ¶ˆæ¯æ— æ„ä¹‰</span></span><br><span class="line">                        .setApnsProduction(apnsProduction)</span><br><span class="line">                        <span class="comment">// æ­¤å­—æ®µæ˜¯ç»™å¼€å‘è€…è‡ªå·±ç»™æ¨é€ç¼–å·ï¼Œæ–¹ä¾¿æ¨é€è€…åˆ†è¾¨æ¨é€è®°å½•</span></span><br><span class="line">                        .setSendno(<span class="number">1</span>)</span><br><span class="line">                        <span class="comment">// æ­¤å­—æ®µçš„å€¼æ˜¯ç”¨æ¥æŒ‡å®šæœ¬æ¨é€çš„ç¦»çº¿ä¿å­˜æ—¶é•¿ï¼Œå¦‚æœä¸ä¼ æ­¤å­—æ®µåˆ™é»˜è®¤ä¿å­˜ä¸€å¤©ï¼Œæœ€å¤šæŒ‡å®šä¿ç•™åå¤©ï¼Œå•ä½ä¸ºç§’</span></span><br><span class="line">                        .setTimeToLive(<span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>) <span class="comment">// 1å¤©</span></span><br><span class="line">                        .build());</span><br><span class="line">        <span class="keyword">return</span> load.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>ç¬¬ä¸‰æ–¹</category>
      </categories>
      <tags>
        <tag>ç¬¬ä¸‰æ–¹</tag>
        <tag>JPush</tag>
      </tags>
  </entry>
  <entry>
    <title>å‡½æ•°å’Œæ–¹æ³•</title>
    <url>/2019/07/15/java8-method/</url>
    <content><![CDATA[<h1>Javaä¸­çš„å‡½æ•°</h1>
<h2 id="æ–¹æ³•å¼•ç”¨">æ–¹æ³•å¼•ç”¨:</h2>
<p>æ¯”æ–¹è¯´ï¼Œä½ æƒ³è¦ç­›é€‰ä¸€ä¸ªç›®å½•ä¸­çš„æ‰€æœ‰éšè—æ–‡ä»¶ã€‚ä½ éœ€è¦ç¼–å†™ä¸€ä¸ªæ–¹æ³•ï¼Œç„¶åç»™å®ƒä¸€ä¸ª<code>File</code>ï¼Œå®ƒå°±ä¼šå‘Šè¯‰ä½ æ–‡ä»¶æ˜¯ä¸æ˜¯éšè—çš„ã€‚å¹¸å¥½ï¼ŒFileç±»é‡Œé¢æœ‰ä¸€ä¸ªå«ä½œ<code>isHidden</code>çš„æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå®ƒçœ‹ä½œä¸€ä¸ªå‡½æ•°ï¼Œæ¥å—ä¸€ä¸ª<code>File</code>ï¼Œè¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ã€‚ä½†è¦ç”¨å®ƒåšç­›é€‰ï¼Œä½ éœ€è¦æŠŠå®ƒåŒ…åœ¨ä¸€ä¸ª<code>FileFilter</code>å¯¹è±¡é‡Œï¼Œç„¶åä¼ é€’ç»™<code>File.listFiles</code>æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">File[] hiddenFiles = <span class="keyword">new</span> File(<span class="string">"."</span>).listFiles(<span class="keyword">new</span> FileFilter() &#123; </span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File file)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> file.isHidden(); </span><br><span class="line"> &#125; </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>æˆ‘ä»¬å·²ç»æœ‰ä¸€ä¸ªæ–¹æ³•isHiddenå¯ä»¥ä½¿ç”¨ï¼Œä¸ºä»€ä¹ˆéå¾—æŠŠå®ƒåŒ…åœ¨ä¸€ä¸ªå•°å—¦çš„FileFilterç±»é‡Œé¢å†å®ä¾‹åŒ–å‘¢ï¼Ÿå› ä¸ºåœ¨Java 8ä¹‹å‰ä½ å¿…é¡»è¿™ä¹ˆåšï¼å¦‚ä»Šåœ¨Java 8é‡Œï¼Œä½ å¯ä»¥æŠŠä»£ç é‡å†™æˆè¿™ä¸ªæ ·å­ï¼š<br>
<code>File[] hiddenFiles = new File(&quot;.&quot;).listFiles(File::isHidden);</code><br>
ä½ å·²ç»æœ‰äº†å‡½æ•°isHiddenï¼Œå› æ­¤åªéœ€ç”¨Java 8çš„æ–¹æ³•å¼•ç”¨::è¯­æ³•ï¼ˆå³â€œæŠŠè¿™ä¸ªæ–¹æ³•ä½œä¸ºå€¼â€ï¼‰å°†å…¶ä¼ ç»™listFilesæ–¹æ³•ï¼›è¯·æ³¨æ„ï¼Œæˆ‘ä»¬ä¹Ÿå¼€å§‹ç”¨å‡½æ•°ä»£è¡¨æ–¹æ³•äº†ã€‚ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œä½ çš„ä»£ç ç°åœ¨è¯»èµ·æ¥æ›´æ¥è¿‘é—®é¢˜çš„é™ˆè¿°äº†ã€‚æ–¹æ³•ä¸å†æ˜¯äºŒç­‰å€¼äº†ã€‚ä¸ç”¨å¯¹è±¡å¼•ç”¨ä¼ é€’å¯¹è±¡ç±»ä¼¼ï¼ˆå¯¹è±¡å¼•ç”¨æ˜¯ç”¨newåˆ›å»ºçš„ï¼‰ï¼Œåœ¨<code>Java 8</code>é‡Œå†™ä¸‹ <code>File::isHidden</code> çš„æ—¶å€™ï¼Œä½ å°±åˆ›å»ºäº†ä¸€ä¸ªæ–¹æ³•å¼•ç”¨ï¼Œä½ åŒæ ·å¯ä»¥ä¼ é€’å®ƒã€‚</p>
<h2 id="Lambdaâ€”â€”åŒ¿åå‡½æ•°">Lambdaâ€”â€”åŒ¿åå‡½æ•°</h2>
<p>å‡è®¾ä½ æœ‰ä¸€ä¸ªAppleç±»ï¼Œå®ƒæœ‰ä¸€ä¸ªgetColoræ–¹æ³•ï¼Œè¿˜æœ‰ä¸€ä¸ªå˜é‡inventoryä¿å­˜ç€ä¸€ä¸ªApplesçš„åˆ—è¡¨ã€‚ä½ å¯èƒ½æƒ³è¦é€‰å‡ºæ‰€æœ‰çš„ç»¿è‹¹æœï¼Œå¹¶è¿”å›ä¸€ä¸ªåˆ—è¡¨ã€‚é€šå¸¸æˆ‘ä»¬ç”¨ç­›é€‰ï¼ˆfilterï¼‰ä¸€è¯æ¥è¡¨è¾¾è¿™ä¸ªæ¦‚å¿µã€‚åœ¨Java 8ä¹‹å‰ï¼Œä½ å¯èƒ½ä¼šå†™è¿™æ ·ä¸€ä¸ªæ–¹æ³•<code>filterGreenApples</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Apple&gt; <span class="title">filterGreenApples</span><span class="params">(List&lt;Apple&gt; inventory)</span></span>&#123; </span><br><span class="line">    List&lt;Apple&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(); </span><br><span class="line">    <span class="keyword">for</span> (Apple apple: inventory)&#123; </span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"green"</span>.equals(apple.getColor())) &#123;</span><br><span class="line">            result.add(apple); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> result; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯æ¥ä¸‹æ¥ï¼Œæœ‰äººå¯èƒ½æƒ³è¦é€‰å‡ºé‡çš„è‹¹æœï¼Œæ¯”å¦‚è¶…è¿‡150å…‹ï¼Œäºæ˜¯ä½ å¿ƒæƒ…æ²‰é‡åœ°å†™äº†ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼Œç”šè‡³ç”¨äº†å¤åˆ¶ç²˜è´´ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Apple&gt; <span class="title">filterHeavyApples</span><span class="params">(List&lt;Apple&gt; inventory)</span></span>&#123; </span><br><span class="line">    List&lt;Apple&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(); </span><br><span class="line">    <span class="keyword">for</span> (Apple apple: inventory)&#123; </span><br><span class="line">        <span class="keyword">if</span> (apple.getWeight() &gt; <span class="number">150</span>) &#123; </span><br><span class="line">            result.add(apple); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> result; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å˜¿ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•åªæœ‰ä¸€è¡Œä¸åŒï¼šifé‡Œé¢é«˜äº®çš„é‚£è¡Œæ¡ä»¶ã€‚å¦‚æœè¿™ä¸¤ä¸ªé«˜äº®çš„æ–¹æ³•ä¹‹é—´çš„å·®å¼‚ä»…ä»…æ˜¯æ¥å—çš„é‡é‡èŒƒå›´ä¸åŒï¼Œé‚£ä¹ˆä½ åªè¦æŠŠæ¥å—çš„é‡é‡ä¸Šä¸‹é™ä½œä¸ºå‚æ•°ä¼ é€’ç»™filterå°±è¡Œäº†ï¼Œæ¯”å¦‚æŒ‡å®š(150, 1000)æ¥é€‰å‡ºé‡çš„è‹¹æœï¼ˆè¶…è¿‡150å…‹ï¼‰ï¼Œæˆ–è€…æŒ‡å®š(0, 80)æ¥é€‰å‡ºè½»çš„è‹¹æœï¼ˆä½äº80å…‹ï¼‰ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å‰é¢æè¿‡äº†ï¼ŒJava 8ä¼šæŠŠæ¡ä»¶ä»£ç ä½œä¸ºå‚æ•°ä¼ é€’è¿›å»ï¼Œè¿™æ ·å¯ä»¥é¿å…filteræ–¹æ³•å‡ºç°é‡å¤çš„ä»£ç ã€‚ç°åœ¨ä½ å¯ä»¥å†™ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isGreenApple</span><span class="params">(Apple apple)</span> </span>&#123; </span><br><span class="line"> <span class="keyword">return</span> <span class="string">"green"</span>.equals(apple.getColor());</span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isHeavyApple</span><span class="params">(Apple apple)</span> </span>&#123; </span><br><span class="line"> <span class="keyword">return</span> apple.getWeight() &gt; <span class="number">150</span>;</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Predicate</span>&lt;<span class="title">T</span>&gt;</span>&#123; </span><br><span class="line"> <span class="function"><span class="keyword">boolean</span> <span class="title">test</span><span class="params">(T t)</span></span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="function"><span class="keyword">static</span> List&lt;Apple&gt; <span class="title">filterApples</span><span class="params">(List&lt;Apple&gt; inventory, Predicate&lt;Apple&gt; p)</span> </span>&#123;</span><br><span class="line">    List&lt;Apple&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;(); </span><br><span class="line">    <span class="keyword">for</span> (Apple apple: inventory)&#123; </span><br><span class="line">        <span class="keyword">if</span> (p.test(apple)) &#123; </span><br><span class="line">            result.add(apple); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> result; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¦ç”¨å®ƒçš„è¯ï¼Œä½ å¯ä»¥å†™ï¼š<code>filterApples(inventory, Apple::isGreenApple)</code>; æˆ–è€…<code>filterApples(inventory, Apple::isHeavyApple)</code>;</p>
<p><strong>ä»€ä¹ˆæ˜¯è°“è¯ï¼Ÿå‰é¢çš„ä»£ç ä¼ é€’äº†æ–¹æ³• Apple::isGreenApple ï¼ˆå®ƒæ¥å—å‚æ•° Apple å¹¶è¿”å›ä¸€ä¸ªbooleanï¼‰ç»™filterApplesï¼Œåè€…åˆ™å¸Œæœ›æ¥å—ä¸€ä¸ªPredicate<Apple>å‚æ•°ã€‚è°“è¯ï¼ˆpredicateï¼‰åœ¨æ•°å­¦ä¸Šå¸¸å¸¸ç”¨æ¥ä»£è¡¨ä¸€ä¸ªç±»ä¼¼å‡½æ•°çš„ä¸œè¥¿ï¼Œå®ƒæ¥å—ä¸€ä¸ªå‚æ•°å€¼ï¼Œå¹¶è¿”å›trueæˆ–falseã€‚ä½ åœ¨åé¢ä¼šçœ‹åˆ°ï¼ŒJava 8ä¹Ÿä¼šå…è®¸ä½ å†™Function&lt;Apple,Boolean&gt;â€”â€”åœ¨å­¦æ ¡å­¦è¿‡å‡½æ•°å´æ²¡å­¦è¿‡è°“è¯çš„è¯»è€…å¯¹æ­¤å¯èƒ½æ›´ç†Ÿæ‚‰ï¼Œä½†ç”¨Predicate<Apple>æ˜¯æ›´æ ‡å‡†çš„æ–¹å¼ï¼Œæ•ˆç‡ä¹Ÿä¼šæ›´é«˜ä¸€ç‚¹å„¿ï¼Œè¿™é¿å…äº†æŠŠbooleanå°è£…åœ¨Booleané‡Œé¢ã€‚</strong></p>
<h2 id="ä»ä¼ é€’æ–¹æ³•åˆ°-Lambda">ä»ä¼ é€’æ–¹æ³•åˆ° Lambda</h2>
<p>æŠŠæ–¹æ³•ä½œä¸ºå€¼æ¥ä¼ é€’æ˜¾ç„¶å¾ˆæœ‰ç”¨ï¼Œä½†è¦æ˜¯ä¸ºç±»ä¼¼äºisHeavyAppleå’ŒisGreenAppleè¿™ç§å¯èƒ½åªç”¨ä¸€ä¸¤æ¬¡çš„çŸ­æ–¹æ³•å†™ä¸€å †å®šä¹‰æœ‰ç‚¹å„¿çƒ¦äººã€‚ä¸è¿‡Java 8ä¹Ÿè§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå®ƒå¼•å…¥äº†ä¸€å¥—æ–°è®°æ³•ï¼ˆåŒ¿åå‡½æ•°æˆ–Lambdaï¼‰ï¼Œè®©ä½ å¯ä»¥å†™<br>
<code>filterApples(inventory, (Apple a) -&gt; &quot;green&quot;.equals(a.getColor()) )</code>;<br>
æˆ–è€…<br>
<code>filterApples(inventory, (Apple a) -&gt; a.getWeight() &gt; 150 )</code>;<br>
ç”šè‡³<br>
<code>filterApples(inventory, (Apple a) -&gt; a.getWeight() &lt; 80 || &quot;brown&quot;.equals(a.getColor()) )</code>;<br>
æ‰€ä»¥ï¼Œä½ ç”šè‡³éƒ½ä¸éœ€è¦ä¸ºåªç”¨ä¸€æ¬¡çš„æ–¹æ³•å†™å®šä¹‰ï¼›ä»£ç æ›´å¹²å‡€ã€æ›´æ¸…æ™°ï¼Œå› ä¸ºä½ ç”¨ä¸ç€å»æ‰¾è‡ªå·±åˆ°åº•ä¼ é€’äº†ä»€ä¹ˆä»£ç ã€‚<strong>ä½†è¦æ˜¯Lambdaçš„é•¿åº¦å¤šäºå‡ è¡Œï¼Œè¿˜æ˜¯åº”è¯¥ç”¨æ–¹æ³•å¼•ç”¨æ¥æŒ‡å‘ä¸€ä¸ªæœ‰æè¿°æ€§åç§°çš„æ–¹æ³•ï¼Œè€Œä¸æ˜¯ä½¿ç”¨åŒ¿åLambda,åº”è¯¥ä»¥ä»£ç æ¸…æ™°ä¸ºå‡†ç»³.</strong></p>
]]></content>
      <categories>
        <category>Java</category>
        <category>Java8æ–°ç‰¹æ€§</category>
      </categories>
      <tags>
        <tag>Java8æ–°ç‰¹æ€§</tag>
      </tags>
  </entry>
  <entry>
    <title>æµ</title>
    <url>/2019/07/15/java8-stream/</url>
    <content><![CDATA[<h1>æµ(1)</h1>
<p>å‡ ä¹æ¯ä¸ªJavaåº”ç”¨éƒ½ä¼šåˆ¶é€ å’Œå¤„ç†é›†åˆã€‚ä½†é›†åˆç”¨èµ·æ¥å¹¶ä¸æ€»æ˜¯é‚£ä¹ˆç†æƒ³ã€‚æ¯”æ–¹è¯´ï¼Œä½ éœ€è¦ä»ä¸€ä¸ªåˆ—è¡¨ä¸­ç­›é€‰é‡‘é¢è¾ƒé«˜çš„äº¤æ˜“ï¼Œç„¶åæŒ‰è´§å¸åˆ†ç»„ã€‚ä½ éœ€è¦å†™ä¸€å¤§å †å¥—è·¯åŒ–çš„ä»£ç æ¥å®ç°è¿™ä¸ªæ•°æ®å¤„ç†å‘½ä»¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;Currency, List&lt;Transaction&gt;&gt; transactionsByCurrencies = <span class="keyword">new</span> HashMap&lt;&gt;(); </span><br><span class="line"><span class="keyword">for</span> (Transaction transaction : transactions) &#123; </span><br><span class="line">        <span class="keyword">if</span>(transaction.getPrice() &gt; <span class="number">1000</span>)&#123; </span><br><span class="line">            Currency currency = transaction.getCurrency(); </span><br><span class="line">            List&lt;Transaction&gt; transactionsForCurrency = transactionsByCurrencies.get(currency); </span><br><span class="line">            <span class="keyword">if</span> (transactionsForCurrency == <span class="keyword">null</span>) &#123; </span><br><span class="line">                transactionsForCurrency = <span class="keyword">new</span> ArrayList&lt;&gt;(); </span><br><span class="line">                transactionsByCurrencies.put(currency, transactionsForCurrency); </span><br><span class="line">            &#125; </span><br><span class="line">        transactionsForCurrency.add(transaction); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>æ­¤å¤–ï¼Œæˆ‘ä»¬å¾ˆéš¾ä¸€çœ¼çœ‹å‡ºæ¥è¿™äº›ä»£ç æ˜¯åšä»€ä¹ˆçš„ï¼Œå› ä¸ºæœ‰å¥½å‡ ä¸ªåµŒå¥—çš„æ§åˆ¶æµæŒ‡ä»¤ã€‚æœ‰äº†<code>Stream API</code>ï¼Œä½ ç°åœ¨å¯ä»¥è¿™æ ·è§£å†³è¿™ä¸ªé—®é¢˜äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.stream.Collectors.toList; </span><br><span class="line">Map&lt;Currency, List&lt;Transaction&gt;&gt; transactionsByCurrencies = transactions.stream() .filter((Transaction t) -&gt; t.getPrice() &gt; <span class="number">1000</span>) .collect(groupingBy(Transaction::getCurrency));</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå’ŒCollection APIç›¸æ¯”ï¼ŒStream APIå¤„ç†æ•°æ®çš„æ–¹å¼éå¸¸ä¸åŒã€‚ç”¨é›†åˆçš„è¯ï¼Œä½ å¾—è‡ªå·±å»åšè¿­ä»£çš„è¿‡ç¨‹ã€‚ä½ å¾—ç”¨for-eachå¾ªç¯ä¸€ä¸ªä¸ªå»è¿­ä»£å…ƒç´ ï¼Œç„¶åå†å¤„ç†å…ƒç´ ã€‚æˆ‘ä»¬æŠŠè¿™ç§æ•°æ®è¿­ä»£çš„æ–¹æ³•ç§°ä¸º<strong>å¤–éƒ¨è¿­ä»£</strong>,ç›¸åï¼Œæœ‰äº†Stream APIï¼Œä½ æ ¹æœ¬ç”¨ä¸ç€æ“å¿ƒå¾ªç¯çš„äº‹æƒ…ã€‚æ•°æ®å¤„ç†å®Œå…¨æ˜¯åœ¨åº“å†…éƒ¨è¿›è¡Œçš„ã€‚æˆ‘ä»¬æŠŠè¿™ç§æ€æƒ³å«ä½œ<strong>å†…éƒ¨è¿­ä»£</strong>ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>Java8æ–°ç‰¹æ€§</category>
      </categories>
      <tags>
        <tag>Java8æ–°ç‰¹æ€§</tag>
      </tags>
  </entry>
  <entry>
    <title>javaè®¾è®¡æ¨¡å¼</title>
    <url>/2019/01/03/java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h2 id="Designç±»å‹ï¼Œå…±23ç§ï¼š">Designç±»å‹ï¼Œå…±23ç§ï¼š</h2>
<p>**åˆ›å»ºå‹æ¨¡å¼ï¼šå•ä¾‹æ¨¡å¼ã€æŠ½è±¡å·¥å‚æ¨¡å¼ã€å»ºé€ è€…æ¨¡å¼ã€å·¥å‚æ¨¡å¼ã€åŸå‹æ¨¡å¼ã€‚<br>
**ç»“æ„å‹æ¨¡å¼ï¼šé€‚é…å™¨æ¨¡å¼ã€æ¡¥æ¥æ¨¡å¼ã€è£…é¥°æ¨¡å¼ã€ç»„åˆæ¨¡å¼ã€å¤–è§‚æ¨¡å¼ã€äº«å…ƒæ¨¡å¼ã€ä»£ç†æ¨¡å¼ã€‚<br>
**è¡Œä¸ºå‹æ¨¡å¼ï¼šæ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼ã€å‘½ä»¤æ¨¡å¼ã€è¿­ä»£å™¨æ¨¡å¼ã€è§‚å¯Ÿè€…æ¨¡å¼ã€ä¸­ä»‹è€…æ¨¡å¼ã€å¤‡å¿˜å½•æ¨¡å¼ã€è§£é‡Šå™¨æ¨¡å¼ã€çŠ¶æ€æ¨¡å¼ã€ç­–ç•¥æ¨¡å¼ã€èŒè´£é“¾æ¨¡å¼(è´£ä»»é“¾æ¨¡å¼)ã€è®¿é—®è€…æ¨¡å¼ã€‚<br>
è®¾è®¡åŸåˆ™ï¼š</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>è®¾è®¡æ¨¡å¼</category>
      </categories>
      <tags>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title>JPA hibernateçš„æŒä¹…åŒ–ç”Ÿå‘½çŠ¶æ€</title>
    <url>/2019/01/02/jpa%E6%8C%81%E4%B9%85%E5%8C%96%E7%94%9F%E5%91%BD%E7%8A%B6%E6%80%81/</url>
    <content><![CDATA[<h2 id="å¼€ç¯‡">å¼€ç¯‡</h2>
<p>æŸæ—¥å†™ç¨‹åºæ—¶ï¼Œä½¿ç”¨jpaæ“ä½œæ•°æ®åº“ï¼Œå½“æˆ‘ä½¿ç”¨<code>findAllï¼ˆï¼‰</code>æ–¹æ³•æŸ¥å¤„ä¸€ä¸ªListçš„å¯¹è±¡åï¼Œç»™å¯¹è¿™ä¸ªlistçš„å®ä½“è¿›è¡Œäº†ä¸€äº›æ“ä½œï¼Œå¹¶æ²¡æœ‰è°ƒç”¨<code>update</code> æˆ–è€… <code>saveOrUpdate</code>æ–¹æ³•ï¼Œæ›´æ”¹åçš„æ•°æ®å´ç¥å¥‡çš„ä¿å­˜åˆ°æ•°æ®åº“é‡Œé¢å»äº†ğŸ˜•ğŸ˜•ğŸ˜•æˆ‘ä¹Ÿåœ¨serviceå±‚æ·»åŠ äº‹ç‰©äº†å•Šã€‚åé¢æ‰¾äº†èµ„æ–™æ‰å‘ç°æ˜¯jpaæ˜¯å¯¹hibernateçš„å°è£…ï¼Œåº•å±‚æ˜¯hibernateï¼Œè¿™æ˜¯hibernateçš„æŒä¹…çŠ¶æ€æçš„é¬¼ã€‚</p>
<a id="more"></a>
<h2 id="hibernate-çš„ä¸‰ç§çŠ¶æ€">hibernate çš„ä¸‰ç§çŠ¶æ€</h2>
<ol>
<li><strong>ç¬æ—¶çŠ¶æ€ (Transient)</strong><br>
å½“æˆ‘ä»¬é€šè¿‡Javaçš„newå…³é”®å­—æ¥ç”Ÿæˆä¸€ä¸ªå®ä½“å¯¹è±¡æ—¶ï¼Œè¿™æ—¶è¿™ä¸ªå®ä½“å¯¹è±¡å°±å¤„äºè‡ªç”±çŠ¶æ€ï¼Œå¦‚ä¸‹ï¼š<br>
<code>People people=new People(â€œxsâ€,20);</code><br>
æ­¤æ—¶peopleåªæ˜¯é€šè¿‡JVMè·å¾—äº†ä¸€å—å†…å­˜ç©ºé—´ï¼Œè¿˜å¹¶æ²¡æœ‰é€šè¿‡Sessionå¯¹è±¡çš„save()æ–¹æ³•ä¿å­˜è¿›æ•°æ®åº“ï¼Œå› æ­¤ä¹Ÿå°±è¿˜æ²¡æœ‰çº³å…¥Hibernateçš„ç¼“å­˜ç®¡ç†ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´customerå¯¹è±¡ç°åœ¨è¿˜è‡ªç”±çš„æ¸¸è¡äºHibernateç¼“å­˜ç®¡ç†ä¹‹å¤–ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹å‡ºè‡ªç”±å¯¹è±¡æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯ï¼Œåœ¨æ•°æ®åº“ä¸­ä¸å­˜åœ¨ä¸€æ¡ä¸å®ƒå¯¹åº”çš„è®°å½•ã€‚<br>
ç¬æ—¶å¯¹è±¡ç‰¹ç‚¹ï¼š<br>
<strong>ä¸å’Œ Session å®ä¾‹å…³è”</strong><br>
<strong>åœ¨æ•°æ®åº“ä¸­æ²¡æœ‰å’Œç¬æ—¶å¯¹è±¡å…³è”çš„è®°å½•</strong></li>
<li><strong>æŒä¹…çŠ¶æ€ (Persistent)</strong><br>
æŒä¹…åŒ–å¯¹è±¡å°±æ˜¯å·²ç»è¢«ä¿å­˜è¿›æ•°æ®åº“çš„å®ä½“å¯¹è±¡ï¼Œå¹¶ä¸”è¿™ä¸ªå®ä½“å¯¹è±¡ç°åœ¨è¿˜å¤„äºHibernateçš„ç¼“å­˜ç®¡ç†ä¹‹ä¸­ã€‚è¿™æ˜¯å¯¹è¯¥å®ä½“å¯¹è±¡çš„ä»»ä½•ä¿®æ”¹ï¼Œéƒ½ä¼šåœ¨æ¸…ç†ç¼“å­˜æ—¶åŒæ­¥åˆ°æ•°æ®åº“ä¸­ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">People people=<span class="keyword">new</span> People(â€œxsâ€,<span class="number">20</span>);</span><br><span class="line">tx=session.beginTransaction();</span><br><span class="line">session.save(people);</span><br><span class="line">customer=(Customer)session.load(Customer<span class="class">.<span class="keyword">class</span>,â€1â€)</span>;</span><br><span class="line">customer.setAge(<span class="number">28</span>);</span><br><span class="line">tx.commit();</span><br></pre></td></tr></table></figure>
<p>è¿™æ—¶æˆ‘ä»¬å¹¶æ²¡æœ‰æ˜¾ç¤ºè°ƒç”¨<code>session.update()</code>æ–¹æ³•æ¥ä¿å­˜æ›´æ–°ï¼Œä½†æ˜¯å¯¹å®ä½“å¯¹è±¡çš„ä¿®æ”¹è¿˜æ˜¯ä¼šåŒæ­¥æ›´æ–°åˆ°æ•°æ®åº“ä¸­ï¼Œå› ä¸ºæ­¤æ—¶customerå¯¹è±¡é€šè¿‡saveæ–¹æ³•ä¿å­˜è¿›æ•°æ®åº“åï¼Œå·²ç»æ˜¯æŒä¹…åŒ–å¯¹è±¡äº†ï¼Œç„¶åé€šè¿‡loadæ–¹æ³•å†æ¬¡åŠ è½½å®ƒï¼Œå®ƒä»ç„¶æ˜¯æŒä¹…åŒ–å¯¹è±¡ï¼Œæ‰€ä»¥å®ƒè¿˜å¤„äºHibernateç¼“å­˜çš„ç®¡ç†ä¹‹ä¸­ï¼Œè¿™æ—¶å½“æ‰§è¡Œ<code>tx.commit()</code>æ–¹æ³•æ—¶ï¼Œ<code>Hibernate</code>ä¼šè‡ªåŠ¨æ¸…ç†ç¼“å­˜ï¼Œå¹¶ä¸”è‡ªåŠ¨å°†æŒä¹…åŒ–å¯¹è±¡çš„å±æ€§å˜åŒ–åŒæ­¥åˆ°åˆ°æ•°æ®åº“ä¸­ã€‚<br>
æŒä¹…çš„å®ä¾‹åœ¨æ•°æ®åº“ä¸­æœ‰å¯¹åº”çš„è®°å½•ï¼Œå¹¶æ‹¥æœ‰ä¸€ä¸ªæŒä¹…åŒ–æ ‡è¯† (identifier).æŒä¹…å¯¹è±¡æ€»æ˜¯ä¸ <code>Session</code> å’Œ <code>Transaction</code> ç›¸å…³è”ï¼Œåœ¨ä¸€ä¸ª<code> Session</code> ä¸­ï¼Œå¯¹æŒä¹…å¯¹è±¡çš„æ”¹å˜ä¸ä¼šé©¬ä¸Šå¯¹æ•°æ®åº“è¿›è¡Œå˜æ›´ï¼Œè€Œå¿…é¡»åœ¨<code>Transaction</code>ç»ˆæ­¢ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œ<code> commit()</code> ä¹‹åï¼Œæ‰åœ¨æ•°æ®åº“ä¸­çœŸæ­£è¿è¡Œ SQL è¿›è¡Œå˜æ›´ï¼ŒæŒä¹…å¯¹è±¡çš„çŠ¶æ€æ‰ä¼šä¸æ•°æ®åº“è¿›è¡ŒåŒæ­¥ã€‚åœ¨åŒæ­¥ä¹‹å‰çš„æŒä¹…å¯¹è±¡ç§°ä¸ºè„ (dirty) å¯¹è±¡ã€‚<br>
ç¬æ—¶å¯¹è±¡è½¬ä¸ºæŒä¹…å¯¹è±¡ï¼š<br>
é€šè¿‡ <code>Session</code> çš„ <code>save()</code> å’Œ <code>saveOrUpdate() </code>æ–¹æ³•æŠŠä¸€ä¸ªç¬æ—¶å¯¹è±¡ä¸æ•°æ®åº“ç›¸å…³è”ï¼Œè¿™ä¸ªç¬æ—¶å¯¹è±¡å°±æˆä¸ºæŒä¹…åŒ–å¯¹è±¡ã€‚<br>
ä½¿ç”¨ <code>fine()</code>,<code>get()</code>,<code>load()</code> å’Œ <code>iterater()</code> å¾…æ–¹æ³•æŸ¥è¯¢åˆ°çš„æ•°æ®å¯¹è±¡ï¼Œå°†æˆä¸ºæŒä¹…åŒ–å¯¹è±¡ã€‚<br>
æŒä¹…åŒ–å¯¹è±¡çš„ç‰¹ç‚¹ï¼š<br>
<strong>å’Œ Session å®ä¾‹å…³è”</strong><br>
<strong>åœ¨æ•°æ®åº“ä¸­æœ‰å’ŒæŒä¹…å¯¹è±¡å…³è”çš„è®°å½•</strong><br>
3. <strong>è„±ç®¡çŠ¶æ€ (Detached)</strong><br>
å½“ä¸€ä¸ªæŒä¹…åŒ–å¯¹è±¡ï¼Œè„±ç¦»å¼€Hibernateçš„ç¼“å­˜ç®¡ç†åï¼Œå®ƒå°±å¤„äºæ¸¸ç¦»çŠ¶æ€ï¼Œæ¸¸ç¦»å¯¹è±¡å’Œè‡ªç”±å¯¹è±¡çš„æœ€å¤§åŒºåˆ«åœ¨äºï¼Œæ¸¸ç¦»å¯¹è±¡åœ¨æ•°æ®åº“ä¸­å¯èƒ½è¿˜å­˜åœ¨ä¸€æ¡ä¸å®ƒå¯¹åº”çš„è®°å½•ï¼Œåªæ˜¯ç°åœ¨è¿™ä¸ªæ¸¸ç¦»å¯¹è±¡è„±ç¦»äº†Hibernateçš„ç¼“å­˜ç®¡ç†ï¼Œè€Œè‡ªç”±å¯¹è±¡ä¸ä¼šåœ¨æ•°æ®åº“ä¸­å‡ºç°ä¸å®ƒå¯¹åº”çš„æ•°æ®è®°å½•ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">People people=<span class="keyword">new</span> People(â€œxsâ€,<span class="number">20</span>);</span><br><span class="line">tx=session.beginTransaction();</span><br><span class="line">session.save(people);</span><br><span class="line">people=(People)session.load(People<span class="class">.<span class="keyword">class</span>,â€1â€)</span>;</span><br><span class="line">people.setAge(<span class="number">28</span>);</span><br><span class="line">tx.commit();</span><br><span class="line">session.close();</span><br></pre></td></tr></table></figure>
<p>å½“sessionå…³é—­åï¼Œcustomerå¯¹è±¡å°±ä¸å¤„äºHibernateçš„ç¼“å­˜ç®¡ç†ä¹‹ä¸­äº†ï¼Œä½†æ˜¯æ­¤æ—¶åœ¨æ•°æ®åº“ä¸­è¿˜å­˜åœ¨ä¸€æ¡ä¸customerå¯¹è±¡å¯¹åº”çš„æ•°æ®è®°å½•ï¼Œæ‰€ä»¥æ­¤æ—¶customerå¯¹è±¡å¤„äºæ¸¸ç¦»æ€<br>
ä¸æŒä¹…å¯¹è±¡å…³è”çš„ Session è¢«å…³é—­åï¼Œå¯¹è±¡å°±å˜ä¸ºè„±ç®¡å¯¹è±¡ã€‚å¯¹è„±ç®¡å¯¹è±¡çš„å¼•ç”¨ä¾ç„¶æœ‰æ•ˆï¼Œå¯¹è±¡å¯ç»§ç»­è¢«ä¿®æ”¹ã€‚<br>
è„±ç®¡å¯¹è±¡ç‰¹ç‚¹ï¼š<br>
<strong>æœ¬è´¨ä¸Šå’Œç¬æ—¶å¯¹è±¡ç›¸åŒ</strong><br>
<strong>åªæ˜¯æ¯”ç¬æ—¶å¯¹è±¡å¤šäº†ä¸€ä¸ªæ•°æ®åº“è®°å½•æ ‡è¯†å€¼ id</strong>.<br>
æŒä¹…å¯¹è±¡è½¬ä¸ºè„±ç®¡å¯¹è±¡ï¼š<br>
å½“æ‰§è¡Œ <code>close() </code>æˆ– <code>clear()</code>,<code>evict()</code> ä¹‹åï¼ŒæŒä¹…å¯¹è±¡ä¼šå˜ä¸ºè„±ç®¡å¯¹è±¡ã€‚<br>
ç¬æ—¶å¯¹è±¡è½¬ä¸ºæŒä¹…å¯¹è±¡ï¼š<br>
é€šè¿‡ <code>Session</code> çš„ <code>update()</code>,<code>saveOrUpdate() </code>å’Œ <code>lock()</code> ç­‰æ–¹æ³•ï¼ŒæŠŠè„±ç®¡å¯¹è±¡å˜ä¸ºæŒä¹…å¯¹è±¡ã€‚<br>
<img src="/images/hibernate.jpg" alt=""></p>
<h2 id="JPA-å®ä½“ç”Ÿå‘½å‘¨æœŸæœ‰å››ç§çŠ¶æ€">JPA å®ä½“ç”Ÿå‘½å‘¨æœŸæœ‰å››ç§çŠ¶æ€</h2>
<p><code>New</code>ï¼šç¬æ—¶å¯¹è±¡ï¼Œå°šæœªæœ‰idï¼Œè¿˜æœªå’Œ<code>Persistence Context</code>å»ºç«‹å…³è”çš„å¯¹è±¡ã€‚<br>
<code>Managed</code>ï¼šæŒä¹…åŒ–å—ç®¡å¯¹è±¡ï¼Œæœ‰idå€¼ï¼Œå·²ç»å’Œ<code>Persistence Context</code>å»ºç«‹äº†å…³è”çš„å¯¹è±¡ã€‚<br>
<code>Datached</code>ï¼šæ¸¸ç¦»æ€ç¦»çº¿å¯¹è±¡ï¼Œæœ‰idå€¼ï¼Œä½†æ²¡æœ‰å’Œ<code>Persistence Context</code>å»ºç«‹å…³è”çš„å¯¹è±¡ã€‚<br>
<code>Removed</code>ï¼šåˆ é™¤çš„å¯¹è±¡ï¼Œæœ‰idå€¼ï¼Œå°šä¸”å’Œ<code>Persistence Context</code>æœ‰å…³è”ï¼Œä½†æ˜¯å·²ç»å‡†å¤‡å¥½ä»æ•°æ®åº“ä¸­åˆ é™¤ã€‚<br>
<code>Managed</code>çŠ¶æ€ä¸‹çš„æ•°æ®ä¿å­˜ï¼Œæ›´æ–°ä»¥åŠåˆ é™¤æ•°æ®ä¸‹çš„<code>Removed</code>çŠ¶æ€ï¼Œæ•°æ®éƒ½ä¸ä¼šç«‹å³æ›´æ–°åˆ°æ•°æ®åº“ï¼Œåªæœ‰å½“ä½ äº‹åŠ¡æäº¤æˆ–è€…<code>em.flush()</code>ï¼Œæ‰ä¼šç«‹å³æ›´æ–°åˆ°æ•°æ®åº“ã€‚<br>
<code>Datached</code>çš„çŠ¶æ€ï¼Œå¯ä»¥è°ƒç”¨<code>em.merge()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šæ ¹æ®å®ä½“ç±»çš„idæ¥æ›´æ–°æ•°æ®åº“æ•°æ®ï¼Œè¿™æ—¶å®ä½“ç±»å˜æˆäº†<code>Managed</code>çŠ¶æ€ã€‚<br>
å››ç§çŠ¶æ€æ€»ç»“ï¼š</p>
<p>çŠ¶æ€å                      ä½œä¸ºjavaå¯¹è±¡å­˜åœ¨                    åœ¨å®ä½“ç®¡ç†å™¨ä¸­å­˜åœ¨                      åœ¨æ•°æ®åº“å­˜åœ¨</p>
<p>New                             yes                                 no                                  no</p>
<p>Managed                         yes                                 yes                                 yes</p>
<p>Detached                        no                                  no                                  no</p>
<p>Removed                         yes                                 yes                                 no</p>
<h2 id="è§£å†³åŠæ³•">è§£å†³åŠæ³•</h2>
<ol>
<li>æ³¨å…¥EntityManager</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PersistenceContext</span></span><br><span class="line">EntityManager entityManager;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>ä¸´æ—¶èµ‹å€¼å,detchå¯¹è±¡</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">entityManager.detach(xxx);</span><br></pre></td></tr></table></figure>
<p>eg:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Video&gt; living = videos.getContent().stream().filter(x-&gt;x.getIsLive()!=<span class="keyword">null</span>).filter(x-&gt;x.getIsLive()==<span class="number">2</span>).filter(x-&gt;x.getLiveTime().compareTo(<span class="keyword">new</span> Date())&gt;<span class="number">0</span>).collect(Collectors.toList());</span><br><span class="line">           living.forEach(e-&gt;&#123;</span><br><span class="line">               e.setHd(<span class="string">""</span>);</span><br><span class="line">               e.setSd(<span class="string">""</span>);</span><br><span class="line">               e.setUltraClear(<span class="string">""</span>);</span><br><span class="line">               entityManager.detach(e);</span><br><span class="line">           &#125;);</span><br></pre></td></tr></table></figure>
<h2 id="detach-æ–¹æ³•">detach()æ–¹æ³•</h2>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Method</span><br><span class="line">javax.persistence.EntityManager</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">detach</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  Object entity</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span></span><br></pre></td></tr></table></figure>
<p>Remove the given entity from the persistence context, causing a managed entity to become detached. Unflushed changes made to the entity if any (including removal of the entity), will not be synchronized to the database. Entities which previously referenced the detached entity will continue to reference it.<br>
Parameters:<br>
entity - entity instance<br>
Throws:<br>
IllegalArgumentException - if the instance is not an entity<br>
Since:<br>
JPA 2.0</p>
<p><a href="https://www.cnblogs.com/0201zcr/p/6580192.html" target="_blank" rel="noopener">å‚è€ƒé“¾æ¥</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>NginxåŸŸåè½¬å‘</title>
    <url>/2018/12/27/nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/</url>
    <content><![CDATA[<h2 id="nginx-confé…ç½®æ–‡ä»¶">nginx.confé…ç½®æ–‡ä»¶</h2>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> For more information on configuration, see:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   * Official English Documentation: http://nginx.org/en/docs/</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   * Official Russian Documentation: http://nginx.org/ru/docs/</span></span><br><span class="line"></span><br><span class="line">user nginx;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/log/nginx/error.log;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line">&lt;!-- more --&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.</span></span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span><br><span class="line">                      '$status $body_bytes_sent "$http_referer" '</span><br><span class="line">                      '"$http_user_agent" "$http_x_forwarded_for"';</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    # Load modular configuration files from the /etc/nginx/conf.d directory.</span><br><span class="line">    # See http://nginx.org/en/docs/ngx_core_module.html#include</span><br><span class="line">    # for more information.</span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        listen       [::]:80;</span><br><span class="line">        server_name  _;</span><br><span class="line">        root         /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">        # Load configuration files for the default server block.</span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">            location = /40x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">            location = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Settings <span class="keyword">for</span> a TLS enabled server.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    server &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        listen       443 ssl http2 default_server;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        listen       [::]:443 ssl http2 default_server;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        server_name  _;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        root         /usr/share/nginx/html;</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        ssl_certificate <span class="string">"/etc/pki/nginx/server.crt"</span>;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        ssl_certificate_key <span class="string">"/etc/pki/nginx/private/server.key"</span>;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        ssl_session_cache shared:SSL:1m;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        ssl_session_timeout  10m;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        ssl_ciphers HIGH:!aNULL:!MD5;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        ssl_prefer_server_ciphers on;</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        <span class="comment"># Load configuration files for the default server block.</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">        include /etc/nginx/default.d/*.conf;</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        location / &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        &#125;</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        error_page 404 /404.html;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">            location = /40x.html &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        &#125;</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        error_page 500 502 503 504 /50x.html;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">            location = /50x.html &#123;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">        &#125;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    &#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>include /etc/nginx/conf.d/*.conf</code>; //å¼•å…¥/etc/nginx/conf.d/ä¸‹çš„æ‰€æœ‰.confå­é…ç½®æ–‡ä»¶ æ³¨æ„è¿™æ¡å¾ˆé‡è¦ï¼Œå› ä¸ºåœ¨é»˜è®¤é…ç½®ä¸­æ²¡æœ‰serveræ®µçš„é…ç½®ï¼Œè€Œä¸€èˆ¬éƒ½æ˜¯å°†serverçš„é…ç½®æ”¾åœ¨/etc/nginx/conf.d/ç›®å½•ä¸‹ã€‚<br>
æ­£å¸¸æƒ…å†µä¸‹httpæ®µé…ç½®ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">      ...</span><br><span class="line">    server &#123;</span><br><span class="line">          ...</span><br><span class="line">        location [PATTERN]  &#123;</span><br><span class="line">               ...</span><br><span class="line">        &#125;</span><br><span class="line">        location [PATTERN]  &#123;</span><br><span class="line">              ...</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  server &#123;</span><br><span class="line">         ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Nginxçš„ç›¸å…³å‘½ä»¤å’ŒæœåŠ¡å¯åŠ¨åŠ è½½<br>
<code>nginx  -s  reload </code> ï¼šé‡æ–°åŠ è½½nginxçš„é…ç½®æ–‡ä»¶ï¼›</p>
<p><code>nginx  -t</code>ï¼šæ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•æ˜¯å¦æœ‰é—®é¢˜ï¼›</p>
<p>NginxæœåŠ¡å¯åŠ¨ã€åœæ­¢ã€é‡æ–°åŠ è½½</p>
<p>#service nginx start  | stop | reload</p>
<p>#/etc/init.d/nginx  start | stop | reload</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sites-enabled</span><br><span class="line">è¿™é‡Œé¢çš„é…ç½®æ–‡ä»¶å…¶å®å°±æ˜¯sites-availableé‡Œé¢çš„é…ç½®æ–‡ä»¶çš„è½¯</span><br><span class="line">è¿æ¥,ä½†æ˜¯ç”±äºnginx.confé»˜è®¤åŒ…å«çš„æ˜¯è¿™ä¸ªæ–‡ä»¶å¤¹,æ‰€ä»¥æˆ‘ä»¬åœ¨</span><br><span class="line">sites-availableé‡Œé¢å»ºç«‹äº†æ–°çš„ç«™ç‚¹ä¹‹å,è¿˜è¦å»ºç«‹ä¸ªè½¯è¿æ¥åˆ°sites-enabledé‡Œé¢æ‰è¡Œ</span><br><span class="line"></span><br><span class="line">sites-available</span><br><span class="line">è¿™é‡Œæ˜¯æˆ‘ä»¬çš„è™šæ‹Ÿä¸»æœºçš„ç›®å½•ï¼Œæˆ‘ä»¬åœ¨åœ¨è¿™é‡Œé¢å¯ä»¥åˆ›å»ºå¤šä¸ªè™šæ‹Ÿä¸»æœº.</span><br><span class="line">## </span><br><span class="line">åœ¨conf.dä¸‹é¢é…ç½®æˆ‘çš„ä¸¤ä¸ªé…ç½®æ–‡ä»¶</span><br><span class="line">aaa.conf</span><br><span class="line">&#96;&#96;&#96;shell</span><br><span class="line">upstream gooneserver  &#123;</span><br><span class="line">    server 127.0.0.1:8580;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">	listen       80 default_server;</span><br><span class="line">	server_name  www.rizin.fun rizin.fun;</span><br><span class="line"></span><br><span class="line">	access_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;goone.access.log  main;</span><br><span class="line">	error_log  &#x2F;var&#x2F;log&#x2F;nginx&#x2F;goone.error.log;</span><br><span class="line"></span><br><span class="line">        root         &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span><br><span class="line">	index  index.html index.htm index.php;</span><br><span class="line"></span><br><span class="line">	## send request back to apache ##</span><br><span class="line">	location &#x2F; &#123;</span><br><span class="line">		proxy_pass  http:&#x2F;&#x2F;gooneserver;</span><br><span class="line"></span><br><span class="line">		#Proxy Settings</span><br><span class="line">		proxy_redirect     off;</span><br><span class="line">		proxy_set_header   Host             $host;</span><br><span class="line">		proxy_set_header   X-Real-IP        $remote_addr;</span><br><span class="line">		proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class="line">		proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;</span><br><span class="line">		proxy_max_temp_file_size 0;</span><br><span class="line">		proxy_connect_timeout      90;</span><br><span class="line">		proxy_send_timeout         90;</span><br><span class="line">		proxy_read_timeout         90;</span><br><span class="line">		proxy_buffer_size          4k;</span><br><span class="line">		proxy_buffers              4 32k;</span><br><span class="line">		proxy_busy_buffers_size    64k;</span><br><span class="line">		proxy_temp_file_write_size 64k;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>yyy.conf</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">upstream gooneadminserver  &#123;</span><br><span class="line">    server 127.0.0.1:8581;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">	listen       80;</span><br><span class="line">	server_name  admin.rizin.fun;</span><br><span class="line"></span><br><span class="line">	access_log  /var/log/nginx/admin.goone.access.log  main;</span><br><span class="line">	error_log  /var/log/nginx/admin.goone.error.log;</span><br><span class="line"></span><br><span class="line">        root         /usr/share/nginx/html;</span><br><span class="line">	index  index.html index.htm index.php;</span><br><span class="line"></span><br><span class="line"><span class="meta">	#</span><span class="bash"><span class="comment"># send request back to apache ##</span></span></span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass  http://gooneadminserver;</span><br><span class="line"></span><br><span class="line"><span class="meta">		#</span><span class="bash">Proxy Settings</span></span><br><span class="line">		proxy_redirect     off;</span><br><span class="line">		proxy_set_header   Host             $host;</span><br><span class="line">		proxy_set_header   X-Real-IP        $remote_addr;</span><br><span class="line">		proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class="line">		proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;</span><br><span class="line">		proxy_max_temp_file_size 0;</span><br><span class="line">		proxy_connect_timeout      90;</span><br><span class="line">		proxy_send_timeout         90;</span><br><span class="line">		proxy_read_timeout         90;</span><br><span class="line">		proxy_buffer_size          4k;</span><br><span class="line">		proxy_buffers              4 32k;</span><br><span class="line">		proxy_busy_buffers_size    64k;</span><br><span class="line">		proxy_temp_file_write_size 64k;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Nginx</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot Junit Restful Api æµ‹è¯•ç”¨ä¾‹</title>
    <url>/2018/10/27/springbootjunittest/</url>
    <content><![CDATA[<h2 id="Controllerçš„å•å…ƒæµ‹è¯•">Controllerçš„å•å…ƒæµ‹è¯•</h2>
<h3 id="ç¬¬ä¸€ç§ä½¿ç”¨æ¨¡æ‹Ÿç¯å¢ƒè¿›è¡Œæµ‹è¯•">ç¬¬ä¸€ç§ä½¿ç”¨æ¨¡æ‹Ÿç¯å¢ƒè¿›è¡Œæµ‹è¯•</h3>
<h4 id="åŸç†">åŸç†</h4>
<p>ä½¿ç”¨<code>MockMvc</code>å‘èµ·è¯·æ±‚ï¼Œç„¶åæ‰§è¡ŒAPIä¸­ç›¸åº”çš„ä»£ç ï¼Œåœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä½¿mockæ¨¡æ‹Ÿåº•å±‚æ•°æ®çš„è¿”å›ï¼Œæœ€åç»“æœéªŒè¯ã€‚<br>
<code>Spring</code>æµ‹è¯•æ¡†æ¶æä¾›<code>MockMvc</code>å¯¹è±¡ï¼Œå¯ä»¥åœ¨ä¸éœ€è¦å®¢æˆ·ç«¯-æœåŠ¡ç«¯è¯·æ±‚çš„æƒ…å†µä¸‹è¿›è¡ŒMVCæµ‹è¯•ï¼Œå®Œå…¨åœ¨æœåŠ¡ç«¯è¿™è¾¹å°±å¯ä»¥æ‰§è¡Œ<code>Controller</code>çš„è¯·æ±‚ï¼Œè·Ÿå¯åŠ¨äº†æµ‹è¯•æœåŠ¡å™¨ä¸€æ ·ã€‚<br>
æµ‹è¯•å¼€å§‹ä¹‹å‰éœ€è¦å»ºç«‹æµ‹è¯•ç¯å¢ƒï¼Œ<code>setup</code>æ–¹æ³•è¢«<code>@Before</code>ä¿®é¥°ã€‚é€šè¿‡<code>MockMvcBuilders</code>å·¥å…·ï¼Œä½¿ç”¨<code>WebApplicationContext</code>å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œåˆ›å»ºä¸€ä¸ª<code>MockMvc</code>å¯¹è±¡ã€‚</p>
<a id="more"></a>
<p>MockMvcå¯¹è±¡æä¾›ä¸€ç»„å·¥å…·å‡½æ•°ç”¨æ¥æ‰§è¡Œassertåˆ¤æ–­ï¼Œéƒ½æ˜¯é’ˆå¯¹webè¯·æ±‚çš„åˆ¤æ–­ã€‚è¿™ç»„å·¥å…·çš„ä½¿ç”¨æ–¹å¼æ˜¯å‡½æ•°çš„é“¾å¼è°ƒç”¨ï¼Œå…è®¸ç¨‹åºå‘˜å°†å¤šä¸ªæµ‹è¯•ç”¨ä¾‹é“¾æ¥åœ¨ä¸€èµ·ï¼Œå¹¶è¿›è¡Œå¤šä¸ªåˆ¤æ–­ã€‚é€šå¸¸æˆ‘ä»¬ä¼šç”¨åˆ°ä¸‹é¢çš„ä¸€äº›å·¥å…·å‡½æ•°ï¼š<br>
<code>perform(get(...))</code>å»ºç«‹webè¯·æ±‚ã€‚é€šè¿‡<code>MockMvcRequestBuilder</code>æ‰§è¡ŒGETè¯·æ±‚ã€‚postã€deleteåˆ†åˆ«å¯¹åº”<code>POST</code>ã€<code>DELETE</code>è¯·æ±‚<br>
<code>andExpect(...)å¯ä»¥åœ¨perform(...)</code>å‡½æ•°è°ƒç”¨åå¤šæ¬¡è°ƒç”¨ï¼Œè¡¨ç¤ºå¯¹å¤šä¸ªæ¡ä»¶çš„åˆ¤æ–­ï¼Œè¿™ä¸ªå‡½æ•°çš„å‚æ•°ç±»å‹æ˜¯<code>ResultMatcher</code>æ¥å£ï¼Œåœ¨<code>MockMvcResultMatchers</code>è¿™è¿™ä¸ªç±»ä¸­æä¾›äº†å¾ˆå¤šè¿”å›ResultMatcheræ¥å£çš„å·¥å…·å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°ä½¿å¾—å¯ä»¥æ£€æµ‹åŒä¸€ä¸ªwebè¯·æ±‚çš„å¤šä¸ªæ–¹é¢ï¼ŒåŒ…æ‹¬HTTPå“åº”çŠ¶æ€ç ï¼ˆresponse statusï¼‰ï¼Œå“åº”çš„å†…å®¹ç±»å‹ï¼ˆcontent typeï¼‰ï¼Œä¼šè¯ä¸­å­˜æ”¾çš„å€¼ï¼Œæ£€éªŒé‡å®šå‘ã€modelæˆ–è€…headerçš„å†…å®¹ç­‰ç­‰ã€‚è¿™é‡Œéœ€è¦é€šè¿‡ç¬¬ä¸‰æ–¹åº“json-pathæ£€æµ‹JSONæ ¼å¼çš„å“åº”æ•°æ®ï¼šæ£€æŸ¥jsonæ•°æ®åŒ…å«æ­£ç¡®çš„å…ƒç´ ç±»å‹å’Œå¯¹åº”çš„å€¼ï¼Œä¾‹å¦‚<code>jsonPath(&quot;$.name&quot;).value(&quot;ä¸­æ–‡æµ‹è¯•&quot;)</code>ç”¨äºæ£€æŸ¥åœ¨æ ¹ç›®å½•ä¸‹æœ‰ä¸€ä¸ªåä¸ºnameçš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”è¯¥èŠ‚ç‚¹å¯¹åº”çš„å€¼æ˜¯â€œä¸­æ–‡æµ‹è¯•â€ã€‚</p>
<h4 id="MockMvcå¯¹è±¡çš„å¼•å…¥çš„ä¸¤ç§æ–¹å¼">MockMvcå¯¹è±¡çš„å¼•å…¥çš„ä¸¤ç§æ–¹å¼</h4>
<p>1.æµ‹è¯•ç±»ä¸Šæ·»åŠ <code>@AutoConfigureMockMvc</code>æ³¨è§£ï¼Œè¯¥æ³¨è§£è¡¨ç¤ºå¯åŠ¨æµ‹è¯•çš„æ—¶å€™è‡ªåŠ¨æ³¨å…¥<code> MockMvc</code>,ç„¶åç›´æ¥<code>@Autowired</code>æ³¨å…¥<code>MockMvc</code>å¯¹è±¡,ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class">@<span class="title">AutoConfigureMockMvc</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">UserControllerTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">userMapping</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String JSON =</span><br><span class="line">                <span class="string">"&#123;\"nickName\":\"å²—æ‘ä¸€æ³½\",\"lastName\":\"å²—æ‘\",\"firstName\":\"ä¸€æ³½\",\"email\":\"gangcunyiza@gmail.com\",\"password\":\"12345678\",\"jpFirstName\":\"ä¸€æ³½\",\"jpLastName\":\"å²—æ‘\",\"address1\":\"å¤§é˜ª\",\"address2\":\"å°æ±åŒºæ±ä¸Šé‡ï¼“ä¸ç›®\",\"address3\":\"ï¼‘ï¼™ç•ªï¼–å·\",\"phone\":\"2014561\",\"postalCode\":\"1100112\"&#125;"</span>;</span><br><span class="line">        Mockito.when(userService.findByEmailAndStatus(<span class="string">"gangcunyiza@gmail.com.com"</span>,<span class="number">1</span>)).thenReturn(user);</span><br><span class="line">        Mockito.when(userRepository.findByNickNameAndStatus(<span class="string">"å²—æ‘ä¸€æ³½"</span>,<span class="number">1</span>)).thenReturn(user);</span><br><span class="line">        mockMvc.perform(MockMvcRequestBuilders.post(<span class="string">"/registe"</span>)</span><br><span class="line">                .accept(MediaType.APPLICATION_JSON).content(JSON)</span><br><span class="line">                .contentType(MediaType.APPLICATION_JSON))</span><br><span class="line">                .andExpect(status().isOk())</span><br><span class="line">                .andReturn();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2.ä½¿ç”¨<code>MockMvcBuilder</code>æ„å»º<code>MockMvc</code>å¯¹è±¡,ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼šã€</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">UserControllerTest4</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebApplicationContext web;</span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setupMockMvc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mockMvc = MockMvcBuilders.webAppContextSetup(web).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ç”¨æ³•">ç”¨æ³•</h4>
<p>1.<code>MockMvcBuilders.webAppContextSetup(WebApplicationContext context)</code>ï¼šæŒ‡å®š<code>WebApplicationContext</code>ï¼Œå°†ä¼šä»è¯¥ä¸Šä¸‹æ–‡è·å–ç›¸åº”çš„æ§åˆ¶å™¨å¹¶å¾—åˆ°ç›¸åº”çš„<code>MockMvc</code>;<br>
2.éƒ¨åˆ†æ–¹æ³•è¯´æ˜<br>
<code>perform</code>ï¼šæ‰§è¡Œä¸€ä¸ª<code>RequestBuilder</code>è¯·æ±‚ï¼Œä¼šè‡ªåŠ¨æ‰§è¡Œ<code>SpringMVC</code>çš„æµç¨‹å¹¶æ˜ å°„åˆ°ç›¸åº”çš„æ§åˆ¶å™¨æ‰§è¡Œå¤„ç†;<br>
<code>andExpec</code>tï¼šæ·»åŠ <code>ResultMatcher</code>éªŒè¯è§„åˆ™ï¼ŒéªŒè¯æ§åˆ¶å™¨æ‰§è¡Œå®Œæˆåç»“æœæ˜¯å¦æ­£ç¡®;<br>
<code>andDo</code>ï¼šæ·»åŠ <code>ResultHandler</code>ç»“æœå¤„ç†å™¨ï¼Œæ¯”å¦‚è°ƒè¯•æ—¶æ‰“å°ç»“æœåˆ°æ§åˆ¶å°;<br>
<code>andReturn</code>ï¼šæœ€åè¿”å›ç›¸åº”çš„<code>MvcResult</code>ï¼›ç„¶åè¿›è¡Œè‡ªå®šä¹‰éªŒè¯/è¿›è¡Œä¸‹ä¸€æ­¥çš„å¼‚æ­¥å¤„ç†;<br>
3.<code>MockMvc</code> æµ‹è¯•æ•´ä¸ªæµç¨‹ç¨‹è¯´æ˜ï¼š<br>
1.<code>mockMvc.perform</code>æ‰§è¡Œä¸€ä¸ªè¯·æ±‚ï¼›<br>
2.<code>MockMvcRequestBuilders.get(&quot;/1/2&quot;)</code>æ„é€ ä¸€ä¸ªè¯·æ±‚<br>
3.<code>ResultActions.andExpect</code>æ·»åŠ æ‰§è¡Œå®Œæˆåçš„æ–­è¨€<br>
4.<code>ResultActions.andDo</code>æ·»åŠ ä¸€ä¸ªç»“æœå¤„ç†å™¨ï¼Œè¡¨ç¤ºè¦å¯¹ç»“æœåšç‚¹ä»€ä¹ˆäº‹æƒ…ï¼Œæ¯”å¦‚æ­¤å¤„ä½¿ç”¨<code>MockMvcResultHandlers.print()</code>è¾“å‡ºæ•´ä¸ªå“åº”ç»“æœä¿¡æ¯ã€‚<br>
5.<code>ResultActions.andReturn</code>è¡¨ç¤ºæ‰§è¡Œå®Œæˆåè¿”å›ç›¸åº”çš„ç»“æœã€‚<br>
4.ä¼ å‚</p>
<ul>
<li>è·¯å¾„è¯·æ±‚</li>
</ul>
<p>mockMvc.perform(MockMvcRequestBuilders<br>
.è¯·æ±‚æ–¹å¼(â€œurl/{path}â€,å‚æ•°å€¼)</p>
<ul>
<li>è¡¨å•è¯·æ±‚</li>
</ul>
<p>mockMvc.perform(MockMvcRequestBuilders<br>
.è¯·æ±‚æ–¹å¼(â€œurlâ€).param(â€œé”®â€,â€œå€¼â€).contentType(MediaType.APPLICATION_FORM_URLENCODED)</p>
<ul>
<li>JSONè¯·æ±‚</li>
</ul>
<p>mockMvc.perform(MockMvcRequestBuilders<br>
.è¯·æ±‚æ–¹å¼ï¼Œä¸€èˆ¬ä¸ºPOST(â€œurlâ€).content(JSONObject.toJSONString(map)).contentType(.contentType(MediaType.APPLICATION_JSON))</p>
<p>æµ‹è¯•è¿‡ç¨‹å¦‚ä¸‹ï¼š<br>
1ã€å‡†å¤‡æµ‹è¯•ç¯å¢ƒ<br>
2ã€é€šè¿‡<code>MockMvc</code>æ‰§è¡Œè¯·æ±‚<br>
3.æ·»åŠ éªŒè¯æ–­è¨€<br>
4.æ·»åŠ ç»“æœå¤„ç†å™¨<br>
5.å¾—åˆ°MvcResultè¿›è¡Œè‡ªå®šä¹‰æ–­è¨€/è¿›è¡Œä¸‹ä¸€æ­¥çš„å¼‚æ­¥è¯·æ±‚<br>
6.å¸è½½æµ‹è¯•ç¯å¢ƒ</p>
<h3 id="ç¬¬äºŒç§ä½¿ç”¨çœŸå®Webç¯å¢ƒè¿›è¡Œæµ‹è¯•">ç¬¬äºŒç§ä½¿ç”¨çœŸå®Webç¯å¢ƒè¿›è¡Œæµ‹è¯•</h3>
<p>åœ¨@SpringBootTestæ³¨è§£ä¸­è®¾ç½®å±æ€§ webEnvironment = WebEnvironment.RANDOM_PORT,æ¯æ¬¡è¿è¡Œçš„æ—¶å€™ä¼šéšæœºé€‰æ‹©ä¸€ä¸ªå¯ç”¨ç«¯å£ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥è¿˜ä½¿ç”¨ @LoalServerPortæ³¨è§£ç”¨äºæœ¬åœ°ç«¯å£å·ã€‚ä¸‹é¢æ˜¯æµ‹è¯•ä»£ç :</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span>(<span class="title">webEnvironment</span> </span>= SpringBootTest.WebEnvironment.RANDOM_PORT)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserControllerTest3</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restemplate;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">userMapping</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setNickName(<span class="string">"pj_pj"</span>);</span><br><span class="line">        user.setPassword(<span class="string">"12345678"</span>);</span><br><span class="line">        ResponseEntity&lt;String&gt; responseEntity = testRestTemplate.postForEntity(<span class="string">"/user"</span>, user, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(<span class="string">"Result: "</span>+responseEntity.getBody());</span><br><span class="line">        System.out.println(<span class="string">"çŠ¶æ€ç : "</span>+responseEntity.getStatusCodeValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç ä¸­æœ‰ä¸€ä¸ªå…³é”®çš„ç±»â€”â€”TestRestTemplate, TestRestTemplateæ˜¯Springçš„RestTemplateçš„ä¸€ç§æ›¿ä»£å“ï¼Œå¯ç”¨äºé›†æˆæµ‹è¯•ï¼Œæ›´RestTemplateçš„ä½¿ç”¨åŠŸèƒ½æ–¹æ³•ç±»ä¼¼ï¼Œä¸€èˆ¬ç”¨äºçœŸå®webç¯å¢ƒæµ‹è¯•ä¸­ï¼Œå…³äºè¯¥ç±»æ›´åŠ è¯¦ç»†çš„ç”¨æ³•å‚è€ƒ<a href="https://docs.spring.io/spring-boot/docs/2.0.4.RELEASE/reference/htmlsingle/#boot-features-test-scope-dependencies" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<h2 id="å¸¸ç”¨æ³¨è§£ä»‹ç»">å¸¸ç”¨æ³¨è§£ä»‹ç»</h2>
<p><code>@SpringBootTest</code>æ˜¯<code>SpringBoot</code>çš„ä¸€ä¸ªç”¨äºæµ‹è¯•çš„æ³¨è§£ï¼Œé€šè¿‡<code>SpringApplication</code>åœ¨æµ‹è¯•ä¸­åˆ›å»º<code>ApplicationContext</code>ã€‚<br>
<code>@AutoConfigureMockMvc</code>æ˜¯ç”¨äºè‡ªåŠ¨é…ç½®MockMvcã€‚<br>
<code>@RunWithåœ¨JUnit</code>ä¸­æœ‰å¾ˆå¤šä¸ª<code>Runner</code>ï¼Œä»–ä»¬è´Ÿè´£è°ƒç”¨ä½ çš„æµ‹è¯•ä»£ç ï¼Œæ¯ä¸€ä¸ª<code>Runner</code>éƒ½æœ‰å„è‡ªçš„ç‰¹æ®ŠåŠŸèƒ½ï¼Œä½ è¦æ ¹æ®éœ€è¦é€‰æ‹©ä¸åŒçš„Runneræ¥è¿è¡Œä½ çš„æµ‹è¯•ä»£ç ã€‚<br>
<code>@Before</code>åœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•å‰æ‰§è¡Œï¼Œä¸€èˆ¬ç”¨æ¥åˆå§‹åŒ–æ–¹æ³•ã€‚<br>
<code>@After</code>åœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•åæ‰§è¡Œï¼Œåœ¨æ–¹æ³•æ‰§è¡Œå®Œæˆåè¦åšçš„äº‹æƒ…ã€‚</p>
<h2 id="ä¸»è¦ä»£ç ">ä¸»è¦ä»£ç </h2>
<p>å¼•å…¥æµ‹è¯•jaråŒ…</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class">@<span class="title">AutoConfigureMockMvc</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">UserControllerTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span> <span class="comment">//æµ‹è¯•å‰</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//å…ˆæ³¨å†Œä¸€ä¸ªuserå¯¹è±¡</span></span><br><span class="line">        String JSON =</span><br><span class="line">                <span class="string">"&#123;\"nickName\":\"å²—æ‘ä¸€æ³½\",\"lastName\":\"å²—æ‘\",\"firstName\":\"ä¸€æ³½\",\"email\":\"gangcunyiza@gmail.com\",\"password\":\"12345678\",\"jpFirstName\":\"ä¸€æ³½\",\"jpLastName\":\"å²—æ‘\"&#125;"</span>;</span><br><span class="line">        Mockito.when(userService.findByEmailAndStatus(<span class="string">"gangcunyiza@gmail.com.com"</span>,<span class="number">1</span>)).thenReturn(user);</span><br><span class="line">        Mockito.when(userRepository.findByNickNameAndStatus(<span class="string">"å²—æ‘ä¸€æ³½"</span>,<span class="number">1</span>)).thenReturn(user);</span><br><span class="line">        mockMvc.perform(MockMvcRequestBuilders.post(<span class="string">"/registe"</span>)</span><br><span class="line">                .accept(MediaType.APPLICATION_JSON).content(JSON)</span><br><span class="line">                .contentType(MediaType.APPLICATION_JSON))</span><br><span class="line">                .andExpect(status().isOk())</span><br><span class="line">                .andReturn();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@After</span> <span class="comment">//æµ‹è¯•å</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tearDown</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String JSON = <span class="string">"&#123;\"email\":\"gangcunyiza@gmail.com.com\",\"password\":\"12345678\"&#125;"</span>;</span><br><span class="line">                mockMvc.perform(MockMvcRequestBuilders.post(<span class="string">"/login"</span>)</span><br><span class="line">                        .accept(MediaType.APPLICATION_JSON).content(JSON)</span><br><span class="line">                        .contentType(MediaType.APPLICATION_JSON))</span><br><span class="line">                .andExpect(status().isOk())<span class="comment">//æ–­è¨€è¯·æ±‚çŠ¶æ€</span></span><br><span class="line">                        .andReturn();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦å¤–ï¼Œå¦‚æœæ˜¯åªæƒ³å…³æ³¨Webå±‚è€Œä¸æ˜¯å¯åŠ¨å®Œæ•´çš„<code>ApplicationContext</code>,å¯ä»¥è€ƒè™‘ä½¿ç”¨<code>@WebMvcTest</code>æ³¨è§£ï¼Œè¯¥æ³¨è§£ä¸èƒ½ä¸@<code>SpringBootTest</code>æ­é…ä½¿ç”¨ï¼Œè€Œä¸”å®ƒåªå…³æ³¨Webå±‚é¢ï¼Œè‡³äºæ¶‰åŠåˆ°æ•°æ®å±‚çš„æ—¶å€™ï¼Œéœ€è¦å¼•å…¥ç›¸å…³ä¾èµ–ï¼Œå…³äºè¿™ä¸ªæ³¨è§£æ›´å¤šçš„ä»‹ç»è¯·å‚é˜…<a href="https://docs.spring.io/spring-boot/docs/2.0.4.RELEASE/reference/htmlsingle/#boot-features-testing-spring-boot-applications-testing-autoconfigured-mvc-tests" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></p>
<h2 id="å•å…ƒæµ‹è¯•å›æ»š">å•å…ƒæµ‹è¯•å›æ»š</h2>
<p>å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œå¦‚æœä¸æƒ³é€ æˆåƒåœ¾æ•°æ®ï¼Œå¯ä»¥å¼€å¯äº‹åŠ¡åŠŸèƒ½ï¼Œåœ¨æ–¹æ³•æˆ–ç±»å¤´éƒ¨æ·»åŠ <code>@Transactional</code>æ³¨è§£å³å¯ï¼Œåœ¨å®˜æ–¹æ–‡æ¡£ä¸­å¯¹æ­¤ä¹Ÿæœ‰è¯´æ˜ã€‚å¦‚æœä½ æƒ³å…³é—­å›æ»šï¼Œåªè¦åŠ ä¸Š @Rollback(false)æ³¨è§£å³å¯ã€‚<br>
è¿˜æœ‰ä¸€ç§æƒ…å†µéœ€è¦æ³¨æ„ï¼Œå°±æ˜¯å¦‚æœä½ ä½¿ç”¨çš„æ•°æ®åº“æ˜¯MySQL,æœ‰æ—¶å€™ä¼šå‘ç°åŠ äº†æ³¨è§£ @Transactionlä¹Ÿä¸ä¼šå›æ»šï¼Œé‚£ä¹ˆä½ å°±è¦æŸ¥çœ‹ä¸€ä¸‹ä½ çš„é»˜è®¤å¼•æ“æ˜¯ä¸æ˜¯InnoDB,å¦‚æœä¸æ˜¯å°±è¦æ”¹æˆ InnoDBã€‚<br>
MyISAM ä¸ InnoDBæ˜¯mysqlç›®å‰æ¯”è¾ƒå¸¸ç”¨çš„ä¸¤ä¸ªæ•°æ®åº“å¼•æ“ï¼ŒMyISAMä¸InnoDBçš„ä¸»è¦çš„ä¸åŒç‚¹åœ¨äºæ€§èƒ½å’Œäº‹åŠ¡æ§åˆ¶ä¸Šï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸‹ä¸¤è€…çš„åŒºåˆ«ä¸è½¬æ¢æ–¹æ³•ï¼š</p>
<p>MyISAMï¼š MyISAMæ˜¯MySQL5.5ä¹‹å‰ç‰ˆæœ¬é»˜è®¤çš„æ•°æ®åº“å­˜å‚¨å¼•æ“ï¼ŒMyISAMæä¾›é«˜é€Ÿå­˜å‚¨å’Œæ£€ç´¢ï¼Œä»¥åŠå…¨æ–‡æœç´¢èƒ½åŠ›ï¼Œé€‚åˆæ•°æ®ä»“åº“ç­‰æŸ¥è¯¢é¢‘ç¹çš„åº”ç”¨ï¼Œä½†ä¸æ”¯æŒäº‹åŠ¡å’Œå¤–é”®ï¼Œä¸èƒ½åœ¨è¡¨æŸååæ¢å¤æ•°æ®<br>
InnoDB: InnoDBæ˜¯MySQL5.5ç‰ˆæœ¬çš„é»˜è®¤æ•°æ®åº“å­˜å‚¨å¼•æ“ï¼ŒInnoDBå…·æœ‰æäº¤ï¼Œå›æ»šå’Œå´©æºƒæ¢å¤èƒ½åŠ›çš„äº‹åŠ¡å®‰å…¨ï¼Œæ”¯æŒäº‹åŠ¡å’Œå¤–é”®ï¼Œæ¯”èµ·MyISAM,InnoDBå†™çš„å¤„ç†æ•ˆç‡å·®ä¸€äº›å¹¶ä¸”ä¼šå ç”¨æ›´å¤šçš„ç£ç›˜ç©ºé—´ä»¥ä¿ç•™æ•°æ®å’Œç´¢å¼•ã€‚</p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>hexoéƒ¨ç½²æ¨è</title>
    <url>/2018/07/28/hexo%E9%83%A8%E7%BD%B2%E6%8E%A8%E8%8D%90/</url>
    <content><![CDATA[<h2 id="ä¸€ä¸ªåšå®¢ä¸ºä»€ä¹ˆè¦å»ºä¸¤ä¸ªä»“åº“">ä¸€ä¸ªåšå®¢ä¸ºä»€ä¹ˆè¦å»ºä¸¤ä¸ªä»“åº“</h2>
<p>ä¹‹å‰æˆ‘çš„åšå®¢å°±ä¸€ä¸ªä»“åº“ï¼Œè¿˜æ˜¯å…¬æœ‰çš„ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæˆ‘å‘å¸ƒæ–‡ç« éƒ¨ç½²ä¹‹åæ‰€æœ‰äººéƒ½å¯ä»¥çœ‹æˆ‘çš„æºç åŠé…ç½®æ–‡ä»¶ğŸ˜Ÿã€‚è¿™æ˜¯ç»å¯¹ä¸èƒ½å…è®¸çš„ï¼Œå¹¶ä¸æ˜¯å°ç¼–æˆ‘å¤ªå°æ°”ï¼Œå°±æ˜¯æ€•æœ‰äº›æŠ•æœºå–å·§ä¸åŠ³è€Œè·çš„äººç›´æ¥copyæˆ‘çš„æºç å‘è¡¨ï¼Œå²‚ä¸æ˜¯ä¾¿å®œäº†ä»–ï¼Œè¿™æ ·çš„äººå¤§å®¶éƒ½ä¸å–œæ¬¢å§ï¼Ÿå¥½äº†ï¼ŒåºŸè¯å°‘è¯´ï¼Œå¼€å§‹æ­¥å…¥æ­£é¢˜ğŸ˜€ã€‚</p>
<a id="more"></a>
<h2 id="æ“ä½œæ­¥éª¤">æ“ä½œæ­¥éª¤</h2>
<p><a href="http://xn--jiangfumei-0b4pt84bvza161dhjholcjyqxlqlos7vf640a5x7c.github.io" target="_blank" rel="noopener">æ¯”å¦‚åŸæ¥æˆ‘çš„åšå®¢ä»“åº“å°±æ˜¯jiangfumei.github.io</a>,è¿™ä¸ªä»“åº“æ˜¯å…¬æœ‰çš„ã€‚æˆ‘éœ€è¦åœ¨githubä¸Šå†æ–°å»ºä¸€ä¸ªç§æœ‰ä»“åº“ï¼Œæˆ‘æ–°å»ºçš„ä»“åº“åå­—æ˜¯MyBlog,ç„¶åæœ¬åœ°cloneä¸‹æ¥ï¼Œç°åœ¨ä¸ºæ­¢ï¼Œå°ç¼–è¿˜æ˜¯å»ºè®®æŠŠåŸæ¥çš„åšå®¢ä»“åº“å¤‡ä»½ä¸€ä¸‹ï¼Œä¿è¯ä¸‡æ— ä¸€å¤±å—ğŸ˜ã€‚<br>
ç„¶ååœ¨å…¬æœ‰ä»“åº“jiangfumei.github.ioæ ¹ç›®å½•ä¸‹çš„_config.ymlçš„deployé…ç½®ä¸­å¢åŠ ä½ çš„ä»“åº“åœ°å€ï¼Œå¦‚ä¸‹å›¾ï¼š<br>
<img src="/images/blogdeploy.png" alt=""><br>
åœ¨jiangfumei.github.ioæ ¹ç›®å½•ä¸‹<code>hexo g -d</code>å³å¯ã€‚<br>
ç™»å…¥githubç½‘é¡µï¼ŒæŸ¥çœ‹ç§æœ‰ä»“åº“å…¬æœ‰ä»“åº“å‘ç°å·²ç»å’Œä½ æœŸæœ›çš„é‚£æ ·å•¦ï¼<br>
<img src="/images/blogcommon.png" alt=""><br>
<img src="/images/blogprivate.png" alt=""></p>
<h2 id="é—®é¢˜åŠå»ºè®®">é—®é¢˜åŠå»ºè®®</h2>
<p>åœ¨å®è·µä¸­ï¼Œæˆ‘ç¢°åˆ°æ¯æ¬¡<code>hexo g -d</code>å…¬æœ‰åº“ç”Ÿæˆçš„ç›®å½•ç»“æ„ç«Ÿç„¶å’Œç§æœ‰åº“ä¸€æ ·ï¼Œé‚£åˆ°åº•æ˜¯ä»€ä¹ˆåŸå› æ˜µï¼ŸåŸæ¥æ˜¯_congig.ymlçš„public_diré…ç½®é”™è¯¯ï¼Œå¼€å§‹é…çš„æ˜¯./public_ã€‚æ”¹ä¸º<code>public</code>.<br>
å…¶æ¬¡ï¼Œå°ç¼–å»ºè®®é€‰æ‹©Netlifyä¸ºæ‰˜ç®¡å¹³å°ã€‚Netlifyæ˜¯ä¸€å®¶å›½å¤–çš„é™æ€ç½‘ç«™çš„æ‰˜ç®¡å¹³å°ï¼Œæä¾›å…è´¹çš„httpsï¼Œè‡ªåŠ¨åŒ–éƒ¨ç½²å’Œå‡çº§ï¼Œå¯ä»¥ç›‘æ§GitHubã€GitLabæˆ–è€…Bitbucketåšåˆ°è‡ªåŠ¨æ›´æ–°å‘å¸ƒã€‚é›†æˆè¿‡ç¨‹ç½‘ä¸Šåˆ°å¤„éƒ½æ˜¯ï¼Œè¿™é‡Œä¸å†å™è¿°ã€‚</p>
]]></content>
      <categories>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Javaååºåˆ—åŒ–ä¹‹DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES</title>
    <url>/2018/07/12/serlize/</url>
    <content><![CDATA[<h2 id="Java-ååºåˆ—åŒ–">Java ååºåˆ—åŒ–</h2>
<p><code>private static final ObjectMapper mapper = new ObjectMapper().configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);</code><br>
<code>DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES</code>å±æ€§é»˜è®¤ä¸ºtrueå¼€å¯çŠ¶æ€ï¼Œå½“å±æ€§ä¸ºtrueæ—¶ï¼Œè¡¨ç¤ºåœ¨ååºåˆ—åŒ–æ—¶é‡åˆ°æœªçŸ¥å±æ€§(å±æ€§æ²¡æœ‰å¯¹åº”çš„ç±»å±æ€§æ¥æ˜ å°„,å¹¶ä¸”æ²¡æœ‰ä»»ä½•setteræˆ–handleræ¥å¤„ç†è¿™æ ·çš„å±æ€§)æ—¶ä¼šå¼•èµ·ç»“æœå¤±è´¥(é€šè¿‡æŠ›JsonMappingExceptionå¼‚<br>
å¿½ç•¥ä¸éœ€è¦çš„å­—ä½“<br>
æœ‰æ—¶å€™ï¼Œè¿”å›çš„JSONå­—ç¬¦ä¸²ä¸­å«æœ‰æˆ‘ä»¬å¹¶ä¸éœ€è¦çš„å­—æ®µï¼Œé‚£ä¹ˆå½“å¯¹åº”çš„å®ä½“ç±»ä¸­ä¸å«æœ‰è¯¥å­—æ®µæ—¶ï¼Œä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œå‘Šè¯‰ä½ æœ‰äº›å­—æ®µæ²¡æœ‰åœ¨å®ä½“ç±»ä¸­æ‰¾åˆ°ã€‚è§£å†³åŠæ³•å¾ˆç®€å•ï¼Œåœ¨å£°æ˜ObjectMapperä¹‹åï¼ŒåŠ ä¸Šä¸‹è¿°ä»£ç ï¼š</p>
<a id="more"></a>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper().configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, ExProduct&gt; <span class="title">getExProduct</span><span class="params">(RedisService redisService)</span> </span>&#123;</span><br><span class="line">       Map&lt;String, String&gt; productJson = redisService.getMap(<span class="string">"HRY:EXCHANGE:PRODUCT"</span>);</span><br><span class="line">       Map&lt;String, ExProduct&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">       productJson.forEach((k, v) -&gt; &#123;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               ExProduct product = mapper.readValue(v, ExProduct<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">               map.put(k, product);</span><br><span class="line">           &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">       <span class="keyword">return</span> map;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h4 id="è¡¥å……">è¡¥å……</h4>
<p>å¯¹äºç»“æ„å›ºå®šçš„JSONï¼Œä½¿ç”¨ObjectMapperç»“åˆæŸä¸ªé¢„å…ˆå®šä¹‰çš„å®ä½“ç±»å‹å¯ä»¥éå¸¸æ–¹ä¾¿åœ°å®Œæˆååºåˆ—åŒ–å·¥ä½œï¼Œæ¯”å¦‚å¯¹ä¸‹é¢è¿™æ ·çš„JSONï¼š</p>
<p>GET /person/1</p>
<p>{<br>
â€œidâ€: â€œ1â€,<br>
â€œnameâ€: â€œdm_vincentâ€,<br>
â€œageâ€: â€œ28â€<br>
}</p>
<p>ç»“åˆä¸€ä¸ªå®ä½“ç±»å‹ï¼Œå¯ä»¥å¾ˆè½»æ¾çš„å®Œæˆååºåˆ—åŒ–å·¥ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> id;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> age;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getEntity</span><span class="params">(String jsonString, Class&lt;T&gt; prototype)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> (T) objectMapper.readValue(jsonString, prototype);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯åœ¨æŸäº›æ”¯æŒä¸€æ¬¡æ€§è·å–å¤šæ¡è®°å½•çš„APIä¸­ï¼Œå°±å‡ºç°é—®é¢˜äº†ã€‚æ¯”å¦‚æ‹¥æœ‰ä¸‹é¢è¿™ç§æ ¼å¼çš„APIï¼š</p>
<p>GET /person/1,2,3</p>
<p>{<br>
â€œdm_vincentâ€: {<br>
â€œidâ€: â€œ1â€,<br>
â€œnameâ€: â€œdm_vincentâ€,<br>
â€œageâ€: â€œ28â€<br>
},<br>
â€œdm_vincent2â€: {<br>
â€œidâ€: â€œ2â€,<br>
â€œnameâ€: â€œdm_vincent2â€,<br>
â€œageâ€: â€œ29â€<br>
},<br>
â€œdm_vincent3â€: {<br>
â€œidâ€: â€œ3â€,<br>
â€œnameâ€: â€œdm_vincent3â€,<br>
â€œageâ€: â€œ30â€<br>
}<br>
}<br>
è™½ç„¶éœ€è¦è·å–çš„å®ä½“ç±»å‹è¿˜æ˜¯é‚£ä¸ªPersonç±»ï¼Œå¯æ˜¯è¿™ä¸ªæ—¶å€™å°±ä¸åƒä¸Šé¢é‚£æ ·ç®€å•æ˜äº†äº†ã€‚æ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç åœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¼šå‡ºç°é—®é¢˜ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonWrapper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Person&gt; persons;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çš„æ„å›¾æ˜¯æ˜ç¡®çš„ï¼Œå°†è¿”å›çš„å¤šä¸ªPersonå®ä½“å¯¹è±¡æ”¾åˆ°ä¸€ä¸ªMapç»“æ„ä¸­ã€‚ä½†æ˜¯é—®é¢˜å°±åœ¨äºè¿”å›çš„JSONä¸­çš„keysæ˜¯ä¸å›ºå®šçš„(æ¯”å¦‚ä¸Šè¿°JSONä¸­çš„keysæ˜¯äººå)ï¼Œè¿™å¯¼è‡´ååºåˆ—åŒ–å¤±è´¥ã€‚æ¯•ç«Ÿé»˜è®¤é…ç½®ä¸‹çš„ObjectMapperä¹Ÿæ²¡æœ‰èªæ˜åˆ°è¿™ç§ç¨‹åº¦ï¼Œèƒ½å¤ŸçŒœæµ‹ä½ æ˜¯æƒ³è¦å°†å¤šä¸ªå®ä½“æ”¾åˆ°Mapä¸­ã€‚</p>
<p>æ­£ç¡®çš„åšæ³•ä¹‹ä¸€æ˜¯ä½¿ç”¨ObjectMapperçš„readTreeæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">EntityWrapper&lt;T&gt; <span class="title">getEntityWrapper</span><span class="params">(String jsonString, Class&lt;T&gt; prototype)</span> </span>&#123;</span><br><span class="line">    ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">    EntityWrapper&lt;T&gt; wrapper = <span class="keyword">new</span> EntityWrapper&lt;T&gt;();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      JsonNode root = objectMapper.readTree(jsonString);</span><br><span class="line">      Iterator&lt;Entry&lt;String, JsonNode&gt;&gt; elements = root.fields();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">while</span> (elements.hasNext()) &#123;</span><br><span class="line">        Entry&lt;String, JsonNode&gt; node = elements.next();</span><br><span class="line">        String key = node.getKey();</span><br><span class="line">        T element = objectMapper.readValue(node.getValue().toString(), prototype);</span><br><span class="line">        wrapper.addEntry(key, element);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> wrapper;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>ç®€å•è§£é‡Šä¸€ä¸‹ä¸Šè¿°ä»£ç ï¼š<br>
ä½¿ç”¨<code>root.field()</code>æ–¹æ³•èƒ½å¤Ÿå¾—åˆ°è¿”å›çš„JSONä¸­çš„æ‰€æœ‰key-valueå¯¹ã€‚<br>
ç„¶åå¾ªç¯æå–æŸä¸ªé”®å€¼å¯¹çš„keyå’Œvalueï¼Œå¯¹äºvalueæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ä¹‹å‰çš„ç­–ç•¥è¿›è¡Œååºåˆ—åŒ–ï¼Œå› ä¸ºè¿™éƒ¨åˆ†çš„ç»“æ„ä¹Ÿæ˜¯å›ºå®šçš„ã€‚</p>
]]></content>
      <categories>
        <category>Java</category>
        <category>Javaé«˜çº§</category>
      </categories>
      <tags>
        <tag>Javaé«˜çº§</tag>
      </tags>
  </entry>
  <entry>
    <title>æ·±å…¥åˆ†æJavaçš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</title>
    <url>/2018/02/08/%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90Java%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    <content><![CDATA[<h2 id="JavaAPIä¸­çš„å®šä¹‰">JavaAPIä¸­çš„å®šä¹‰:</h2>
<p><code>public interface Serializable</code><br>
ç±»é€šè¿‡å®ç° <code>java.io.Serializable</code> æ¥å£ä»¥å¯ç”¨å…¶åºåˆ—åŒ–åŠŸèƒ½ã€‚æœªå®ç°æ­¤æ¥å£çš„ç±»å°†æ— æ³•ä½¿å…¶ä»»ä½•çŠ¶æ€åºåˆ—åŒ–æˆ–ååºåˆ—åŒ–ã€‚å¯åºåˆ—åŒ–ç±»çš„æ‰€æœ‰å­ç±»å‹æœ¬èº«éƒ½æ˜¯å¯åºåˆ—åŒ–çš„ã€‚åºåˆ—åŒ–æ¥å£æ²¡æœ‰æ–¹æ³•æˆ–å­—æ®µï¼Œä»…ç”¨äºæ ‡è¯†å¯åºåˆ—åŒ–çš„è¯­ä¹‰ã€‚<br>
è¦å…è®¸ä¸å¯åºåˆ—åŒ–ç±»çš„å­ç±»å‹åºåˆ—åŒ–ï¼Œå¯ä»¥å‡å®šè¯¥å­ç±»å‹è´Ÿè´£ä¿å­˜å’Œæ¢å¤è¶…ç±»å‹çš„å…¬ç”¨ <code>(public)</code>. å—ä¿æŠ¤çš„ <code>(protected)</code> å’Œï¼ˆå¦‚æœå¯è®¿é—®ï¼‰åŒ… <code>(package)</code> å­—æ®µçš„çŠ¶æ€ã€‚ä»…åœ¨å­ç±»å‹æ‰©å±•çš„ç±»æœ‰ä¸€ä¸ªå¯è®¿é—®çš„æ— å‚æ•°æ„é€ æ–¹æ³•æ¥åˆå§‹åŒ–è¯¥ç±»çš„çŠ¶æ€æ—¶ï¼Œæ‰å¯ä»¥å‡å®šå­ç±»å‹æœ‰æ­¤èŒè´£ã€‚å¦‚æœä¸æ˜¯è¿™ç§æƒ…å†µï¼Œåˆ™å£°æ˜ä¸€ä¸ªç±»ä¸ºå¯åºåˆ—åŒ–ç±»æ˜¯é”™è¯¯çš„ã€‚è¯¥é”™è¯¯å°†åœ¨è¿è¡Œæ—¶æ£€æµ‹åˆ°ã€‚</p>
<a id="more"></a>
<p>åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œå°†ä½¿ç”¨è¯¥ç±»çš„å…¬ç”¨æˆ–å—ä¿æŠ¤çš„æ— å‚æ•°æ„é€ æ–¹æ³•åˆå§‹åŒ–ä¸å¯åºåˆ—åŒ–ç±»çš„å­—æ®µã€‚å¯åºåˆ—åŒ–çš„å­ç±»å¿…é¡»èƒ½å¤Ÿè®¿é—®æ— å‚æ•°æ„é€ æ–¹æ³•ã€‚å¯åºåˆ—åŒ–å­ç±»çš„å­—æ®µå°†ä»è¯¥æµä¸­æ¢å¤ã€‚<br>
å½“éå†ä¸€ä¸ªå›¾å½¢æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°ä¸æ”¯æŒ Serializable æ¥å£çš„å¯¹è±¡ã€‚åœ¨æ­¤æƒ…å†µä¸‹ï¼Œå°†æŠ›å‡º <code>NotSerializableException</code>ï¼Œå¹¶å°†æ ‡è¯†ä¸å¯åºåˆ—åŒ–å¯¹è±¡çš„ç±»ã€‚<br>
åœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–è¿‡ç¨‹ä¸­éœ€è¦ç‰¹æ®Šå¤„ç†çš„ç±»å¿…é¡»ä½¿ç”¨ä¸‹åˆ—å‡†ç¡®ç­¾åæ¥å®ç°ç‰¹æ®Šæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(java.io.ObjectOutputStream out)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream in)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, ClassNotFoundException</span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObjectNoData</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> ObjectStreamException</span>;</span><br></pre></td></tr></table></figure>
<p><code>writeObject</code> æ–¹æ³•è´Ÿè´£å†™å…¥ç‰¹å®šç±»çš„å¯¹è±¡çš„çŠ¶æ€ï¼Œä»¥ä¾¿ç›¸åº”çš„ readObject æ–¹æ³•å¯ä»¥æ¢å¤å®ƒã€‚é€šè¿‡è°ƒç”¨ <code>out.defaultWriteObject</code> å¯ä»¥è°ƒç”¨ä¿å­˜ <code>Object</code> çš„å­—æ®µçš„é»˜è®¤æœºåˆ¶ã€‚è¯¥æ–¹æ³•æœ¬èº«ä¸éœ€è¦æ¶‰åŠå±äºå…¶è¶…ç±»æˆ–å­ç±»çš„çŠ¶æ€ã€‚é€šè¿‡ä½¿ç”¨ <code>writeObject</code> æ–¹æ³•æˆ–ä½¿ç”¨ <code>DataOutput</code> æ”¯æŒçš„ç”¨äºåŸºæœ¬æ•°æ®ç±»å‹çš„æ–¹æ³•å°†å„ä¸ªå­—æ®µå†™å…¥ <code>ObjectOutputStream</code>ï¼ŒçŠ¶æ€å¯ä»¥è¢«ä¿å­˜ã€‚</p>
<!-- more -->
<p><code>readObject</code> æ–¹æ³•è´Ÿè´£ä»æµä¸­è¯»å–å¹¶æ¢å¤ç±»å­—æ®µã€‚å®ƒå¯ä»¥è°ƒç”¨ <code>in.defaultReadObject</code> æ¥è°ƒç”¨é»˜è®¤æœºåˆ¶ï¼Œä»¥æ¢å¤å¯¹è±¡çš„éé™æ€å’Œéç¬æ€å­—æ®µã€‚<code>defaultReadObject </code>æ–¹æ³•ä½¿ç”¨æµä¸­çš„ä¿¡æ¯æ¥åˆ†é…æµä¸­é€šè¿‡å½“å‰å¯¹è±¡ä¸­ç›¸åº”æŒ‡å®šå­—æ®µä¿å­˜çš„å¯¹è±¡çš„å­—æ®µã€‚è¿™ç”¨äºå¤„ç†ç±»æ¼”åŒ–åéœ€è¦æ·»åŠ æ–°å­—æ®µçš„æƒ…å½¢ã€‚è¯¥æ–¹æ³•æœ¬èº«ä¸éœ€è¦æ¶‰åŠå±äºå…¶è¶…ç±»æˆ–å­ç±»çš„çŠ¶æ€ã€‚é€šè¿‡ä½¿ç”¨ writeObject æ–¹æ³•æˆ–ä½¿ç”¨ <code>DataOutput</code> æ”¯æŒçš„ç”¨äºåŸºæœ¬æ•°æ®ç±»å‹çš„æ–¹æ³•å°†å„ä¸ªå­—æ®µå†™å…¥ <code>ObjectOutputStream</code>ï¼ŒçŠ¶æ€å¯ä»¥è¢«ä¿å­˜ã€‚</p>
<p>åœ¨åºåˆ—åŒ–æµä¸åˆ—å‡ºç»™å®šç±»ä½œä¸ºå°†è¢«ååºåˆ—åŒ–å¯¹è±¡çš„è¶…ç±»çš„æƒ…å†µä¸‹ï¼Œ<code>readObjectNoData</code> æ–¹æ³•è´Ÿè´£åˆå§‹åŒ–ç‰¹å®šç±»çš„å¯¹è±¡çŠ¶æ€ã€‚è¿™åœ¨æ¥æ”¶æ–¹ä½¿ç”¨çš„ååºåˆ—åŒ–å®ä¾‹ç±»çš„ç‰ˆæœ¬ä¸åŒäºå‘é€æ–¹ï¼Œå¹¶ä¸”æ¥æ”¶è€…ç‰ˆæœ¬æ‰©å±•çš„ç±»ä¸æ˜¯å‘é€è€…ç‰ˆæœ¬æ‰©å±•çš„ç±»æ—¶å‘ç”Ÿã€‚åœ¨åºåˆ—åŒ–æµå·²ç»è¢«ç¯¡æ”¹æ—¶ä¹Ÿå°†å‘ç”Ÿï¼›å› æ­¤ï¼Œä¸ç®¡æºæµæ˜¯â€œæ•Œæ„çš„â€è¿˜æ˜¯ä¸å®Œæ•´çš„ï¼Œ<code>readObjectNoData</code> æ–¹æ³•éƒ½å¯ä»¥ç”¨æ¥æ­£ç¡®åœ°åˆå§‹åŒ–ååºåˆ—åŒ–çš„å¯¹è±¡ã€‚</p>
<p>å°†å¯¹è±¡å†™å…¥æµæ—¶éœ€è¦æŒ‡å®šè¦ä½¿ç”¨çš„æ›¿ä»£å¯¹è±¡çš„å¯åºåˆ—åŒ–ç±»ï¼Œåº”ä½¿ç”¨å‡†ç¡®çš„ç­¾åæ¥å®ç°æ­¤ç‰¹æ®Šæ–¹æ³•ï¼š</p>
<p><code>ANY-ACCESS-MODIFIER Object writeReplace() throws ObjectStreamException;</code></p>
<p>æ­¤ <code>writeReplace</code> æ–¹æ³•å°†ç”±åºåˆ—åŒ–è°ƒç”¨ï¼Œå‰ææ˜¯å¦‚æœæ­¤æ–¹æ³•å­˜åœ¨ï¼Œè€Œä¸”å®ƒå¯ä»¥é€šè¿‡è¢«åºåˆ—åŒ–å¯¹è±¡çš„ç±»ä¸­å®šä¹‰çš„ä¸€ä¸ªæ–¹æ³•è®¿é—®ã€‚å› æ­¤ï¼Œè¯¥æ–¹æ³•å¯ä»¥æ‹¥æœ‰ç§æœ‰ <code>(private)</code>. å—ä¿æŠ¤çš„ (protected) å’ŒåŒ…ç§æœ‰ <code>(package-private)</code> è®¿é—®ã€‚å­ç±»å¯¹æ­¤æ–¹æ³•çš„è®¿é—®éµå¾ª java è®¿é—®è§„åˆ™ã€‚</p>
<p>åœ¨ä»æµä¸­è¯»å–ç±»çš„ä¸€ä¸ªå®ä¾‹æ—¶éœ€è¦æŒ‡å®šæ›¿ä»£çš„ç±»åº”ä½¿ç”¨çš„å‡†ç¡®ç­¾åæ¥å®ç°æ­¤ç‰¹æ®Šæ–¹æ³•ã€‚</p>
<p><code>ANY-ACCESS-MODIFIER Object readResolve() throws ObjectStreamException;</code></p>
<p>æ­¤ <code>readResolve</code> æ–¹æ³•éµå¾ªä¸ <code>writeReplace</code> ç›¸åŒçš„è°ƒç”¨è§„åˆ™å’Œè®¿é—®è§„åˆ™ã€‚</p>
<p>åºåˆ—åŒ–è¿è¡Œæ—¶ä½¿ç”¨ä¸€ä¸ªç§°ä¸º <code>serialVersionUID</code> çš„ç‰ˆæœ¬å·ä¸æ¯ä¸ªå¯åºåˆ—åŒ–ç±»ç›¸å…³è”ï¼Œè¯¥åºåˆ—å·åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ç”¨äºéªŒè¯åºåˆ—åŒ–å¯¹è±¡çš„å‘é€è€…å’Œæ¥æ”¶è€…æ˜¯å¦ä¸ºè¯¥å¯¹è±¡åŠ è½½äº†ä¸åºåˆ—åŒ–å…¼å®¹çš„ç±»ã€‚å¦‚æœæ¥æ”¶è€…åŠ è½½çš„è¯¥å¯¹è±¡çš„ç±»çš„ <code>serialVersionUID</code> ä¸å¯¹åº”çš„å‘é€è€…çš„ç±»çš„ç‰ˆæœ¬å·ä¸åŒï¼Œåˆ™ååºåˆ—åŒ–å°†ä¼šå¯¼è‡´ <code>InvalidClassException</code>ã€‚å¯åºåˆ—åŒ–ç±»å¯ä»¥é€šè¿‡å£°æ˜åä¸º â€œ<code>serialVersionUID</code>â€ çš„å­—æ®µï¼ˆè¯¥å­—æ®µå¿…é¡»æ˜¯é™æ€ <code>(static)</code>. æœ€ç»ˆ <code>(final)</code> çš„ long å‹å­—æ®µï¼‰æ˜¾å¼å£°æ˜å…¶è‡ªå·±çš„ <code>serialVersionUID</code>ï¼š</p>
<p><code>ANY-ACCESS-MODIFIER static final long serialVersionUID = 42L;</code></p>
<p>å¦‚æœå¯åºåˆ—åŒ–ç±»æœªæ˜¾å¼å£°æ˜ <code>serialVersionUID</code>ï¼Œåˆ™åºåˆ—åŒ–è¿è¡Œæ—¶å°†åŸºäºè¯¥ç±»çš„å„ä¸ªæ–¹é¢è®¡ç®—è¯¥ç±»çš„é»˜è®¤ <code>serialVersionUID </code>å€¼ï¼Œå¦‚â€œJavaâ„¢ å¯¹è±¡åºåˆ—åŒ–è§„èŒƒâ€ä¸­æ‰€è¿°ã€‚ä¸è¿‡ï¼Œå¼ºçƒˆå»ºè®® æ‰€æœ‰å¯åºåˆ—åŒ–ç±»éƒ½æ˜¾å¼å£°æ˜ <code>serialVersionUID</code> å€¼ï¼ŒåŸå› æ˜¯è®¡ç®—é»˜è®¤çš„ <code>serialVersionUID</code> å¯¹ç±»çš„è¯¦ç»†ä¿¡æ¯å…·æœ‰è¾ƒé«˜çš„æ•æ„Ÿæ€§ï¼Œæ ¹æ®ç¼–è¯‘å™¨å®ç°çš„ä¸åŒå¯èƒ½åƒå·®ä¸‡åˆ«ï¼Œè¿™æ ·åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå¯¼è‡´æ„å¤–çš„ <code>InvalidClassException</code>ã€‚å› æ­¤ï¼Œä¸ºä¿è¯ <code>serialVersionUID</code> å€¼è·¨ä¸åŒ java ç¼–è¯‘å™¨å®ç°çš„ä¸€è‡´æ€§ï¼Œåºåˆ—åŒ–ç±»å¿…é¡»å£°æ˜ä¸€ä¸ªæ˜ç¡®çš„ <code>serialVersionUID</code> å€¼ã€‚è¿˜å¼ºçƒˆå»ºè®®ä½¿ç”¨ <code>private</code> ä¿®é¥°ç¬¦æ˜¾ç¤ºå£°æ˜ <code>serialVersionUID</code>ï¼ˆå¦‚æœå¯èƒ½ï¼‰ï¼ŒåŸå› æ˜¯è¿™ç§å£°æ˜ä»…åº”ç”¨äºç›´æ¥å£°æ˜ç±» â€“ <code>serialVersionUID</code> å­—æ®µä½œä¸ºç»§æ‰¿æˆå‘˜æ²¡æœ‰ç”¨å¤„ã€‚æ•°ç»„ç±»ä¸èƒ½å£°æ˜ä¸€ä¸ªæ˜ç¡®çš„ <code>serialVersionUID</code>ï¼Œå› æ­¤å®ƒä»¬æ€»æ˜¯å…·æœ‰é»˜è®¤çš„è®¡ç®—å€¼ï¼Œä½†æ˜¯æ•°ç»„ç±»æ²¡æœ‰åŒ¹é… <code>serialVersionUID</code> å€¼çš„è¦æ±‚ã€‚<br>
ä»ä»¥ä¸‹ç‰ˆæœ¬å¼€å§‹ï¼š<br>
<code>JDK1.1</code></p>
<h1>æ·±å…¥åˆ†æJavaçš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h1>
<p>åºåˆ—åŒ–æ˜¯ä¸€ç§å¯¹è±¡æŒä¹…åŒ–çš„æ‰‹æ®µã€‚æ™®éåº”ç”¨åœ¨ç½‘ç»œä¼ è¾“. RMIç­‰åœºæ™¯ä¸­ã€‚æœ¬æ–‡é€šè¿‡åˆ†æArrayListçš„åºåˆ—åŒ–æ¥ä»‹ç»Javaåºåˆ—åŒ–çš„ç›¸å…³å†…å®¹ã€‚ä¸»è¦æ¶‰åŠåˆ°ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>
<p>æ€ä¹ˆå®ç°Javaçš„åºåˆ—åŒ–</p>
</li>
<li>
<p>ä¸ºä»€ä¹ˆå®ç°äº†java.io.Serializableæ¥å£æ‰èƒ½è¢«åºåˆ—åŒ–</p>
</li>
<li>
<p>transientçš„ä½œç”¨æ˜¯ä»€ä¹ˆ</p>
</li>
<li>
<p>æ€ä¹ˆè‡ªå®šä¹‰åºåˆ—åŒ–ç­–ç•¥</p>
</li>
<li>
<p>è‡ªå®šä¹‰çš„åºåˆ—åŒ–ç­–ç•¥æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„</p>
</li>
<li>
<p>ArrayListå¯¹åºåˆ—åŒ–çš„å®ç°æœ‰ä»€ä¹ˆå¥½å¤„</p>
</li>
</ul>
<h2 id="Javaå¯¹è±¡çš„åºåˆ—åŒ–">Javaå¯¹è±¡çš„åºåˆ—åŒ–</h2>
<p>Javaå¹³å°å…è®¸æˆ‘ä»¬åœ¨å†…å­˜ä¸­åˆ›å»ºå¯å¤ç”¨çš„Javaå¯¹è±¡ï¼Œä½†ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªæœ‰å½“JVMå¤„äºè¿è¡Œæ—¶ï¼Œè¿™äº›å¯¹è±¡æ‰å¯èƒ½å­˜åœ¨ï¼Œå³ï¼Œè¿™äº›å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸä¸ä¼šæ¯”JVMçš„ç”Ÿå‘½å‘¨æœŸæ›´é•¿ã€‚ä½†åœ¨ç°å®åº”ç”¨ä¸­ï¼Œå°±å¯èƒ½è¦æ±‚åœ¨JVMåœæ­¢è¿è¡Œä¹‹åèƒ½å¤Ÿä¿å­˜(æŒä¹…åŒ–)æŒ‡å®šçš„å¯¹è±¡ï¼Œå¹¶åœ¨å°†æ¥é‡æ–°è¯»å–è¢«ä¿å­˜çš„å¯¹è±¡ã€‚Javaå¯¹è±¡åºåˆ—åŒ–å°±èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å®ç°è¯¥åŠŸèƒ½ã€‚</p>
<p>ä½¿ç”¨Javaå¯¹è±¡åºåˆ—åŒ–ï¼Œåœ¨ä¿å­˜å¯¹è±¡æ—¶ï¼Œä¼šæŠŠå…¶çŠ¶æ€ä¿å­˜ä¸ºä¸€ç»„å­—èŠ‚ï¼Œåœ¨æœªæ¥ï¼Œå†å°†è¿™äº›å­—èŠ‚ç»„è£…æˆå¯¹è±¡ã€‚å¿…é¡»æ³¨æ„åœ°æ˜¯ï¼Œå¯¹è±¡åºåˆ—åŒ–ä¿å­˜çš„æ˜¯å¯¹è±¡çš„â€çŠ¶æ€â€ï¼Œå³å®ƒçš„æˆå‘˜å˜é‡ã€‚ç”±æ­¤å¯çŸ¥ï¼Œå¯¹è±¡åºåˆ—åŒ–ä¸ä¼šå…³æ³¨ç±»ä¸­çš„é™æ€å˜é‡ã€‚</p>
<p>é™¤äº†åœ¨æŒä¹…åŒ–å¯¹è±¡æ—¶ä¼šç”¨åˆ°å¯¹è±¡åºåˆ—åŒ–ä¹‹å¤–ï¼Œå½“ä½¿ç”¨RMI(è¿œç¨‹æ–¹æ³•è°ƒç”¨)ï¼Œæˆ–åœ¨ç½‘ç»œä¸­ä¼ é€’å¯¹è±¡æ—¶ï¼Œéƒ½ä¼šç”¨åˆ°å¯¹è±¡åºåˆ—åŒ–ã€‚Javaåºåˆ—åŒ–APIä¸ºå¤„ç†å¯¹è±¡åºåˆ—åŒ–æä¾›äº†ä¸€ä¸ªæ ‡å‡†æœºåˆ¶ï¼Œè¯¥APIç®€å•æ˜“ç”¨ã€‚</p>
<h2 id="å¦‚ä½•å¯¹Javaå¯¹è±¡è¿›è¡Œåºåˆ—åŒ–ä¸ååºåˆ—åŒ–">å¦‚ä½•å¯¹Javaå¯¹è±¡è¿›è¡Œåºåˆ—åŒ–ä¸ååºåˆ—åŒ–</h2>
<p>åœ¨Javaä¸­ï¼Œåªè¦ä¸€ä¸ªç±»å®ç°äº†java.io.Serializableæ¥å£ï¼Œé‚£ä¹ˆå®ƒå°±å¯ä»¥è¢«åºåˆ—åŒ–ã€‚è¿™é‡Œå…ˆæ¥ä¸€æ®µä»£ç ï¼š</p>
<p>code 1 åˆ›å»ºä¸€ä¸ªUserç±»ï¼Œç”¨äºåºåˆ—åŒ–åŠååºåˆ—åŒ–</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hollis;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by hollis on 16/2/2.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> Date birthday;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> String gender;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">6849794470754667710L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getBirthday</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> birthday;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBirthday</span><span class="params">(Date birthday)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.birthday = birthday;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getGender</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> gender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setGender</span><span class="params">(String gender)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.gender = gender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"User&#123;"</span> +</span><br><span class="line">                <span class="string">"name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", age="</span> + age +</span><br><span class="line">                <span class="string">", gender="</span> + gender +</span><br><span class="line">                <span class="string">", birthday="</span> + birthday +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>code 2 å¯¹Userè¿›è¡Œåºåˆ—åŒ–åŠååºåˆ—åŒ–çš„Demo</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hollis;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.FileUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.io.IOUtils;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by hollis on 16/2/2.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializableDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//Initializes The Object</span></span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setName(<span class="string">"hollis"</span>);</span><br><span class="line">        user.setGender(<span class="string">"male"</span>);</span><br><span class="line">        user.setAge(<span class="number">23</span>);</span><br><span class="line">        user.setBirthday(<span class="keyword">new</span> Date());</span><br><span class="line">        System.out.println(user);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Write Obj to File</span></span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"tempFile"</span>));</span><br><span class="line">            oos.writeObject(user);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            IOUtils.closeQuietly(oos);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Read Obj from File</span></span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"tempFile"</span>);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">            User newUser = (User) ois.readObject();</span><br><span class="line">            System.out.println(newUser);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            IOUtils.closeQuietly(ois);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                FileUtils.forceDelete(file);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>output</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">User&#123;name=<span class="string">'hollis'</span>, age=<span class="number">23</span>, gender=male, birthday=Tue Feb <span class="number">02</span> <span class="number">17</span>:<span class="number">37</span>:<span class="number">38</span> CST <span class="number">2016</span>&#125;</span><br><span class="line">User&#123;name=<span class="string">'hollis'</span>, age=<span class="number">23</span>, gender=<span class="keyword">null</span>, birthday=Tue Feb <span class="number">02</span> <span class="number">17</span>:<span class="number">37</span>:<span class="number">38</span> CST <span class="number">2016</span>&#125;</span><br></pre></td></tr></table></figure>
<h2 id="åºåˆ—åŒ–åŠååºåˆ—åŒ–ç›¸å…³çŸ¥è¯†">åºåˆ—åŒ–åŠååºåˆ—åŒ–ç›¸å…³çŸ¥è¯†</h2>
<ol>
<li>
<p>åœ¨Javaä¸­ï¼Œåªè¦ä¸€ä¸ªç±»å®ç°äº†java.io.Serializableæ¥å£ï¼Œé‚£ä¹ˆå®ƒå°±å¯ä»¥è¢«åºåˆ—åŒ–ã€‚</p>
</li>
<li>
<p>é€šè¿‡ObjectOutputStreamå’ŒObjectInputStreamå¯¹å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–åŠååºåˆ—åŒ–</p>
</li>
<li>
<p>è™šæ‹Ÿæœºæ˜¯å¦å…è®¸ååºåˆ—åŒ–ï¼Œä¸ä»…å–å†³äºç±»è·¯å¾„å’ŒåŠŸèƒ½ä»£ç æ˜¯å¦ä¸€è‡´ï¼Œä¸€ä¸ªéå¸¸é‡è¦çš„ä¸€ç‚¹æ˜¯ä¸¤ä¸ªç±»çš„åºåˆ—åŒ– ID æ˜¯å¦ä¸€è‡´ï¼ˆå°±æ˜¯ private static final long serialVersionUIDï¼‰</p>
</li>
<li>
<p>åºåˆ—åŒ–å¹¶ä¸ä¿å­˜é™æ€å˜é‡ã€‚</p>
</li>
<li>
<p>è¦æƒ³å°†çˆ¶ç±»å¯¹è±¡ä¹Ÿåºåˆ—åŒ–ï¼Œå°±éœ€è¦è®©çˆ¶ç±»ä¹Ÿå®ç°Serializable æ¥å£ã€‚</p>
</li>
<li>
<p>Transient å…³é”®å­—çš„ä½œç”¨æ˜¯æ§åˆ¶å˜é‡çš„åºåˆ—åŒ–ï¼Œåœ¨å˜é‡å£°æ˜å‰åŠ ä¸Šè¯¥å…³é”®å­—ï¼Œå¯ä»¥é˜»æ­¢è¯¥å˜é‡è¢«åºåˆ—åŒ–åˆ°æ–‡ä»¶ä¸­ï¼Œåœ¨è¢«ååºåˆ—åŒ–åï¼Œtransient å˜é‡çš„å€¼è¢«è®¾ä¸ºåˆå§‹å€¼ï¼Œå¦‚ int å‹çš„æ˜¯ 0ï¼Œå¯¹è±¡å‹çš„æ˜¯ nullã€‚</p>
</li>
<li>
<p>æœåŠ¡å™¨ç«¯ç»™å®¢æˆ·ç«¯å‘é€åºåˆ—åŒ–å¯¹è±¡æ•°æ®ï¼Œå¯¹è±¡ä¸­æœ‰ä¸€äº›æ•°æ®æ˜¯æ•æ„Ÿçš„ï¼Œæ¯”å¦‚å¯†ç å­—ç¬¦ä¸²ç­‰ï¼Œå¸Œæœ›å¯¹è¯¥å¯†ç å­—æ®µåœ¨åºåˆ—åŒ–æ—¶ï¼Œè¿›è¡ŒåŠ å¯†ï¼Œè€Œå®¢æˆ·ç«¯å¦‚æœæ‹¥æœ‰è§£å¯†çš„å¯†é’¥ï¼Œåªæœ‰åœ¨å®¢æˆ·ç«¯è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œæ‰å¯ä»¥å¯¹å¯†ç è¿›è¡Œè¯»å–ï¼Œè¿™æ ·å¯ä»¥ä¸€å®šç¨‹åº¦ä¿è¯åºåˆ—åŒ–å¯¹è±¡çš„æ•°æ®å®‰å…¨ã€‚</p>
</li>
</ol>
<h2 id="ArrayListçš„åºåˆ—åŒ–">ArrayListçš„åºåˆ—åŒ–</h2>
<p>åœ¨ä»‹ç»ArrayListåºåˆ—åŒ–ä¹‹å‰ï¼Œå…ˆæ¥è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼š</p>
<p>å¦‚ä½•è‡ªå®šä¹‰çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç­–ç•¥</p>
<p>å¸¦ç€è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ¥çœ‹java.util.ArrayListçš„æºç </p>
<p>code 3</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractList</span>&lt;<span class="title">E</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">List</span>&lt;<span class="title">E</span>&gt;, <span class="title">RandomAccess</span>, <span class="title">Cloneable</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">8683452581122892189L</span>;</span><br><span class="line">    <span class="keyword">transient</span> Object[] elementData; <span class="comment">// non-private to simplify nested class access</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¬”è€…çœç•¥äº†å…¶ä»–æˆå‘˜å˜é‡ï¼Œä»ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çŸ¥é“<code>ArrayList</code>å®ç°äº†<code>java.io.Serializable</code>æ¥å£ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å¯¹å®ƒè¿›è¡Œåºåˆ—åŒ–åŠååºåˆ—åŒ–ã€‚å› ä¸º<code>elementData</code>æ˜¯<code>transient</code>çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è®¤ä¸ºè¿™ä¸ªæˆå‘˜å˜é‡ä¸ä¼šè¢«åºåˆ—åŒ–è€Œä¿ç•™ä¸‹æ¥ã€‚æˆ‘ä»¬å†™ä¸€ä¸ªDemoï¼ŒéªŒè¯ä¸€ä¸‹æˆ‘ä»¬çš„æƒ³æ³•ï¼š</p>
<p>code 4</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        List&lt;String&gt; stringList = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        stringList.add(<span class="string">"hello"</span>);</span><br><span class="line">        stringList.add(<span class="string">"world"</span>);</span><br><span class="line">        stringList.add(<span class="string">"hollis"</span>);</span><br><span class="line">        stringList.add(<span class="string">"chuang"</span>);</span><br><span class="line">        System.out.println(<span class="string">"init StringList"</span> + stringList);</span><br><span class="line">        ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"stringlist"</span>));</span><br><span class="line">        objectOutputStream.writeObject(stringList);</span><br><span class="line"></span><br><span class="line">        IOUtils.close(objectOutputStream);</span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"stringlist"</span>);</span><br><span class="line">        ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">        List&lt;String&gt; newStringList = (List&lt;String&gt;)objectInputStream.readObject();</span><br><span class="line">        IOUtils.close(objectInputStream);</span><br><span class="line">        <span class="keyword">if</span>(file.exists())&#123;</span><br><span class="line">            file.delete();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"new StringList"</span> + newStringList);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>è¾“å‡º</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">init StringList[hello, world, hollis, chuang]</span><br><span class="line">new StringList[hello, world, hollis, chuang]</span><br></pre></td></tr></table></figure>
<p>äº†è§£<code>ArrayList</code>çš„äººéƒ½çŸ¥é“ï¼Œ<code>ArrayList</code>åº•å±‚æ˜¯é€šè¿‡æ•°ç»„å®ç°çš„ã€‚é‚£ä¹ˆæ•°ç»„<code>elementData</code>å…¶å®å°±æ˜¯ç”¨æ¥ä¿å­˜åˆ—è¡¨ä¸­çš„å…ƒç´ çš„ã€‚é€šè¿‡è¯¥å±æ€§çš„å£°æ˜æ–¹å¼æˆ‘ä»¬çŸ¥é“ï¼Œä»–æ˜¯æ— æ³•é€šè¿‡åºåˆ—åŒ–æŒä¹…åŒ–ä¸‹æ¥çš„ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆ <strong>code 4</strong> çš„ç»“æœå´é€šè¿‡åºåˆ—åŒ–å’Œååºåˆ—åŒ–æŠŠListä¸­çš„å…ƒç´ ä¿ç•™ä¸‹æ¥äº†å‘¢ï¼Ÿ</p>
<h3 id="writeObjectå’ŒreadObjectæ–¹æ³•">writeObjectå’ŒreadObjectæ–¹æ³•</h3>
<p>åœ¨ArrayListä¸­å®šä¹‰äº†æ¥ä¸ªæ–¹æ³•ï¼š writeObjectå’ŒreadObjectã€‚</p>
<p>è¿™é‡Œå…ˆç»™å‡ºç»“è®º:</p>
<p>åœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¢«åºåˆ—åŒ–çš„ç±»ä¸­å®šä¹‰äº†writeObject å’Œ readObject æ–¹æ³•ï¼Œè™šæ‹Ÿæœºä¼šè¯•å›¾è°ƒç”¨å¯¹è±¡ç±»é‡Œçš„ writeObject å’Œ readObject æ–¹æ³•ï¼Œè¿›è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p>
<p>å¦‚æœæ²¡æœ‰è¿™æ ·çš„æ–¹æ³•ï¼Œåˆ™é»˜è®¤è°ƒç”¨æ˜¯ ObjectOutputStream çš„ defaultWriteObject æ–¹æ³•ä»¥åŠ ObjectInputStream çš„ defaultReadObject æ–¹æ³•ã€‚</p>
<p>ç”¨æˆ·è‡ªå®šä¹‰çš„ writeObject å’Œ readObject æ–¹æ³•å¯ä»¥å…è®¸ç”¨æˆ·æ§åˆ¶åºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œæ¯”å¦‚å¯ä»¥åœ¨åºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­åŠ¨æ€æ”¹å˜åºåˆ—åŒ–çš„æ•°å€¼ã€‚</p>
<p>æ¥çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ï¼š</p>
<p>code 5</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        elementData = EMPTY_ELEMENTDATA;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read in size, and any hidden stuff</span></span><br><span class="line">        s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Read in capacity</span></span><br><span class="line">        s.readInt(); <span class="comment">// ignored</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// be like clone(), allocate array based upon size not capacity</span></span><br><span class="line">            ensureCapacityInternal(size);</span><br><span class="line"></span><br><span class="line">            Object[] a = elementData;</span><br><span class="line">            <span class="comment">// Read in all elements in the proper order.</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;size; i++) &#123;</span><br><span class="line">                a[i] = s.readObject();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>code 6</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException</span>&#123;</span><br><span class="line">        <span class="comment">// Write out element count, and any hidden stuff</span></span><br><span class="line">        <span class="keyword">int</span> expectedModCount = modCount;</span><br><span class="line">        s.defaultWriteObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Write out size as capacity for behavioural compatibility with clone()</span></span><br><span class="line">        s.writeInt(size);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Write out all elements in the proper order.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;size; i++) &#123;</span><br><span class="line">            s.writeObject(elementData[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (modCount != expectedModCount) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConcurrentModificationException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆä¸ºä»€ä¹ˆArrayListè¦ç”¨è¿™ç§æ–¹å¼æ¥å®ç°åºåˆ—åŒ–å‘¢ï¼Ÿ</p>
<h3 id="why-transient">why transient</h3>
<p>ArrayListå®é™…ä¸Šæ˜¯åŠ¨æ€æ•°ç»„ï¼Œæ¯æ¬¡åœ¨æ”¾æ»¡ä»¥åè‡ªåŠ¨å¢é•¿è®¾å®šçš„é•¿åº¦å€¼ï¼Œå¦‚æœæ•°ç»„è‡ªåŠ¨å¢é•¿é•¿åº¦è®¾ä¸º100ï¼Œè€Œå®é™…åªæ”¾äº†ä¸€ä¸ªå…ƒç´ ï¼Œé‚£å°±ä¼šåºåˆ—åŒ–99ä¸ªnullå…ƒç´ ã€‚ä¸ºäº†ä¿è¯åœ¨åºåˆ—åŒ–çš„æ—¶å€™ä¸ä¼šå°†è¿™ä¹ˆå¤šnullåŒæ—¶è¿›è¡Œåºåˆ—åŒ–ï¼ŒArrayListæŠŠå…ƒç´ æ•°ç»„è®¾ç½®ä¸ºtransientã€‚</p>
<h3 id="why-writeObject-and-readObject">why writeObject and readObject</h3>
<p>å‰é¢è¯´è¿‡ï¼Œä¸ºäº†é˜²æ­¢ä¸€ä¸ªåŒ…å«å¤§é‡ç©ºå¯¹è±¡çš„æ•°ç»„è¢«åºåˆ—åŒ–ï¼Œä¸ºäº†ä¼˜åŒ–å­˜å‚¨ï¼Œæ‰€ä»¥ï¼ŒArrayListä½¿ç”¨transientæ¥å£°æ˜elementDataã€‚ ä½†æ˜¯ï¼Œä½œä¸ºä¸€ä¸ªé›†åˆï¼Œåœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­è¿˜å¿…é¡»ä¿è¯å…¶ä¸­çš„å…ƒç´ å¯ä»¥è¢«æŒä¹…åŒ–ä¸‹æ¥ï¼Œæ‰€ä»¥ï¼Œé€šè¿‡é‡å†™writeObject å’Œ readObjectæ–¹æ³•çš„æ–¹å¼æŠŠå…¶ä¸­çš„å…ƒç´ ä¿ç•™ä¸‹æ¥ã€‚</p>
<p>writeObjectæ–¹æ³•æŠŠelementDataæ•°ç»„ä¸­çš„å…ƒç´ éå†çš„ä¿å­˜åˆ°è¾“å‡ºæµï¼ˆObjectOutputStreamï¼‰ä¸­ã€‚</p>
<p>readObjectæ–¹æ³•ä»è¾“å…¥æµï¼ˆObjectInputStreamï¼‰ä¸­è¯»å‡ºå¯¹è±¡å¹¶ä¿å­˜èµ‹å€¼åˆ°elementDataæ•°ç»„ä¸­ã€‚</p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å…ˆè¯•ç€æ¥å›ç­”åˆšåˆšæå‡ºçš„é—®é¢˜ï¼š</p>
<p>å¦‚ä½•è‡ªå®šä¹‰çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç­–ç•¥</p>
<p>ç­”ï¼šå¯ä»¥é€šè¿‡åœ¨è¢«åºåˆ—åŒ–çš„ç±»ä¸­å¢åŠ writeObject å’Œ readObjectæ–¹æ³•ã€‚é‚£ä¹ˆé—®é¢˜åˆæ¥äº†ï¼š</p>
<p>è™½ç„¶ArrayListä¸­å†™äº†writeObject å’Œ readObject æ–¹æ³•ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªæ–¹æ³•å¹¶æ²¡æœ‰æ˜¾ç¤ºçš„è¢«è°ƒç”¨å•Šã€‚</p>
<p>é‚£ä¹ˆå¦‚æœä¸€ä¸ªç±»ä¸­åŒ…å«writeObject å’Œ readObject æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯æ€ä¹ˆè¢«è°ƒç”¨çš„å‘¢?</p>
<h2 id="ObjectOutputStream">ObjectOutputStream</h2>
<p>ä»code 4ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå¯¹è±¡çš„åºåˆ—åŒ–è¿‡ç¨‹é€šè¿‡ObjectOutputStreamå’ŒObjectInputputStreamæ¥å®ç°çš„ï¼Œé‚£ä¹ˆå¸¦ç€åˆšåˆšçš„é—®é¢˜ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ArrayListä¸­çš„writeObject å’Œ readObject æ–¹æ³•åˆ°åº•æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„å‘¢ï¼Ÿ</p>
<p>ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œè¿™é‡Œç»™å‡ºObjectOutputStreamçš„writeObjectçš„è°ƒç”¨æ ˆï¼š</p>
<p>writeObject â€”&gt; writeObject0 â€”&gt;writeOrdinaryObjectâ€”&gt;writeSerialDataâ€”&gt;invokeWriteObject</p>
<p>è¿™é‡Œçœ‹ä¸€ä¸‹invokeWriteObjectï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">invokeWriteObject</span><span class="params">(Object obj, ObjectOutputStream out)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, UnsupportedOperationException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (writeObjectMethod != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                writeObjectMethod.invoke(obj, <span class="keyword">new</span> Object[]&#123; out &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">                Throwable th = ex.getTargetException();</span><br><span class="line">                <span class="keyword">if</span> (th <span class="keyword">instanceof</span> IOException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (IOException) th;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    throwMiscException(th);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">                <span class="comment">// should not occur, as access checks have been suppressed</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­writeObjectMethod.invoke(obj, new Object[]{ out });æ˜¯å…³é”®ï¼Œé€šè¿‡åå°„çš„æ–¹å¼è°ƒç”¨writeObjectMethodæ–¹æ³•ã€‚å®˜æ–¹æ˜¯è¿™ä¹ˆè§£é‡Šè¿™ä¸ªwriteObjectMethodçš„ï¼š</p>
<p>class-defined writeObject method, or null if none</p>
<p>åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯æˆ‘ä»¬åœ¨ArrayListä¸­å®šä¹‰çš„writeObjectæ–¹æ³•ã€‚é€šè¿‡åå°„çš„æ–¹å¼è¢«è°ƒç”¨äº†ã€‚</p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å…ˆè¯•ç€æ¥å›ç­”åˆšåˆšæå‡ºçš„é—®é¢˜ï¼š</p>
<p>å¦‚æœä¸€ä¸ªç±»ä¸­åŒ…å«writeObject å’Œ readObject æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯æ€ä¹ˆè¢«è°ƒç”¨çš„?</p>
<p>ç­”ï¼šåœ¨ä½¿ç”¨ObjectOutputStreamçš„writeObjectæ–¹æ³•å’ŒObjectInputStreamçš„readObjectæ–¹æ³•æ—¶ï¼Œä¼šé€šè¿‡åå°„çš„æ–¹å¼è°ƒç”¨ã€‚</p>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»ä»‹ç»å®Œäº†ArrayListçš„åºåˆ—åŒ–æ–¹å¼ã€‚é‚£ä¹ˆï¼Œä¸çŸ¥é“æœ‰æ²¡æœ‰äººæå‡ºè¿™æ ·çš„ç–‘é—®ï¼š</p>
<p>Serializableæ˜æ˜å°±æ˜¯ä¸€ä¸ªç©ºçš„æ¥å£ï¼Œå®ƒæ˜¯æ€ä¹ˆä¿è¯åªæœ‰å®ç°äº†è¯¥æ¥å£çš„æ–¹æ³•æ‰èƒ½è¿›è¡Œåºåˆ—åŒ–ä¸ååºåˆ—åŒ–çš„å‘¢ï¼Ÿ</p>
<h3 id="Serializableæ¥å£çš„å®šä¹‰ï¼š">Serializableæ¥å£çš„å®šä¹‰ï¼š</h3>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯»è€…å¯ä»¥å°è¯•æŠŠ <strong>code 1</strong> ä¸­çš„ç»§æ‰¿<code>Serializable</code>çš„ä»£ç å»æ‰ï¼Œå†æ‰§è¡Œ <strong>code 2</strong> ï¼Œä¼šæŠ›å‡º<code>java.io.NotSerializableException</code>ã€‚</p>
<p>å…¶å®è¿™ä¸ªé—®é¢˜ä¹Ÿå¾ˆå¥½å›ç­”ï¼Œæˆ‘ä»¬å†å›åˆ°åˆšåˆšObjectOutputStreamçš„writeObjectçš„è°ƒç”¨æ ˆï¼š<br>
<font color='red'><br>
writeObject â€”&gt; writeObject0 â€”&gt;writeOrdinaryObjectâ€”&gt;writeSerialDataâ€”&gt;invokeWriteObject<br>
</font><br>
<code>writeObject0</code>æ–¹æ³•ä¸­æœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (obj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        writeString((String) obj, unshared);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cl.isArray()) &#123;</span><br><span class="line">        writeArray(obj, desc, unshared);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Enum) &#123;</span><br><span class="line">        writeEnum((Enum&lt;?&gt;) obj, desc, unshared);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Serializable) &#123;</span><br><span class="line">        writeOrdinaryObject(obj, desc, unshared);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (extendedDebugInfo) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotSerializableException(</span><br><span class="line">                cl.getName() + <span class="string">"\n"</span> + debugInfoStack.toString());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotSerializableException(cl.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿›è¡Œåºåˆ—åŒ–æ“ä½œæ—¶ï¼Œä¼šåˆ¤æ–­è¦è¢«åºåˆ—åŒ–çš„ç±»æ˜¯å¦æ˜¯Enum. Arrayå’ŒSerializableç±»å‹ï¼Œå¦‚æœä¸æ˜¯åˆ™ç›´æ¥æŠ›å‡º<code>NotSerializableException</code>ã€‚</p>
<h2 id="æ€»ç»“">æ€»ç»“</h2>
<ol>
<li>
<p>å¦‚æœä¸€ä¸ªç±»æƒ³è¢«åºåˆ—åŒ–ï¼Œéœ€è¦å®ç°<code>Serializable</code>æ¥å£ã€‚å¦åˆ™å°†æŠ›å‡º<code>NotSerializableException</code>å¼‚å¸¸ï¼Œè¿™æ˜¯å› ä¸ºï¼Œåœ¨åºåˆ—åŒ–æ“ä½œè¿‡ç¨‹ä¸­ä¼šå¯¹ç±»å‹è¿›è¡Œæ£€æŸ¥ï¼Œè¦æ±‚è¢«åºåˆ—åŒ–çš„ç±»å¿…é¡»å±äºEnum. Arrayå’ŒSerializableç±»å‹å…¶ä¸­çš„ä»»ä½•ä¸€ç§ã€‚</p>
</li>
<li>
<p>åœ¨å˜é‡å£°æ˜å‰åŠ ä¸Šè¯¥å…³é”®å­—ï¼Œå¯ä»¥é˜»æ­¢è¯¥å˜é‡è¢«åºåˆ—åŒ–åˆ°æ–‡ä»¶ä¸­ã€‚</p>
</li>
<li>
<p>åœ¨ç±»ä¸­å¢åŠ <code>writeObject</code> å’Œ <code>readObject</code> æ–¹æ³•å¯ä»¥å®ç°è‡ªå®šä¹‰åºåˆ—åŒ–ç­–ç•¥</p>
</li>
</ol>
<blockquote>
<p>æœ¬æ–‡è½¬è½½è‡ª<a href="http://www.hollischuang.com/archives/1140" target="_blank" rel="noopener">æ·±å…¥åˆ†æJavaçš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–</a></p>
</blockquote>
]]></content>
      <categories>
        <category>Java</category>
        <category>Javaé«˜çº§</category>
      </categories>
      <tags>
        <tag>Javaé«˜çº§</tag>
      </tags>
  </entry>
</search>
